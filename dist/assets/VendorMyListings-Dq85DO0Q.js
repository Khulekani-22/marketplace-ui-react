import{u as xe,p as be,r as o,e as je,d as ye,c as te,j as s,L as P,b as Ne}from"./index-HPcd39yI.js";import{u as Se,M as ke}from"./MasterLayout-Ucxt6LSp.js";import{f as ve}from"./listings-DoTUFSnM.js";import"./iconify-D0q36GhI.js";function U(c){if(!c)return"public";const m=c.toString().toLowerCase();return m==="vendor"?"public":m}function we(c,m){const p=U(c||"public"),a=(m||"").trim().toLowerCase();return a?`vendor_pending_listings:${p}:${a}`:null}function W(c){return String((c==null?void 0:c.id)||(c==null?void 0:c.serviceId)||"")}function Ie(c){try{const m=typeof c=="string"?JSON.parse(c):c;return Array.isArray(m)?m:[]}catch{return[]}}function se(c,m){const p=U(c),a=U(m);return p===a||p==="public"||a==="public"}function ne({s:c}){const m=(c||"unknown").toLowerCase(),p={approved:"success",pending:"warning",rejected:"danger",scheduled:"info",completed:"success",canceled:"secondary",unknown:"secondary"};return s.jsx("span",{className:`badge text-bg-${p[m]||"secondary"}`,children:m})}function Re(){var ee;const c=xe(),m=be(),p=o.useRef(null),{vendor:a,ensureVendorId:O,loading:q}=je(),{refresh:ae,syncMessagesToLive:re}=Se(),{appData:Y,appDataLoading:G}=ye(),M=o.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[b,j]=o.useState([]),[N,S]=o.useState([]),[R,ie]=o.useState(!0),[Q,ce]=o.useState(!1),[X,w]=o.useState(""),[h,k]=o.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1}),v=o.useMemo(()=>we(M,(a==null?void 0:a.vendorId)||(a==null?void 0:a.email)||(a==null?void 0:a.id)||""),[M,a==null?void 0:a.vendorId,a==null?void 0:a.email,a==null?void 0:a.id]),[I,T]=o.useState([]),g=(ee=m.state)==null?void 0:ee.newListing,E=o.useCallback(e=>{if(T(e),!!v){if(!e.length){localStorage.removeItem(v);return}try{localStorage.setItem(v,JSON.stringify(e))}catch{}}},[v]);o.useEffect(()=>{if(!v){T([]);return}try{const e=Ie(localStorage.getItem(v));T(e)}catch{T([])}},[v]),o.useEffect(()=>{if(!g)return;p.current=g;const e=String((g==null?void 0:g.id)||(g==null?void 0:g.serviceId)||"");j(t=>t?t.some(i=>String((i==null?void 0:i.id)||(i==null?void 0:i.serviceId))===e)?t:[g,...t]:[g]),E([g,...I.filter(t=>String((t==null?void 0:t.id)||(t==null?void 0:t.serviceId)||"")!==e)]),w(""),c({pathname:m.pathname,search:m.search},{replace:!0,state:{}})},[g,c,m.pathname,m.search,E,I]);const L=o.useCallback(e=>{const t=Array.isArray(e)?[...e]:[],n=new Set(t.map(W).filter(Boolean)),i=p.current;if(i){const d=W(i);d&&!n.has(d)?(t.unshift(i),n.add(d)):p.current=null}if(I.length){const d=[];I.forEach(u=>{const r=W(u);r&&(n.has(r)||(n.add(r),t.unshift(u),d.push(u)))}),d.length!==I.length&&E(d)}return t},[I,E]);o.useEffect(()=>{if(a&&!a.isApproved){const e=encodeURIComponent("/listings-vendors-mine");c(`/profile-vendor?next=${e}`,{replace:!0})}},[a,c]);function Z(e){var i,d,u;let t=e;const n=new Set;for(;t&&typeof t=="object"&&!Array.isArray(t==null?void 0:t.services)&&!n.has(t);){if(n.add(t),Array.isArray((i=t==null?void 0:t.data)==null?void 0:i.services)){t=t.data;continue}if(Array.isArray((d=t==null?void 0:t.payload)==null?void 0:d.services)){t=t.payload;continue}if(Array.isArray((u=t==null?void 0:t.appData)==null?void 0:u.services)){t=t.appData;continue}break}return t&&typeof t=="object"?t:null}const z=o.useCallback(e=>{if(!e)return{listings:[],bookings:[]};const t=Z(Y)||Z(te)||te,n=U(M),i=Array.isArray(t==null?void 0:t.services)?t.services:[],u=(Array.isArray(t==null?void 0:t.bookings)?t.bookings:[]).filter(l=>se(l==null?void 0:l.tenantId,n)),r=String((e==null?void 0:e.vendorId)||""),x=String((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||"").toLowerCase(),f=String((e==null?void 0:e.name)||(e==null?void 0:e.companyName)||"").toLowerCase(),y=i.filter(l=>{if(!se(l==null?void 0:l.tenantId,n))return!1;const A=String(l.vendorId||""),H=String(l.contactEmail||l.email||"").toLowerCase(),F=String(l.vendor||"").toLowerCase();return A&&r&&A===r||!A&&(F&&F===f||x&&H===x)}),_=new Set(y.flatMap(l=>[String(l.id||""),String(l.serviceId||""),String(l.vendorId||"")]).filter(Boolean)),C=u.filter(l=>{const B=String(l.serviceId||""),A=r&&String(l.vendorId||"")===r,H=x&&String(l.vendorEmail||"").toLowerCase()===x,F=f&&String(l.vendorName||"").toLowerCase()===f;return _.has(B)||A||H||F});return{listings:y,bookings:C}},[Y,M]),$=o.useCallback(async({signal:e,silent:t}={})=>{var d,u;const n=r=>{t?ce(r):ie(r)};n(!0),w("");let i=a;try{if(e!=null&&e.aborted||q&&!a)return;if(!a){j([]),S([]);return}const r=O?await O():a;if(e!=null&&e.aborted)return;if(i=r||a,!i){j([]),S([]);return}const{listings:x,bookings:f}=await ve({signal:e});if(e!=null&&e.aborted)return;const y=Array.isArray(x)?x:[],_=Array.isArray(f)?f:[],C=L(y);if(C.length)j(C),S(_);else{const l=z(i);if(l.listings.length){const B=L(l.listings);j(B),S(l.bookings),t||w("Showing cached listings until the live catalog updates.")}else j(C),S([])}}catch(r){if(e!=null&&e.aborted)return;if((r==null?void 0:r.code)==="ERR_NETWORK"){const f=z(i),y=L(f.listings);j(y),S(f.bookings),w("Showing cached data while the network is unavailable.")}else w(((u=(d=r==null?void 0:r.response)==null?void 0:d.data)==null?void 0:u.message)||(r==null?void 0:r.message)||"Failed to load listings"),j(L([])),S([])}finally{n(!1)}},[z,O,L,a,q]);o.useEffect(()=>{const e=new AbortController;return $({signal:e.signal}),()=>{e.abort()}},[$]);const le=o.useCallback(async()=>{w(""),await $({silent:!0})},[$]),K=o.useMemo(()=>{const e={approved:0,pending:0,rejected:0};return b.forEach(t=>{var n;return e[n=(t.status||"pending").toLowerCase()]||(e[n]=0),e[(t.status||"pending").toLowerCase()]++}),e},[b]),oe=o.useMemo(()=>{const e={};return N.forEach(t=>{const n=String(t.serviceId||"");n&&(e[n]=(e[n]||0)+1)}),e},[N]),de=o.useMemo(()=>{const e={};return b.forEach(t=>{[String(t.id||""),String(t.serviceId||""),String(t.vendorId||"")].filter(Boolean).forEach(i=>{e[i]=t})}),e},[b]);function V(e){const t=(e+11)%12+1,n=e>=12?"PM":"AM";return`${t}:00 ${n}`}function ue(e){if(!e)return"";const[t]=e.split(":"),n=Number(t);return Number.isNaN(n)?e:`${V(n)} – ${V(n+1)}`}function J(e){if(e!=null&&e.scheduledDate){const t=e.scheduledSlot||"00:00",n=`${e.scheduledDate}T${t.length===5?t:`${t}:00`}`,i=new Date(n);if(!Number.isNaN(i.getTime()))return i}if(e!=null&&e.bookedAt){const t=new Date(e.bookedAt);if(!Number.isNaN(t.getTime()))return t}return null}const me=o.useMemo(()=>{const e=N.map(t=>({...t}));return e.sort((t,n)=>{var u,r;const i=((u=J(t))==null?void 0:u.getTime())??0,d=((r=J(n))==null?void 0:r.getTime())??0;return i-d}),e},[N]);function he(e){return e?{date:e.toLocaleDateString(),time:e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}:{date:"—",time:""}}function ge(e){const t=encodeURIComponent(JSON.stringify({title:e.title,category:e.category,price:e.price,imageUrl:e.imageUrl,description:e.description,listingType:e.listingType||"service"}));c(`/listings-vendors?prefill=${t}`)}function fe(e){const t=`Feedback request: ${e.title}`,n=`Hello Admin

My listing "${e.title}" (ID: ${e.id}) was ${String(e.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;k({open:!0,listing:e,subject:t,content:n,sending:!1,err:null,done:!1})}function D(){k({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function pe(e){var t;if((t=e==null?void 0:e.preventDefault)==null||t.call(e),!(!h.listing||!h.content.trim())){k(n=>({...n,sending:!0,err:null}));try{await Ne.post("/api/messages",{listingId:h.listing.id,listingTitle:h.listing.title,vendorId:(a==null?void 0:a.vendorId)||"",vendorEmail:(a==null?void 0:a.email)||"",subject:h.subject,content:h.content}),k(n=>({...n,sending:!1,done:!0}));try{await ae({force:!0}),await re()}catch{}setTimeout(()=>D(),1200)}catch(n){k(i=>{var d,u;return{...i,sending:!1,err:((u=(d=n==null?void 0:n.response)==null?void 0:d.data)==null?void 0:u.message)||(n==null?void 0:n.message)||"Failed to send"}})}}}return s.jsx(ke,{activeRoute:"/listings-vendors-mine",pageTitle:"My listings",children:s.jsxs("div",{className:"container py-4",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[s.jsx("h1",{className:"h4 mb-0",children:"My listings"}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:le,disabled:R||Q||G,children:Q||G?"Refreshing…":"Refresh"}),s.jsx(P,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})]})]}),s.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[s.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",K.approved]}),s.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",K.pending]}),s.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",K.rejected]}),s.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",b.length]})]}),s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[X&&s.jsx("div",{className:"alert alert-danger",children:X}),R&&s.jsx("div",{className:"text-muted",children:"Loading…"}),!R&&!b.length&&s.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",s.jsx(P,{to:"/listings-vendors",children:"Create your first one."})]}),!R&&!!b.length&&s.jsx("div",{className:"table-responsive",children:s.jsxs("table",{className:"table align-middle",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{style:{width:72}}),s.jsx("th",{children:"Title"}),s.jsx("th",{children:"Category"}),s.jsx("th",{children:"Price"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Bookings"}),s.jsx("th",{style:{width:220},children:"Actions"})]})}),s.jsx("tbody",{children:b.map((e,t)=>{const n=String(e.id||e.serviceId||e.vendorId||"");return s.jsxs("tr",{children:[s.jsx("td",{children:s.jsx("img",{src:e.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),s.jsx("td",{className:"fw-semibold",children:e.title}),s.jsx("td",{children:e.category||"—"}),s.jsxs("td",{children:["R",Number(e.price||0).toLocaleString()]}),s.jsx("td",{children:s.jsx(ne,{s:e.status})}),s.jsx("td",{children:oe[n]||0}),s.jsxs("td",{className:"d-flex gap-2",children:[s.jsx(P,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(e.id)}`,children:"View"}),s.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>ge(e),children:"Duplicate & edit"}),String(e.status||"").toLowerCase()==="rejected"&&s.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>fe(e),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},n||t)})})]})})]})}),s.jsxs("div",{className:"card mt-4",children:[s.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[s.jsx("h6",{className:"mb-0",children:"Bookings"}),s.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",N.length]})]}),s.jsxs("div",{className:"card-body",children:[!N.length&&s.jsx("div",{className:"text-muted",children:"No bookings yet. Once customers reserve sessions, they will appear here."}),!!N.length&&s.jsx("div",{className:"table-responsive",children:s.jsxs("table",{className:"table align-middle",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Service"}),s.jsx("th",{children:"Customer"}),s.jsx("th",{children:"Scheduled"}),s.jsx("th",{children:"Status"}),s.jsx("th",{className:"text-end",children:"Price"})]})}),s.jsx("tbody",{children:me.map((e,t)=>{const n=J(e),{date:i,time:d}=he(n),u=ue(e.scheduledSlot),r=de[String(e.serviceId||"")],x=e.serviceTitle||(r==null?void 0:r.title)||"Unknown service",f=Number(e.price||(r==null?void 0:r.price)||0)||0,y=String(e.id||[e.serviceId,e.customerId,e.scheduledDate,e.scheduledSlot,e.bookedAt].filter(Boolean).join("-")||t);return s.jsxs("tr",{children:[s.jsx("td",{children:s.jsxs("div",{className:"d-flex flex-column",children:[s.jsx("span",{className:"fw-semibold",children:x}),(r==null?void 0:r.id)&&s.jsx(P,{className:"small",to:`/marketplace-details?id=${encodeURIComponent(r.id)}`,children:"Open listing"})]})}),s.jsx("td",{children:s.jsx("div",{className:"small text-muted",children:e.customerName||e.customerEmail||"—"})}),s.jsx("td",{children:s.jsxs("div",{className:"d-flex flex-column small",children:[s.jsx("span",{children:i}),s.jsx("span",{children:u||d})]})}),s.jsx("td",{children:s.jsx(ne,{s:e.status||"pending"})}),s.jsxs("td",{className:"text-end",children:["R",f.toLocaleString()]})]},y)})})]})})]})]}),h.open&&h.listing&&s.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:e=>e.target===e.currentTarget&&D(),children:s.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[s.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[s.jsxs("h6",{className:"mb-0",children:["Message Admin about: ",h.listing.title]}),s.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:D,children:"Close"})]}),s.jsxs("form",{onSubmit:pe,children:[s.jsxs("div",{className:"card-body",children:[h.err&&s.jsx("div",{className:"alert alert-danger py-2 mb-2",children:h.err}),h.done&&s.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label",children:"Subject"}),s.jsx("input",{className:"form-control",value:h.subject,onChange:e=>k(t=>({...t,subject:e.target.value}))})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label",children:"Message"}),s.jsx("textarea",{className:"form-control",rows:6,value:h.content,onChange:e=>k(t=>({...t,content:e.target.value}))}),s.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",(a==null?void 0:a.email)||"you"]})]})]}),s.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[s.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:D,disabled:h.sending,children:"Cancel"}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:h.sending||!h.content.trim(),children:h.sending?"Sending…":"Send"})]})]})]})})]})})}export{Re as default};
