import{r as a,d as B,b as v,a as u,j as e}from"./index-C1K-Ttoc.js";import{M as T}from"./MasterLayout-2IldCL2c.js";import{B as _}from"./Breadcrumb-Y9hUuaca.js";import{f as L,u as J}from"./subscriptions-BiGoMWRW.js";import"./iconify-CXWIXv_s.js";function q(){const[y,x]=a.useState(!0),[S,p]=a.useState([]),[j,N]=a.useState(""),[w,I]=a.useState({}),[U,A]=a.useState(!1),C=a.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),{appData:b}=B(),F=a.useCallback(async()=>{var s;try{console.log("ðŸ”— Testing API connection..."),console.log("ðŸ”— Current API base URL:",v.defaults.baseURL);const t=await v.get("/api/health");if(console.log("âœ… API health check passed:",t.data),u.currentUser){console.log("ðŸ” Testing authenticated endpoint...");const o=await v.get("/api/subscriptions/my");console.log("âœ… Subscriptions endpoint test:",o.data)}}catch(t){console.error("âŒ API connection test failed:",t),console.error("âŒ Error details:",(s=t==null?void 0:t.response)==null?void 0:s.data)}},[]);a.useEffect(()=>{F()},[F]);const h=a.useCallback(async(s={})=>{const{silent:t,signal:o}=s;t?A(!0):x(!0),N("");try{if(!u.currentUser){console.log("ðŸ” No authenticated user found"),o!=null&&o.aborted||p([]);return}console.log("ðŸ“¡ Fetching subscriptions for user:",u.currentUser.email);const c=await L();console.log("ðŸ“‹ Raw subscriptions from API:",c);const g=new Set(c.filter(i=>(i.type||"service")==="service").map(i=>String(i.serviceId)));console.log("ðŸ” Service IDs from subscriptions:",Array.from(g));const m=Array.isArray(b==null?void 0:b.services)?b.services:[];console.log("ðŸ“¦ Available services in appData:",m.length);const d=m.filter(i=>g.has(String(i.id)));console.log("âœ… Matched services:",d.length,d.map(i=>({id:i.id,title:i.title}))),o!=null&&o.aborted||p(d)}catch(c){console.error("âŒ Failed to load subscriptions:",c),o!=null&&o.aborted||N((c==null?void 0:c.message)||"Failed to load subscriptions")}finally{(o==null?void 0:o.aborted)||(t?A(!1):x(!1))}},[b]);a.useEffect(()=>{const s=new AbortController;return h({silent:!1,signal:s.signal}),()=>{s.abort()}},[h,C]);async function P(s){var o,c,g,m,d,i,R,M;const t=String(s);console.log("ðŸ”„ Starting unsubscribe process for service:",t),console.log("ðŸ”„ Current user:",(o=u.currentUser)==null?void 0:o.email),console.log("ðŸ”„ Current tenant:",C),I(r=>({...r,[t]:!0}));try{console.log("ðŸ” Fetching current subscriptions before unsubscribe...");const r=await L();console.log("ðŸ“‹ Current subscriptions:",r);const f=r.find(n=>String(n.serviceId)===t);if(console.log("ðŸŽ¯ Target subscription to cancel:",f),!f){console.log("âš ï¸ No subscription found in cache for service:",t),p(n=>n.filter(l=>String(l.id)!==t)),alert(`âœ… Service ${t} removed from your subscriptions (was already cancelled)`);return}console.log("ðŸ“¡ Calling unsubscribeFromService API...");try{const n=await J(t);console.log("âœ… Unsubscribe API success:",n),alert(`âœ… Successfully unsubscribed from service ${t}`)}catch(n){if(((c=n==null?void 0:n.response)==null?void 0:c.status)===404)console.log("âš ï¸ Backend says subscription not found (404) - treating as already cancelled"),alert(`âœ… Service ${t} removed from your subscriptions (was already cancelled on server)`);else throw n}p(n=>{const l=n.filter(k=>String(k.id)!==t);return console.log("ðŸ“ Updated items count:",l.length),l}),console.log("ï¿½ï¸ Clearing subscription from local cache...");try{const n=`sl_subscriptions_cache_v1:${((g=u.currentUser)==null?void 0:g.uid)||((m=u.currentUser)==null?void 0:m.email)}`,l=localStorage.getItem(n);if(l){const E=JSON.parse(l).filter($=>String($.serviceId)!==t);localStorage.setItem(n,JSON.stringify(E)),console.log("ðŸ—‘ï¸ Removed subscription from cache, remaining:",E.length)}}catch(n){console.log("âš ï¸ Failed to update cache:",n)}console.log("âœ… Unsubscribe completed - skipping refresh to prevent reappearing")}catch(r){console.error("âŒ Failed to unsubscribe:",r),console.error("âŒ Error response:",r==null?void 0:r.response),console.error("âŒ Error data:",(d=r==null?void 0:r.response)==null?void 0:d.data),console.error("âŒ Error status:",(i=r==null?void 0:r.response)==null?void 0:i.status);const f=((M=(R=r==null?void 0:r.response)==null?void 0:R.data)==null?void 0:M.message)||(r==null?void 0:r.message)||"Failed to unsubscribe";alert(`âŒ Unsubscribe failed for service ${t}: ${f}`)}finally{I(r=>({...r,[t]:!1})),console.log("ðŸ Unsubscribe process completed for service:",t)}}return e.jsxs(T,{children:[e.jsx(_,{title:"My Subscriptions"}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header border-bottom py-16 px-24 d-flex align-items-center justify-content-between gap-3 flex-wrap",children:[e.jsx("h6",{className:"mb-0",children:"Active Subscriptions"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>h({silent:!0}),disabled:y||U,children:U?"Refreshingâ€¦":"Refresh"})]}),e.jsxs("div",{className:"card-body",children:[j&&e.jsx("div",{className:"alert alert-danger",children:j}),y?e.jsx("div",{children:"Loadingâ€¦"}):e.jsxs("div",{className:"row g-3",children:[S.length===0&&e.jsx("div",{className:"col-12 text-secondary",children:"No subscriptions yet."}),S.map(s=>e.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:e.jsxs("div",{className:"card h-100",children:[e.jsx("img",{src:s.imageUrl||"/assets/images/services/placeholder.png",className:"card-img-top",alt:s.title||"Listing",style:{maxHeight:160,objectFit:"cover"}}),e.jsxs("div",{className:"card-body d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsx("h6",{className:"card-title mb-1",children:s.title||"Listing"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",title:"Notifications (soon)",disabled:!0,children:e.jsx("i",{className:"ri-notification-3-line"})})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[s.category||"General"," Â· ",s.vendor||""]}),s.description&&e.jsxs("p",{className:"flex-grow-1 text-secondary small",children:[s.description.slice(0,140),s.description.length>140?"â€¦":""]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-auto",children:[e.jsxs("strong",{children:["R ",Number(s.price||0).toLocaleString()]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("span",{className:"badge bg-neutral-200 text-neutral-900",children:["â˜… ",Number(s.rating||0).toFixed(1)]}),e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>P(s.id),disabled:!!w[String(s.id)],children:w[String(s.id)]?"Removingâ€¦":"Unsubscribe"})]})]})]})]})},String(s.id)))]})]})]})]})}export{q as default};
