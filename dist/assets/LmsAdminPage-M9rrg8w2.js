import{r as m,c as k,j as e}from"./index-DGewQ82u.js";const W="lms_admin_draft_v1",E="lms_admin_undo_v1",K="lms_admin_history_cache_v1",S="/api/lms";function T(t){try{return typeof t=="string"?JSON.parse(t):t}catch{return null}}function y(t){return JSON.parse(JSON.stringify(t))}function me(t){return new Date(t).toLocaleString()}function xe(t){var a,x;const i=Array.isArray(t==null?void 0:t.cohorts)?t.cohorts.length:0,r=((a=t==null?void 0:t.cohorts)==null?void 0:a.reduce((f,c)=>f+(Array.isArray(c.courses)?c.courses.length:0),0))??0,h=((x=t==null?void 0:t.cohorts)==null?void 0:x.reduce((f,c)=>f+(Array.isArray(c.courses)?c.courses.reduce((p,b)=>p+(Array.isArray(b.lessons)?b.lessons.length:0),0):0),0))??0;return{cohorts:i,courses:r,lessons:h}}function ye(){var B,F;const t=m.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[i,r]=m.useState(()=>T(localStorage.getItem(W))??{cohorts:[],bookings:[],events:[],forumThreads:[],jobs:[],mentorshipSessions:[],messageThreads:[],services:[],leads:[],startups:[]}),[h,a]=m.useState(()=>JSON.stringify(i,null,2)),[x,f]=m.useState("visual"),[c,p]=m.useState(!1),[b,w]=m.useState(null),[_,C]=m.useState(null),I=m.useRef([]),[M,H]=m.useState(()=>T(localStorage.getItem(K))??[]),L=m.useMemo(()=>Array.isArray(i==null?void 0:i.cohorts)?i.cohorts:[],[i]),[J,A]=m.useState(((B=L[0])==null?void 0:B.id)??""),l=m.useMemo(()=>L.find(s=>s.id===J),[L,J]),[$,U]=m.useState(""),[u,P]=m.useState(null),v=m.useMemo(()=>{var s;return(s=l==null?void 0:l.courses)==null?void 0:s.find(n=>n.id===u)},[l,u]);function Y(s){const n=T(localStorage.getItem(E))??[];n.unshift(s);const o=n.slice(0,10);localStorage.setItem(E,JSON.stringify(o)),I.current=o}function g(s){Y(i),r(s),a(JSON.stringify(s,null,2)),localStorage.setItem(W,JSON.stringify(s))}function q(){const s=I.current.length?I.current:T(localStorage.getItem(E))??[];if(!s.length)return;const n=s.shift();I.current=s,localStorage.setItem(E,JSON.stringify(s)),r(n),a(JSON.stringify(n,null,2))}function O(s){w(s),setTimeout(()=>w(null),2500)}m.useEffect(()=>{(async()=>{var s,n;try{p(!0);const{data:o}=await k.get(`${S}/live`,{headers:{"x-tenant-id":t,"cache-control":"no-cache"}});o&&(r(o),a(JSON.stringify(o,null,2)),localStorage.setItem(W,JSON.stringify(o)),A(((n=(s=o==null?void 0:o.cohorts)==null?void 0:s[0])==null?void 0:n.id)??"")),await R()}catch(o){console.warn("Init load failed:",o)}finally{p(!1)}})()},[]);async function R(){try{const{data:s}=await k.get(`${S}/checkpoints`,{headers:{"x-tenant-id":t,"cache-control":"no-cache"}}),n=Array.isArray(s==null?void 0:s.items)?s.items:[];H(n),localStorage.setItem(K,JSON.stringify(n.slice(0,2)))}catch{}}async function G(s){var o;const n=(o=s.target.files)==null?void 0:o[0];if(n)try{const d=await n.text(),j=JSON.parse(d);g(j),O("Imported JSON into working copy")}catch{C("Invalid JSON file")}finally{s.target.value=""}}function Q(){const s=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),o=document.createElement("a");o.download=`lms-working-copy-${Date.now()}.json`,o.href=n,o.click(),URL.revokeObjectURL(n)}async function X(){C(null),p(!0);try{await k.put(`${S}/publish`,{data:i},{headers:{"Content-Type":"application/json","x-tenant-id":t}}),O("Published to live"),await R()}catch(s){C(s.message||"Publish failed")}finally{p(!1)}}async function Z(s){C(null);try{await k.post(`${S}/checkpoints`,{message:s||"",data:i},{headers:{"Content-Type":"application/json","x-tenant-id":t}}),O("Checkpoint saved"),await R()}catch(n){C(n.message||"Failed to save checkpoint")}}async function ee(s){if(window.confirm("Restore this snapshot to LIVE? This will overwrite appData.json."))try{await k.post(`${S}/restore/${s}`,null,{headers:{"x-tenant-id":t}}),O("Restored and published"),await R();try{const{data:n}=await k.get(`${S}/live`,{headers:{"x-tenant-id":t,"cache-control":"no-cache"}});n&&g(n)}catch{}}catch(n){C(n.message||"Restore failed")}}async function se(){if(window.confirm("Clear ALL checkpoints on the server?"))try{await k.delete(`${S}/checkpoints`,{headers:{"x-tenant-id":t}}),O("Cleared history"),await R()}catch(s){C(s.message||"Failed to clear")}}function te(){const s=prompt("Cohort name?");if(!s)return;const n=s.toLowerCase().replace(/\s+/g,"-"),o=y(i);o.cohorts=o.cohorts||[],o.cohorts.push({id:n,name:s,courses:[]}),g(o),A(n)}function ne(){if(!l)return;const s=prompt("New cohort name:",l.name||"");if(!s)return;const n=y(i),o=n.cohorts.find(d=>d.id===l.id);o.name=s,g(n)}function oe(){var n;if(!l||!window.confirm(`Delete cohort "${l.name}"?`))return;const s=y(i);s.cohorts=s.cohorts.filter(o=>o.id!==l.id),g(s),A(((n=s.cohorts[0])==null?void 0:n.id)??""),P(null)}function ie(){var j;if(!l)return;const s=prompt("Course title?");if(!s)return;const n=(((j=l.courses)==null?void 0:j.length)||0)+1+"",o=y(i),d=o.cohorts.find(N=>N.id===l.id);d.courses=d.courses||[],d.courses.push({id:n,title:s,description:"",videoThumbnail:"",aiHint:"",lessons:[]}),g(o)}function le(){if(!v||!l)return;const s=y(i),n=s.cohorts.find(d=>d.id===l.id),o=y(v);o.id=(n.courses.length+1).toString(),o.title=o.title+" (Copy)",n.courses.push(o),g(s)}function ce(){if(!v||!l||!window.confirm(`Delete "${v.title}"?`))return;const s=y(i),n=s.cohorts.find(o=>o.id===l.id);n.courses=n.courses.filter(o=>o.id!==v.id),g(s),P(null)}function re(s,n){const o=y(i),j=o.cohorts.find(N=>N.id===l.id).courses.find(N=>N.id===v.id);j[s]=n,g(o)}function ae(){if(!v)return;const s=prompt("Lesson title?");if(!s)return;const n=y(i),d=n.cohorts.find(N=>N.id===l.id).courses.find(N=>N.id===v.id);d.lessons=d.lessons||[];const j=d.lessons.length+1;d.lessons.push({id:`${d.id}-${String.fromCharCode(96+j)}`,title:s,duration:"15 min",completed:!1}),g(n)}function de(s,n){const o=y(i),j=o.cohorts.find(N=>N.id===l.id).courses.find(N=>N.id===v.id);j.lessons[s]={...j.lessons[s],...n},g(o)}function he(s){if(!v)return;const n=y(i);n.cohorts.find(j=>j.id===l.id).courses.find(j=>j.id===v.id).lessons.splice(s,1),g(n)}const V=xe(i),ue=((F=l==null?void 0:l.courses)==null?void 0:F.filter(s=>s.title.toLowerCase().includes($.toLowerCase())))??[];return e.jsxs("div",{className:"container py-4",children:[e.jsx("style",{children:`
        .history-item{ padding: .75rem 1rem; }
        .item-actions{ opacity: 0; transition: opacity .15s ease; }
        .history-item:hover .item-actions{ opacity: 1; }
        .pill{ padding:.25rem .5rem; border-radius:9999px; font-weight:600; font-size:.75rem; }
        .pill-low{ background:#fde2e0; color:#b42318; }     /* red-ish */
        .pill-med{ background:#eadcfb; color:#5925dc; }    /* purple-ish */
        .pill-high{ background:#d1fadf; color:#067647; }   /* green-ish */
        .pill-none{ background:#e9ecef; color:#495057; }
        .icon{ width:20px; height:20px; margin-right:.5rem; opacity:.8 }
        .btn-icon{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; }
      `}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("h1",{className:"display-6 mb-0",children:"LMS Admin"}),e.jsxs("div",{className:"text-muted small",children:["Cohorts: ",V.cohorts," Â· Courses: ",V.courses," Â· Lessons: ",V.lessons]})]}),e.jsxs("p",{className:"text-secondary",children:["Manage cohorts, courses and lessons. Draft persists in ",e.jsx("code",{children:"localStorage"}),". Checkpoints live on the server (with a 2-item offline cache)."]}),e.jsxs("div",{className:"d-flex gap-2 mb-3",children:[e.jsxs("label",{className:"btn btn-light mb-0",children:["Import JSON",e.jsx("input",{type:"file",accept:"application/json",hidden:!0,onChange:G})]}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:Q,children:"Export Current"}),e.jsx("button",{className:"btn btn-success",onClick:X,disabled:c,title:"Write working copy to live appData.json on the server",children:c?"Publishingâ€¦":"Publish to live"})]}),b&&e.jsx("div",{className:"alert alert-success py-2",children:b}),_&&e.jsx("div",{className:"alert alert-danger py-2",children:_}),e.jsx(fe,{onSave:Z,onClear:se,onUndo:q,disabled:c}),e.jsxs("div",{className:"d-flex gap-3",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("ul",{className:"nav nav-tabs mb-3",children:[e.jsx("li",{className:"nav-item",children:e.jsx("button",{className:`nav-link ${x==="visual"?"active":""}`,onClick:()=>f("visual"),children:"Visual editor"})}),e.jsx("li",{className:"nav-item",children:e.jsx("button",{className:`nav-link ${x==="json"?"active":""}`,onClick:()=>f("json"),children:"JSON editor"})})]}),x==="json"?e.jsx(je,{text:h,setText:a,onApply:()=>{const s=T(h);if(!s){C("Invalid JSON");return}g(s),O("Applied JSON to working copy")}}):e.jsx(pe,{data:i,cohortId:J,setCohortId:A,currentCohort:l,courseSearch:$,setCourseSearch:U,filteredCourses:ue,selectedCourseId:u,setSelectedCourseId:P,selectedCourse:v,addCohort:te,renameCohort:ne,deleteCohort:oe,addCourse:ie,duplicateCourse:le,deleteCourse:ce,updateCourseField:re,addLesson:ae,updateLesson:de,deleteLesson:he})]}),e.jsx("div",{style:{width:420},children:e.jsx(ge,{items:M,onRestore:ee})})]})]})}function fe({onSave:t,onClear:i,onUndo:r,disabled:h}){const[a,x]=m.useState("");return e.jsx("div",{className:"card mb-3",children:e.jsxs("div",{className:"card-body d-flex align-items-center gap-2 py-2",children:[e.jsx(z,{className:"icon"}),e.jsx("input",{className:"form-control",placeholder:"Checkpoint message (e.g. 'Added AWS serverless module')",value:a,onChange:f=>x(f.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:()=>t(a),disabled:h,title:"Save checkpoint",children:"Save"}),e.jsx("button",{className:"btn btn-outline-secondary btn-icon",onClick:r,title:"Undo",children:"â†¶"}),e.jsx("button",{className:"btn btn-outline-danger btn-icon",onClick:i,title:"Clear history",children:"ðŸ—‘"})]})})}function je({text:t,setText:i,onApply:r}){return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header fw-semibold",children:"Working copy (JSON)"}),e.jsxs("div",{className:"card-body",children:[e.jsx("textarea",{value:t,onChange:h=>i(h.target.value),rows:22,spellCheck:!1,className:"form-control font-monospace"}),e.jsxs("div",{className:"d-flex justify-content-between mt-2",children:[e.jsxs("small",{className:"text-muted",children:["Tip: Press ",e.jsx("kbd",{children:"âŒ˜/Ctrl"}),"+",e.jsx("kbd",{children:"A"})," then ",e.jsx("kbd",{children:"âŒ˜/Ctrl"}),"+",e.jsx("kbd",{children:"C"})," to copy."]}),e.jsx("button",{className:"btn btn-outline-primary",onClick:r,children:"Apply JSON"})]})]})]})}function pe(t){const{data:i,cohortId:r,setCohortId:h,currentCohort:a,courseSearch:x,setCourseSearch:f,filteredCourses:c,selectedCourseId:p,setSelectedCourseId:b,selectedCourse:w,addCohort:_,renameCohort:C,deleteCohort:I,addCourse:M,duplicateCourse:H,deleteCourse:L,updateCourseField:J,addLesson:A,updateLesson:l,deleteLesson:$}=t,U=(i==null?void 0:i.cohorts)??[];return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between",children:[e.jsx("span",{className:"fw-semibold",children:"Visual editor"}),e.jsx("span",{className:"text-muted small",children:"Friendly CRUD for cohorts, courses & lessons"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-3",children:[e.jsx("label",{className:"fw-medium me-2",children:"Cohort"}),e.jsx("select",{className:"form-select",style:{maxWidth:320},value:r,onChange:u=>h(u.target.value),children:U.map(u=>e.jsx("option",{value:u.id,children:u.name||u.id},u.id))}),e.jsx("button",{className:"btn btn-outline-primary",onClick:_,children:"+ Add cohort"}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:C,disabled:!a,children:"Rename"}),e.jsx("button",{className:"btn btn-outline-danger",onClick:I,disabled:!a,children:"Delete"})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-4",children:[e.jsx("label",{className:"fw-medium",children:"Courses"}),e.jsx("input",{className:"form-control mb-2",placeholder:"Search",value:x,onChange:u=>f(u.target.value)}),e.jsxs("div",{className:"list-group mb-2",style:{maxHeight:360,overflow:"auto"},children:[c.map(u=>e.jsx("button",{className:"list-group-item list-group-item-action "+(p===u.id?"active":""),onClick:()=>b(u.id),children:u.title},u.id)),!c.length&&e.jsx("div",{className:"text-muted small p-2",children:"No courses."})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-outline-primary",onClick:M,disabled:!a,children:"+ Add course"}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:H,disabled:!w,children:"Duplicate"}),e.jsx("button",{className:"btn btn-outline-danger",onClick:L,disabled:!w,children:"Delete"})]})]}),e.jsx("div",{className:"col",children:w?e.jsx(be,{course:w,updateCourseField:J,addLesson:A,updateLesson:l,deleteLesson:$}):e.jsx("div",{className:"text-muted mt-2",children:"Select a course to edit details and lessons."})})]})]})]})}function be({course:t,updateCourseField:i,addLesson:r,updateLesson:h,deleteLesson:a}){var x,f;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Title"}),e.jsx("input",{className:"form-control",value:t.title||"",onChange:c=>i("title",c.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-control",rows:3,value:t.description||"",onChange:c=>i("description",c.target.value)})]}),e.jsxs("div",{className:"row g-3 mb-3",children:[e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"Video thumbnail URL"}),e.jsx("input",{className:"form-control",value:t.videoThumbnail||"",onChange:c=>i("videoThumbnail",c.target.value)})]}),e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"AI hint (optional)"}),e.jsx("input",{className:"form-control",value:t.aiHint||"",onChange:c=>i("aiHint",c.target.value)})]})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-2",children:"Lessons"}),e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:r,children:"+ Add lesson"})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:80},children:"ID"}),e.jsx("th",{children:"Title"}),e.jsx("th",{style:{width:120},children:"Duration"}),e.jsx("th",{style:{width:100},children:"Completed"}),e.jsx("th",{style:{width:70}})]})}),e.jsxs("tbody",{children:[(x=t.lessons)==null?void 0:x.map((c,p)=>e.jsxs("tr",{children:[e.jsx("td",{children:c.id}),e.jsx("td",{children:e.jsx("input",{className:"form-control form-control-sm",value:c.title||"",onChange:b=>h(p,{title:b.target.value})})}),e.jsx("td",{children:e.jsx("input",{className:"form-control form-control-sm",value:c.duration||"",onChange:b=>h(p,{duration:b.target.value})})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",className:"form-check-input",checked:!!c.completed,onChange:b=>h(p,{completed:!!b.target.checked})})}),e.jsx("td",{className:"text-end",children:e.jsx("button",{className:"btn btn-outline-danger btn-sm",onClick:()=>a(p),children:"Delete"})})]},c.id||p)),!((f=t.lessons)!=null&&f.length)&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-muted small",children:"No lessons yet."})})]})]})})]})}function ge({items:t,onRestore:i}){return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header fw-semibold d-flex justify-content-between",children:[e.jsx("span",{children:"Version history"}),e.jsx("span",{className:"text-muted small",children:"Showing latest checkpoints"})]}),t!=null&&t.length?e.jsx("div",{className:"list-group list-group-flush",children:t.map(r=>{var a,x,f;const h=Ne(r.delta);return e.jsx("div",{className:"list-group-item history-item",children:e.jsxs("div",{className:"d-flex align-items-start justify-content-between gap-3",children:[e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx(z,{className:"icon"}),e.jsxs("div",{className:"text-truncate",style:{maxWidth:220},children:[e.jsx("div",{className:"fw-semibold text-truncate",children:r.message||"(no message)"}),e.jsx("div",{className:"text-muted small",children:me(r.ts)}),e.jsxs("div",{className:"text-muted small",children:["Î” Cohorts: ",D((a=r.delta)==null?void 0:a.cohorts)," Â· Î” Courses: ",D((x=r.delta)==null?void 0:x.courses)," Â· Î” Lessons: ",D((f=r.delta)==null?void 0:f.lessons)]})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:`pill ${h.className}`,children:h.label}),e.jsxs("div",{className:"item-actions",children:[e.jsx("button",{className:"btn btn-outline-primary btn-sm",title:"Restore snapshot to LIVE",onClick:()=>i(r.id),children:"Restore"}),e.jsx("a",{className:"btn btn-outline-secondary btn-sm ms-1",title:"Download snapshot JSON",href:`${S}/checkpoints/${r.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]})]})]})},r.id)})}):e.jsx("div",{className:"list-group list-group-flush",children:e.jsxs("div",{className:"list-group-item text-muted small",children:["No checkpoints yet.",e.jsx("div",{className:"mt-1",children:"Offline cache keeps the two most recent checkpoints."})]})})]})}function D(t){const i=Number(t||0);return(i>=0?"+":"")+i}function Ne(t){const i=Math.abs((t==null?void 0:t.cohorts)||0)+Math.abs((t==null?void 0:t.courses)||0)+Math.abs((t==null?void 0:t.lessons)||0);return i===0?{label:"No change",className:"pill-none"}:i<=2?{label:"Low",className:"pill-low"}:i<=5?{label:"Medium",className:"pill-med"}:{label:"High",className:"pill-high"}}function z({className:t}){return e.jsxs("svg",{className:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeWidth:"1.6"}),e.jsx("path",{d:"M12 7v5l3 2",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})]})}export{ye as default};
