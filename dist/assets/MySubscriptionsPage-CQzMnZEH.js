import{e as F,b as p,a as d,i as U,j as s,M as R,k as E}from"./index-Bn5LcKgl.js";import{B as M}from"./Breadcrumb-B3g6Xnkc.js";import{r as a}from"./vendor-DW3XjTa1.js";import"./firebase-BBiW2ZCr.js";import"./utils-B2rxisVD.js";function D(){const[m,f]=a.useState(!0),[h,u]=a.useState([]),[v,y]=a.useState(""),[x,S]=a.useState({}),[j,N]=a.useState(!1),w=a.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),{appData:b}=F(),I=a.useCallback(async()=>{try{console.log("🔗 Testing API connection..."),console.log("🔗 Current API base URL:",p.defaults.baseURL);const e=await p.get("/api/health");if(console.log("✅ API health check passed:",e.data),d.currentUser){console.log("🔐 Testing authenticated endpoint...");const t=await p.get("/api/subscriptions/my");console.log("✅ Subscriptions endpoint test:",t.data)}}catch(e){console.error("❌ API connection test failed:",e),console.error("❌ Error details:",e?.response?.data)}},[]);a.useEffect(()=>{I()},[I]);const g=a.useCallback(async(e={})=>{const{silent:t,signal:r}=e;t?N(!0):f(!0),y("");try{if(!d.currentUser){console.log("🔐 No authenticated user found"),r?.aborted||u([]);return}console.log("📡 Fetching subscriptions for user:",d.currentUser.email);const n=await U();console.log("📋 Raw subscriptions from API:",n);const o=new Set(n.filter(i=>(i.type||"service")==="service").map(i=>String(i.serviceId)));console.log("🔍 Service IDs from subscriptions:",Array.from(o));const c=Array.isArray(b?.services)?b.services:[];console.log("📦 Available services in appData:",c.length);const l=c.filter(i=>o.has(String(i.id)));console.log("✅ Matched services:",l.length,l.map(i=>({id:i.id,title:i.title}))),r?.aborted||u(l)}catch(n){console.error("❌ Failed to load subscriptions:",n),r?.aborted||y(n?.message||"Failed to load subscriptions")}finally{r?.aborted||(t?N(!1):f(!1))}},[b]);a.useEffect(()=>{const e=new AbortController;return g({silent:!1,signal:e.signal}),()=>{e.abort()}},[g,w]);async function A(e){const t=String(e);console.log("🔄 Starting unsubscribe process for service:",t),console.log("🔄 Current user:",d.currentUser?.email),console.log("🔄 Current tenant:",w),S(r=>({...r,[t]:!0}));try{console.log("🔍 Fetching current subscriptions before unsubscribe...");const r=await U();console.log("📋 Current subscriptions:",r);const n=r.find(o=>String(o.serviceId)===t);if(console.log("🎯 Target subscription to cancel:",n),!n){console.log("⚠️ No subscription found in cache for service:",t),u(o=>o.filter(c=>String(c.id)!==t)),alert(`✅ Service ${t} removed from your subscriptions (was already cancelled)`);return}console.log("📡 Calling unsubscribeFromService API...");try{const o=await E(t);console.log("✅ Unsubscribe API success:",o),alert(`✅ Successfully unsubscribed from service ${t}`)}catch(o){if(o?.response?.status===404)console.log("⚠️ Backend says subscription not found (404) - treating as already cancelled"),alert(`✅ Service ${t} removed from your subscriptions (was already cancelled on server)`);else throw o}u(o=>{const c=o.filter(l=>String(l.id)!==t);return console.log("📝 Updated items count:",c.length),c}),console.log("�️ Clearing subscription from local cache...");try{const o=`sl_subscriptions_cache_v1:${d.currentUser?.uid||d.currentUser?.email}`,c=localStorage.getItem(o);if(c){const i=JSON.parse(c).filter(C=>String(C.serviceId)!==t);localStorage.setItem(o,JSON.stringify(i)),console.log("🗑️ Removed subscription from cache, remaining:",i.length)}}catch(o){console.log("⚠️ Failed to update cache:",o)}console.log("✅ Unsubscribe completed - skipping refresh to prevent reappearing")}catch(r){console.error("❌ Failed to unsubscribe:",r),console.error("❌ Error response:",r?.response),console.error("❌ Error data:",r?.response?.data),console.error("❌ Error status:",r?.response?.status);const n=r?.response?.data?.message||r?.message||"Failed to unsubscribe";alert(`❌ Unsubscribe failed for service ${t}: ${n}`)}finally{S(r=>({...r,[t]:!1})),console.log("🏁 Unsubscribe process completed for service:",t)}}return s.jsxs(R,{children:[s.jsx(M,{title:"My Subscriptions"}),s.jsxs("div",{className:"card",children:[s.jsxs("div",{className:"card-header border-bottom py-16 px-24 d-flex align-items-center justify-content-between gap-3 flex-wrap",children:[s.jsx("h6",{className:"mb-0",children:"Active Subscriptions"}),s.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>g({silent:!0}),disabled:m||j,children:j?"Refreshing…":"Refresh"})]}),s.jsxs("div",{className:"card-body",children:[v&&s.jsx("div",{className:"alert alert-danger",children:v}),m?s.jsx("div",{children:"Loading…"}):s.jsxs("div",{className:"row g-3",children:[h.length===0&&s.jsx("div",{className:"col-12 text-secondary",children:"No subscriptions yet."}),h.map(e=>s.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:s.jsxs("div",{className:"card h-100",children:[s.jsx("img",{src:e.imageUrl||"/assets/images/services/placeholder.png",className:"card-img-top",alt:e.title||"Listing",style:{maxHeight:160,objectFit:"cover"}}),s.jsxs("div",{className:"card-body d-flex flex-column",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[s.jsx("h6",{className:"card-title mb-1",children:e.title||"Listing"}),s.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",title:"Notifications (soon)",disabled:!0,children:s.jsx("i",{className:"ri-notification-3-line"})})]}),s.jsxs("div",{className:"text-muted small mb-2",children:[e.category||"General"," · ",e.vendor||""]}),e.description&&s.jsxs("p",{className:"flex-grow-1 text-secondary small",children:[e.description.slice(0,140),e.description.length>140?"…":""]}),s.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-auto",children:[s.jsxs("strong",{children:["R ",Number(e.price||0).toLocaleString()]}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsxs("span",{className:"badge bg-neutral-200 text-neutral-900",children:["★ ",Number(e.rating||0).toFixed(1)]}),s.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>A(e.id),disabled:!!x[String(e.id)],children:x[String(e.id)]?"Removing…":"Unsubscribe"})]})]})]})]})},String(e.id)))]})]})]})]})}export{D as default};
