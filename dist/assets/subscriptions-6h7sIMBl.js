import{b as u,d as h}from"./index-C_y_1zWD.js";const v="sl_subscriptions_cache_v1";function p(e){if(!e||typeof e!="object")return"";const t=(e.type||"service").toString(),r=(e.email||"").toLowerCase(),n=e.serviceId!=null?String(e.serviceId):"";return`${t}::${r}::${n}`}function m(e){return[...e].sort((t,r)=>{const n=Date.parse(t?.createdAt||"")||0;return(Date.parse(r?.createdAt||"")||0)-n})}function b(e,t){if(!t?.length)return e;const r=new Map;return e.forEach(n=>{const i=p(n);i&&r.set(i,n)}),t.forEach(n=>{const i=p(n);!i||r.has(i)||r.set(i,n)}),Array.from(r.values())}function I(e){if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function f(){if(typeof window>"u")return null;try{const e=h.currentUser,t=(e?.email||window.sessionStorage.getItem("userEmail")||"").toLowerCase(),r=e?.uid||window.sessionStorage.getItem("userId")||"";return!t&&!r?null:`${v}:${r||t}`}catch{return null}}function d(e){if(!e||typeof window>"u")return[];try{return I(window.localStorage.getItem(e))}catch{return[]}}function l(e,t){if(!(!e||typeof window>"u"))try{window.localStorage.setItem(e,JSON.stringify(t))}catch{}}function C(e){if(!(!e||typeof window>"u"))try{window.localStorage.removeItem(e)}catch{}}function w(e){if(!e||typeof e!="object")return null;const t={...e};return t.type=(t.type||"service").toString(),t.email&&(t.email=t.email.toLowerCase()),t.serviceId=t.serviceId!=null?String(t.serviceId):t.serviceId,t.tenantId=(t.tenantId||"public").toString(),t}function A(e,t){const r=w(t);if(!e||!r)return;const n=d(e),i=(r.email||"").toLowerCase(),c=String(r.serviceId||""),s=r.type||"service",o=n.findIndex(a=>{const S=(a.email||"").toLowerCase(),y=String(a.serviceId||""),g=a.type||"service";return S===i&&y===c&&g===s});o>=0?n[o]={...n[o],...r,canceledAt:void 0}:n.push(r),l(e,n)}function L(e,t){if(!e)return;const r=String(t||""),n=d(e).filter(i=>String(i.serviceId||"")!==r);l(e,n)}async function E(){const e=f(),t=d(e);try{const{data:r}=await u.get("/api/subscriptions/my"),i=(Array.isArray(r)?r:[]).map(w).filter(Boolean),c=b(i,t),s=m(c);return e&&l(e,s),s}catch(r){const n=r?.response?.status;return n===401||n===403||n===404?(C(e),[]):t.length?m(t):[]}}async function _(e,t={}){const r={serviceId:e,...t},{data:n}=await u.post("/api/subscriptions/service",r),i=f();return A(i,n||{serviceId:e,...t,type:"service"}),n}async function $(e){await u.put("/api/subscriptions/service/cancel",{serviceId:e});const t=f();return L(t,e),!0}export{E as f,_ as s,$ as u};
