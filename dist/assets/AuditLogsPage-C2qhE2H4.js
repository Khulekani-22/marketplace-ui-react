import{r as n,b as k,D as U,j as e}from"./index-7-v0jUWh.js";import{M as V}from"./MasterLayout-SmJzx4r8.js";import{B}from"./Breadcrumb-BBtNR4li.js";import"./iconify-BSamAZK7.js";function M(){const[v,L]=n.useState([]),[i,b]=n.useState(!0),[x,y]=n.useState(!1),[N,S]=n.useState(""),[r,w]=n.useState(""),[g,E]=n.useState(""),[p,C]=n.useState(""),[o,T]=n.useState(""),[c,A]=n.useState(""),[j,F]=n.useState(()=>sessionStorage.getItem("tenantId")||"vendor"),[D,I]=n.useState([{id:"vendor",name:"Vendor"}]);n.useEffect(()=>{let t=!0;return(async()=>{try{const{data:s}=await k.get("/api/tenants"),l=Array.isArray(s)?s:[],u=[{id:"vendor",name:"Vendor"},...l.map(a=>typeof a=="string"?{id:a,name:a}:{id:a==null?void 0:a.id,name:(a==null?void 0:a.name)||(a==null?void 0:a.id)}).map(a=>a.id==="public"?{...a,id:"vendor",name:a.name||"Vendor"}:a)].filter(a=>a&&a.id),d=Object.values(u.reduce((a,h)=>(a[h.id]=h,a),{}));t&&I(d)}catch{t&&I([{id:"vendor",name:"Vendor"}])}})(),()=>{t=!1}},[]);const f=n.useCallback(async({silent:t}={})=>{t?y(!0):b(!0),S("");try{const s=await U({search:r.trim(),userEmail:g.trim()||void 0,action:p.trim()||void 0,dateFrom:o?new Date(o):void 0,dateTo:c?new Date(c):void 0,limit:250,tenantId:j});L(s)}catch(s){S((s==null?void 0:s.message)||"Failed to load audit logs")}finally{t?y(!1):b(!1)}},[p,o,c,r,j,g]);n.useEffect(()=>{f({silent:!1}).catch(()=>{})},[]);const m=n.useMemo(()=>{const t=r.trim().toLowerCase();return v.filter(s=>t?[s.userEmail,s.action,s.targetType,s.targetId,s.ip].filter(Boolean).some(l=>String(l).toLowerCase().includes(t)):!0)},[v,r]);function R(){const s=[["timestamp","userEmail","userId","action","targetType","targetId","ip","tenantId"].join(",")];m.forEach(a=>{const h=[a.timestamp?new Date(a.timestamp).toISOString():"",a.userEmail||"",a.userId||"",a.action||"",a.targetType||"",a.targetId||"",a.ip||"",a.tenantId||""];s.push(h.map(O=>`"${String(O).replaceAll('"','""')}"`).join(","))});const l=new Blob(["\uFEFF"+s.join(`
`)],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(l),d=document.createElement("a");d.href=u,d.download=`audit-logs-${new Date().toISOString().slice(0,10)}.csv`,d.click(),URL.revokeObjectURL(u)}return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-wrap gap-2 align-items-end mb-3",children:[e.jsxs("div",{className:"me-auto",children:[e.jsx("h5",{className:"mb-0",children:"Audit Logs"}),e.jsx("small",{className:"text-secondary",children:"Centralized user activity across tenants"})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx("select",{className:"form-select",value:j,onChange:t=>F(t.target.value),title:"Tenant scope",children:D.map(t=>e.jsx("option",{value:t.id,children:t.name||t.id},t.id))}),e.jsx("input",{className:"form-control",placeholder:"Search email, action, target",value:r,onChange:t=>w(t.target.value)}),e.jsx("input",{className:"form-control",placeholder:"Filter by user email",value:g,onChange:t=>E(t.target.value)}),e.jsx("input",{className:"form-control",placeholder:"Filter by action (e.g., LOGIN, CREATE)",value:p,onChange:t=>C(t.target.value)}),e.jsx("input",{type:"date",className:"form-control",value:o,onChange:t=>T(t.target.value),"aria-label":"From date"}),e.jsx("input",{type:"date",className:"form-control",value:c,onChange:t=>A(t.target.value),"aria-label":"To date"}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>f({silent:!1}),disabled:i||x,children:i?"Loading…":"Apply"}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:()=>f({silent:!0}),disabled:i||x,children:x?"Refreshing…":"Refresh"}),e.jsx("button",{className:"btn btn-outline-primary",onClick:R,disabled:!m.length,children:"Export CSV"})]})]}),N&&e.jsx("div",{className:"alert alert-danger",role:"alert",children:N}),!i&&!m.length?e.jsx("div",{className:"text-center text-secondary py-5",children:"No audit events found."}):null,e.jsx("div",{className:"table-responsive border rounded",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{minWidth:160},children:"Timestamp"}),e.jsx("th",{children:"User"}),e.jsx("th",{children:"Action"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"IP"}),e.jsx("th",{children:"Tenant"})]})}),e.jsxs("tbody",{children:[m.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.timestamp?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fw-semibold",children:new Date(t.timestamp).toLocaleString()}),e.jsx("div",{className:"text-secondary small",children:new Date(t.timestamp).toISOString()})]}):e.jsx("span",{className:"text-secondary",children:"—"})}),e.jsxs("td",{children:[e.jsx("div",{className:"fw-semibold",children:t.userEmail||t.userId||"—"}),t.userId&&e.jsx("div",{className:"text-secondary small",children:t.userId})]}),e.jsx("td",{children:e.jsx("span",{className:"badge text-bg-secondary",children:t.action||"—"})}),e.jsx("td",{children:t.targetType||t.targetId?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fw-semibold",children:t.targetType||"—"}),t.targetId&&e.jsx("div",{className:"text-secondary small",children:t.targetId})]}):e.jsx("span",{className:"text-secondary",children:"—"})}),e.jsx("td",{children:t.ip||"—"}),e.jsx("td",{children:t.tenantId||"vendor"})]},t.id)),i&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-secondary py-4",children:"Loading logs…"})})]})]})})]})})}const G=()=>e.jsxs(V,{children:[e.jsx(B,{title:"Audit Logs"}),e.jsx(M,{})]});export{G as default};
