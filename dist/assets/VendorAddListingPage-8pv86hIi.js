import{m as oe,f as ce,i as le,a as A,c as f,j as e,M as de}from"./index-D_DTgdmv.js";import{b as me,j as ue,r as c,L as Z}from"./vendor-DW3XjTa1.js";import"./firebase-ARhtPVQA.js";import"./utils-B2rxisVD.js";const E="/api/lms",M="__OTHER__";function re(){return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)}function ee(t){try{return typeof t=="string"?JSON.parse(t):t}catch{return null}}function ge(t,a){const l=(t||"public").toLowerCase(),S=(a||"").trim().toLowerCase();return S?`vendor_pending_listings:${l}:${S}`:null}function T(t){return{id:t?.id??re(),title:t?.title??"",category:t?.category??"",vendor:t?.vendor??"",vendorId:t?.vendorId??"",contactEmail:(t?.contactEmail||t?.email||"").toLowerCase(),ownerUid:t?.ownerUid??t?.ownerId??"",ownerEmail:(t?.ownerEmail||t?.contactEmail||t?.email||"").toLowerCase(),price:Number(t?.price||0),rating:Number(t?.rating||0),reviewCount:typeof t?.reviewCount=="number"?t.reviewCount:Number(t?.reviewCount||t?.reviews?.length||0),imageUrl:t?.imageUrl??"",aiHint:t?.aiHint??"",listingType:t?.listingType??"service",status:t?.status??"pending",isFeatured:!!t?.isFeatured,description:t?.description??"",reviews:Array.isArray(t?.reviews)?t.reviews:[],tags:Array.isArray(t?.tags)?t.tags:[],source:t?.source??"",clonedFrom:t?.clonedFrom??"",tenantId:t?.tenantId??"public",createdAt:t?.createdAt??t?.created_at??new Date().toISOString()}}function se(t,a={}){const l=(t?.email||t?.contactEmail||a.email||"").toLowerCase();return{id:String(t?.id??t?.vendorId??a.vendorId??""),vendorId:String(t?.vendorId??t?.id??a.vendorId??""),name:t?.name??t?.companyName??t?.vendor??a.name??"",contactEmail:l,ownerUid:t?.ownerUid??t?.uid??a.uid??"",status:(t?.status||"active").toLowerCase()}}function te(t,a){if(!t)return null;const l=(a?.email||"").toLowerCase(),S=[Array.isArray(t.startups)&&t.startups,Array.isArray(t.vendors)&&t.vendors,Array.isArray(t.companies)&&t.companies,Array.isArray(t.profiles)&&t.profiles].filter(Boolean);for(const R of S){const D=R.find(i=>i?.ownerUid&&i.ownerUid===a?.uid||i?.email&&i.email.toLowerCase()===l||i?.contactEmail&&i.contactEmail.toLowerCase()===l||a?.vendorId&&(String(i?.vendorId)===String(a.vendorId)||String(i?.id)===String(a.vendorId)));if(D)return se(D,a)}return null}function fe(){const t=me(),[a]=ue(),{vendor:l,ensureVendorId:S,refresh:R}=oe(),{syncNow:D}=ce(),i=c.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),F=le(sessionStorage.getItem("role")),[I,V]=c.useState({startups:[],vendors:[],companies:[],services:[]}),[_,Y]=c.useState(()=>F?[]:[]),ae=c.useMemo(()=>{const r=I?.services||[];return Array.from(new Set(r.map(v=>(v.category||"").trim()).filter(Boolean)))},[I]),[B,H]=c.useState(!1),[J,w]=c.useState(""),[q,z]=c.useState(""),U=c.useMemo(()=>{const r=a.get("prefill");return r?ee(decodeURIComponent(r)):null},[a]),[x,ie]=c.useState(null);c.useEffect(()=>{let r=!0;return(async()=>{await S();try{let v={startups:[],vendors:[],companies:[],services:[]};try{const{data:p}=await A.get(`${E}/live`,{headers:{"x-tenant-id":i,"cache-control":"no-cache"}});if(p){v=p;const y=a.get("from");if(y){const m=p?.services?.find(u=>String(u.id)===String(y));m&&ie(m)}}}catch{}try{const{data:p}=await A.get("/api/data/vendors"),y=Array.isArray(p)?p:[],m=JSON.parse(JSON.stringify(v));m.startups=Array.isArray(m.startups)?m.startups:[],y.forEach(u=>{const O=(u.email||u.contactEmail||"").toLowerCase(),h=String(u.vendorId||u.id||O||""),n=m.startups.findIndex(b=>String(b.vendorId||b.id)===h),g={...m.startups[n]||{},...u,vendorId:h,id:h};n>=0?m.startups[n]=g:m.startups.push(g)}),v=m}catch{}if(r&&V(v),F)try{const{data:p}=await A.get(`${E}/checkpoints`,{headers:{"x-tenant-id":i,"cache-control":"no-cache"}}),y=Array.isArray(p?.items)?p.items:[];r&&Y(y)}catch{r&&Y([])}}catch{}})(),()=>{r=!1}},[i,F]);const o=c.useMemo(()=>{const r={uid:f.currentUser?.uid,email:f.currentUser?.email||l?.email||"",name:f.currentUser?.displayName||l?.name||"",vendorId:l?.vendorId||""};return te(I,r)||se({},r)},[I,l?.vendorId,f.currentUser?.uid,f.currentUser?.email]);c.useEffect(()=>{!l?.vendorId&&o?.vendorId&&R?.()},[o?.vendorId]);const G=(o?.status||"").toLowerCase(),P=G==="active",k=G==="suspended",d=c.useMemo(()=>T(x||U||{}),[x,U]),[s,K]=c.useState({title:d.title||"",categoryChoice:d.category||"",categoryCustom:"",price:d.price?String(d.price):"",imageUrl:d.imageUrl||"",description:d.description||"",listingType:d.listingType||"service"});c.useEffect(()=>{K(r=>({...r,title:x?`${d.title} (Copy)`:d.title||r.title,categoryChoice:d.category||r.categoryChoice,price:d.price?String(d.price):r.price,imageUrl:d.imageUrl||r.imageUrl,description:d.description||r.description,listingType:d.listingType||r.listingType}))},[x?.id]);function N(r,v){K(p=>({...p,[r]:v}))}const W=s.categoryChoice===M?s.categoryCustom.trim():(s.categoryChoice||"").trim(),Q=(o?.contactEmail||"").toLowerCase()||(f.currentUser?.email||"").toLowerCase(),C=!o?.vendorId,j=C||k||!P;c.useEffect(()=>{if(f.currentUser&&(C||!P)){const r=encodeURIComponent(window.location.pathname+window.location.search);t(`/profile-vendor?next=${r}`)}},[C,P]);async function ne(r){if(r.preventDefault(),w(""),z(""),C){w("Please create your vendor profile before submitting a listing.");return}if(!P){w("Your vendor account is not yet approved. Please complete your profile and wait for admin approval.");return}if(k){w("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}if(!s.title.trim()||!W){w("Title and category are required.");return}let v=I;try{const{data:u}=await A.get(`${E}/live`,{headers:{"x-tenant-id":i,"cache-control":"no-cache"}});u&&(v=u)}catch{v=I}const p={uid:f.currentUser?.uid,email:f.currentUser?.email||l?.email||"",name:f.currentUser?.displayName||l?.name||"",vendorId:o?.vendorId||l?.vendorId||""},y=te(v,p)||o;if((y?.status||"").toLowerCase()==="suspended"){w("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}const m=T({id:re(),title:s.title.trim(),category:W,vendor:y.name||y.contactEmail||"Vendor",vendorId:y.vendorId,contactEmail:Q,ownerUid:f.currentUser?.uid||y.ownerUid||"",ownerEmail:Q,price:Number(s.price||0),rating:0,reviewCount:0,imageUrl:(s.imageUrl||"").trim(),listingType:s.listingType||"service",status:"pending",isFeatured:!1,description:(s.description||"").trim(),reviews:[],createdAt:new Date().toISOString(),...x?{source:"duplicate",clonedFrom:x.id}:{},...U&&!x?{source:"prefill"}:{}});H(!0);try{const u={...m,tenantId:i,tags:Array.isArray(m?.tags)?m.tags:[]},{data:O}=await A.post("/api/data/services",u,{headers:{"Content-Type":"application/json","x-tenant-id":i}}),h=T(O||u);try{const{data:n}=await A.get(`${E}/live`,{headers:{"x-tenant-id":i,"cache-control":"no-cache"}}),g=n&&typeof n=="object"&&n.data?n.data:n;g&&typeof g=="object"&&!Array.isArray(g)?V(g):V(b=>{const L=b&&typeof b=="object"?{...b}:{},$=Array.isArray(L.services)?L.services:[];return{...L,services:[...$,h]}})}catch{V(n=>{const g=n&&typeof n=="object"?{...n}:{},b=Array.isArray(g.services)?g.services:[];return{...g,services:[...b,h]}})}try{await D?.()}catch{}try{const n=ge(i,h.vendorId||h.contactEmail||h.ownerEmail||f.currentUser?.uid||"");if(n){const g=ee(localStorage.getItem(n)),b=Array.isArray(g)?g:[],L=String(h.id||h.serviceId||""),$=[h,...b.filter(X=>String(X?.id||X?.serviceId||"")!==L)];localStorage.setItem(n,JSON.stringify($))}}catch{}z("Listing submitted! It’s now pending review by the marketplace admins."),setTimeout(()=>t("/listings-vendors-mine",{replace:!0,state:{newListing:h}}),850)}catch(u){w(u?.message||"Failed to submit listing."),window.scrollTo({top:0,behavior:"smooth"})}finally{H(!1)}}return e.jsx(de,{activeRoute:"/listings-vendors",pageTitle:"Submit a Listing",children:e.jsxs("div",{className:"container py-4",style:{maxWidth:880},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h1",{className:"h4 mb-0",children:"Submit a Listing"}),e.jsxs("div",{className:"text-muted small",children:["Vendor:"," ",o?.vendorId?e.jsxs(e.Fragment,{children:[e.jsx("code",{className:"me-1",children:o.vendorId}),e.jsxs("span",{children:["(",o.name||o.contactEmail,")"]}),k&&e.jsx("span",{className:"badge text-bg-danger ms-2",children:"suspended"})]}):"not set"]})]}),C&&e.jsxs("div",{className:"alert alert-warning d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"You need a vendor profile before submitting a listing."}),e.jsx(Z,{to:"/signup/vendor?next=/listings-vendors",className:"btn btn-sm btn-primary",children:"Create vendor profile"})]}),!C&&k&&e.jsxs("div",{className:"alert alert-danger",children:["Your vendor account is ",e.jsx("strong",{children:"suspended"}),". You cannot submit listings. Please contact support if you think this is an error."]}),x&&e.jsxs("div",{className:"alert alert-info",children:["Duplicating from ",e.jsx("strong",{children:x.title}),". Adjust fields and submit to create a new ",e.jsx("strong",{children:"pending"})," listing."]}),U&&!x&&e.jsxs("div",{className:"alert alert-info",children:["Form prefilled. Review and submit to create a"," ",e.jsx("strong",{children:"pending"})," listing."]}),J&&e.jsx("div",{className:"alert alert-danger",children:J}),q&&e.jsx("div",{className:"alert alert-success",children:q}),e.jsxs("div",{className:"card bg-body",children:[e.jsx("div",{className:"card-header bg-body-tertiary fw-semibold",children:"Listing details"}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:ne,noValidate:!0,children:[e.jsxs("div",{className:"row g-3 mb-1",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Vendor"}),e.jsx("input",{className:"form-control",value:o?.name||o?.contactEmail||"",disabled:!0,"aria-readonly":"true"})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Vendor ID"}),e.jsx("input",{className:"form-control",value:o?.vendorId||"",disabled:!0,"aria-readonly":"true"})]})]}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-8",children:[e.jsx("label",{className:"form-label",children:"Title"}),e.jsx("input",{className:"form-control",value:s.title,onChange:r=>N("title",r.target.value),placeholder:"e.g., Modern Logo & Brand Identity Pack",required:!0,disabled:j})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Listing type"}),e.jsxs("select",{className:"form-select",value:s.listingType,onChange:r=>N("listingType",r.target.value),disabled:j,children:[e.jsx("option",{value:"service",children:"Service"}),e.jsx("option",{value:"saas",children:"SaaS"})]})]})]}),e.jsxs("div",{className:"row g-3 mt-1",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Category"}),e.jsxs("select",{className:"form-select",value:s.categoryChoice,onChange:r=>N("categoryChoice",r.target.value),disabled:j,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Pick a category"}),ae.map(r=>e.jsx("option",{value:r,children:r},r)),e.jsx("option",{value:M,children:"Other…"})]})]}),s.categoryChoice===M&&e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"Custom category"}),e.jsx("input",{className:"form-control",value:s.categoryCustom,onChange:r=>N("categoryCustom",r.target.value),placeholder:"Type a new category",disabled:j,required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("label",{className:"form-label",children:"Price (R)"}),e.jsx("input",{type:"number",min:"0",className:"form-control",value:s.price,onChange:r=>N("price",r.target.value),placeholder:"e.g., 8500",disabled:j})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx("label",{className:"form-label",children:"Image URL"}),e.jsx("input",{className:"form-control",value:s.imageUrl,onChange:r=>N("imageUrl",r.target.value),placeholder:"https://…",disabled:j})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-control",rows:4,value:s.description,onChange:r=>N("description",r.target.value),placeholder:"Describe what buyers get, deliverables, timelines, etc.",disabled:j})]}),e.jsxs("div",{className:"border rounded p-2 mt-3",children:[e.jsx("div",{className:"text-muted small mb-1",children:"Card preview"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("img",{src:s.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:120,height:72,objectFit:"cover",borderRadius:6}}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-semibold",children:s.title||"Untitled service"}),e.jsx("div",{className:"text-muted small",children:o?.name||o?.contactEmail||"Vendor"}),e.jsxs("div",{className:"small",children:["R",Number(s.price||0).toLocaleString()," · ★ 0.0"]})]})]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-3",children:[e.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",type:"submit",disabled:B||j,children:B?"Submitting…":"Submit for review"}),e.jsx(Z,{to:"/listings-vendors-mine",className:"btn btn-outline-secondary",children:"Cancel"})]}),e.jsxs("div",{className:"form-text mt-2",children:["Submissions are added as ",e.jsx("strong",{children:"pending"})," and become visible once approved by admins."]})]})})]}),F&&e.jsxs("div",{className:"card mt-3",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("span",{children:"Recent checkpoints"}),e.jsx("span",{className:"text-muted small",children:"Latest snapshots"})]}),e.jsxs("div",{className:"list-group list-group-flush",children:[!_?.length&&e.jsx("div",{className:"list-group-item text-muted small",children:"No checkpoints yet."}),_?.slice(0,4).map(r=>e.jsxs("div",{className:"list-group-item d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"fw-semibold",children:r.message||"(no message)"}),e.jsx("div",{className:"text-muted small",children:new Date(r.ts).toLocaleString()})]}),e.jsx("a",{className:"btn btn-sm btn-outline-secondary",href:`${E}/checkpoints/${r.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]},r.id))]})]})]})})}export{fe as default};
