import{r as s,a as O,j as e,y as R}from"./index-DaarVqB8.js";import{M as U}from"./MasterLayout-2uOgNMve.js";import{B as V}from"./Breadcrumb-BRZsn1CE.js";import"./iconify-CVdOCQR-.js";function k(){const[x,S]=s.useState([]),[l,g]=s.useState(!0),[p,j]=s.useState(""),[d,I]=s.useState(""),[v,L]=s.useState(""),[f,w]=s.useState(""),[u,E]=s.useState(""),[h,T]=s.useState(""),[y,C]=s.useState(()=>sessionStorage.getItem("tenantId")||"vendor"),[A,b]=s.useState([{id:"vendor",name:"Vendor"}]);s.useEffect(()=>{let t=!0;return(async()=>{try{const{data:n}=await O.get("/api/tenants"),r=Array.isArray(n)?n:[],c=[{id:"vendor",name:"Vendor"},...r.map(a=>typeof a=="string"?{id:a,name:a}:{id:a==null?void 0:a.id,name:(a==null?void 0:a.name)||(a==null?void 0:a.id)}).map(a=>a.id==="public"?{...a,id:"vendor",name:a.name||"Vendor"}:a)].filter(a=>a&&a.id),i=Object.values(c.reduce((a,m)=>(a[m.id]=m,a),{}));t&&b(i)}catch{t&&b([{id:"vendor",name:"Vendor"}])}})(),()=>{t=!1}},[]);async function N(){g(!0),j("");try{const t=await R({search:d.trim(),userEmail:v.trim()||void 0,action:f.trim()||void 0,dateFrom:u?new Date(u):void 0,dateTo:h?new Date(h):void 0,limit:250,tenantId:y});S(t)}catch{j("Failed to load audit logs")}finally{g(!1)}}s.useEffect(()=>{N()},[]);const o=s.useMemo(()=>{const t=d.trim().toLowerCase();return x.filter(n=>t?[n.userEmail,n.action,n.targetType,n.targetId,n.ip].filter(Boolean).some(r=>String(r).toLowerCase().includes(t)):!0)},[x,d]);function F(){const n=[["timestamp","userEmail","userId","action","targetType","targetId","ip","tenantId"].join(",")];o.forEach(a=>{const m=[a.timestamp?new Date(a.timestamp).toISOString():"",a.userEmail||"",a.userId||"",a.action||"",a.targetType||"",a.targetId||"",a.ip||"",a.tenantId||""];n.push(m.map(D=>`"${String(D).replaceAll('"','""')}"`).join(","))});const r=new Blob(["\uFEFF"+n.join(`
`)],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(r),i=document.createElement("a");i.href=c,i.download=`audit-logs-${new Date().toISOString().slice(0,10)}.csv`,i.click(),URL.revokeObjectURL(c)}return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-wrap gap-2 align-items-end mb-3",children:[e.jsxs("div",{className:"me-auto",children:[e.jsx("h5",{className:"mb-0",children:"Audit Logs"}),e.jsx("small",{className:"text-secondary",children:"Centralized user activity across tenants"})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx("select",{className:"form-select",value:y,onChange:t=>C(t.target.value),title:"Tenant scope",children:A.map(t=>e.jsx("option",{value:t.id,children:t.name||t.id},t.id))}),e.jsx("input",{className:"form-control",placeholder:"Search email, action, target",value:d,onChange:t=>I(t.target.value)}),e.jsx("input",{className:"form-control",placeholder:"Filter by user email",value:v,onChange:t=>L(t.target.value)}),e.jsx("input",{className:"form-control",placeholder:"Filter by action (e.g., LOGIN, CREATE)",value:f,onChange:t=>w(t.target.value)}),e.jsx("input",{type:"date",className:"form-control",value:u,onChange:t=>E(t.target.value),"aria-label":"From date"}),e.jsx("input",{type:"date",className:"form-control",value:h,onChange:t=>T(t.target.value),"aria-label":"To date"}),e.jsx("button",{className:"btn btn-secondary",onClick:N,disabled:l,children:l?"Loading…":"Apply"}),e.jsx("button",{className:"btn btn-outline-primary",onClick:F,disabled:!o.length,children:"Export CSV"})]})]}),p&&e.jsx("div",{className:"alert alert-danger",role:"alert",children:p}),!l&&!o.length?e.jsx("div",{className:"text-center text-secondary py-5",children:"No audit events found."}):null,e.jsx("div",{className:"table-responsive border rounded",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{minWidth:160},children:"Timestamp"}),e.jsx("th",{children:"User"}),e.jsx("th",{children:"Action"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"IP"}),e.jsx("th",{children:"Tenant"})]})}),e.jsxs("tbody",{children:[o.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.timestamp?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fw-semibold",children:new Date(t.timestamp).toLocaleString()}),e.jsx("div",{className:"text-secondary small",children:new Date(t.timestamp).toISOString()})]}):e.jsx("span",{className:"text-secondary",children:"—"})}),e.jsxs("td",{children:[e.jsx("div",{className:"fw-semibold",children:t.userEmail||t.userId||"—"}),t.userId&&e.jsx("div",{className:"text-secondary small",children:t.userId})]}),e.jsx("td",{children:e.jsx("span",{className:"badge text-bg-secondary",children:t.action||"—"})}),e.jsx("td",{children:t.targetType||t.targetId?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fw-semibold",children:t.targetType||"—"}),t.targetId&&e.jsx("div",{className:"text-secondary small",children:t.targetId})]}):e.jsx("span",{className:"text-secondary",children:"—"})}),e.jsx("td",{children:t.ip||"—"}),e.jsx("td",{children:t.tenantId||"vendor"})]},t.id)),l&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-secondary py-4",children:"Loading logs…"})})]})]})})]})})}const $=()=>e.jsxs(U,{children:[e.jsx(V,{title:"Audit Logs"}),e.jsx(k,{})]});export{$ as default};
