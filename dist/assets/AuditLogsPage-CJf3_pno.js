import{r as a,l as k,j as e,m as O}from"./index-BsOh-tAE.js";import{M as R}from"./MasterLayout-BVEjpXnC.js";import{B as U}from"./Breadcrumb-DFWMpTDh.js";import"./iconify-BmV4o_YB.js";import"./ThemeToggleButton-DJ1aWpop.js";function B(){const[u,N]=a.useState([]),[i,h]=a.useState(!0),[x,p]=a.useState(""),[r,S]=a.useState(""),[g,I]=a.useState(""),[j,w]=a.useState(""),[o,L]=a.useState(""),[d,E]=a.useState(""),[b,T]=a.useState(()=>sessionStorage.getItem("tenantId")||"public"),[A,f]=a.useState(["public"]);a.useEffect(()=>{let t=!0;return(async()=>{try{const{data:s}=await k.get("/api/tenants"),l=Array.isArray(s)&&s.length?s:["public"];t&&f(Array.from(new Set(["public",...l])))}catch{t&&f(["public"])}})(),()=>{t=!1}},[]);async function v(){h(!0),p("");try{const t=await O({search:r.trim(),userEmail:g.trim()||void 0,action:j.trim()||void 0,dateFrom:o?new Date(o):void 0,dateTo:d?new Date(d):void 0,limit:250,tenantId:b});N(t)}catch{p("Failed to load audit logs")}finally{h(!1)}}a.useEffect(()=>{v()},[]);const c=a.useMemo(()=>{const t=r.trim().toLowerCase();return u.filter(s=>t?[s.userEmail,s.action,s.targetType,s.targetId,s.ip].filter(Boolean).some(l=>String(l).toLowerCase().includes(t)):!0)},[u,r]);function C(){const s=[["timestamp","userEmail","userId","action","targetType","targetId","ip","tenantId"].join(",")];c.forEach(n=>{const F=[n.timestamp?new Date(n.timestamp).toISOString():"",n.userEmail||"",n.userId||"",n.action||"",n.targetType||"",n.targetId||"",n.ip||"",n.tenantId||""];s.push(F.map(D=>`"${String(D).replaceAll('"','""')}"`).join(","))});const l=new Blob(["\uFEFF"+s.join(`
`)],{type:"text/csv;charset=utf-8;"}),y=URL.createObjectURL(l),m=document.createElement("a");m.href=y,m.download=`audit-logs-${new Date().toISOString().slice(0,10)}.csv`,m.click(),URL.revokeObjectURL(y)}return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-wrap gap-2 align-items-end mb-3",children:[e.jsxs("div",{className:"me-auto",children:[e.jsx("h5",{className:"mb-0",children:"Audit Logs"}),e.jsx("small",{className:"text-secondary",children:"Centralized user activity across tenants"})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx("select",{className:"form-select",value:b,onChange:t=>T(t.target.value),title:"Tenant scope",children:A.map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsx("input",{className:"form-control",placeholder:"Search email, action, target",value:r,onChange:t=>S(t.target.value)}),e.jsx("input",{className:"form-control",placeholder:"Filter by user email",value:g,onChange:t=>I(t.target.value)}),e.jsx("input",{className:"form-control",placeholder:"Filter by action (e.g., LOGIN, CREATE)",value:j,onChange:t=>w(t.target.value)}),e.jsx("input",{type:"date",className:"form-control",value:o,onChange:t=>L(t.target.value),"aria-label":"From date"}),e.jsx("input",{type:"date",className:"form-control",value:d,onChange:t=>E(t.target.value),"aria-label":"To date"}),e.jsx("button",{className:"btn btn-secondary",onClick:v,disabled:i,children:i?"Loading…":"Apply"}),e.jsx("button",{className:"btn btn-outline-primary",onClick:C,disabled:!c.length,children:"Export CSV"})]})]}),x&&e.jsx("div",{className:"alert alert-danger",role:"alert",children:x}),!i&&!c.length?e.jsx("div",{className:"text-center text-secondary py-5",children:"No audit events found."}):null,e.jsx("div",{className:"table-responsive border rounded",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{minWidth:160},children:"Timestamp"}),e.jsx("th",{children:"User"}),e.jsx("th",{children:"Action"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"IP"}),e.jsx("th",{children:"Tenant"})]})}),e.jsxs("tbody",{children:[c.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.timestamp?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fw-semibold",children:new Date(t.timestamp).toLocaleString()}),e.jsx("div",{className:"text-secondary small",children:new Date(t.timestamp).toISOString()})]}):e.jsx("span",{className:"text-secondary",children:"—"})}),e.jsxs("td",{children:[e.jsx("div",{className:"fw-semibold",children:t.userEmail||t.userId||"—"}),t.userId&&e.jsx("div",{className:"text-secondary small",children:t.userId})]}),e.jsx("td",{children:e.jsx("span",{className:"badge text-bg-secondary",children:t.action||"—"})}),e.jsx("td",{children:t.targetType||t.targetId?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fw-semibold",children:t.targetType||"—"}),t.targetId&&e.jsx("div",{className:"text-secondary small",children:t.targetId})]}):e.jsx("span",{className:"text-secondary",children:"—"})}),e.jsx("td",{children:t.ip||"—"}),e.jsx("td",{children:t.tenantId||"public"})]},t.id)),i&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-secondary py-4",children:"Loading logs…"})})]})]})}),e.jsx("div",{className:"mt-3",children:e.jsxs("small",{className:"text-secondary",children:["Notes: This page prefers the backend endpoint at ",e.jsx("code",{children:"/api/audit-logs"})," and falls back to Firestore collection ",e.jsx("code",{children:"audit_logs"})," if the API is unavailable."]})})]})})}const V=()=>e.jsxs(R,{children:[e.jsx(U,{title:"Audit Logs"}),e.jsx(B,{})]});export{V as default};
