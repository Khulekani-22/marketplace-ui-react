import{d as O,e as J,b as p,f as I,B as g,j as e,I as t,M as K}from"./index-Bn5LcKgl.js";import{B as X}from"./Breadcrumb-B3g6Xnkc.js";import{r as n,L as y}from"./vendor-DW3XjTa1.js";import{W as Y,a as Z,A as _,T as ee,f as se}from"./WalletNavigation-BrA_QL_O.js";import"./firebase-BBiW2ZCr.js";import"./utils-B2rxisVD.js";function ae(){const[S,z]=n.useState([]),[f,A]=n.useState(!0),[c,D]=n.useState(""),[d,b]=n.useState(!1),[r,R]=n.useState(""),[B,C]=n.useState([]),[o,L]=n.useState(!1),[k,N]=n.useState(""),[m,U]=n.useState(""),[v,te]=n.useState(100),W=n.useRef(!1),{wallet:h,loading:M,eligible:P,refresh:F,grantCredits:$}=O(),{isAdmin:q}=J(),w=n.useCallback(async(s=!0)=>{N(""),L(!0);try{const a={search:r,pageSize:v};!s&&m&&(a.pageToken=m);const{data:i}=await p.get("/api/users/all",{params:a}),l=Array.isArray(i?.items)?i.items:[];C(j=>s?l:[...j,...l]),U(i?.nextPageToken||"")}catch(a){const i=a?.response?.status;if(i===401||i===403)try{await I();const l={search:r,pageSize:v};!s&&m&&(l.pageToken=m);const{data:j}=await p.get("/api/users/all",{params:l}),T=Array.isArray(j?.items)?j.items:[];C(H=>s?T:[...H,...T]),U(j?.nextPageToken||""),N("");return}catch(l){N(l?.response?.data?.message||l?.message||"Failed to search platform users")}else N(a?.response?.data?.message||a?.message||"Failed to search platform users")}finally{L(!1)}},[r,v,m]);n.useEffect(()=>{if(W.current)return;W.current=!0;let s=!0;return(async()=>{try{if(await I(),!s||(await w(!0),!s))return;await x()}catch(a){console.error("Failed to auto-load users:",a)}})(),()=>{s=!1}},[w]);const x=async()=>{try{A(!0);const i=((await p.get("/api/users")).data||[]).map(l=>({...l,walletBalance:G(l.uid||l.email),lastActivity:l.lastActivity||new Date().toISOString(),avatar:l.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(l.name||l.email)}&background=6366f1&color=fff`}));z(i)}catch(s){console.error("Error loading users:",s),g.error("Failed to load user data")}finally{A(!1)}},G=s=>S.find(i=>i.uid===s)?.walletBalance||0,Q=async()=>{if(!d)try{b(!0),await p.post("/api/admin/wallet/normalize-appdata"),g.success("Successfully normalized app data"),await x()}catch(s){console.error("Error normalizing data:",s);const a=s.response?.data?.message||"Failed to normalize app data";g.error(a)}finally{b(!1)}},V=async()=>{if(!d)try{b(!0);const s=["mncubekhulekani@gmail.com","ruthmaphosa2024@gmail.com","zinhlesloane@gmail.com","khulekani@gecafrica.co","22onsloanedigitalteam@gmail.com","khulekani@22onsloane.co"],a=await p.post("/api/admin/wallet/sync-firebase-users",{promoteVendors:s,defaultRole:"member",defaultTenant:"vendor"});g.success(`Successfully synced ${a.data.synced} Firebase users`),await x()}catch(s){console.error("Error syncing Firebase users:",s);const a=s.response?.data?.message||"Failed to sync Firebase users";g.error(a)}finally{b(!1)}},E=S.filter(s=>s.email.toLowerCase().includes(c.toLowerCase())||s.name?.toLowerCase().includes(c.toLowerCase())||s.role.toLowerCase().includes(c.toLowerCase())),u=B.filter(s=>s.email?.toLowerCase().includes(r.toLowerCase())||s.displayName?.toLowerCase().includes(r.toLowerCase()));return e.jsxs("div",{className:"container-fluid",children:[e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-info",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(t,{icon:"mdi:information",className:"me-2 text-xl"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Enhanced Integration Available:"}),e.jsxs("p",{className:"mb-1",children:["The main ",e.jsx(y,{to:"/wallet",className:"alert-link",children:"Wallet interface"})," now includes all admin functionality with improved user transaction tracking capabilities."]}),e.jsx("small",{className:"text-muted",children:"This legacy interface remains available for compatibility, but we recommend using the unified wallet for better user experience."})]})]})})})}),e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-12",children:e.jsx(Y,{})}),q&&h&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-12 col-lg-8",children:e.jsx(Z,{wallet:h,loading:M,eligible:P,onRefresh:F,showActions:!0})}),e.jsx("div",{className:"col-12 col-lg-4",children:e.jsxs("div",{className:"card p-24 radius-12 h-100",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(t,{icon:"mdi:shield-crown",className:"text-xl text-primary-600 me-2"}),"Admin Actions"]}),e.jsxs("div",{className:"d-grid gap-2",children:[e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:Q,disabled:d,children:d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Normalizing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{icon:"mdi:database-sync",className:"me-2"}),"Normalize Data"]})}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:V,disabled:d,children:d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Syncing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(t,{icon:"mdi:account-sync",className:"me-2"}),"Sync Firebase Users"]})}),e.jsxs(y,{to:"/wallet",className:"btn btn-outline-success btn-sm",children:[e.jsx(t,{icon:"mdi:wallet",className:"me-2"}),"Unified Wallet Interface"]}),e.jsxs(y,{to:"/dashboard",className:"btn btn-outline-info btn-sm",children:[e.jsx(t,{icon:"mdi:view-dashboard",className:"me-2"}),"Dashboard"]})]})]})})]})}),e.jsx("div",{className:"col-12",children:e.jsx(_,{grantCredits:$,onRefresh:async()=>{await x(),await F()},compact:!1,showUserLookup:!0})}),h?.transactions&&h.transactions.length>0&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(t,{icon:"mdi:history",className:"text-xl text-primary-600 me-2"}),"My Recent Activity"]}),e.jsx(y,{to:"/wallet",className:"btn btn-outline-primary btn-sm",children:"View Full History"})]}),e.jsx(ee,{transactions:h.transactions,compact:!0})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(t,{icon:"mdi:account-group",className:"text-xl text-primary-600 me-2"}),"Platform Users"]}),e.jsx("div",{className:"d-flex gap-2",children:e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>w(!0),disabled:o,children:o?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(t,{icon:"mdi:refresh"})})})]}),e.jsx("div",{className:"row mb-3",children:e.jsx("div",{className:"col-12 col-md-6",children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx(t,{icon:"mdi:magnify"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Search platform users...",value:r,onChange:s=>R(s.target.value)})]})})}),k&&e.jsxs("div",{className:"alert alert-warning mb-3",children:[e.jsx(t,{icon:"mdi:alert-circle",className:"me-2"}),k]}),o&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"text-secondary mt-2",children:"Searching platform users..."})]}),!o&&u.length>0&&e.jsxs("div",{className:"table-responsive",children:[e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Last Sign In"}),e.jsx("th",{children:"Provider"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:u.slice(0,20).map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:s.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.displayName||s.email)}&background=6366f1&color=fff`,alt:s.displayName||s.email,className:"rounded-circle me-2",width:"32",height:"32"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.displayName||"No Name"}),e.jsx("div",{className:"text-xs text-secondary",children:s.uid})]})]})}),e.jsx("td",{children:s.email}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:s.metadata?.lastSignInTime?new Date(s.metadata.lastSignInTime).toLocaleDateString():"Never"})}),e.jsx("td",{children:e.jsx("span",{className:"badge bg-light text-dark",children:s.providerData?.[0]?.providerId||"Unknown"})}),e.jsx("td",{children:e.jsx("div",{className:"btn-group btn-group-sm",children:e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{const a=document.querySelector('input[type="email"]');a&&(a.value=s.email,a.dispatchEvent(new Event("input",{bubbles:!0})))},title:"Grant credits to this user",children:e.jsx(t,{icon:"mdi:wallet-plus"})})})})]},s.uid))})]}),u.length>20&&e.jsx("div",{className:"text-center pt-3",children:e.jsxs("small",{className:"text-secondary",children:["Showing 20 of ",u.length," users. Use search to narrow results."]})})]}),!o&&u.length===0&&r&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(t,{icon:"mdi:account-search",className:"text-4xl text-secondary-light mb-2"}),e.jsxs("p",{className:"text-secondary",children:['No users found matching "',r,'"']})]})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(t,{icon:"mdi:account-group",className:"text-xl text-primary-600 me-2"}),"Local Users & Wallets"]}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:x,disabled:f,children:f?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(t,{icon:"mdi:refresh"})})]}),e.jsx("div",{className:"row mb-3",children:e.jsx("div",{className:"col-12 col-md-6",children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx(t,{icon:"mdi:magnify"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Search users...",value:c,onChange:s=>D(s.target.value)})]})})}),f?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"text-secondary mt-2",children:"Loading users..."})]}):E.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Tenant"}),e.jsx("th",{children:"Wallet Balance"}),e.jsx("th",{children:"Last Activity"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:E.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:s.avatar,alt:s.name,className:"rounded-circle me-2",width:"32",height:"32"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.name}),e.jsx("div",{className:"text-xs text-secondary",children:s.email})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.role==="admin"?"bg-danger":s.role==="vendor"?"bg-warning":"bg-secondary"}`,children:s.role})}),e.jsx("td",{children:s.tenantId}),e.jsx("td",{children:e.jsxs("span",{className:"fw-medium",children:["R ",se(s.walletBalance)]})}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:new Date(s.lastActivity).toLocaleDateString()})}),e.jsx("td",{children:e.jsx("div",{className:"btn-group btn-group-sm",children:e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{const a=document.querySelector('input[type="email"]');a&&(a.value=s.email,a.dispatchEvent(new Event("input",{bubbles:!0})))},title:"Grant credits to this user",children:e.jsx(t,{icon:"mdi:wallet-plus"})})})})]},s.uid))})]})}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(t,{icon:"mdi:account-search",className:"text-4xl text-secondary-light mb-2"}),e.jsx("p",{className:"text-secondary",children:c?`No users found matching "${c}"`:"No users found"})]})]})})]})]})}const oe=()=>e.jsxs(K,{children:[e.jsx(X,{title:"Wallet Credits Management"}),e.jsx(ae,{})]});export{oe as default};
