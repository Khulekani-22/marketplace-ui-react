import{e as Le,f as Ee,a as h,b as A,B as o,j as e,I as l,M as Ue}from"./index-DgAHpWmH.js";import{B as Fe}from"./Breadcrumb-Dt1H-3v0.js";import{r,L as oe}from"./vendor-DW3XjTa1.js";import{W as Re,a as de,T as me,A as De,f as T}from"./WalletNavigation-oAsq59tu.js";import"./firebase-ARhtPVQA.js";import"./utils-B2rxisVD.js";function $e(){const{loading:he,eligible:J,wallet:g,redeemCredits:ue,grantCredits:xe,refresh:V}=Le(),{isAdmin:d}=Ee(),[G,K]=r.useState(""),[R,X]=r.useState(""),[D,$]=r.useState({type:"",message:""}),[B,Y]=r.useState(!1),[pe,ge]=r.useState([]),[Q,Z]=r.useState(!1),[f,je]=r.useState(""),[C,O]=r.useState(null),[ee,se]=r.useState(""),[be,M]=r.useState(""),[y,I]=r.useState(!1),[p,Ne]=r.useState(""),[fe,ae]=r.useState([]),[v,te]=r.useState(!1),[ne,P]=r.useState(""),[S,le]=r.useState(""),[_]=r.useState(50),re=r.useRef(!1),[x,W]=r.useState([]),[i,j]=r.useState({userEmail:"",type:"",dateFrom:"",dateTo:"",minAmount:"",maxAmount:""}),[z,ie]=r.useState(!1),[u,L]=r.useState(1),[b]=r.useState(20),[E,ye]=r.useState(!0),H=r.useCallback(async(s=!0)=>{P(""),te(!0);try{const a={search:p,pageSize:_};!s&&S&&(a.pageToken=S);const{data:n}=await h.get("/api/users/all",{params:a}),t=Array.isArray(n?.items)?n.items:[];ae(c=>s?t:[...c,...t]),le(n?.nextPageToken||"")}catch(a){const n=a?.response?.status;if(n===401||n===403)try{await A();const t={search:p,pageSize:_};!s&&S&&(t.pageToken=S);const{data:c}=await h.get("/api/users/all",{params:t}),k=Array.isArray(c?.items)?c.items:[];ae(m=>s?k:[...m,...k]),le(c?.nextPageToken||""),P("");return}catch(t){P(t?.response?.data?.message||t?.message||"Failed to search platform users")}else P(a?.response?.data?.message||a?.message||"Failed to search platform users")}finally{te(!1)}},[p,_,S]),w=r.useCallback(async()=>{if(d)try{Z(!0);const{data:s}=await h.get("/api/admin/wallet/users",{suppressToast:!0,suppressErrorLog:!0}),n=(Array.isArray(s?.users)?s.users:[]).map(t=>({uid:t.uid||t.id||t.email,email:t.email||"",name:t.name||t.email||"Unknown user",role:t.role||"member",tenantId:t.tenantId||"public",walletBalance:Number(t.walletBalance)||0,lastActivity:t.lastActivity||new Date().toISOString(),avatar:t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name||t.email||"User")}&background=6366f1&color=fff`}));ge(n)}catch(s){console.error("Error loading users:",s);const a=s?.response?.data?.message||"Failed to load user data";o.error(a)}finally{Z(!1)}},[d]),q=r.useCallback(async s=>{try{const{data:a}=await h.get("/api/wallets/admin/lookup",{params:{email:s.trim().toLowerCase()}});O(a?.wallet||null),se(s)}catch(a){console.error("Error looking up user wallet:",a),O(null),o.error("Failed to lookup user wallet")}},[]),N=r.useCallback(async()=>{if(d)try{ie(!0),console.log("Loading transactions with filters:",i),await A();try{const{data:s}=await h.get("/api/wallets/admin/transactions",{params:{userEmail:i.userEmail||void 0,type:i.type||void 0,dateFrom:i.dateFrom||void 0,dateTo:i.dateTo||void 0,minAmount:i.minAmount||void 0,maxAmount:i.maxAmount||void 0,page:u,limit:b}});console.log("Received transaction data from dedicated endpoint:",s),W(s?.transactions||[]),s?.transactions?.length>0?o.success(`Loaded ${s.transactions.length} transactions`):o.info("No transactions found")}catch(s){console.warn("Dedicated transactions endpoint failed, trying fallback approach:",s);try{const{data:t}=await h.get("/api/admin/wallet/transactions",{params:{limit:500,offset:0,userId:i.userEmail||void 0},suppressToast:!0,suppressErrorLog:!0}),c=Array.isArray(t?.transactions)?t.transactions:[];if(c.length){const k=c.map(m=>({...m,userEmail:m.userEmail||m.email||m.userId||"unknown",userName:m.userName||m.displayName||m.userId||m.email||"Unknown",userRole:m.userRole||m.role||"member",userTenant:m.userTenant||m.tenantId||"public",walletBalance:Number(m.walletBalance)||0}));k.sort((m,Se)=>new Date(Se.createdAt).getTime()-new Date(m.createdAt).getTime()),W(k),o.success(`Loaded ${k.length} transactions (admin fallback)`);return}}catch(t){console.warn("Admin wallet transactions fallback failed, using wallet snapshot fallback:",t)}const{data:a}=await h.get("/api/wallets",{suppressToast:!0,suppressErrorLog:!0});let n=[];if(Array.isArray(a)&&a.forEach(t=>{t&&Array.isArray(t.transactions)&&t.transactions.length&&t.transactions.forEach(c=>{n.push({...c,userEmail:t.userEmail||t.email||"unknown",userName:t.userName||t.name||t.userEmail||t.email,userRole:t.role,userTenant:t.tenantId,walletBalance:t.balance})})}),i.userEmail){const t=i.userEmail.toLowerCase();n=n.filter(c=>c.userEmail?.toLowerCase().includes(t))}if(i.type&&(n=n.filter(t=>t.type===i.type)),i.dateFrom){const t=new Date(i.dateFrom);n=n.filter(c=>new Date(c.createdAt)>=t)}if(i.dateTo){const t=new Date(i.dateTo);t.setHours(23,59,59,999),n=n.filter(c=>new Date(c.createdAt)<=t)}if(i.minAmount){const t=Number(i.minAmount);Number.isFinite(t)&&(n=n.filter(c=>c.amount>=t))}if(i.maxAmount){const t=Number(i.maxAmount);Number.isFinite(t)&&(n=n.filter(c=>c.amount<=t))}n.sort((t,c)=>new Date(c.createdAt).getTime()-new Date(t.createdAt).getTime()),W(n),n.length?o.success(`Loaded ${n.length} transactions (snapshot fallback)`):o.info("No transactions found in any wallets")}}catch(s){console.error("Error loading transactions:",s);const a=s.response?.data?.message||s.message||"Failed to load transaction history",n=s.response?.status;n===404?o.error("Transaction endpoint not found. Please check if backend is running with latest code."):n===401||n===403?o.error("Authentication required. Please sign in again."):o.error(`Failed to load transaction history: ${a}`),W([])}finally{ie(!1)}},[d,i,u,b]),ve=r.useCallback(()=>{j({userEmail:"",type:"",dateFrom:"",dateTo:"",minAmount:"",maxAmount:""}),L(1)},[]),we=r.useCallback(()=>{L(1),N()},[N]),ke=async()=>{if(!y)try{I(!0),await h.post("/api/admin/wallet/normalize-appdata"),o.success("Successfully normalized app data"),await w(),await V()}catch(s){console.error("Error normalizing data:",s);const a=s.response?.data?.message||"Failed to normalize app data";o.error(a)}finally{I(!1)}},Ae=async()=>{if(!y)try{I(!0);const s=["mncubekhulekani@gmail.com","ruthmaphosa2024@gmail.com","zinhlesloane@gmail.com","khulekani@gecafrica.co","22onsloanedigitalteam@gmail.com","khulekani@22onsloane.co"],a=await h.post("/api/admin/wallet/sync-firebase-users",{promoteVendors:s,defaultRole:"member",defaultTenant:"vendor"});o.success(`Successfully synced ${a.data.synced} Firebase users`),await w()}catch(s){console.error("Error syncing Firebase users:",s);const a=s.response?.data?.message||"Failed to sync Firebase users";o.error(a)}finally{I(!1)}};r.useEffect(()=>{if(!d||re.current)return;re.current=!0;let s=!0;return(async()=>{try{if(await A(),!s||(await H(!0),!s))return;await w()}catch(a){console.error("Failed to auto-load users:",a)}})(),()=>{s=!1}},[d,H,w]),r.useEffect(()=>{d&&E&&x.length===0&&N()},[d,E,N,x.length]);const Te=async s=>{if(s.preventDefault(),!g)return;$({type:"",message:""});const a=Number(G.replace(/[^0-9.]/g,""));if(!Number.isFinite(a)||a<=0){$({type:"danger",message:"Enter a valid voucher amount to record."});return}Y(!0);try{const n=await ue(a,{description:R?`Manual redemption: ${R.trim()}`:"Manual voucher redemption",metadata:{source:"my-wallet",note:R.trim()||void 0},reference:"manual-redemption"});if(!n.success){$({type:"danger",message:n.error||"Unable to record voucher usage."});return}K(""),X(""),$({type:"success",message:`Voucher usage recorded. Remaining balance: ${T(n.wallet?.balance)} credits.`})}finally{Y(!1)}},ce=pe.filter(s=>s.email.toLowerCase().includes(f.toLowerCase())||s.name?.toLowerCase().includes(f.toLowerCase())||s.role.toLowerCase().includes(f.toLowerCase())),U=fe.filter(s=>s.email?.toLowerCase().includes(p.toLowerCase())||s.displayName?.toLowerCase().includes(p.toLowerCase())),Ce=x.slice((u-1)*b,u*b),F=Math.ceil(x.length/b);return e.jsxs("div",{className:"row gy-4",children:[d&&e.jsx("div",{className:"col-12",children:e.jsx(Re,{})}),e.jsx("div",{className:"col-12 col-lg-8",children:e.jsx(de,{wallet:g,loading:he,eligible:J,onRefresh:V,showActions:!d})}),d&&e.jsx("div",{className:"col-12 col-lg-4",children:e.jsxs("div",{className:"card p-24 radius-12 h-100",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(l,{icon:"mdi:shield-crown",className:"text-xl text-primary-600 me-2"}),"Admin Actions"]}),e.jsxs("div",{className:"d-grid gap-2",children:[e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:ke,disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Normalizing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{icon:"mdi:database-sync",className:"me-2"}),"Normalize Data"]})}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:Ae,disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Syncing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{icon:"mdi:account-sync",className:"me-2"}),"Sync Firebase Users"]})}),e.jsxs(oe,{to:"/admin/wallet-credits",className:"btn btn-outline-warning btn-sm",children:[e.jsx(l,{icon:"mdi:wallet-plus",className:"me-2"}),"Legacy Admin"]}),e.jsxs(oe,{to:"/dashboard",className:"btn btn-outline-info btn-sm",children:[e.jsx(l,{icon:"mdi:view-dashboard",className:"me-2"}),"Dashboard"]})]})]})}),(!d||g)&&e.jsx("div",{className:d?"col-12 col-lg-6":"col-12 col-lg-4",children:e.jsxs("div",{className:"card p-24 radius-12 h-100",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(l,{icon:"mdi:receipt-text-plus",className:"text-xl text-primary-600 me-2"}),"Record Usage"]}),e.jsx("p",{className:"text-secondary-light mb-3",children:"Manually record voucher usage for offline transactions or services not yet integrated with the marketplace."}),J&&g&&e.jsxs("form",{onSubmit:Te,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label text-sm text-secondary-light",children:"Amount"}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:"R"}),e.jsx("input",{type:"text",className:"form-control",value:G,onChange:s=>K(s.target.value),placeholder:"e.g. 150",disabled:B})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label text-sm text-secondary-light",children:"Description (optional)"}),e.jsx("input",{type:"text",className:"form-control",value:R,onChange:s=>X(s.target.value),placeholder:"What was this used for?",disabled:B})]}),e.jsx("button",{type:"submit",className:"btn btn-primary w-100",disabled:B||!G,children:B?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Recording..."]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{icon:"mdi:plus-circle",className:"me-2"}),"Record Usage"]})})]}),D.message&&e.jsxs("div",{className:`alert alert-${D.type||"info"} mt-3 mb-0`,children:[e.jsx(l,{icon:D.type==="success"?"mdi:check-circle":"mdi:alert-circle",className:"me-2"}),D.message]})]})}),d&&C&&e.jsx("div",{className:"col-12 col-lg-6",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(l,{icon:"mdi:account-cash",className:"text-xl text-primary-600 me-2"}),"User Wallet: ",ee]}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>{O(null),se("")},children:e.jsx(l,{icon:"mdi:close"})})]}),e.jsx(de,{wallet:C,loading:!1,eligible:!0,onRefresh:()=>q(ee),showActions:!1,compact:!0}),C.transactions&&C.transactions.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h6",{className:"mb-2",children:"Recent Transactions"}),e.jsx(me,{transactions:C.transactions.slice(0,5),compact:!0})]})]})}),g&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(l,{icon:"mdi:history",className:"text-xl text-primary-600 me-2"}),d?"My Transaction History":"Transaction History"]}),d&&e.jsxs("div",{className:"text-sm text-secondary",children:["Total Transactions: ",g.transactions?.length||0]})]}),e.jsx(me,{transactions:g.transactions||[]})]})}),d&&e.jsx("div",{className:"col-12",children:e.jsx(De,{grantCredits:async s=>{const a=await xe(s.email||"",s.amount,s.description,{metadata:s.metadata||void 0,reference:s.reference});return{ok:a.success,error:a.error,wallet:a.wallet}},onRefresh:async()=>{await w(),await V()},compact:!1,showUserLookup:!0,selectedUserEmail:be,onEmailChange:M})}),d&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(l,{icon:"mdi:account-group",className:"text-xl text-primary-600 me-2"}),"Platform Users Transaction Tracking"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>{const s=!E;ye(s),s&&x.length===0&&N()},children:[e.jsx(l,{icon:"mdi:history",className:"me-1"}),E?"Hide":"Show"," Transaction History"]}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>H(!0),disabled:v,children:v?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(l,{icon:"mdi:refresh"})})]})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsx("div",{className:"col-12 col-md-6",children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx(l,{icon:"mdi:magnify"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Search platform users by name or email...",value:p,onChange:s=>Ne(s.target.value)})]})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("button",{className:"btn btn-primary w-100",onClick:()=>H(!0),disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Searching..."]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{icon:"mdi:magnify",className:"me-2"}),"Search Users"]})})})]}),ne&&e.jsxs("div",{className:"alert alert-warning mb-3",children:[e.jsx(l,{icon:"mdi:alert-circle",className:"me-2"}),ne]}),!v&&U.length>0&&e.jsxs("div",{className:"table-responsive",children:[e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Last Sign In"}),e.jsx("th",{children:"Provider"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:U.slice(0,20).map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:s.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.displayName||s.email)}&background=6366f1&color=fff`,alt:s.displayName||s.email,className:"rounded-circle me-2",width:"32",height:"32"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.displayName||"No Name"}),e.jsx("div",{className:"text-xs text-secondary",children:s.uid})]})]})}),e.jsx("td",{children:s.email}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:s.metadata?.lastSignInTime?new Date(s.metadata.lastSignInTime).toLocaleDateString():"Never"})}),e.jsx("td",{children:e.jsx("span",{className:"badge bg-light text-dark",children:s.providerData?.[0]?.providerId||"Unknown"})}),e.jsx("td",{children:e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{M(s.email)},title:"Grant credits to this user",children:e.jsx(l,{icon:"mdi:wallet-plus"})}),e.jsx("button",{className:"btn btn-outline-info",onClick:()=>q(s.email),title:"View user's transaction history",children:e.jsx(l,{icon:"mdi:history"})})]})})]},s.uid))})]}),U.length>20&&e.jsx("div",{className:"text-center pt-3",children:e.jsxs("small",{className:"text-secondary",children:["Showing 20 of ",U.length," users. Use search to narrow results."]})})]}),!v&&U.length===0&&p&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(l,{icon:"mdi:account-search",className:"text-4xl text-secondary-light mb-2"}),e.jsxs("p",{className:"text-secondary",children:['No users found matching "',p,'"']})]})]})}),d&&E&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(l,{icon:"mdi:chart-line",className:"text-xl text-primary-600 me-2"}),"Platform Transaction History"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:N,disabled:z,children:z?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(l,{icon:"mdi:refresh"})}),e.jsxs("button",{className:"btn btn-outline-success btn-sm",onClick:async()=>{try{console.log("Testing basic wallets endpoints..."),await A();const s=await h.get("/api/wallets");console.log("Wallets endpoint works:",s.data);const a=await h.get("/api/wallets/admin/debug/wallets");console.log("Debug endpoint works:",a.data),o.success("Basic wallet endpoints work!")}catch(s){console.error("Basic endpoints test failed:",s);const a=s.response?.status,n=s.response?.data?.message||s.message;o.error(`Basic endpoints failed (${a}): ${n}`)}},children:[e.jsx(l,{icon:"mdi:check-circle",className:"me-1"}),"Test Basic"]}),e.jsxs("button",{className:"btn btn-outline-warning btn-sm",onClick:async()=>{try{console.log("Testing transaction endpoint directly..."),console.log("Current API base URL:",h.defaults.baseURL),await A();const s=`${h.defaults.baseURL||""}/api/wallets/admin/transactions`;console.log("Full URL being called:",s);const a=await h.get("/api/wallets/admin/transactions",{params:{limit:10}});console.log("Transaction endpoint test response:",a),o.success(`Transaction endpoint works! Found ${a.data?.transactions?.length||0} transactions`)}catch(s){console.error("Transaction endpoint test failed:",s),console.error("Request config:",s.config),console.error("Request URL:",s.config?.url),console.error("Full request details:",{baseURL:s.config?.baseURL,url:s.config?.url,method:s.config?.method,headers:s.config?.headers});const a=s.response?.status,n=s.response?.data?.message||s.message;o.error(`Transaction endpoint failed (${a}): ${n}`)}},children:[e.jsx(l,{icon:"mdi:database-search",className:"me-1"}),"Test Transactions"]}),e.jsxs("button",{className:"btn btn-outline-info btn-sm",onClick:async()=>{try{const s=await h.get("/api/health");console.log("Health check:",s.data);const n=await(await fetch("http://localhost:5055/api/health")).json();console.log("Direct health check:",n),await A();const t=await h.get("/api/wallets/admin/debug/wallets");console.log("Debug response:",t.data),o.success("Backend connection successful!")}catch(s){console.error("Backend connection failed:",s);const a=s.response?.status,n=s.response?.data?.message||s.message;a===404?o.error("Endpoint not found (404). Check backend routes."):a===401||a===403?o.error("Authentication failed. Please sign in again."):o.error(`Backend connection failed: ${n}`)}},children:[e.jsx(l,{icon:"mdi:bug",className:"me-1"}),"Test Backend"]}),e.jsxs("button",{className:"btn btn-outline-secondary btn-sm",onClick:ve,children:[e.jsx(l,{icon:"mdi:filter-off",className:"me-1"}),"Clear Filters"]})]})]}),e.jsxs("div",{className:"row g-3 mb-4 p-3 bg-light rounded",children:[e.jsx("div",{className:"col-12",children:e.jsxs("h6",{className:"mb-2",children:[e.jsx(l,{icon:"mdi:filter",className:"me-1"}),"Transaction Filters"]})}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-3",children:[e.jsx("label",{className:"form-label text-sm",children:"User Email"}),e.jsx("input",{type:"email",className:"form-control form-control-sm",placeholder:"Filter by user email...",value:i.userEmail,onChange:s=>j(a=>({...a,userEmail:s.target.value}))})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-2",children:[e.jsx("label",{className:"form-label text-sm",children:"Transaction Type"}),e.jsxs("select",{className:"form-select form-select-sm",value:i.type,onChange:s=>j(a=>({...a,type:s.target.value})),children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"credit",children:"Credit"}),e.jsx("option",{value:"debit",children:"Debit"}),e.jsx("option",{value:"adjustment",children:"Adjustment"})]})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-2",children:[e.jsx("label",{className:"form-label text-sm",children:"Date From"}),e.jsx("input",{type:"date",className:"form-control form-control-sm",value:i.dateFrom,onChange:s=>j(a=>({...a,dateFrom:s.target.value}))})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-2",children:[e.jsx("label",{className:"form-label text-sm",children:"Date To"}),e.jsx("input",{type:"date",className:"form-control form-control-sm",value:i.dateTo,onChange:s=>j(a=>({...a,dateTo:s.target.value}))})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-1",children:[e.jsx("label",{className:"form-label text-sm",children:"Min Amount"}),e.jsx("input",{type:"number",className:"form-control form-control-sm",placeholder:"0",value:i.minAmount,onChange:s=>j(a=>({...a,minAmount:s.target.value}))})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-2",children:[e.jsx("label",{className:"form-label text-sm",children:"Max Amount"}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("input",{type:"number",className:"form-control form-control-sm",placeholder:"∞",value:i.maxAmount,onChange:s=>j(a=>({...a,maxAmount:s.target.value}))}),e.jsx("button",{className:"btn btn-primary btn-sm",onClick:we,disabled:z,children:e.jsx(l,{icon:"mdi:magnify"})})]})]})]}),x.length>0&&e.jsxs("div",{className:"row g-3 mb-4",children:[e.jsx("div",{className:"col-6 col-md-3",children:e.jsxs("div",{className:"bg-primary-50 p-3 rounded text-center",children:[e.jsx("div",{className:"text-sm text-secondary",children:"Total Transactions"}),e.jsx("div",{className:"h5 text-primary mb-0",children:x.length})]})}),e.jsx("div",{className:"col-6 col-md-3",children:e.jsxs("div",{className:"bg-success-50 p-3 rounded text-center",children:[e.jsx("div",{className:"text-sm text-secondary",children:"Total Credits"}),e.jsxs("div",{className:"h5 text-success mb-0",children:["R ",T(x.filter(s=>s.type==="credit").reduce((s,a)=>s+(a.amount||0),0))]})]})}),e.jsx("div",{className:"col-6 col-md-3",children:e.jsxs("div",{className:"bg-danger-50 p-3 rounded text-center",children:[e.jsx("div",{className:"text-sm text-secondary",children:"Total Debits"}),e.jsxs("div",{className:"h5 text-danger mb-0",children:["R ",T(x.filter(s=>s.type==="debit").reduce((s,a)=>s+(a.amount||0),0))]})]})}),e.jsx("div",{className:"col-6 col-md-3",children:e.jsxs("div",{className:"bg-info-50 p-3 rounded text-center",children:[e.jsx("div",{className:"text-sm text-secondary",children:"Unique Users"}),e.jsx("div",{className:"h5 text-info mb-0",children:new Set(x.map(s=>s.userEmail)).size})]})})]}),z?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"text-secondary mt-2",children:"Loading transaction history..."})]}):x.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"User"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Description"}),e.jsx("th",{className:"text-end",children:"Amount"}),e.jsx("th",{className:"text-end",children:"Balance After"}),e.jsx("th",{children:"Reference"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Ce.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("span",{className:"text-sm",children:[new Date(s.createdAt).toLocaleDateString(),e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:new Date(s.createdAt).toLocaleTimeString()})]})}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:`https://ui-avatars.com/api/?name=${encodeURIComponent(s.userEmail||"Unknown")}&background=6366f1&color=fff&size=24`,alt:s.userEmail,className:"rounded-circle me-2",width:"24",height:"24"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm fw-medium",children:s.userEmail}),s.userName&&e.jsx("small",{className:"text-muted",children:s.userName})]})]})}),e.jsx("td",{children:e.jsxs("span",{className:`badge ${s.type==="credit"?"bg-success":s.type==="debit"?"bg-danger":"bg-warning"}`,children:[e.jsx(l,{icon:s.type==="credit"?"mdi:plus-circle":s.type==="debit"?"mdi:minus-circle":"mdi:circle-edit-outline",className:"me-1"}),s.type]})}),e.jsxs("td",{children:[e.jsx("span",{className:"text-sm",children:s.description}),s.metadata&&e.jsxs("div",{className:"text-xs text-muted",children:[s.metadata.source&&`Source: ${s.metadata.source}`,s.metadata.note&&` | ${s.metadata.note}`]})]}),e.jsx("td",{className:"text-end",children:e.jsxs("span",{className:`text-sm fw-medium ${s.type==="credit"?"text-success":"text-danger"}`,children:[s.type==="credit"?"+":"-","R ",T(s.amount)]})}),e.jsx("td",{className:"text-end",children:e.jsxs("span",{className:"text-sm",children:["R ",T(s.balanceAfter)]})}),e.jsx("td",{children:s.reference&&e.jsx("small",{className:"text-muted font-monospace",children:s.reference})}),e.jsx("td",{children:e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx("button",{className:"btn btn-outline-info",onClick:()=>q(s.userEmail),title:"View user's full wallet",children:e.jsx(l,{icon:"mdi:wallet"})}),e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{M(s.userEmail)},title:"Grant credits to this user",children:e.jsx(l,{icon:"mdi:wallet-plus"})})]})})]},s.id))})]})}),F>1&&e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{className:"text-sm text-secondary",children:["Showing ",(u-1)*b+1," to ",Math.min(u*b,x.length)," of ",x.length," transactions"]}),e.jsx("nav",{children:e.jsxs("ul",{className:"pagination pagination-sm mb-0",children:[e.jsx("li",{className:`page-item ${u===1?"disabled":""}`,children:e.jsx("button",{className:"page-link",onClick:()=>L(u-1),disabled:u===1,children:e.jsx(l,{icon:"mdi:chevron-left"})})}),Array.from({length:Math.min(5,F)},(s,a)=>{const n=Math.max(1,Math.min(F-4,u-2))+a;return e.jsx("li",{className:`page-item ${n===u?"active":""}`,children:e.jsx("button",{className:"page-link",onClick:()=>L(n),children:n})},n)}),e.jsx("li",{className:`page-item ${u===F?"disabled":""}`,children:e.jsx("button",{className:"page-link",onClick:()=>L(u+1),disabled:u===F,children:e.jsx(l,{icon:"mdi:chevron-right"})})})]})})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(l,{icon:"mdi:chart-line-variant",className:"text-4xl text-secondary-light mb-2"}),e.jsx("p",{className:"text-secondary",children:"No transactions found matching the current filters."}),e.jsxs("button",{className:"btn btn-outline-primary btn-sm",onClick:N,children:[e.jsx(l,{icon:"mdi:refresh",className:"me-1"}),"Load Transaction History"]})]})]})}),d&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(l,{icon:"mdi:account-group",className:"text-xl text-primary-600 me-2"}),"Local Users & Wallets"]}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:w,disabled:Q,children:Q?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(l,{icon:"mdi:refresh"})})]}),e.jsx("div",{className:"row mb-3",children:e.jsx("div",{className:"col-12 col-md-6",children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx(l,{icon:"mdi:magnify"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Search local users...",value:f,onChange:s=>je(s.target.value)})]})})}),Q?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"text-secondary mt-2",children:"Loading users..."})]}):ce.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Tenant"}),e.jsx("th",{children:"Wallet Balance"}),e.jsx("th",{children:"Last Activity"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:ce.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:s.avatar,alt:s.name,className:"rounded-circle me-2",width:"32",height:"32"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.name}),e.jsx("div",{className:"text-xs text-secondary",children:s.email})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.role==="admin"?"bg-danger":s.role==="vendor"?"bg-warning":"bg-secondary"}`,children:s.role})}),e.jsx("td",{children:s.tenantId}),e.jsx("td",{children:e.jsxs("span",{className:"fw-medium",children:["R ",T(s.walletBalance)]})}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:new Date(s.lastActivity).toLocaleDateString()})}),e.jsx("td",{children:e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{M(s.email)},title:"Grant credits to this user",children:e.jsx(l,{icon:"mdi:wallet-plus"})}),e.jsx("button",{className:"btn btn-outline-info",onClick:()=>q(s.email),title:"View user's transaction history",children:e.jsx(l,{icon:"mdi:history"})})]})})]},s.uid))})]})}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(l,{icon:"mdi:account-search",className:"text-4xl text-secondary-light mb-2"}),e.jsx("p",{className:"text-secondary",children:f?`No users found matching "${f}"`:"No users found"})]})]})})]})}const He=()=>e.jsx(e.Fragment,{children:e.jsxs(Ue,{children:[e.jsx(Fe,{title:"My Wallet"}),e.jsx($e,{})]})});export{He as default};
