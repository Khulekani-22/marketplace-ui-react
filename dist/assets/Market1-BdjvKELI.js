import{d as q,b as Y,a as v,i as D,j as e,k as Q,s as T}from"./index-Bn5LcKgl.js";import{r as l,b as V}from"./vendor-DW3XjTa1.js";import"./firebase-BBiW2ZCr.js";import"./utils-B2rxisVD.js";const z=new Intl.NumberFormat("en-ZA");function j(i){if(typeof i=="number"&&Number.isFinite(i))return i;if(i==null)return 0;const h=String(i),b=Number(h.replace(/[^0-9.]/g,""));return Number.isFinite(b)?b:0}function m(i){return z.format(Math.round(i))}function J(){const[i,h]=l.useState([]),[b,C]=l.useState(""),[M,N]=l.useState(!0),[w,x]=l.useState(()=>new Set),[n,o]=l.useState({open:!1,service:null,working:!1,error:"",success:""}),[R,F]=l.useState(()=>new Set),f=V(),I=l.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),{wallet:d,loading:g,eligible:u,redeemCredits:L}=q(),p=l.useCallback(async()=>{N(!0);const{data:s}=await Y.get("/api/data/services",{params:{q:b||void 0,page:1,pageSize:40,featured:"true"}});h(Array.isArray(s.items)?s.items:[]),N(!1)},[b]);l.useEffect(()=>{p()},[p]),l.useEffect(()=>{(async()=>{try{if(!v.currentUser)return;const s=await D(),r=new Set(s.filter(t=>(t.type||"service")==="service").map(t=>String(t.serviceId)));x(r)}catch{}})()},[I]),l.useEffect(()=>{if(!n.open||typeof document>"u")return;const{body:s}=document;if(s)return s.classList.add("modal-open"),()=>s.classList.remove("modal-open")},[n.open]);async function E(s){try{if(!v.currentUser){f("/login",{replace:!0,state:{from:window.location?.pathname||"/"}});return}const r=String(s);w.has(r)?(await Q(r),x(a=>{const c=new Set(a);return c.delete(r),c})):(await T(r),x(a=>{const c=new Set(a);return c.add(r),c}))}catch{}}function P(s){if(!v.currentUser){f("/login",{replace:!0,state:{from:window.location?.pathname||"/"}});return}o({open:!0,service:s,working:!1,error:u?"":"My Wallet is only available to startup and vendor accounts.",success:""})}function y(){o({open:!1,service:null,working:!1,error:"",success:""})}async function W(){const s=n.service;if(!s)return;if(!u){o(t=>({...t,error:"Your account does not have voucher access yet."}));return}if(!d){o(t=>({...t,error:"We could not load your wallet. Please try again."}));return}const r=j(s.price);if(r<=0){o(t=>({...t,success:"This listing does not require voucher credits.",error:""}));return}if(d.balance<r){o(t=>({...t,error:"You do not have enough voucher credits for this listing."}));return}o(t=>({...t,working:!0,error:"",success:""}));try{const t=await L(r,{description:`Listing purchase: ${s.title||"Marketplace service"}`,reference:`listing-${s.id||"unknown"}`,metadata:{serviceId:s.id||null,vendor:s.vendor||null,category:s.category||null}});if(!t.ok){o(a=>({...a,working:!1,error:t.error||"Unable to redeem vouchers."}));return}F(a=>{const c=new Set(a);return c.add(String(s.id)),c}),o(a=>({...a,working:!1,error:"",success:`Voucher applied! Remaining balance: ${m(t.wallet?.balance||0)} credits.`}))}catch{o(a=>({...a,working:!1,error:"Unable to redeem vouchers."}))}}function U(){if(!n.open||!n.service)return null;const s=n.service,r=j(s.price),t=d?.balance??0,a=Math.max(0,r-t),c=n.working||g||!u||!d||r<=0||t<r;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal fade show d-block",tabIndex:-1,role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Redeem voucher credits"}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:y})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("h6",{className:"mb-1",children:s.title}),e.jsx("p",{className:"text-muted mb-3",children:s.description||"Marketplace listing"}),e.jsxs("dl",{className:"row mb-0",children:[e.jsx("dt",{className:"col-6",children:"Listing price"}),e.jsxs("dd",{className:"col-6 text-end",children:["R ",m(r)]}),e.jsx("dt",{className:"col-6",children:"Wallet balance"}),e.jsxs("dd",{className:"col-6 text-end",children:["R ",m(t)]}),e.jsx("dt",{className:"col-6",children:"After redeeming"}),e.jsxs("dd",{className:"col-6 text-end",children:["R ",m(Math.max(0,t-r))]})]}),!u&&e.jsx("div",{className:"alert alert-warning mt-3 mb-0",children:"My Wallet is only available to startup and vendor accounts."}),u&&d&&a>0&&e.jsxs("div",{className:"alert alert-warning mt-3 mb-0",children:["You need an additional ",m(a)," credits to redeem this listing."]}),n.error&&e.jsx("div",{className:"alert alert-danger mt-3 mb-0",children:n.error}),n.success&&e.jsx("div",{className:"alert alert-success mt-3 mb-0",children:n.success})]}),e.jsxs("div",{className:"modal-footer d-flex justify-content-between",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:y,disabled:n.working,children:"Close"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>void W(),disabled:c,children:n.working?"Processing…":"Redeem now"})]})]})})}),e.jsx("div",{className:"modal-backdrop fade show"})]})}return e.jsxs("div",{className:"container py-4",children:[e.jsxs("div",{className:"d-flex align-items-end justify-content-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"h4 mb-1",children:"Featured Marketplace"}),e.jsx("small",{className:"text-muted",children:"Discover services from trusted vendors"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("input",{className:"form-control",placeholder:"Search…",value:b,onChange:s=>C(s.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:p,children:"Search"})]})]}),u&&d&&e.jsxs("div",{className:"alert alert-primary d-flex justify-content-between align-items-center",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"My Wallet:"})," ",m(d.balance)," credits available."]}),e.jsx("button",{className:"btn btn-sm btn-outline-light",onClick:()=>f("/wallet"),children:"View wallet"})]}),M?e.jsx("p",{children:"Loading…"}):e.jsxs("div",{className:"row g-3",children:[i.length===0&&e.jsx("p",{className:"text-muted",children:"No featured services yet."}),i.map(s=>{const r=j(s.price),t=String(s.id),a=R.has(t),c=w.has(t),S=d?.balance??0,k=u&&d&&r>S,A=a?"Redeemed":u?"Redeem":"Select",$=a?"btn btn-success btn-sm":"btn btn-outline-primary btn-sm";return e.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start gap-2",children:[e.jsx("h5",{className:"card-title mb-0",children:s.title}),s.isFeatured&&e.jsx("span",{className:"badge text-bg-success",children:"Featured"})]}),e.jsxs("div",{className:"text-muted mb-2",children:[s.category," · ",s.vendor]}),e.jsx("p",{className:"flex-grow-1",children:s.description||"Quality service for SMMEs."}),e.jsxs("div",{className:"d-flex flex-column gap-2",children:[e.jsxs("strong",{children:["R ",m(r)]}),u&&d&&e.jsx("small",{className:k?"text-danger":"text-success",children:k?`Short by ${m(r-S)} credits`:"Covered by your voucher balance"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("button",{className:$,onClick:()=>P(s),disabled:g||a,children:g?"Checking wallet…":A}),e.jsx("button",{className:c?"btn btn-sm btn-secondary":"btn btn-sm btn-primary",onClick:()=>E(s.id),children:c?"Subscribed":"Subscribe"})]})]})]})})},t)})]}),U()]})}export{J as default};
