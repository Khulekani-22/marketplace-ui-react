import{d as Ie,r as m,b as Ce,a as se,j as e,L as te,c as D}from"./index-1xXifhh4.js";import{u as _e,M as ke}from"./MasterLayout-12_PyrKn.js";import{B as Le}from"./Breadcrumb-DCAKCTBT.js";import{I as v}from"./iconify-Dl13qa3R.js";import{u as Me}from"./useAppSync-7L5yo-ON.js";const Ae=()=>{var Z;const{threads:y,unreadCount:ae,markRead:ne,refresh:q,loading:ie,refreshing:z,error:F,syncMessagesToLive:P}=_e(),{vendor:t}=Ie(),[L,re]=m.useState(""),[I,B]=m.useState("inbox"),O=(typeof window<"u"?sessionStorage.getItem("role"):null)||"",[b,le]=m.useState(()=>{const s=(typeof window<"u"?sessionStorage.getItem("messageViewAs"):null)||"";return s||(O==="admin"?t!=null&&t.vendorId?"vendor":"admin":t!=null&&t.vendorId?"vendor":"user")}),[a,g]=m.useState({open:!1,mode:t!=null&&t.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1,subscriberEmail:""}),[U,M]=m.useState([]),[ce,C]=m.useState([]),[l,N]=m.useState({q:"",page:1,pageSize:10,total:0,items:[],loading:!1}),j=(typeof window<"u"?sessionStorage.getItem("tenantId"):null)||"vendor",{appData:A}=Me(),K=m.useMemo(()=>(j==="vendor"?"public":j).toString().toLowerCase(),[j]),f=(((Z=Ce.currentUser)==null?void 0:Z.email)||sessionStorage.getItem("userEmail")||"").toLowerCase(),W=O,E=W==="admin"||!!(t!=null&&t.vendorId),T=(t==null?void 0:t.vendorId)||(t==null?void 0:t.id)||"",_=m.useMemo(()=>{const s=[];return b==="user"?f&&s.push(`user:${f}`):b==="vendor"?(T&&s.push(`vendor:${String(T).toLowerCase()}`),f&&s.push(`vendor:${f}`)):b==="admin"&&(s.push("admin"),f&&s.push(`admin:${f}`)),s},[b,f,T]),H=m.useMemo(()=>y.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(n=>_.includes(String(n.senderId||"").toLowerCase()))),[y,_]),oe=m.useMemo(()=>y.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(n=>!_.includes(String(n.senderId||"").toLowerCase()))),[y,_]),de=H.length,me=oe.length,V=I==="sent"?H:y,Y=m.useMemo(()=>{const s=L.trim().toLowerCase();return s?V.filter(n=>{var i;const r=(n.subject||"").toLowerCase(),o=(((i=n.lastMessage)==null?void 0:i.snippet)||"").toLowerCase();return r.includes(s)||o.includes(s)}):V},[V,L]),ue=ae===0,be=async()=>{await Promise.all(y.filter(s=>!s.read).map(s=>ne(s.id,!0)))},[G,J]=m.useState(!1),[ge,$]=m.useState(!1),[Q,S]=m.useState(""),[X,pe]=m.useState(()=>{try{return localStorage.getItem("sl_messages_last_sync")||""}catch{return""}});async function xe(){if(!E){S("Vendor or admin access required to sync."),setTimeout(()=>S(""),2500);return}J(!0),S(""),$(!1);try{if(!await P())throw new Error("Sync did not complete");const n=new Date().toISOString();try{localStorage.setItem("sl_messages_last_sync",n)}catch{}pe(n),$(!0),setTimeout(()=>$(!1),1500)}catch(s){S((s==null?void 0:s.message)||"Sync failed"),setTimeout(()=>S(""),2500)}finally{J(!1)}}m.useEffect(()=>{try{sessionStorage.setItem("messageViewAs",b)}catch{}g(s=>({...s,mode:b==="vendor"?"vendor_admin":"vendor_subscriber",serviceId:"",subscriberEmail:""}))},[b]);function he(){g(s=>({...s,open:!0}))}function k(){g({open:!1,mode:t!=null&&t.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1})}async function fe(){try{const s=A||se,n=Array.isArray(s==null?void 0:s.services)?s.services:[];if(t!=null&&t.vendorId){const r=n.filter(o=>String(o.vendorId||"")===String(t.vendorId));M(r.map(o=>({id:o.id,title:o.title})))}else M([]);try{const o=(await D.get("/api/subscriptions/my").then(i=>Array.isArray(i.data)?i.data:[])).map(i=>{var c;return{...i,title:((c=n.find(p=>String(p.id)===String(i.serviceId)))==null?void 0:c.title)||i.serviceId}});C(o)}catch(r){if((r==null?void 0:r.code)==="ERR_NETWORK"){const i=(j==="vendor"?"public":j).toString().toLowerCase(),h=(Array.isArray(s==null?void 0:s.subscriptions)?s.subscriptions:[]).filter(u=>{const x=((u==null?void 0:u.tenantId)??"public").toString().toLowerCase()===i,w=((u==null?void 0:u.email)||"").toLowerCase();return x&&w===f}).map(u=>{var x;return{...u,title:((x=n.find(w=>String(w.id)===String(u.serviceId)))==null?void 0:x.title)||u.serviceId}});C(h)}else C([])}}catch{M([]),C([])}}const ve=m.useCallback((s,n="",r=1,o=10)=>{if(!s)return{items:[],total:0};const i=A||se,c=Array.isArray(i==null?void 0:i.subscriptions)?i.subscriptions:[],p=t!=null&&t.vendorId?String(t.vendorId).toLowerCase():"",h=(n||"").trim().toLowerCase(),u=c.filter(d=>{const Ne=((d==null?void 0:d.tenantId)??"public").toString().toLowerCase()===K,Se=String((d==null?void 0:d.serviceId)||"")===String(s),we=p?String((d==null?void 0:d.vendorId)||"").toLowerCase()===p:!0;return Ne&&Se&&we}),x=h?u.filter(d=>((d==null?void 0:d.email)||"").toLowerCase().includes(h)):u,w=x.length,ee=Math.max(0,(Number(r)-1)*Number(o)),je=ee+Number(o);return{items:x.slice(ee,je).map(d=>({id:d.id||`${d.serviceId}-${d.email}`,email:d.email,tenantId:d.tenantId,serviceId:d.serviceId})),total:w}},[A,K,t]);async function R(s,n=l.q,r=l.page,o=l.pageSize){try{N(x=>({...x,loading:!0}));const{data:i}=await D.get(`/api/subscriptions/service/${encodeURIComponent(s)}`,{params:{q:n,page:r,pageSize:o}}),c=Number((i==null?void 0:i.page)||r),p=Number((i==null?void 0:i.pageSize)||o),h=Number((i==null?void 0:i.total)||0),u=Array.isArray(i==null?void 0:i.items)?i.items:[];N({q:n,page:c,pageSize:p,total:h,items:u,loading:!1})}catch{const i=ve(s,n,r,o);N(c=>i.total>0?{q:n,page:r,pageSize:o,total:i.total,items:i.items,loading:!1}:{...c,q:n,page:r,pageSize:o,loading:!1})}}m.useEffect(()=>{a.open&&fe()},[a.open,t==null?void 0:t.vendorId,j]),m.useEffect(()=>{a.open&&a.mode==="vendor_to_subscriber"&&a.serviceId?R(a.serviceId,l.q,1,l.pageSize):N({q:"",page:1,pageSize:10,total:0,items:[],loading:!1})},[a.open,a.mode,a.serviceId]);async function ye(s){var n,r,o,i;if((n=s==null?void 0:s.preventDefault)==null||n.call(s),!(!a.serviceId||!a.content.trim())){g(c=>({...c,sending:!0,err:null,ok:!1}));try{const p={type:a.mode==="vendor_admin"?"vendor_admin":a.mode==="vendor_to_subscriber"?"vendor_to_subscriber":"vendor_subscriber",serviceId:a.serviceId,listingId:a.serviceId,subject:a.subject,content:a.content,subscriberEmail:a.mode==="vendor_to_subscriber"?a.subscriberEmail:void 0};await D.post("/api/messages/compose",p),g(h=>({...h,sending:!1,ok:!0})),await q({force:!0});try{await P()}catch{}setTimeout(()=>k(),1200)}catch(c){const p=(r=c==null?void 0:c.response)==null?void 0:r.status,h=((i=(o=c==null?void 0:c.response)==null?void 0:o.data)==null?void 0:i.message)||(c==null?void 0:c.message)||"Failed to send",u=p===401?" Please sign in to send messages.":"";g(x=>({...x,sending:!1,err:h+u}))}}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-xxl-3",children:e.jsx("div",{className:"card h-100 p-0",children:e.jsx("div",{className:"card-body p-24",children:e.jsxs("div",{className:"mt-16",children:[e.jsxs("button",{type:"button",className:"btn btn-primary btn-sm w-100 mb-3 d-flex align-items-center gap-2",onClick:he,disabled:b==="admin",children:[e.jsx(v,{icon:"fa6-regular:square-plus",className:"icon text-lg line-height-1"}),"Compose"]}),e.jsxs("ul",{children:[e.jsx("li",{className:"item-active mb-4",children:e.jsx("button",{type:"button",onClick:()=>B("inbox"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${I==="inbox"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(v,{icon:"uil:envelope",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Message Center"})]}),e.jsx("span",{className:"fw-medium",children:me})]})})}),e.jsx("li",{className:"mb-4",children:e.jsx("button",{type:"button",onClick:()=>B("sent"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${I==="sent"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(v,{icon:"ion:paper-plane-outline",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Sent"})]}),e.jsx("span",{className:"fw-medium",children:de})]})})})]})]})})})}),e.jsx("div",{className:"col-xxl-9",children:e.jsxs("div",{className:"card h-100 p-0 email-card",children:[e.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{q({silent:!0,force:!0})},disabled:ie||z,children:[e.jsx(v,{icon:"tabler:reload",className:"me-1"}),z?"Refreshing…":"Refresh"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:be,disabled:ue,children:[e.jsx(v,{icon:"gravity-ui:envelope-open",className:"me-1"})," Mark all as read"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:xe,disabled:G||!E,title:E?"Write messages to server appData.json":"Vendor or admin access required",children:[e.jsx(v,{icon:"mdi:cloud-upload-outline",className:"me-1"})," ",G?"Syncing…":"Sync Now"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("label",{className:"form-label mb-0 small text-muted",children:"View as"}),e.jsxs("select",{className:"form-select form-select-sm",value:b,onChange:s=>le(s.target.value),children:[e.jsx("option",{value:"user",children:"Startup"}),(t==null?void 0:t.vendorId)&&e.jsx("option",{value:"vendor",children:"Vendor"}),W==="admin"&&e.jsx("option",{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("form",{className:"navbar-search d-flex",onSubmit:s=>s.preventDefault(),children:[e.jsx("input",{type:"text",className:"bg-base h-40-px w-auto",name:"search",placeholder:"Search",value:L,onChange:s=>re(s.target.value)}),e.jsx(v,{icon:"ion:search-outline",className:"icon"})]}),e.jsx("div",{className:"small text-muted",children:Q?e.jsx("span",{className:"text-danger",children:Q}):ge?e.jsx("span",{className:"text-success",children:"Synced"}):X?`Last sync: ${new Date(X).toLocaleString()}`:""})]})]})}),e.jsxs("div",{className:"card-body p-0",children:[F&&e.jsx("div",{className:"alert alert-danger rounded-0 border-bottom mb-0",children:F}),e.jsxs("ul",{className:"overflow-x-auto",children:[Y.map(s=>{var n,r,o,i,c;return e.jsxs("li",{className:`email-item px-24 py-16 d-flex gap-4 align-items-center border-bottom cursor-pointer bg-hover-neutral-200 min-w-max-content ${s.read?"":"bg-primary-50"}`,children:[e.jsx(te,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium text-md text-line-1 w-190-px",children:s.subject||"Message"}),e.jsx(te,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium mb-0 text-line-1 max-w-740-px",children:((n=s.lastMessage)==null?void 0:n.snippet)||((i=(o=s.messages)==null?void 0:o[((r=s.messages)==null?void 0:r.length)-1])==null?void 0:i.content)||""}),e.jsx("span",{className:"text-primary-light fw-medium min-w-max-content ms-auto",children:(c=s.lastMessage)!=null&&c.date?new Date(s.lastMessage.date).toLocaleString():""})]},s.id)}),Y.length===0&&e.jsx("li",{className:"px-24 py-16 text-muted",children:I==="sent"?"No sent messages for this role; try switching “View as”.":"No messages yet. Try switching “View as” or start a conversation."})]})]})]})})]}),a.open&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&k(),children:e.jsxs("div",{className:"card",style:{maxWidth:640,margin:"8vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Compose message"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:k,children:"Close"})]}),e.jsxs("form",{onSubmit:ye,children:[e.jsxs("div",{className:"card-body",children:[a.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:a.err}),a.ok&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-select",value:a.mode,onChange:s=>g(n=>({...n,mode:s.target.value,serviceId:"",subscriberEmail:""})),children:[b==="vendor"&&(t==null?void 0:t.vendorId)&&e.jsx("option",{value:"vendor_admin",children:"Ask Admin about my listing"}),b==="user"&&e.jsx("option",{value:"vendor_subscriber",children:"Message Vendor about a subscribed listing"}),b==="vendor"&&(t==null?void 0:t.vendorId)&&e.jsx("option",{value:"vendor_to_subscriber",children:"Message a subscriber of my listing"})]})]}),a.mode==="vendor_admin"&&b==="vendor"&&(t==null?void 0:t.vendorId)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my listings"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>g(n=>({...n,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),U.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),a.mode==="vendor_subscriber"&&b==="user"&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my subscriptions"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>g(n=>({...n,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),ce.map(s=>e.jsx("option",{value:s.serviceId,children:s.title},s.id))]})]}),a.mode==="vendor_to_subscriber"&&b==="vendor"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select my listing"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>g(n=>({...n,serviceId:s.target.value,subscriberEmail:""})),children:[e.jsx("option",{value:"",children:"Select…"}),U.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"To (subscriber email)"}),e.jsx("input",{className:"form-control",value:a.subscriberEmail,onChange:s=>{const n=s.target.value;g(r=>({...r,subscriberEmail:n})),N(r=>({...r,q:n,page:1}))},placeholder:"Type to search subscribers",disabled:!a.serviceId}),a.serviceId&&e.jsxs("div",{className:"border rounded mt-2 p-2 bg-base",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"small text-secondary",children:"Suggestions"}),e.jsx("div",{className:"small text-secondary",children:l.loading?"Loading…":`${l.total} total`})]}),e.jsxs("div",{className:"list-group list-group-flush",style:{maxHeight:160,overflowY:"auto"},children:[l.items.map(s=>e.jsx("button",{type:"button",className:"list-group-item list-group-item-action py-1",onClick:()=>g(n=>({...n,subscriberEmail:s.email})),children:s.email},s.id)),!l.loading&&l.items.length===0&&e.jsx("div",{className:"text-muted small px-2 py-1",children:"No matches"})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:l.page<=1||l.loading,onClick:()=>R(a.serviceId,l.q,Math.max(1,l.page-1),l.pageSize),children:"Prev"}),e.jsxs("span",{className:"small text-secondary",children:["Page ",l.page," of ",Math.max(1,Math.ceil((l.total||0)/(l.pageSize||10)))]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:l.loading||l.page>=Math.ceil((l.total||0)/(l.pageSize||10)),onClick:()=>R(a.serviceId,l.q,l.page+1,l.pageSize),children:"Next"})]})]})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject (optional)"}),e.jsx("input",{className:"form-control",value:a.subject,onChange:s=>g(n=>({...n,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{rows:6,className:"form-control",value:a.content,onChange:s=>g(n=>({...n,content:s.target.value}))})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:k,disabled:a.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:a.sending||!a.serviceId||!a.content.trim()||a.mode==="vendor_to_subscriber"&&!a.subscriberEmail,children:a.sending?"Sending…":"Send"})]})]})]})})]})},ze=()=>e.jsx(e.Fragment,{children:e.jsxs(ke,{children:[e.jsx(Le,{title:"Message Center"}),e.jsx(Ae,{})]})});export{ze as default};
