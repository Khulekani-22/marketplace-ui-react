import{m as S,c,j as a,a as j,w as I}from"./index-BuQ02B8O.js";import{b as V,u as T,r as d}from"./vendor-DW3XjTa1.js";import{G as A,h as G,u as w,n as L,f as U}from"./firebase-ARhtPVQA.js";import"./utils-B2rxisVD.js";const W="/api/data/vendors";function q(){const f=V(),{search:x}=T(),{vendor:m,ensureVendorId:N,refresh:E}=S(),P=d.useMemo(()=>new URLSearchParams(x).get("next")||"/profile-vendor",[x]),[s,b]=d.useState({company:"",website:"",phone:"",email:"",password:"",agree:!1}),[h,p]=d.useState(!1),[v,r]=d.useState("");d.useEffect(()=>{c.currentUser?.email&&b(e=>({...e,email:c.currentUser.email}))},[]);function o(e,t){b(n=>({...n,[e]:t}))}async function u(e){try{await j.post("/api/users",{email:e,tenantId:"vendor",role:"member"})}catch{}try{sessionStorage.setItem("tenantId","vendor"),sessionStorage.setItem("role",sessionStorage.getItem("role")||"member")}catch{}}async function g(e){try{const t={id:e.id,name:e.name,contactEmail:e.contactEmail,email:e.contactEmail,ownerUid:e.id,phone:e.phone||"",website:e.website||"",kycStatus:e.kycStatus||"pending",categories:e.categories||[]};await j.post(W,t);try{await I({action:"VENDOR_CREATE",userEmail:e.contactEmail,targetType:"vendor",targetId:e.id,metadata:{name:e.name}})}catch{}}catch(t){const n=t?.response?.data?.message||t?.message||"Failed to save vendor profile";throw new Error(n)}}async function y(){try{await E?.(),await N?.()}finally{f(P,{replace:!0})}}async function C(){if(r(""),!s.agree){r("Please agree to the Terms and Privacy Policy.");return}p(!0);try{const e=new A,{user:t}=await G(c,e),n={id:t.uid,name:s.company||t.displayName||"Vendor",contactEmail:(t.email||"").toLowerCase(),phone:s.phone,website:s.website};if(s.company)try{await w(t,{displayName:s.company})}catch{}await g(n),await u(n.contactEmail),await y()}catch(e){const t=e?.code||"";r(t==="auth/popup-closed-by-user"?"Google sign-in was closed before completing.":e?.message||"Google sign-in failed")}finally{p(!1)}}async function k(e){if(e.preventDefault(),r(""),!s.agree){r("Please agree to the Terms and Privacy Policy.");return}p(!0);try{const{user:t}=await L(c,s.email,s.password);s.company&&await w(t,{displayName:s.company});const n={id:t.uid,name:s.company||(t.email?t.email.split("@")[0]:"Vendor"),contactEmail:(t.email||s.email).toLowerCase(),phone:s.phone,website:s.website};await g(n),await u(n.contactEmail),await y()}catch(t){const n=t?.code||"";if(n==="auth/email-already-in-use")try{const{user:i}=await U(c,s.email,s.password);if(s.company)try{await w(i,{displayName:s.company})}catch{}const l={id:i.uid,name:s.company||(i.email?i.email.split("@")[0]:"Vendor"),contactEmail:(i.email||s.email).toLowerCase(),phone:s.phone,website:s.website};await g(l),await u(l.contactEmail),await y()}catch(i){const l=i?.code||"";r(l==="auth/wrong-password"?"Email already registered. The password is incorrect. Please sign in or reset your password.":l==="auth/user-disabled"?"This account is disabled. Please contact support.":l==="auth/user-not-found"?"This email is registered with a different sign-in method. Try 'Continue with Google'.":i?.message||"Unable to sign in to existing account.")}else r(n==="auth/weak-password"?"Password is too weak. Please use at least 8 characters.":t?.message||"Sign up failed")}finally{p(!1)}}return a.jsxs("div",{className:"container py-4",style:{maxWidth:760},children:[a.jsx("h1",{className:"h3 mb-2",children:"Become a Vendor"}),a.jsx("p",{className:"text-secondary",children:"Create your vendor profile to list services on the marketplace. After signing up you’ll be redirected to your vendor workspace."}),v&&a.jsx("div",{className:"alert alert-danger",children:v}),a.jsxs("div",{className:"card mb-3",children:[a.jsx("div",{className:"card-header fw-semibold",children:"Vendor details"}),a.jsxs("div",{className:"card-body",children:[a.jsxs("form",{onSubmit:k,children:[a.jsxs("div",{className:"row g-3",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Company / Brand"}),a.jsx("input",{className:"form-control",value:s.company,onChange:e=>o("company",e.target.value),placeholder:"e.g., 22 On Sloane",required:!0})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Website"}),a.jsx("input",{className:"form-control",value:s.website,onChange:e=>o("website",e.target.value),placeholder:"https://your-site.co.za"})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Work Email"}),a.jsx("input",{type:"email",className:"form-control",value:s.email,onChange:e=>o("email",e.target.value),placeholder:"name@company.com",required:!0})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Phone"}),a.jsx("input",{className:"form-control",value:s.phone,onChange:e=>o("phone",e.target.value),placeholder:"+27 …"})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Password"}),a.jsx("input",{type:"password",className:"form-control",value:s.password,onChange:e=>o("password",e.target.value),minLength:8,placeholder:"Minimum 8 characters",required:!0})]}),a.jsxs("div",{className:"col-12 d-flex align-items-center gap-2 mt-2",children:[a.jsx("input",{id:"agree",type:"checkbox",className:"form-check-input",checked:s.agree,onChange:e=>o("agree",!!e.target.checked)}),a.jsxs("label",{htmlFor:"agree",className:"form-check-label",children:["I agree to the ",a.jsx("a",{href:"/terms-condition",target:"_blank",rel:"noreferrer",children:"Terms"})," and"," ",a.jsx("a",{href:"/privacy",target:"_blank",rel:"noreferrer",children:"Privacy Policy"}),"."]})]})]}),a.jsxs("div",{className:"d-flex gap-2 mt-3",children:[a.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",type:"submit",disabled:h||!s.agree||!s.company||!s.email||!s.password||s.password.length<8,children:h?"Creating…":"Create account"}),a.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>f(-1),children:"Cancel"})]})]}),a.jsx("div",{className:"text-center my-3 text-muted",children:"or"}),a.jsx("div",{className:"d-grid",children:a.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-600 bg-hover-primary-800 radius-8 px-12 py-6",onClick:C,disabled:h||!s.company||!s.agree,title:"Continue with Google",children:h?"Please wait…":"Continue with Google"})})]})]}),m?.vendorId&&a.jsxs("div",{className:"alert alert-info",children:["Signed in as ",a.jsx("strong",{children:m.name||m.email}),". Vendor ID:"," ",a.jsx("code",{children:m.vendorId})]})]})}export{q as default};
