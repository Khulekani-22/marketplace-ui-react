const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DaarVqB8.js","assets/index-BXSesTeZ.css"])))=>i.map(i=>d[i]);
import{u as pe,z as ge,c as he,r as c,b as h,_ as fe,j as t,L as ae}from"./index-DaarVqB8.js";import{M as xe}from"./MasterLayout-2uOgNMve.js";import{a as ie}from"./appData-vWFasogN.js";import"./iconify-CVdOCQR-.js";const U="/api/lms",z="__OTHER__";function se(){return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)}function ye(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return null}}function B(e){var n;return{id:(e==null?void 0:e.id)??se(),title:(e==null?void 0:e.title)??"",category:(e==null?void 0:e.category)??"",vendor:(e==null?void 0:e.vendor)??"",vendorId:(e==null?void 0:e.vendorId)??"",contactEmail:((e==null?void 0:e.contactEmail)||(e==null?void 0:e.email)||"").toLowerCase(),price:Number((e==null?void 0:e.price)||0),rating:Number((e==null?void 0:e.rating)||0),reviewCount:typeof(e==null?void 0:e.reviewCount)=="number"?e.reviewCount:Number((e==null?void 0:e.reviewCount)||((n=e==null?void 0:e.reviews)==null?void 0:n.length)||0),imageUrl:(e==null?void 0:e.imageUrl)??"",aiHint:(e==null?void 0:e.aiHint)??"",listingType:(e==null?void 0:e.listingType)??"service",status:(e==null?void 0:e.status)??"pending",isFeatured:!!(e!=null&&e.isFeatured),description:(e==null?void 0:e.description)??"",reviews:Array.isArray(e==null?void 0:e.reviews)?e.reviews:[]}}function ne(e,n={}){const r=((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||n.email||"").toLowerCase();return{id:String((e==null?void 0:e.id)??(e==null?void 0:e.vendorId)??n.vendorId??""),vendorId:String((e==null?void 0:e.vendorId)??(e==null?void 0:e.id)??n.vendorId??""),name:(e==null?void 0:e.name)??(e==null?void 0:e.companyName)??(e==null?void 0:e.vendor)??n.name??"",contactEmail:r,ownerUid:(e==null?void 0:e.ownerUid)??(e==null?void 0:e.uid)??n.uid??"",status:((e==null?void 0:e.status)||"active").toLowerCase()}}function re(e,n){if(!e)return null;const r=((n==null?void 0:n.email)||"").toLowerCase(),F=[Array.isArray(e.startups)&&e.startups,Array.isArray(e.vendors)&&e.vendors,Array.isArray(e.companies)&&e.companies,Array.isArray(e.profiles)&&e.profiles].filter(Boolean);for(const E of F){const y=E.find(s=>(s==null?void 0:s.ownerUid)&&s.ownerUid===(n==null?void 0:n.uid)||(s==null?void 0:s.email)&&s.email.toLowerCase()===r||(s==null?void 0:s.contactEmail)&&s.contactEmail.toLowerCase()===r||(n==null?void 0:n.vendorId)&&(String(s==null?void 0:s.vendorId)===String(n.vendorId)||String(s==null?void 0:s.id)===String(n.vendorId)));if(y)return ne(y,n)}return null}function ve(){var Q,X,Z;const e=pe(),[n]=ge(),{vendor:r,ensureVendorId:F,refresh:E}=he(),y=c.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[s,O]=c.useState(ie),[A,oe]=c.useState([]),le=c.useMemo(()=>{const a=(s==null?void 0:s.services)||[];return Array.from(new Set(a.map(u=>(u.category||"").trim()).filter(Boolean)))},[s]),[M,Y]=c.useState(!1),[H,I]=c.useState(""),[J,q]=c.useState(""),k=c.useMemo(()=>{const a=n.get("prefill");return a?ye(decodeURIComponent(a)):null},[n]),[g,ce]=c.useState(null);c.useEffect(()=>{let a=!0;return(async()=>{var u,b,S;await F();try{const x=await((b=(u=h.currentUser)==null?void 0:u.getIdToken)==null?void 0:b.call(u)),P=await fetch(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache",...x?{Authorization:`Bearer ${x}`}:{}}});let f=ie;if(P.ok){f=await P.json();const p=n.get("from");if(p){const m=(S=f==null?void 0:f.services)==null?void 0:S.find(j=>String(j.id)===String(p));m&&ce(m)}}try{const N=await(await fe(async()=>{const{api:m}=await import("./index-DaarVqB8.js").then(j=>j.A);return{api:m}},__vite__mapDeps([0,1]))).api.get("/api/data/vendors").then(m=>m.data||[]),p=JSON.parse(JSON.stringify(f));p.startups=Array.isArray(p.startups)?p.startups:[],N.forEach(m=>{const j=(m.email||m.contactEmail||"").toLowerCase(),T=String(m.vendorId||m.id||j||""),l=p.startups.findIndex(v=>String(v.vendorId||v.id)===T),$={...p.startups[l]||{},...m,vendorId:T,id:T};l>=0?p.startups[l]=$:p.startups.push($)}),f=p}catch{}a&&O(f);const D=await fetch(`${U}/checkpoints`,{headers:{"x-tenant-id":y,...x?{Authorization:`Bearer ${x}`}:{}}}).then(N=>N.ok?N.json():{items:[]});a&&oe(D.items||[])}catch{}})(),()=>{a=!1}},[y]);const i=c.useMemo(()=>{var u,b,S;const a={uid:(u=h.currentUser)==null?void 0:u.uid,email:((b=h.currentUser)==null?void 0:b.email)||(r==null?void 0:r.email)||"",name:((S=h.currentUser)==null?void 0:S.displayName)||(r==null?void 0:r.name)||"",vendorId:(r==null?void 0:r.vendorId)||""};return re(s,a)||ne({},a)},[s,r==null?void 0:r.vendorId,(Q=h.currentUser)==null?void 0:Q.uid,(X=h.currentUser)==null?void 0:X.email]);c.useEffect(()=>{!(r!=null&&r.vendorId)&&(i!=null&&i.vendorId)&&(E==null||E())},[i==null?void 0:i.vendorId]);const G=((i==null?void 0:i.status)||"").toLowerCase(),R=G==="active",_=G==="suspended",d=c.useMemo(()=>B(g||k||{}),[g,k]),[o,W]=c.useState({title:d.title||"",categoryChoice:d.category||"",categoryCustom:"",price:d.price?String(d.price):"",imageUrl:d.imageUrl||"",description:d.description||"",listingType:d.listingType||"service"});c.useEffect(()=>{W(a=>({...a,title:g?`${d.title} (Copy)`:d.title||a.title,categoryChoice:d.category||a.categoryChoice,price:d.price?String(d.price):a.price,imageUrl:d.imageUrl||a.imageUrl,description:d.description||a.description,listingType:d.listingType||a.listingType}))},[g==null?void 0:g.id]);function C(a,u){W(b=>({...b,[a]:u}))}const K=o.categoryChoice===z?o.categoryCustom.trim():(o.categoryChoice||"").trim(),de=((i==null?void 0:i.contactEmail)||"").toLowerCase()||(((Z=h.currentUser)==null?void 0:Z.email)||"").toLowerCase(),L=!(i!=null&&i.vendorId),w=L||_||!R;c.useEffect(()=>{if(h.currentUser&&(L||!R)){const a=encodeURIComponent(window.location.pathname+window.location.search);e(`/profile-vendor?next=${a}`)}},[L,R]);async function me(a){var f,D,N,p,m,j,T;if(a.preventDefault(),I(""),q(""),L){I("Please create your vendor profile before submitting a listing.");return}if(!R){I("Your vendor account is not yet approved. Please complete your profile and wait for admin approval.");return}if(_){I("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}if(!o.title.trim()||!K){I("Title and category are required.");return}const u=await((D=(f=h.currentUser)==null?void 0:f.getIdToken)==null?void 0:D.call(f)),b=await fetch(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache",...u?{Authorization:`Bearer ${u}`}:{}}}).then(l=>l.ok?l.json():s),S={uid:(N=h.currentUser)==null?void 0:N.uid,email:((p=h.currentUser)==null?void 0:p.email)||(r==null?void 0:r.email)||"",name:((m=h.currentUser)==null?void 0:m.displayName)||(r==null?void 0:r.name)||"",vendorId:(i==null?void 0:i.vendorId)||(r==null?void 0:r.vendorId)||""},x=re(b,S)||i;if(((x==null?void 0:x.status)||"").toLowerCase()==="suspended"){I("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}const P=B({id:se(),title:o.title.trim(),category:K,vendor:x.name||x.contactEmail||"Vendor",vendorId:x.vendorId,contactEmail:de,price:Number(o.price||0),rating:0,reviewCount:0,imageUrl:(o.imageUrl||"").trim(),listingType:o.listingType||"service",status:"pending",isFeatured:!1,description:(o.description||"").trim(),reviews:[],createdAt:new Date().toISOString(),...g?{source:"duplicate",clonedFrom:g.id}:{},...k&&!g?{source:"prefill"}:{}});Y(!0);try{const l=await((T=(j=h.currentUser)==null?void 0:j.getIdToken)==null?void 0:T.call(j)),$=await fetch(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache",...l?{Authorization:`Bearer ${l}`}:{}}}),v=$.ok?await $.json():s,V={...v,services:Array.isArray(v==null?void 0:v.services)?[...v.services,P]:[P]},ee=await fetch(`${U}/publish`,{method:"PUT",headers:{"Content-Type":"application/json","x-tenant-id":y,...l?{Authorization:`Bearer ${l}`}:{}},body:JSON.stringify({data:V})});if(!ee.ok)throw new Error(await ee.text());const te=await fetch(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache",...l?{Authorization:`Bearer ${l}`}:{}}});if(te.ok){const ue=await te.json();O(ue)}else O(V);q("Listing submitted! Itâ€™s now pending review by the marketplace admins."),setTimeout(()=>e("/listings-vendors-mine",{replace:!0}),850)}catch(l){I((l==null?void 0:l.message)||"Failed to submit listing."),window.scrollTo({top:0,behavior:"smooth"})}finally{Y(!1)}}return t.jsx(xe,{activeRoute:"/listings-vendors",pageTitle:"Submit a Listing",children:t.jsxs("div",{className:"container py-4",style:{maxWidth:880},children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[t.jsx("h1",{className:"h4 mb-0",children:"Submit a Listing"}),t.jsxs("div",{className:"text-muted small",children:["Vendor:"," ",i!=null&&i.vendorId?t.jsxs(t.Fragment,{children:[t.jsx("code",{className:"me-1",children:i.vendorId}),t.jsxs("span",{children:["(",i.name||i.contactEmail,")"]}),_&&t.jsx("span",{className:"badge text-bg-danger ms-2",children:"suspended"})]}):"not set"]})]}),L&&t.jsxs("div",{className:"alert alert-warning d-flex justify-content-between align-items-center",children:[t.jsx("div",{children:"You need a vendor profile before submitting a listing."}),t.jsx(ae,{to:"/signup/vendor?next=/listings-vendors",className:"btn btn-sm btn-primary",children:"Create vendor profile"})]}),!L&&_&&t.jsxs("div",{className:"alert alert-danger",children:["Your vendor account is ",t.jsx("strong",{children:"suspended"}),". You cannot submit listings. Please contact support if you think this is an error."]}),g&&t.jsxs("div",{className:"alert alert-info",children:["Duplicating from ",t.jsx("strong",{children:g.title}),". Adjust fields and submit to create a new ",t.jsx("strong",{children:"pending"})," listing."]}),k&&!g&&t.jsxs("div",{className:"alert alert-info",children:["Form prefilled. Review and submit to create a"," ",t.jsx("strong",{children:"pending"})," listing."]}),H&&t.jsx("div",{className:"alert alert-danger",children:H}),J&&t.jsx("div",{className:"alert alert-success",children:J}),t.jsxs("div",{className:"card bg-body",children:[t.jsx("div",{className:"card-header bg-body-tertiary fw-semibold",children:"Listing details"}),t.jsx("div",{className:"card-body",children:t.jsxs("form",{onSubmit:me,noValidate:!0,children:[t.jsxs("div",{className:"row g-3 mb-1",children:[t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Vendor"}),t.jsx("input",{className:"form-control",value:(i==null?void 0:i.name)||(i==null?void 0:i.contactEmail)||"",disabled:!0,"aria-readonly":"true"})]}),t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Vendor ID"}),t.jsx("input",{className:"form-control",value:(i==null?void 0:i.vendorId)||"",disabled:!0,"aria-readonly":"true"})]})]}),t.jsxs("div",{className:"row g-3",children:[t.jsxs("div",{className:"col-md-8",children:[t.jsx("label",{className:"form-label",children:"Title"}),t.jsx("input",{className:"form-control",value:o.title,onChange:a=>C("title",a.target.value),placeholder:"e.g., Modern Logo & Brand Identity Pack",required:!0,disabled:w})]}),t.jsxs("div",{className:"col-md-4",children:[t.jsx("label",{className:"form-label",children:"Listing type"}),t.jsxs("select",{className:"form-select",value:o.listingType,onChange:a=>C("listingType",a.target.value),disabled:w,children:[t.jsx("option",{value:"service",children:"Service"}),t.jsx("option",{value:"saas",children:"SaaS"})]})]})]}),t.jsxs("div",{className:"row g-3 mt-1",children:[t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Category"}),t.jsxs("select",{className:"form-select",value:o.categoryChoice,onChange:a=>C("categoryChoice",a.target.value),disabled:w,required:!0,children:[t.jsx("option",{value:"",disabled:!0,children:"Pick a category"}),le.map(a=>t.jsx("option",{value:a,children:a},a)),t.jsx("option",{value:z,children:"Otherâ€¦"})]})]}),o.categoryChoice===z&&t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Custom category"}),t.jsx("input",{className:"form-control",value:o.categoryCustom,onChange:a=>C("categoryCustom",a.target.value),placeholder:"Type a new category",disabled:w,required:!0})]}),t.jsxs("div",{className:"col-md-3",children:[t.jsx("label",{className:"form-label",children:"Price (R)"}),t.jsx("input",{type:"number",min:"0",className:"form-control",value:o.price,onChange:a=>C("price",a.target.value),placeholder:"e.g., 8500",disabled:w})]}),t.jsxs("div",{className:"col-md-3",children:[t.jsx("label",{className:"form-label",children:"Image URL"}),t.jsx("input",{className:"form-control",value:o.imageUrl,onChange:a=>C("imageUrl",a.target.value),placeholder:"https://â€¦",disabled:w})]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("label",{className:"form-label",children:"Description"}),t.jsx("textarea",{className:"form-control",rows:4,value:o.description,onChange:a=>C("description",a.target.value),placeholder:"Describe what buyers get, deliverables, timelines, etc.",disabled:w})]}),t.jsxs("div",{className:"border rounded p-2 mt-3",children:[t.jsx("div",{className:"text-muted small mb-1",children:"Card preview"}),t.jsxs("div",{className:"d-flex align-items-center gap-2",children:[t.jsx("img",{src:o.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:120,height:72,objectFit:"cover",borderRadius:6}}),t.jsxs("div",{children:[t.jsx("div",{className:"fw-semibold",children:o.title||"Untitled service"}),t.jsx("div",{className:"text-muted small",children:(i==null?void 0:i.name)||(i==null?void 0:i.contactEmail)||"Vendor"}),t.jsxs("div",{className:"small",children:["R",Number(o.price||0).toLocaleString()," Â· â˜… 0.0"]})]})]})]}),t.jsxs("div",{className:"d-flex gap-2 mt-3",children:[t.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",type:"submit",disabled:M||w,children:M?"Submittingâ€¦":"Submit for review"}),t.jsx(ae,{to:"/listings-vendors-mine",className:"btn btn-outline-secondary",children:"Cancel"})]}),t.jsxs("div",{className:"form-text mt-2",children:["Submissions are added as ",t.jsx("strong",{children:"pending"})," and become visible once approved by admins."]})]})})]}),t.jsxs("div",{className:"card mt-3",children:[t.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[t.jsx("span",{children:"Recent checkpoints"}),t.jsx("span",{className:"text-muted small",children:"Latest snapshots"})]}),t.jsxs("div",{className:"list-group list-group-flush",children:[!(A!=null&&A.length)&&t.jsx("div",{className:"list-group-item text-muted small",children:"No checkpoints yet."}),A==null?void 0:A.slice(0,4).map(a=>t.jsxs("div",{className:"list-group-item d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("div",{className:"fw-semibold",children:a.message||"(no message)"}),t.jsx("div",{className:"text-muted small",children:new Date(a.ts).toLocaleString()})]}),t.jsx("a",{className:"btn btn-sm btn-outline-secondary",href:`${U}/checkpoints/${a.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]},a.id))]})]})]})})}export{ve as default};
