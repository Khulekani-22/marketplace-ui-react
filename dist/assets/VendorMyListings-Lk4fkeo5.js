import{b as ie,u as je,l as ye,r as o,E as Ne,d as Se,c as ne,j as t,L as O}from"./index-C1K-Ttoc.js";import{u as ke,M as ve}from"./MasterLayout-2IldCL2c.js";import"./iconify-CXWIXv_s.js";async function we(c={}){var d;try{const{signal:h}=c,{data:n}=await ie.get("/api/data/services/mine",{signal:h}),A=Array.isArray(n==null?void 0:n.listings)?n.listings:[],T=Array.isArray(n==null?void 0:n.bookings)?n.bookings:[],z=(n==null?void 0:n.vendor)||null,K=typeof(n==null?void 0:n.tenantId)=="string"?n.tenantId:void 0;return{listings:A,bookings:T,vendor:z,tenantId:K}}catch(h){const n=(d=h==null?void 0:h.response)==null?void 0:d.status;if(n===401||n===403||n===404)return{listings:[],bookings:[]};throw h}}function q(c){if(!c)return"public";const d=c.toString().toLowerCase();return d==="vendor"?"public":d}function Ie(c,d){const h=q(c||"public"),n=(d||"").trim().toLowerCase();return n?`vendor_pending_listings:${h}:${n}`:null}function Y(c){return String((c==null?void 0:c.id)||(c==null?void 0:c.serviceId)||"")}function Ae(c){try{const d=typeof c=="string"?JSON.parse(c):c;return Array.isArray(d)?d:[]}catch{return[]}}function ae(c,d){const h=q(c),n=q(d);return h===n||h==="public"||n==="public"}function re({s:c}){const d=(c||"unknown").toLowerCase(),h={approved:"success",pending:"warning",rejected:"danger",scheduled:"info",completed:"success",canceled:"secondary",unknown:"secondary"};return t.jsx("span",{className:`badge text-bg-${h[d]||"secondary"}`,children:d})}function Te(){var se;const c=je(),d=ye(),h=o.useRef(null),{vendor:n,ensureVendorId:A,loading:T}=Ne(),{refresh:z,syncMessagesToLive:K}=ke(),{appData:Q,appDataLoading:X}=Se(),E=o.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[x,j]=o.useState([]),[S,k]=o.useState([]),[R,ce]=o.useState(!0),[Z,le]=o.useState(!1),[V,w]=o.useState(""),[g,y]=o.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1}),v=o.useMemo(()=>Ie(E,(n==null?void 0:n.vendorId)||(n==null?void 0:n.email)||(n==null?void 0:n.id)||""),[E,n==null?void 0:n.vendorId,n==null?void 0:n.email,n==null?void 0:n.id]),[I,$]=o.useState([]),f=(se=d.state)==null?void 0:se.newListing,D=o.useCallback(e=>{if($(e),!!v){if(!e.length){localStorage.removeItem(v);return}try{localStorage.setItem(v,JSON.stringify(e))}catch{}}},[v]);o.useEffect(()=>{if(!v){$([]);return}try{const e=Ae(localStorage.getItem(v));$(e)}catch{$([])}},[v]),o.useEffect(()=>{if(!f)return;h.current=f;const e=String((f==null?void 0:f.id)||(f==null?void 0:f.serviceId)||"");j(s=>s?s.some(i=>String((i==null?void 0:i.id)||(i==null?void 0:i.serviceId))===e)?s:[f,...s]:[f]),D([f,...I.filter(s=>String((s==null?void 0:s.id)||(s==null?void 0:s.serviceId)||"")!==e)]),w(""),c({pathname:d.pathname,search:d.search},{replace:!0,state:{}})},[f,c,d.pathname,d.search,D,I]);const C=o.useCallback(e=>{const s=Array.isArray(e)?[...e]:[],a=new Set(s.map(Y).filter(Boolean)),i=h.current;if(i){const u=Y(i);u&&!a.has(u)?(s.unshift(i),a.add(u)):h.current=null}if(I.length){const u=[];I.forEach(m=>{const r=Y(m);r&&(a.has(r)||(a.add(r),s.unshift(m),u.push(m)))}),u.length!==I.length&&D(u)}return s},[I,D]);o.useEffect(()=>{if(n&&!n.isApproved){const e=encodeURIComponent("/listings-vendors-mine");c(`/profile-vendor?next=${e}`,{replace:!0})}},[n,c]);function ee(e){var i,u,m;let s=e;const a=new Set;for(;s&&typeof s=="object"&&!Array.isArray(s==null?void 0:s.services)&&!a.has(s);){if(a.add(s),Array.isArray((i=s==null?void 0:s.data)==null?void 0:i.services)){s=s.data;continue}if(Array.isArray((u=s==null?void 0:s.payload)==null?void 0:u.services)){s=s.payload;continue}if(Array.isArray((m=s==null?void 0:s.appData)==null?void 0:m.services)){s=s.appData;continue}break}return s&&typeof s=="object"?s:null}const H=o.useCallback(e=>{if(!e)return{listings:[],bookings:[]};const s=ee(Q)||ee(ne)||ne,a=q(E),i=Array.isArray(s==null?void 0:s.services)?s.services:[],m=(Array.isArray(s==null?void 0:s.bookings)?s.bookings:[]).filter(l=>ae(l==null?void 0:l.tenantId,a)),r=String((e==null?void 0:e.vendorId)||""),b=String((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||"").toLowerCase(),p=String((e==null?void 0:e.name)||(e==null?void 0:e.companyName)||"").toLowerCase(),N=i.filter(l=>{if(!ae(l==null?void 0:l.tenantId,a))return!1;const M=String(l.vendorId||""),W=String(l.contactEmail||l.email||"").toLowerCase(),U=String(l.vendor||"").toLowerCase();return M&&r&&M===r||!M&&(U&&U===p||b&&W===b)}),G=new Set(N.flatMap(l=>[String(l.id||""),String(l.serviceId||""),String(l.vendorId||"")]).filter(Boolean)),L=m.filter(l=>{const P=String(l.serviceId||""),M=r&&String(l.vendorId||"")===r,W=b&&String(l.vendorEmail||"").toLowerCase()===b,U=p&&String(l.vendorName||"").toLowerCase()===p;return G.has(P)||M||W||U});return{listings:N,bookings:L}},[Q,E]),B=o.useCallback(async({signal:e,silent:s}={})=>{var u,m;const a=r=>{s?le(r):ce(r)};a(!0),w("");let i=n;try{if(e!=null&&e.aborted||T&&!n)return;if(!n){j([]),k([]);return}const r=A?await A():n;if(e!=null&&e.aborted)return;if(i=r||n,!i){j([]),k([]);return}const{listings:b,bookings:p}=await we({signal:e});if(e!=null&&e.aborted)return;const N=Array.isArray(b)?b:[],G=Array.isArray(p)?p:[],L=C(N);if(L.length)j(L),k(G);else{const l=H(i);if(l.listings.length){const P=C(l.listings);j(P),k(l.bookings),s||w("Showing cached listings until the live catalog updates.")}else j(L),k([])}}catch(r){if(e!=null&&e.aborted)return;if((r==null?void 0:r.code)==="ERR_NETWORK"){const p=H(i),N=C(p.listings);j(N),k(p.bookings),w("Showing cached data while the network is unavailable.")}else w(((m=(u=r==null?void 0:r.response)==null?void 0:u.data)==null?void 0:m.message)||(r==null?void 0:r.message)||"Failed to load listings"),j(C([])),k([])}finally{a(!1)}},[H,A,C,n,T]);o.useEffect(()=>{const e=new AbortController;return B({signal:e.signal}),()=>{e.abort()}},[B]);const oe=o.useCallback(async()=>{w(""),await B({silent:!0})},[B]),J=o.useMemo(()=>{const e={approved:0,pending:0,rejected:0};return x.forEach(s=>{const a=(s.status||"pending").toLowerCase();e[a]=(e[a]||0)+1}),e},[x]),de=o.useMemo(()=>{const e={};return S.forEach(s=>{const a=String(s.serviceId||"");a&&(e[a]=(e[a]||0)+1)}),e},[S]),ue=o.useMemo(()=>{const e={};return x.forEach(s=>{[String(s.id||""),String(s.serviceId||""),String(s.vendorId||"")].filter(Boolean).forEach(i=>{e[i]=s})}),e},[x]);function te(e){const s=(e+11)%12+1,a=e>=12?"PM":"AM";return`${s}:00 ${a}`}function me(e){if(!e)return"";const[s]=e.split(":"),a=Number(s);return Number.isNaN(a)?e:`${te(a)} – ${te(a+1)}`}function _(e){if(e!=null&&e.scheduledDate){const s=e.scheduledSlot||"00:00",a=`${e.scheduledDate}T${s.length===5?s:`${s}:00`}`,i=new Date(a);if(!Number.isNaN(i.getTime()))return i}if(e!=null&&e.bookedAt){const s=new Date(e.bookedAt);if(!Number.isNaN(s.getTime()))return s}return null}const ge=o.useMemo(()=>{const e=S.map(s=>({...s}));return e.sort((s,a)=>{var m,r;const i=((m=_(s))==null?void 0:m.getTime())??0,u=((r=_(a))==null?void 0:r.getTime())??0;return i-u}),e},[S]);function he(e){return e?{date:e.toLocaleDateString(),time:e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}:{date:"—",time:""}}function fe(e){const s=encodeURIComponent(JSON.stringify({title:e.title,category:e.category,price:e.price,imageUrl:e.imageUrl,description:e.description,listingType:e.listingType||"service"}));c(`/listings-vendors?prefill=${s}`)}function pe(e){const s=`Feedback request: ${e.title}`,a=`Hello Admin

My listing "${e.title}" (ID: ${e.id}) was ${String(e.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;y({open:!0,listing:e,subject:s,content:a,sending:!1,err:null,done:!1})}function be(){const e=`General inquiry from ${(n==null?void 0:n.name)||(n==null?void 0:n.companyName)||"vendor"}`;y({open:!0,listing:null,subject:e,content:`Hello Admin

I have a question/concern regarding my vendor account or listings.

[Please describe your question or concern here]

Thank you for your assistance!`,sending:!1,err:null,done:!1})}function F(){y({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function xe(e){var s;if((s=e==null?void 0:e.preventDefault)==null||s.call(e),!!g.content.trim()){y(a=>({...a,sending:!0,err:null}));try{const a={subject:g.subject,content:g.content,priority:"normal"};g.listing?(a.listingId=g.listing.id,a.listingTitle=g.listing.title,a.vendorId=(n==null?void 0:n.vendorId)||"",a.vendorEmail=(n==null?void 0:n.email)||""):a.to="admin@22onsloane.co",await ie.post("/api/messages",a),y(i=>({...i,sending:!1,done:!0}));try{await z({force:!0}),await K()}catch{}setTimeout(()=>F(),1200)}catch(a){y(i=>{var u,m;return{...i,sending:!1,err:((m=(u=a==null?void 0:a.response)==null?void 0:u.data)==null?void 0:m.message)||(a==null?void 0:a.message)||"Failed to send"}})}}}return t.jsx(ve,{children:t.jsxs("div",{className:"container py-4",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[t.jsx("h1",{className:"h4 mb-0",children:"My listings"}),t.jsxs("div",{className:"d-flex gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:oe,disabled:R||Z||X,children:Z||X?"Refreshing…":"Refresh"}),t.jsxs("button",{type:"button",className:"btn btn-outline-primary",onClick:()=>be(),title:"Contact admin about any questions or concerns",children:[t.jsx("i",{className:"bi bi-envelope me-1"}),"Message Admin"]}),t.jsx(O,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})]})]}),t.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[t.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",J.approved]}),t.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",J.pending]}),t.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",J.rejected]}),t.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",x.length]})]}),t.jsx("div",{className:"card",children:t.jsxs("div",{className:"card-body",children:[V&&t.jsx("div",{className:"alert alert-danger",children:V}),R&&t.jsx("div",{className:"text-muted",children:"Loading…"}),!R&&!x.length&&t.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",t.jsx(O,{to:"/listings-vendors",children:"Create your first one."})]}),!R&&!!x.length&&t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{width:72}}),t.jsx("th",{children:"Title"}),t.jsx("th",{children:"Category"}),t.jsx("th",{children:"Price"}),t.jsx("th",{children:"Status"}),t.jsx("th",{children:"Bookings"}),t.jsx("th",{style:{width:220},children:"Actions"})]})}),t.jsx("tbody",{children:x.map((e,s)=>{const a=String(e.id||e.serviceId||e.vendorId||"");return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx("img",{src:e.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),t.jsx("td",{className:"fw-semibold",children:e.title}),t.jsx("td",{children:e.category||"—"}),t.jsxs("td",{children:["R",Number(e.price||0).toLocaleString()]}),t.jsx("td",{children:t.jsx(re,{s:e.status})}),t.jsx("td",{children:de[a]||0}),t.jsxs("td",{className:"d-flex gap-2",children:[t.jsx(O,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(e.id||"")}`,children:"View"}),t.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>fe(e),children:"Duplicate & edit"}),String(e.status||"").toLowerCase()==="rejected"&&t.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>pe(e),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},a||s)})})]})})]})}),t.jsxs("div",{className:"card mt-4",children:[t.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[t.jsx("h6",{className:"mb-0",children:"Bookings"}),t.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",S.length]})]}),t.jsxs("div",{className:"card-body",children:[!S.length&&t.jsx("div",{className:"text-muted",children:"No bookings yet. Once customers reserve sessions, they will appear here."}),!!S.length&&t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Service"}),t.jsx("th",{children:"Customer"}),t.jsx("th",{children:"Scheduled"}),t.jsx("th",{children:"Status"}),t.jsx("th",{className:"text-end",children:"Price"})]})}),t.jsx("tbody",{children:ge.map((e,s)=>{const a=_(e),{date:i,time:u}=he(a),m=me(e.scheduledSlot),r=ue[String(e.serviceId||"")],b=e.serviceTitle||(r==null?void 0:r.title)||"Unknown service",p=Number(e.price||(r==null?void 0:r.price)||0)||0,N=String(e.id||[e.serviceId,e.customerId,e.scheduledDate,e.scheduledSlot,e.bookedAt].filter(Boolean).join("-")||s);return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"d-flex flex-column",children:[t.jsx("span",{className:"fw-semibold",children:b}),(r==null?void 0:r.id)&&t.jsx(O,{className:"small",to:`/marketplace-details?id=${encodeURIComponent(r.id)}`,children:"Open listing"})]})}),t.jsx("td",{children:t.jsx("div",{className:"small text-muted",children:e.customerName||e.customerEmail||"—"})}),t.jsx("td",{children:t.jsxs("div",{className:"d-flex flex-column small",children:[t.jsx("span",{children:i}),t.jsx("span",{children:m||u})]})}),t.jsx("td",{children:t.jsx(re,{s:e.status||"pending"})}),t.jsxs("td",{className:"text-end",children:["R",p.toLocaleString()]})]},N)})})]})})]})]}),g.open&&g.listing&&t.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:e=>e.target===e.currentTarget&&F(),children:t.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[t.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[t.jsxs("h6",{className:"mb-0",children:["Message Admin about: ",g.listing.title]}),t.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:F,children:"Close"})]}),t.jsxs("form",{onSubmit:xe,children:[t.jsxs("div",{className:"card-body",children:[g.err&&t.jsx("div",{className:"alert alert-danger py-2 mb-2",children:g.err}),g.done&&t.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"form-label",children:"Subject"}),t.jsx("input",{className:"form-control",value:g.subject,onChange:e=>y(s=>({...s,subject:e.target.value}))})]}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"form-label",children:"Message"}),t.jsx("textarea",{className:"form-control",rows:6,value:g.content,onChange:e=>y(s=>({...s,content:e.target.value}))}),t.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",(n==null?void 0:n.email)||"you"]})]})]}),t.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:F,disabled:g.sending,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:g.sending||!g.content.trim(),children:g.sending?"Sending…":"Send"})]})]})]})})]})})}export{Te as default};
