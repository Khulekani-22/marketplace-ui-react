import{g as he,a as v,b as fe,B as j,j as s,I as A}from"./index-BEJvX3gE.js";import{r as i,L as ge}from"./vendor-DW3XjTa1.js";function k(n,d=80){return n?n.length>d?`${n.slice(0,d)}â€¦`:n:""}function X(n){return`https://ui-avatars.com/api/?name=${encodeURIComponent(n||"User")}&background=059669&color=fff`}function U(n){const d=n?.from||{},g=n?.timestamp||n?.date||new Date().toISOString();return{id:String(n?.id||g),senderId:d?.uid||d?.email,senderName:d?.name||d?.email||"User",senderEmail:d?.email,senderRole:d?.type,senderAvatar:d?.avatar,content:(n?.content??"").toString(),timestamp:g}}function $(n,d){const g=Array.isArray(n?.messages)?n.messages:[],p=n?.context||d||{},m=g.map(a=>{const c=a?.senderRole||a?.role;let f=a?.senderEmail||a?.email;if(!f){const o=(c||"").toLowerCase();o==="admin"&&p.adminEmail&&(f=p.adminEmail),o==="vendor"&&p.vendorEmail&&(f=p.vendorEmail),o==="subscriber"&&p.subscriberEmail&&(f=p.subscriberEmail)}const x=a?.date||a?.timestamp||a?.createdAt||new Date().toISOString();return{id:String(a?.id||a?.messageId||x),senderId:a?.senderId||a?.sender?.id,senderName:a?.senderName||a?.sender?.name||a?.senderId||"User",senderEmail:f,senderRole:c,senderAvatar:a?.senderAvatar||a?.sender?.avatar,content:(a?.content??a?.text??"").toString(),timestamp:x}});return m.sort((a,c)=>new Date(a.timestamp).getTime()-new Date(c.timestamp).getTime()),m}function Z(n){const d=new Map;n.forEach(p=>{if(!p)return;const m=String(p.threadId||p.id||p.subject||`legacy-${Date.now()}`);d.has(m)||d.set(m,[]),d.get(m).push(p)});const g=[];for(const[p,m]of d.entries()){m.sort((x,o)=>new Date(x?.timestamp||x?.date||0).getTime()-new Date(o?.timestamp||o?.date||0).getTime());const a=m[0],c=m[m.length-1]||a,f=[];a?.from&&f.push({id:a.from.uid||a.from.email||a.from.name,name:a.from.name||a.from.email,email:a.from.email,role:a.from.type}),a?.to&&f.push({id:a.to.uid||a.to.email||a.to.name,name:a.to.name||a.to.email,email:a.to.email,role:a.to.type}),g.push({id:p,kind:"legacy",subject:c?.subject||a?.subject||"Conversation",lastMessageSnippet:k(c?.content||""),lastMessageAt:c?.timestamp||c?.date,participants:f,legacy:{user1:f[0]?.email,user2:f[1]?.email},raw:m})}return g}function xe(n){const d=Array.isArray(n?.messages)?[...n.messages]:[],g=n?.lastMessage||d[d.length-1]||{},p=Array.isArray(n?.participants)?n.participants.map(o=>({id:o?.id||o?.email||o?.name,name:o?.name||o?.id||"Participant",email:o?.email,role:o?.role})):[],m=n?.context||{},a={id:String(n?.id||n?.threadId||m.threadId||`thread-${Date.now()}`),kind:"thread",subject:n?.subject||m.listingTitle||m.serviceTitle||"Conversation",lastMessageSnippet:k(n?.lastMessage?.snippet||g?.snippet||g?.content||""),lastMessageAt:g?.date||g?.timestamp||n?.updatedAt||n?.createdAt,unreadCount:typeof n?.unreadCount=="number"?n.unreadCount:void 0,participants:p,context:m,raw:n},c=m.vendorEmail,f=m.adminEmail,x=m.subscriberEmail;if(c){const o=a.participants.find(h=>(h?.role||"").toLowerCase()==="vendor"||(h?.id||"").startsWith("vendor:"));o&&!o.email&&(o.email=c)}if(f){const o=a.participants.find(h=>(h?.role||"").toLowerCase()==="admin");o&&!o.email&&(o.email=f)}if(x){const o=a.participants.find(h=>(h?.role||"").toLowerCase()==="subscriber");o&&!o.email&&(o.email=x)}return a}const ve=()=>{const[n,d]=i.useState([]),[g,p]=i.useState([]),[m,a]=i.useState("inbox"),[c,f]=i.useState(null),[x,o]=i.useState([]),[h,ee]=i.useState(()=>{try{return he()}catch{return null}}),[se,F]=i.useState(!0),[B,O]=i.useState(!1),[T,te]=i.useState(""),[D,M]=i.useState(!1),[E,z]=i.useState(""),[L,q]=i.useState(""),[H,P]=i.useState(!1),[Q,V]=i.useState([]),[C,W]=i.useState(""),[ae,I]=i.useState(!1);i.useEffect(()=>{D&&v.get("/api/users/all-contacts").then(e=>V(e.data.items||[])).catch(()=>V([]))},[D]);const re=i.useRef(null),Y=i.useCallback(()=>{re.current?.scrollIntoView({behavior:"smooth"})},[]);i.useEffect(()=>{Y()},[x,Y]),i.useEffect(()=>{fe().then(e=>ee(e)).catch(()=>{})},[]);const _=i.useCallback(e=>{const r=(h?.email||"").toLowerCase();return e.map(t=>{const l=t.participants||[];let u=!1;t.raw&&Array.isArray(t.raw.messages)?u=t.raw.messages.some(b=>(b.senderEmail||b.email||"").toLowerCase()===r):Array.isArray(t.raw)&&(u=t.raw.some(b=>(b?.from?.email||"").toLowerCase()===r));const y=u,S=l.some(b=>(b.email||"").toLowerCase()===r);let w=l.find(b=>(b?.email||"").toLowerCase()!==r);!w&&l.length&&(w=l[0]);const J=w?.name||w?.email||t.subject||"Conversation",me=w?.email||(t.legacy?[t.legacy.user1,t.legacy.user2].find(b=>(b||"").toLowerCase()!==r):void 0),ue=X(J),K=(t.kind==="thread"?t.context?.type||"active":"legacy conversation").replace(/[-_]/g," ");return{id:`${t.kind}:${t.id}`,threadId:t.id,name:J,email:me,avatar:ue,status:K.charAt(0).toUpperCase()+K.slice(1),type:t.kind,lastMessageSnippet:k(t.lastMessageSnippet||""),lastMessageAt:t.lastMessageAt,unreadCount:t.unreadCount,thread:t,isInbox:S,isSent:y}}).sort((t,l)=>{const u=t.lastMessageAt?new Date(t.lastMessageAt).getTime():0;return(l.lastMessageAt?new Date(l.lastMessageAt).getTime():0)-u})},[h]),N=i.useCallback(async({silent:e=!1}={})=>{e||F(!0);try{const t=(await v.get("/api/messages",{params:{limit:100}})).data;let l=[];Array.isArray(t?.items)?l=t.items.map(xe):Array.isArray(t?.messages)?l=Z(t.messages):Array.isArray(t)&&(l=Z(t)),d(l);const u=_(l);return p(u),u}catch(r){if(console.error("Error fetching messages:",r),!e){const t=r?.response?.data?.message||"Failed to load messages";j.error(t)}return d([]),p([]),[]}finally{e||F(!1)}},[_]);i.useEffect(()=>{N()},[N]);const R=i.useCallback(async e=>{if(f(e),e.type==="thread")try{const r=await v.get(`/api/messages/${e.threadId}`),t=r.data&&r.data.id?r.data:e.thread.raw,l=$(t,e.thread.context);o(l)}catch(r){console.error("Error fetching thread conversation:",r);const t=$(e.thread.raw,e.thread.context);o(t),j.error("Unable to refresh conversation; showing cached messages.")}else{const r=e.thread.legacy?.user1,t=e.thread.legacy?.user2||e.email;if(!r||!t){o([]);return}try{const l=await v.get("/api/messages/conversation",{params:{user1:r,user2:t,limit:100}}),y=(Array.isArray(l.data?.conversation)?l.data.conversation:[]).map(U).sort((S,w)=>new Date(S.timestamp).getTime()-new Date(w.timestamp).getTime());o(y)}catch(l){console.error("Error fetching legacy conversation:",l),j.error("Unable to load conversation");const u=Array.isArray(e.thread.raw)?e.thread.raw.map(U):[];u.sort((y,S)=>new Date(y.timestamp).getTime()-new Date(S.timestamp).getTime()),o(u)}}},[]),ne=i.useCallback(async e=>{if(e.preventDefault(),!c||!T.trim()||B)return;const r=T.trim();O(!0);try{if(c.type==="thread")await v.post("/api/messages/reply",{threadId:c.threadId,content:r});else{const u=c.email||c.thread.legacy?.user2;if(!u)throw new Error("Missing recipient email");const y=c.thread.subject||`Message to ${c.name}`;await v.post("/api/messages",{to:u,subject:y,content:r,priority:"normal"})}te("");const l=(await N({silent:!0})).find(u=>u.threadId===c.threadId&&u.type===c.type);l&&await R(l),j.success("Message sent")}catch(t){console.error("Error sending message:",t);const l=t?.response?.data?.message||t?.message||"Failed to send message";j.error(l)}finally{O(!1)}},[c,T,B,N,R]),ie=i.useCallback(e=>{if(e.type==="thread"){const r=$(e.thread.raw,e.thread.context);return r.length?r[r.length-1]:null}if(Array.isArray(e.thread.raw)){const r=e.thread.raw.map(U).sort((t,l)=>new Date(t.timestamp).getTime()-new Date(l.timestamp).getTime());return r.length?r[r.length-1]:null}return null},[]),oe=i.useCallback(e=>e.unreadCount||0,[]),le=i.useMemo(()=>X(h?.email||"User"),[h]),G=i.useMemo(()=>h?.email||"User",[h]),ce=i.useMemo(()=>h?.role||"member",[h]);i.useCallback(e=>{const r=(h?.email||"").toLowerCase();return r?!!(e.senderEmail&&e.senderEmail.toLowerCase()===r||e.senderId&&e.senderId.toLowerCase().includes(r)||e.senderRole?.toLowerCase()==="admin"&&h?.role==="admin"):!1},[h]);const de=i.useCallback(e=>{if(!e)return"";const r=new Date(e);return Number.isFinite(r.getTime())?r.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""},[]);return se?s.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"400px"},children:s.jsx("div",{className:"spinner-border text-primary",role:"status",children:s.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):s.jsxs("div",{className:"chat-wrapper",children:[s.jsxs("div",{className:"chat-sidebar card",children:[s.jsxs("div",{className:"chat-sidebar-single active top-profile",children:[s.jsx("div",{className:"img",children:s.jsx("img",{src:le,alt:"Current user"})}),s.jsxs("div",{className:"info",children:[s.jsx("h6",{className:"text-md mb-0",children:G}),s.jsx("p",{className:"mb-0 text-capitalize",children:ce})]}),s.jsxs("div",{className:"action d-flex flex-column align-items-end",children:[s.jsxs("button",{type:"button",className:"btn btn-primary btn-sm mb-2",onClick:()=>M(!0),children:[s.jsx(A,{icon:"mdi:plus"})," Compose"]}),s.jsxs("div",{className:"btn-group",children:[s.jsx("button",{type:"button",className:"text-secondary-light text-xl","data-bs-toggle":"dropdown","data-bs-display":"static","aria-expanded":"false",children:s.jsx(A,{icon:"bi:three-dots"})}),s.jsx("ul",{className:"dropdown-menu dropdown-menu-lg-end border",children:s.jsx("li",{children:s.jsxs(ge,{to:"/chat-profile",className:"dropdown-item rounded text-secondary-light bg-hover-neutral-200 text-hover-neutral-900 d-flex align-items-center gap-2",children:[s.jsx(A,{icon:"fluent:person-32-regular"}),"Profile"]})})})]})]})]}),s.jsxs("div",{className:"d-flex justify-content-center my-2",children:[s.jsx("button",{className:`btn btn-sm ${m==="inbox"?"btn-primary":"btn-outline-primary"} mx-1`,onClick:()=>a("inbox"),children:"Inbox"}),s.jsx("button",{className:`btn btn-sm ${m==="sent"?"btn-primary":"btn-outline-primary"} mx-1`,onClick:()=>a("sent"),children:"Sent"})]}),s.jsx("div",{className:"chat-search",children:s.jsxs("form",{children:[s.jsx("input",{type:"text",name:"chatSearch",placeholder:"Search here..."}),s.jsx(A,{icon:"iconoir:search",className:"search-icon"})]})}),s.jsx("div",{className:"chat-all-list",children:g.filter(e=>m==="inbox"?e.isInbox:e.isSent).map(e=>{const r=ie(e),t=oe(e),l=r?k(r.content,30):"No messages yet",u=r?de(r.timestamp):"";return s.jsxs("div",{className:`chat-sidebar-single ${c?.id===e.id?"active":""}`,onClick:()=>{R(e)},style:{cursor:"pointer"},children:[s.jsx("div",{className:"img",children:s.jsx("img",{src:e.avatar,alt:e.name})}),s.jsxs("div",{className:"info",children:[s.jsx("h6",{className:"text-sm mb-1",children:e.name}),s.jsx("p",{className:"mb-0 text-xs",children:l})]}),s.jsxs("div",{className:"action text-end",children:[s.jsx("p",{className:"mb-0 text-neutral-400 text-xs lh-1",children:u}),t>0&&s.jsx("span",{className:"w-16-px h-16-px text-xs rounded-circle bg-warning-main text-white d-inline-flex align-items-center justify-content-center",children:t})]})]},e.id)})})]}),s.jsxs("div",{className:"chat-main card",children:[c?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"chat-sidebar-single active"}),s.jsx("div",{className:"chat-message-list",style:{maxHeight:"400px",overflowY:"auto"}}),s.jsx("form",{className:"chat-message-box",onSubmit:ne})]}):s.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center h-100 text-center",children:[s.jsx(A,{icon:"fluent:chat-48-regular",className:"text-primary",style:{fontSize:"4rem"}}),s.jsx("h5",{className:"mt-3 mb-2",children:"Select a conversation"}),s.jsx("p",{className:"text-muted",children:"Choose a contact from the sidebar to start messaging"})]}),D&&s.jsx("div",{className:"modal-backdrop show",style:{zIndex:1050},children:s.jsx("div",{className:"modal d-block",tabIndex:-1,role:"dialog",style:{zIndex:1060},children:s.jsx("div",{className:"modal-dialog modal-dialog-centered",role:"document",children:s.jsxs("div",{className:"modal-content",children:[s.jsxs("div",{className:"modal-header",children:[s.jsx("h5",{className:"modal-title",children:"Compose New Message"}),s.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:()=>M(!1)})]}),s.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!(!E.trim()||!L.trim())){P(!0);try{await v.post("/api/messages",{to:E.trim(),subject:`Message from ${G}`,content:L.trim(),priority:"normal"}),z(""),q(""),M(!1),j.success("Message sent"),await N({silent:!0})}catch(r){j.error(r?.response?.data?.message||"Failed to send message")}finally{P(!1)}}},children:[s.jsxs("div",{className:"modal-body",children:[s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"form-label",children:"Recipient Email"}),s.jsxs("div",{style:{position:"relative"},children:[s.jsx("input",{type:"email",className:"form-control",value:E,onChange:e=>{z(e.target.value),W(e.target.value),I(!0)},onFocus:()=>I(!0),onBlur:()=>setTimeout(()=>I(!1),150),autoComplete:"off",required:!0}),ae&&C.trim()&&s.jsxs("div",{style:{position:"absolute",zIndex:100,top:"100%",left:0,right:0,background:"#fff",border:"1px solid #ddd",maxHeight:200,overflowY:"auto",borderRadius:4},children:[Q.filter(e=>e.email&&e.email.toLowerCase().includes(C.toLowerCase())||e.name&&e.name.toLowerCase().includes(C.toLowerCase())).slice(0,10).map((e,r)=>s.jsxs("div",{style:{padding:"8px 12px",cursor:"pointer",borderBottom:"1px solid #eee"},onMouseDown:()=>{z(e.email),W(e.email),I(!1)},children:[s.jsx("span",{style:{fontWeight:500},children:e.name}),s.jsx("span",{style:{color:"#888",marginLeft:8},children:e.email}),s.jsxs("span",{style:{color:"#aaa",marginLeft:8,fontSize:"0.9em"},children:["(",e.role,")"]})]},e.email+r)),Q.filter(e=>e.email&&e.email.toLowerCase().includes(C.toLowerCase())||e.name&&e.name.toLowerCase().includes(C.toLowerCase())).length===0&&s.jsx("div",{style:{padding:"8px 12px",color:"#888"},children:"No matches found"})]})]})]}),s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"form-label",children:"Message"}),s.jsx("textarea",{className:"form-control",rows:4,value:L,onChange:e=>q(e.target.value),required:!0})]})]}),s.jsxs("div",{className:"modal-footer",children:[s.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>M(!1),children:"Cancel"}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:H||!E.trim()||!L.trim(),children:H?"Sending...":"Send"})]})]})]})})})})]})]})};export{ve as M};
