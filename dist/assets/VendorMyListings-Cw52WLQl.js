import{b as re,m as xe,u as je,e as ye,l as te,j as t,M as ve}from"./index-Bn5LcKgl.js";import{b as Ne,u as Se,r as o,L as U}from"./vendor-DW3XjTa1.js";import"./firebase-BBiW2ZCr.js";import"./utils-B2rxisVD.js";async function ke(a={}){try{const{signal:i}=a,{data:c}=await re.get("/api/data/services/mine",{signal:i}),r=Array.isArray(c?.listings)?c.listings:[],A=Array.isArray(c?.bookings)?c.bookings:[],T=c?.vendor||null,q=typeof c?.tenantId=="string"?c.tenantId:void 0;return{listings:r,bookings:A,vendor:T,tenantId:q}}catch(i){const c=i?.response?.status;if(c===401||c===403||c===404)return{listings:[],bookings:[]};throw i}}function O(a){if(!a)return"public";const i=a.toString().toLowerCase();return i==="vendor"?"public":i}function we(a,i){const c=O(a||"public"),r=(i||"").trim().toLowerCase();return r?`vendor_pending_listings:${c}:${r}`:null}function _(a){return String(a?.id||a?.serviceId||"")}function Ie(a){try{const i=typeof a=="string"?JSON.parse(a):a;return Array.isArray(i)?i:[]}catch{return[]}}function se(a,i){const c=O(a),r=O(i);return c===r||c==="public"||r==="public"}function ne({s:a}){const i=(a||"unknown").toLowerCase(),c={approved:"success",pending:"warning",rejected:"danger",scheduled:"info",completed:"success",canceled:"secondary",unknown:"secondary"};return t.jsx("span",{className:`badge text-bg-${c[i]||"secondary"}`,children:i})}function Te(){const a=Ne(),i=Se(),c=o.useRef(null),{vendor:r,ensureVendorId:A,loading:T}=xe(),{refresh:q,syncMessagesToLive:ae}=je(),{appData:V,appDataLoading:W}=ye(),D=o.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[b,p]=o.useState([]),[v,N]=o.useState([]),[E,ie]=o.useState(!0),[Y,oe]=o.useState(!1),[Q,w]=o.useState(""),[u,x]=o.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1}),S=o.useMemo(()=>we(D,r?.vendorId||r?.email||r?.id||""),[D,r?.vendorId,r?.email,r?.id]),[I,R]=o.useState([]),j=i.state?.newListing,$=o.useCallback(e=>{if(R(e),!!S){if(!e.length){localStorage.removeItem(S);return}try{localStorage.setItem(S,JSON.stringify(e))}catch{}}},[S]);o.useEffect(()=>{if(!S){R([]);return}try{const e=Ie(localStorage.getItem(S));R(e)}catch{R([])}},[S]),o.useEffect(()=>{if(!j)return;c.current=j;const e=String(j?.id||j?.serviceId||"");p(s=>s?s.some(l=>String(l?.id||l?.serviceId)===e)?s:[j,...s]:[j]),$([j,...I.filter(s=>String(s?.id||s?.serviceId||"")!==e)]),w(""),a({pathname:i.pathname,search:i.search},{replace:!0,state:{}})},[j,a,i.pathname,i.search,$,I]);const L=o.useCallback(e=>{const s=Array.isArray(e)?[...e]:[],n=new Set(s.map(_).filter(Boolean)),l=c.current;if(l){const d=_(l);d&&!n.has(d)?(s.unshift(l),n.add(d)):c.current=null}if(I.length){const d=[];I.forEach(h=>{const m=_(h);m&&(n.has(m)||(n.add(m),s.unshift(h),d.push(h)))}),d.length!==I.length&&$(d)}return s},[I,$]);o.useEffect(()=>{if(r&&!r.isApproved){const e=encodeURIComponent("/listings-vendors-mine");a(`/profile-vendor?next=${e}`,{replace:!0})}},[r,a]);function X(e){let s=e;const n=new Set;for(;s&&typeof s=="object"&&!Array.isArray(s?.services)&&!n.has(s);){if(n.add(s),Array.isArray(s?.data?.services)){s=s.data;continue}if(Array.isArray(s?.payload?.services)){s=s.payload;continue}if(Array.isArray(s?.appData?.services)){s=s.appData;continue}break}return s&&typeof s=="object"?s:null}const z=o.useCallback(e=>{if(!e)return{listings:[],bookings:[]};const s=X(V)||X(te)||te,n=O(D),l=Array.isArray(s?.services)?s.services:[],h=(Array.isArray(s?.bookings)?s.bookings:[]).filter(g=>se(g?.tenantId,n)),m=String(e?.vendorId||""),f=String(e?.email||e?.contactEmail||"").toLowerCase(),k=String(e?.name||e?.companyName||"").toLowerCase(),y=l.filter(g=>{if(!se(g?.tenantId,n))return!1;const M=String(g.vendorId||""),J=String(g.contactEmail||g.email||"").toLowerCase(),P=String(g.vendor||"").toLowerCase();return M&&m&&M===m||!M&&(P&&P===k||f&&J===f)}),C=new Set(y.flatMap(g=>[String(g.id||""),String(g.serviceId||""),String(g.vendorId||"")]).filter(Boolean)),H=h.filter(g=>{const ee=String(g.serviceId||""),M=m&&String(g.vendorId||"")===m,J=f&&String(g.vendorEmail||"").toLowerCase()===f,P=k&&String(g.vendorName||"").toLowerCase()===k;return C.has(ee)||M||J||P});return{listings:y,bookings:H}},[V,D]),B=o.useCallback(async({signal:e,silent:s}={})=>{const n=d=>{s?oe(d):ie(d)};n(!0),w("");let l=r;try{if(e?.aborted||T&&!r)return;if(!r){p([]),N([]);return}const d=A?await A():r;if(e?.aborted)return;if(l=d||r,!l){p([]),N([]);return}const{listings:h,bookings:m}=await ke({signal:e});if(e?.aborted)return;const f=Array.isArray(h)?h:[],k=Array.isArray(m)?m:[],y=L(f);if(y.length)p(y),N(k);else{const C=z(l);if(C.listings.length){const H=L(C.listings);p(H),N(C.bookings),s||w("Showing cached listings until the live catalog updates.")}else p(y),N([])}}catch(d){if(e?.aborted)return;if(d?.code==="ERR_NETWORK"){const m=z(l),f=L(m.listings);p(f),N(m.bookings),w("Showing cached data while the network is unavailable.")}else w(d?.response?.data?.message||d?.message||"Failed to load listings"),p(L([])),N([])}finally{n(!1)}},[z,A,L,r,T]);o.useEffect(()=>{const e=new AbortController;return B({signal:e.signal}),()=>{e.abort()}},[B]);const ce=o.useCallback(async()=>{w(""),await B({silent:!0})},[B]),K=o.useMemo(()=>{const e={approved:0,pending:0,rejected:0};return b.forEach(s=>{const n=(s.status||"pending").toLowerCase();e[n]=(e[n]||0)+1}),e},[b]),le=o.useMemo(()=>{const e={};return v.forEach(s=>{const n=String(s.serviceId||"");n&&(e[n]=(e[n]||0)+1)}),e},[v]),de=o.useMemo(()=>{const e={};return b.forEach(s=>{[String(s.id||""),String(s.serviceId||""),String(s.vendorId||"")].filter(Boolean).forEach(l=>{e[l]=s})}),e},[b]);function Z(e){const s=(e+11)%12+1,n=e>=12?"PM":"AM";return`${s}:00 ${n}`}function ue(e){if(!e)return"";const[s]=e.split(":"),n=Number(s);return Number.isNaN(n)?e:`${Z(n)} – ${Z(n+1)}`}function G(e){if(e?.scheduledDate){const s=e.scheduledSlot||"00:00",n=`${e.scheduledDate}T${s.length===5?s:`${s}:00`}`,l=new Date(n);if(!Number.isNaN(l.getTime()))return l}if(e?.bookedAt){const s=new Date(e.bookedAt);if(!Number.isNaN(s.getTime()))return s}return null}const me=o.useMemo(()=>{const e=v.map(s=>({...s}));return e.sort((s,n)=>{const l=G(s)?.getTime()??0,d=G(n)?.getTime()??0;return l-d}),e},[v]);function ge(e){return e?{date:e.toLocaleDateString(),time:e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}:{date:"—",time:""}}function he(e){const s=encodeURIComponent(JSON.stringify({title:e.title,category:e.category,price:e.price,imageUrl:e.imageUrl,description:e.description,listingType:e.listingType||"service"}));a(`/listings-vendors?prefill=${s}`)}function fe(e){const s=`Feedback request: ${e.title}`,n=`Hello Admin

My listing "${e.title}" (ID: ${e.id}) was ${String(e.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;x({open:!0,listing:e,subject:s,content:n,sending:!1,err:null,done:!1})}function be(){const e=`General inquiry from ${r?.name||r?.companyName||"vendor"}`;x({open:!0,listing:null,subject:e,content:`Hello Admin

I have a question/concern regarding my vendor account or listings.

[Please describe your question or concern here]

Thank you for your assistance!`,sending:!1,err:null,done:!1})}function F(){x({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function pe(e){if(e?.preventDefault?.(),!!u.content.trim()){x(s=>({...s,sending:!0,err:null}));try{const s={listingId:u.listing?u.listing.id||"general":"general-admin-message",listingTitle:u.listing?u.listing.title||"General Feedback":"General Admin Message",vendorId:r?.vendorId||r?.id||"",vendorEmail:r?.email||r?.contactEmail||"",subject:u.subject,content:u.content};await re.post("/api/messages",s),x(n=>({...n,sending:!1,done:!0}));try{await q({force:!0}),await ae()}catch{}setTimeout(()=>F(),1200)}catch(s){x(n=>({...n,sending:!1,err:s?.response?.data?.message||s?.message||"Failed to send"}))}}}return t.jsx(ve,{children:t.jsxs("div",{className:"container py-4",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[t.jsx("h1",{className:"h4 mb-0",children:"My listings"}),t.jsxs("div",{className:"d-flex gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:ce,disabled:E||Y||W,children:Y||W?"Refreshing…":"Refresh"}),t.jsxs("button",{type:"button",className:"btn btn-outline-primary",onClick:()=>be(),title:"Contact admin about any questions or concerns",children:[t.jsx("i",{className:"bi bi-envelope me-1"}),"Message Admin"]}),t.jsx(U,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})]})]}),t.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[t.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",K.approved]}),t.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",K.pending]}),t.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",K.rejected]}),t.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",b.length]})]}),t.jsx("div",{className:"card",children:t.jsxs("div",{className:"card-body",children:[Q&&t.jsx("div",{className:"alert alert-danger",children:Q}),E&&t.jsx("div",{className:"text-muted",children:"Loading…"}),!E&&!b.length&&t.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",t.jsx(U,{to:"/listings-vendors",children:"Create your first one."})]}),!E&&!!b.length&&t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{width:72}}),t.jsx("th",{children:"Title"}),t.jsx("th",{children:"Category"}),t.jsx("th",{children:"Price"}),t.jsx("th",{children:"Status"}),t.jsx("th",{children:"Bookings"}),t.jsx("th",{style:{width:220},children:"Actions"})]})}),t.jsx("tbody",{children:b.map((e,s)=>{const n=String(e.id||e.serviceId||e.vendorId||"");return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx("img",{src:e.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),t.jsx("td",{className:"fw-semibold",children:e.title}),t.jsx("td",{children:e.category||"—"}),t.jsxs("td",{children:["R",Number(e.price||0).toLocaleString()]}),t.jsx("td",{children:t.jsx(ne,{s:e.status})}),t.jsx("td",{children:le[n]||0}),t.jsxs("td",{className:"d-flex gap-2",children:[t.jsx(U,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(e.id||"")}`,children:"View"}),t.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>he(e),children:"Duplicate & edit"}),String(e.status||"").toLowerCase()==="rejected"&&t.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>fe(e),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},n||s)})})]})})]})}),t.jsxs("div",{className:"card mt-4",children:[t.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[t.jsx("h6",{className:"mb-0",children:"Bookings"}),t.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",v.length]})]}),t.jsxs("div",{className:"card-body",children:[!v.length&&t.jsx("div",{className:"text-muted",children:"No bookings yet. Once customers reserve sessions, they will appear here."}),!!v.length&&t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Service"}),t.jsx("th",{children:"Customer"}),t.jsx("th",{children:"Scheduled"}),t.jsx("th",{children:"Status"}),t.jsx("th",{className:"text-end",children:"Price"})]})}),t.jsx("tbody",{children:me.map((e,s)=>{const n=G(e),{date:l,time:d}=ge(n),h=ue(e.scheduledSlot),m=de[String(e.serviceId||"")],f=e.serviceTitle||m?.title||"Unknown service",k=Number(e.price||m?.price||0)||0,y=String(e.id||[e.serviceId,e.customerId,e.scheduledDate,e.scheduledSlot,e.bookedAt].filter(Boolean).join("-")||s);return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"d-flex flex-column",children:[t.jsx("span",{className:"fw-semibold",children:f}),m?.id&&t.jsx(U,{className:"small",to:`/marketplace-details?id=${encodeURIComponent(m.id)}`,children:"Open listing"})]})}),t.jsx("td",{children:t.jsx("div",{className:"small text-muted",children:e.customerName||e.customerEmail||"—"})}),t.jsx("td",{children:t.jsxs("div",{className:"d-flex flex-column small",children:[t.jsx("span",{children:l}),t.jsx("span",{children:h||d})]})}),t.jsx("td",{children:t.jsx(ne,{s:e.status||"pending"})}),t.jsxs("td",{className:"text-end",children:["R",k.toLocaleString()]})]},y)})})]})})]})]}),u.open&&t.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:e=>e.target===e.currentTarget&&F(),children:t.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[t.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[t.jsx("h6",{className:"mb-0",children:u.listing?`Message Admin about: ${u.listing.title}`:"Message Admin"}),t.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:F,children:"Close"})]}),t.jsxs("form",{onSubmit:pe,children:[t.jsxs("div",{className:"card-body",children:[u.err&&t.jsx("div",{className:"alert alert-danger py-2 mb-2",children:u.err}),u.done&&t.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"form-label",children:"Subject"}),t.jsx("input",{className:"form-control",value:u.subject,onChange:e=>x(s=>({...s,subject:e.target.value}))})]}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"form-label",children:"Message"}),t.jsx("textarea",{className:"form-control",rows:6,value:u.content,onChange:e=>x(s=>({...s,content:e.target.value}))}),t.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",r?.email||"you"]})]})]}),t.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:F,disabled:u.sending,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:u.sending||!u.content.trim(),children:u.sending?"Sending…":"Send"})]})]})]})})]})})}export{Te as default};
