import{c as Q,u as ce,d as oe,r as d,a as Y,j as s,L as R}from"./index-1xXifhh4.js";import{u as de,M as ue}from"./MasterLayout-12_PyrKn.js";import{u as me}from"./useAppSync-7L5yo-ON.js";import"./iconify-Dl13qa3R.js";async function he(g={}){var a;try{const{signal:u}=g,{data:i}=await Q.get("/api/data/services/mine",{signal:u}),E=Array.isArray(i==null?void 0:i.listings)?i.listings:[],D=Array.isArray(i==null?void 0:i.bookings)?i.bookings:[],I=(i==null?void 0:i.vendor)||null,A=typeof(i==null?void 0:i.tenantId)=="string"?i.tenantId:void 0;return{listings:E,bookings:D,vendor:I,tenantId:A}}catch(u){const i=(a=u==null?void 0:u.response)==null?void 0:a.status;if(i===401||i===403||i===404)return{listings:[],bookings:[]};throw u}}function O(g){if(!g)return"public";const a=g.toString().toLowerCase();return a==="vendor"?"public":a}function _(g,a){const u=O(g),i=O(a);return u===i||u==="public"||i==="public"}function G({s:g}){const a=(g||"unknown").toLowerCase(),u={approved:"success",pending:"warning",rejected:"danger",scheduled:"info",completed:"success",canceled:"secondary",unknown:"secondary"};return s.jsx("span",{className:`badge text-bg-${u[a]||"secondary"}`,children:a})}function je(){const g=ce(),{vendor:a,ensureVendorId:u,loading:i}=oe(),{refresh:E,syncMessagesToLive:D}=de(),{appData:I,appDataLoading:A}=me(),P=d.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[x,j]=d.useState([]),[b,y]=d.useState([]),[C,X]=d.useState(!0),[K,Z]=d.useState(!1),[H,S]=d.useState(""),[o,N]=d.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1});d.useEffect(()=>{if(a&&!a.isApproved){const e=encodeURIComponent("/listings-vendors-mine");g(`/profile-vendor?next=${e}`,{replace:!0})}},[a,g]);function W(e){var l,h,m;let t=e;const n=new Set;for(;t&&typeof t=="object"&&!Array.isArray(t==null?void 0:t.services)&&!n.has(t);){if(n.add(t),Array.isArray((l=t==null?void 0:t.data)==null?void 0:l.services)){t=t.data;continue}if(Array.isArray((h=t==null?void 0:t.payload)==null?void 0:h.services)){t=t.payload;continue}if(Array.isArray((m=t==null?void 0:t.appData)==null?void 0:m.services)){t=t.appData;continue}break}return t&&typeof t=="object"?t:null}const $=d.useCallback(e=>{if(!e)return{listings:[],bookings:[]};const t=W(I)||W(Y)||Y,n=O(P),l=Array.isArray(t==null?void 0:t.services)?t.services:[],m=(Array.isArray(t==null?void 0:t.bookings)?t.bookings:[]).filter(c=>_(c==null?void 0:c.tenantId,n)),r=String((e==null?void 0:e.vendorId)||""),p=String((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||"").toLowerCase(),f=String((e==null?void 0:e.name)||(e==null?void 0:e.companyName)||"").toLowerCase(),v=l.filter(c=>{if(!_(c==null?void 0:c.tenantId,n))return!1;const k=String(c.vendorId||""),z=String(c.contactEmail||c.email||"").toLowerCase(),T=String(c.vendor||"").toLowerCase();return k&&r&&k===r||!k&&(T&&T===f||p&&z===p)}),U=new Set(v.flatMap(c=>[String(c.id||""),String(c.serviceId||""),String(c.vendorId||"")]).filter(Boolean)),w=m.filter(c=>{const J=String(c.serviceId||""),k=r&&String(c.vendorId||"")===r,z=p&&String(c.vendorEmail||"").toLowerCase()===p,T=f&&String(c.vendorName||"").toLowerCase()===f;return U.has(J)||k||z||T});return{listings:v,bookings:w}},[I,P]),L=d.useCallback(async({signal:e,silent:t}={})=>{var h,m;const n=r=>{t?Z(r):X(r)};n(!0),S("");let l=a;try{if(e!=null&&e.aborted||i&&!a)return;if(!a){j([]),y([]);return}const r=u?await u():a;if(e!=null&&e.aborted)return;if(l=r||a,!l){j([]),y([]);return}const{listings:p,bookings:f}=await he({signal:e});if(e!=null&&e.aborted)return;const v=Array.isArray(p)?p:[],U=Array.isArray(f)?f:[];if(v.length)j(v),y(U);else{const w=$(l);w.listings.length?(j(w.listings),y(w.bookings),t||S("Showing cached listings until the live catalog updates.")):(j([]),y([]))}}catch(r){if(e!=null&&e.aborted)return;if((r==null?void 0:r.code)==="ERR_NETWORK"){const f=$(l);j(f.listings),y(f.bookings),S("Showing cached data while the network is unavailable.")}else S(((m=(h=r==null?void 0:r.response)==null?void 0:h.data)==null?void 0:m.message)||(r==null?void 0:r.message)||"Failed to load listings"),j([]),y([])}finally{n(!1)}},[$,u,a,i]);d.useEffect(()=>{const e=new AbortController;return L({signal:e.signal}),()=>{e.abort()}},[L]);const V=d.useCallback(async()=>{S(""),await L({silent:!0})},[L]),B=d.useMemo(()=>{const e={approved:0,pending:0,rejected:0};return x.forEach(t=>{var n;return e[n=(t.status||"pending").toLowerCase()]||(e[n]=0),e[(t.status||"pending").toLowerCase()]++}),e},[x]),ee=d.useMemo(()=>{const e={};return b.forEach(t=>{const n=String(t.serviceId||"");n&&(e[n]=(e[n]||0)+1)}),e},[b]),se=d.useMemo(()=>{const e={};return x.forEach(t=>{[String(t.id||""),String(t.serviceId||""),String(t.vendorId||"")].filter(Boolean).forEach(l=>{e[l]=t})}),e},[x]);function q(e){const t=(e+11)%12+1,n=e>=12?"PM":"AM";return`${t}:00 ${n}`}function te(e){if(!e)return"";const[t]=e.split(":"),n=Number(t);return Number.isNaN(n)?e:`${q(n)} – ${q(n+1)}`}function F(e){if(e!=null&&e.scheduledDate){const t=e.scheduledSlot||"00:00",n=`${e.scheduledDate}T${t.length===5?t:`${t}:00`}`,l=new Date(n);if(!Number.isNaN(l.getTime()))return l}if(e!=null&&e.bookedAt){const t=new Date(e.bookedAt);if(!Number.isNaN(t.getTime()))return t}return null}const ne=d.useMemo(()=>{const e=b.map(t=>({...t}));return e.sort((t,n)=>{var m,r;const l=((m=F(t))==null?void 0:m.getTime())??0,h=((r=F(n))==null?void 0:r.getTime())??0;return l-h}),e},[b]);function re(e){return e?{date:e.toLocaleDateString(),time:e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}:{date:"—",time:""}}function ae(e){const t=encodeURIComponent(JSON.stringify({title:e.title,category:e.category,price:e.price,imageUrl:e.imageUrl,description:e.description,listingType:e.listingType||"service"}));g(`/listings-vendors?prefill=${t}`)}function ie(e){const t=`Feedback request: ${e.title}`,n=`Hello Admin

My listing "${e.title}" (ID: ${e.id}) was ${String(e.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;N({open:!0,listing:e,subject:t,content:n,sending:!1,err:null,done:!1})}function M(){N({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function le(e){var t;if((t=e==null?void 0:e.preventDefault)==null||t.call(e),!(!o.listing||!o.content.trim())){N(n=>({...n,sending:!0,err:null}));try{await Q.post("/api/messages",{listingId:o.listing.id,listingTitle:o.listing.title,vendorId:(a==null?void 0:a.vendorId)||"",vendorEmail:(a==null?void 0:a.email)||"",subject:o.subject,content:o.content}),N(n=>({...n,sending:!1,done:!0}));try{await E({force:!0}),await D()}catch{}setTimeout(()=>M(),1200)}catch(n){N(l=>{var h,m;return{...l,sending:!1,err:((m=(h=n==null?void 0:n.response)==null?void 0:h.data)==null?void 0:m.message)||(n==null?void 0:n.message)||"Failed to send"}})}}}return s.jsx(ue,{activeRoute:"/listings-vendors-mine",pageTitle:"My listings",children:s.jsxs("div",{className:"container py-4",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[s.jsx("h1",{className:"h4 mb-0",children:"My listings"}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:V,disabled:C||K||A,children:K||A?"Refreshing…":"Refresh"}),s.jsx(R,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})]})]}),s.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[s.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",B.approved]}),s.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",B.pending]}),s.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",B.rejected]}),s.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",x.length]})]}),s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[H&&s.jsx("div",{className:"alert alert-danger",children:H}),C&&s.jsx("div",{className:"text-muted",children:"Loading…"}),!C&&!x.length&&s.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",s.jsx(R,{to:"/listings-vendors",children:"Create your first one."})]}),!C&&!!x.length&&s.jsx("div",{className:"table-responsive",children:s.jsxs("table",{className:"table align-middle",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{style:{width:72}}),s.jsx("th",{children:"Title"}),s.jsx("th",{children:"Category"}),s.jsx("th",{children:"Price"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Bookings"}),s.jsx("th",{style:{width:220},children:"Actions"})]})}),s.jsx("tbody",{children:x.map((e,t)=>{const n=String(e.id||e.serviceId||e.vendorId||"");return s.jsxs("tr",{children:[s.jsx("td",{children:s.jsx("img",{src:e.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),s.jsx("td",{className:"fw-semibold",children:e.title}),s.jsx("td",{children:e.category||"—"}),s.jsxs("td",{children:["R",Number(e.price||0).toLocaleString()]}),s.jsx("td",{children:s.jsx(G,{s:e.status})}),s.jsx("td",{children:ee[n]||0}),s.jsxs("td",{className:"d-flex gap-2",children:[s.jsx(R,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(e.id)}`,children:"View"}),s.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>ae(e),children:"Duplicate & edit"}),String(e.status||"").toLowerCase()==="rejected"&&s.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>ie(e),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},n||t)})})]})})]})}),s.jsxs("div",{className:"card mt-4",children:[s.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[s.jsx("h6",{className:"mb-0",children:"Bookings"}),s.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",b.length]})]}),s.jsxs("div",{className:"card-body",children:[!b.length&&s.jsx("div",{className:"text-muted",children:"No bookings yet. Once customers reserve sessions, they will appear here."}),!!b.length&&s.jsx("div",{className:"table-responsive",children:s.jsxs("table",{className:"table align-middle",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Service"}),s.jsx("th",{children:"Customer"}),s.jsx("th",{children:"Scheduled"}),s.jsx("th",{children:"Status"}),s.jsx("th",{className:"text-end",children:"Price"})]})}),s.jsx("tbody",{children:ne.map((e,t)=>{const n=F(e),{date:l,time:h}=re(n),m=te(e.scheduledSlot),r=se[String(e.serviceId||"")],p=e.serviceTitle||(r==null?void 0:r.title)||"Unknown service",f=Number(e.price||(r==null?void 0:r.price)||0)||0,v=String(e.id||[e.serviceId,e.customerId,e.scheduledDate,e.scheduledSlot,e.bookedAt].filter(Boolean).join("-")||t);return s.jsxs("tr",{children:[s.jsx("td",{children:s.jsxs("div",{className:"d-flex flex-column",children:[s.jsx("span",{className:"fw-semibold",children:p}),(r==null?void 0:r.id)&&s.jsx(R,{className:"small",to:`/marketplace-details?id=${encodeURIComponent(r.id)}`,children:"Open listing"})]})}),s.jsx("td",{children:s.jsx("div",{className:"small text-muted",children:e.customerName||e.customerEmail||"—"})}),s.jsx("td",{children:s.jsxs("div",{className:"d-flex flex-column small",children:[s.jsx("span",{children:l}),s.jsx("span",{children:m||h})]})}),s.jsx("td",{children:s.jsx(G,{s:e.status||"pending"})}),s.jsxs("td",{className:"text-end",children:["R",f.toLocaleString()]})]},v)})})]})})]})]}),o.open&&o.listing&&s.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:e=>e.target===e.currentTarget&&M(),children:s.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[s.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[s.jsxs("h6",{className:"mb-0",children:["Message Admin about: ",o.listing.title]}),s.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:M,children:"Close"})]}),s.jsxs("form",{onSubmit:le,children:[s.jsxs("div",{className:"card-body",children:[o.err&&s.jsx("div",{className:"alert alert-danger py-2 mb-2",children:o.err}),o.done&&s.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label",children:"Subject"}),s.jsx("input",{className:"form-control",value:o.subject,onChange:e=>N(t=>({...t,subject:e.target.value}))})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label",children:"Message"}),s.jsx("textarea",{className:"form-control",rows:6,value:o.content,onChange:e=>N(t=>({...t,content:e.target.value}))}),s.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",(a==null?void 0:a.email)||"you"]})]})]}),s.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[s.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:M,disabled:o.sending,children:"Cancel"}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:o.sending||!o.content.trim(),children:o.sending?"Sending…":"Send"})]})]})]})})]})})}export{je as default};
