import{c as F,r as m,j as e,L as g,a as w}from"./index-BFSQDcJW.js";import{u as P,M as U}from"./MasterLayout-CsctlgZZ.js";import{B}from"./Breadcrumb-BCqRyta0.js";import{I as u}from"./iconify-BdsTFD2T.js";import{a as V}from"./appData-CCm-4Pix.js";const H=()=>{const{threads:b,unreadCount:I,markRead:M,refresh:S}=P(),{vendor:r}=F(),[j,E]=m.useState(""),[a,d]=m.useState({open:!1,mode:r!=null&&r.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1,subscriberEmail:""}),[C,v]=m.useState([]),[L,f]=m.useState([]),[n,p]=m.useState({q:"",page:1,pageSize:10,total:0,items:[],loading:!1}),_=(typeof window<"u"?sessionStorage.getItem("tenantId"):null)||"vendor",k=m.useMemo(()=>{const s=j.trim().toLowerCase();return s?b.filter(t=>{var i;const l=(t.subject||"").toLowerCase(),c=(((i=t.lastMessage)==null?void 0:i.snippet)||"").toLowerCase();return l.includes(s)||c.includes(s)}):b},[b,j]),z=I===0,A=async()=>{await Promise.all(b.filter(s=>!s.read).map(s=>M(s.id,!0)))};function q(){d(s=>({...s,open:!0}))}function x(){d({open:!1,mode:r!=null&&r.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1})}async function R(){try{const s=await fetch("/api/lms/live",{headers:{"x-tenant-id":_}}),t=s.ok?await s.json():V,l=Array.isArray(t==null?void 0:t.services)?t.services:[];if(r!=null&&r.vendorId){const c=l.filter(i=>String(i.vendorId||"")===String(r.vendorId));v(c.map(i=>({id:i.id,title:i.title})))}else v([]);try{const i=(await w.get("/api/subscriptions/my").then(o=>Array.isArray(o.data)?o.data:[])).map(o=>{var h;return{...o,title:((h=l.find(y=>String(y.id)===String(o.serviceId)))==null?void 0:h.title)||o.serviceId}});f(i)}catch{f([])}}catch{v([]),f([])}}async function N(s,t=n.q,l=n.page,c=n.pageSize){try{p(D=>({...D,loading:!0}));const{data:i}=await w.get(`/api/subscriptions/service/${encodeURIComponent(s)}`,{params:{q:t,page:l,pageSize:c}}),o=Number((i==null?void 0:i.page)||l),h=Number((i==null?void 0:i.pageSize)||c),y=Number((i==null?void 0:i.total)||0),$=Array.isArray(i==null?void 0:i.items)?i.items:[];p({q:t,page:o,pageSize:h,total:y,items:$,loading:!1})}catch{p(i=>({...i,loading:!1,items:[],total:0}))}}m.useEffect(()=>{a.open&&R()},[a.open,r==null?void 0:r.vendorId,_]),m.useEffect(()=>{a.open&&a.mode==="vendor_to_subscriber"&&a.serviceId?N(a.serviceId,n.q,1,n.pageSize):p({q:"",page:1,pageSize:10,total:0,items:[],loading:!1})},[a.open,a.mode,a.serviceId]);async function T(s){var t;if((t=s==null?void 0:s.preventDefault)==null||t.call(s),!(!a.serviceId||!a.content.trim())){d(l=>({...l,sending:!0,err:null,ok:!1}));try{const c={type:a.mode==="vendor_admin"?"vendor_admin":a.mode==="vendor_to_subscriber"?"vendor_to_subscriber":"vendor_subscriber",serviceId:a.serviceId,listingId:a.serviceId,subject:a.subject,content:a.content,subscriberEmail:a.mode==="vendor_to_subscriber"?a.subscriberEmail:void 0};await w.post("/api/messages/compose",c),d(i=>({...i,sending:!1,ok:!0})),await S(),setTimeout(()=>x(),1200)}catch(l){d(c=>{var i,o;return{...c,sending:!1,err:((o=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:o.message)||(l==null?void 0:l.message)||"Failed to send"}})}}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-xxl-3",children:e.jsx("div",{className:"card h-100 p-0",children:e.jsx("div",{className:"card-body p-24",children:e.jsxs("div",{className:"mt-16",children:[e.jsxs("button",{type:"button",className:"btn btn-primary btn-sm w-100 mb-3 d-flex align-items-center gap-2",onClick:q,children:[e.jsx(u,{icon:"fa6-regular:square-plus",className:"icon text-lg line-height-1"}),"Compose"]}),e.jsxs("ul",{children:[e.jsx("li",{className:"item-active mb-4",children:e.jsx(g,{to:"/email",className:"bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-secondary-light",children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(u,{icon:"uil:envelope",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Inbox"})]}),e.jsx("span",{className:"fw-medium",children:b.length})]})})}),e.jsx("li",{className:"mb-4",children:e.jsx(g,{to:"/email",className:"bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-secondary-light",children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(u,{icon:"ph:star-bold",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Unread"})]}),e.jsx("span",{className:"fw-medium",children:I})]})})})]})]})})})}),e.jsx("div",{className:"col-xxl-9",children:e.jsxs("div",{className:"card h-100 p-0 email-card",children:[e.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:S,children:[e.jsx(u,{icon:"tabler:reload",className:"me-1"})," Refresh"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:A,disabled:z,children:[e.jsx(u,{icon:"gravity-ui:envelope-open",className:"me-1"})," Mark all as read"]})]}),e.jsxs("form",{className:"navbar-search d-flex",onSubmit:s=>s.preventDefault(),children:[e.jsx("input",{type:"text",className:"bg-base h-40-px w-auto",name:"search",placeholder:"Search",value:j,onChange:s=>E(s.target.value)}),e.jsx(u,{icon:"ion:search-outline",className:"icon"})]})]})}),e.jsx("div",{className:"card-body p-0",children:e.jsxs("ul",{className:"overflow-x-auto",children:[k.map(s=>{var t,l,c,i,o;return e.jsxs("li",{className:`email-item px-24 py-16 d-flex gap-4 align-items-center border-bottom cursor-pointer bg-hover-neutral-200 min-w-max-content ${s.read?"":"bg-primary-50"}`,children:[e.jsx(g,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium text-md text-line-1 w-190-px",children:s.subject||"Message"}),e.jsx(g,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium mb-0 text-line-1 max-w-740-px",children:((t=s.lastMessage)==null?void 0:t.snippet)||((i=(c=s.messages)==null?void 0:c[((l=s.messages)==null?void 0:l.length)-1])==null?void 0:i.content)||""}),e.jsx("span",{className:"text-primary-light fw-medium min-w-max-content ms-auto",children:(o=s.lastMessage)!=null&&o.date?new Date(s.lastMessage.date).toLocaleString():""})]},s.id)}),k.length===0&&e.jsx("li",{className:"px-24 py-16 text-muted",children:"No messages"})]})})]})})]}),a.open&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&x(),children:e.jsxs("div",{className:"card",style:{maxWidth:640,margin:"8vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Compose message"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:x,children:"Close"})]}),e.jsxs("form",{onSubmit:T,children:[e.jsxs("div",{className:"card-body",children:[a.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:a.err}),a.ok&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-select",value:a.mode,onChange:s=>d(t=>({...t,mode:s.target.value,serviceId:"",subscriberEmail:""})),children:[(r==null?void 0:r.vendorId)&&e.jsx("option",{value:"vendor_admin",children:"Ask Admin about my listing"}),e.jsx("option",{value:"vendor_subscriber",children:"Message Vendor about a subscribed listing"}),(r==null?void 0:r.vendorId)&&e.jsx("option",{value:"vendor_to_subscriber",children:"Message a subscriber of my listing"})]})]}),a.mode==="vendor_admin"&&(r==null?void 0:r.vendorId)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my listings"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>d(t=>({...t,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),C.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),a.mode==="vendor_subscriber"&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my subscriptions"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>d(t=>({...t,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),L.map(s=>e.jsx("option",{value:s.serviceId,children:s.title},s.id))]})]}),a.mode==="vendor_to_subscriber"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select my listing"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>d(t=>({...t,serviceId:s.target.value,subscriberEmail:""})),children:[e.jsx("option",{value:"",children:"Select…"}),C.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"To (subscriber email)"}),e.jsx("input",{className:"form-control",value:a.subscriberEmail,onChange:s=>{const t=s.target.value;d(l=>({...l,subscriberEmail:t})),p(l=>({...l,q:t,page:1}))},placeholder:"Type to search subscribers",disabled:!a.serviceId}),a.serviceId&&e.jsxs("div",{className:"border rounded mt-2 p-2 bg-base",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"small text-secondary",children:"Suggestions"}),e.jsx("div",{className:"small text-secondary",children:n.loading?"Loading…":`${n.total} total`})]}),e.jsxs("div",{className:"list-group list-group-flush",style:{maxHeight:160,overflowY:"auto"},children:[n.items.map(s=>e.jsx("button",{type:"button",className:"list-group-item list-group-item-action py-1",onClick:()=>d(t=>({...t,subscriberEmail:s.email})),children:s.email},s.id)),!n.loading&&n.items.length===0&&e.jsx("div",{className:"text-muted small px-2 py-1",children:"No matches"})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:n.page<=1||n.loading,onClick:()=>N(a.serviceId,n.q,Math.max(1,n.page-1),n.pageSize),children:"Prev"}),e.jsxs("span",{className:"small text-secondary",children:["Page ",n.page," of ",Math.max(1,Math.ceil((n.total||0)/(n.pageSize||10)))]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:n.loading||n.page>=Math.ceil((n.total||0)/(n.pageSize||10)),onClick:()=>N(a.serviceId,n.q,n.page+1,n.pageSize),children:"Next"})]})]})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject (optional)"}),e.jsx("input",{className:"form-control",value:a.subject,onChange:s=>d(t=>({...t,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{rows:6,className:"form-control",value:a.content,onChange:s=>d(t=>({...t,content:s.target.value}))})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:x,disabled:a.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:a.sending||!a.serviceId||!a.content.trim()||a.mode==="vendor_to_subscriber"&&!a.subscriberEmail,children:a.sending?"Sending…":"Send"})]})]})]})})]})},O=()=>e.jsx(e.Fragment,{children:e.jsxs(U,{children:[e.jsx(B,{title:"Email"}),e.jsx(H,{})]})});export{O as default};
