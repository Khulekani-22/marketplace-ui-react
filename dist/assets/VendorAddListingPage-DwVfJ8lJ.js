import{u as ye,D as fe,E as xe,d as je,r as c,o as be,c as oe,b as P,a as f,j as t,L as le}from"./index-C1K-Ttoc.js";import{M as we}from"./MasterLayout-2IldCL2c.js";import"./iconify-CXWIXv_s.js";const $="/api/lms",G="__OTHER__";function me(){return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)}function ce(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return null}}function Ne(e,n){const i=(e||"public").toLowerCase(),A=(n||"").trim().toLowerCase();return A?`vendor_pending_listings:${i}:${A}`:null}function M(e){var n;return{id:(e==null?void 0:e.id)??me(),title:(e==null?void 0:e.title)??"",category:(e==null?void 0:e.category)??"",vendor:(e==null?void 0:e.vendor)??"",vendorId:(e==null?void 0:e.vendorId)??"",contactEmail:((e==null?void 0:e.contactEmail)||(e==null?void 0:e.email)||"").toLowerCase(),ownerUid:(e==null?void 0:e.ownerUid)??(e==null?void 0:e.ownerId)??"",ownerEmail:((e==null?void 0:e.ownerEmail)||(e==null?void 0:e.contactEmail)||(e==null?void 0:e.email)||"").toLowerCase(),price:Number((e==null?void 0:e.price)||0),rating:Number((e==null?void 0:e.rating)||0),reviewCount:typeof(e==null?void 0:e.reviewCount)=="number"?e.reviewCount:Number((e==null?void 0:e.reviewCount)||((n=e==null?void 0:e.reviews)==null?void 0:n.length)||0),imageUrl:(e==null?void 0:e.imageUrl)??"",aiHint:(e==null?void 0:e.aiHint)??"",listingType:(e==null?void 0:e.listingType)??"service",status:(e==null?void 0:e.status)??"pending",isFeatured:!!(e!=null&&e.isFeatured),description:(e==null?void 0:e.description)??"",reviews:Array.isArray(e==null?void 0:e.reviews)?e.reviews:[],tags:Array.isArray(e==null?void 0:e.tags)?e.tags:[],source:(e==null?void 0:e.source)??"",clonedFrom:(e==null?void 0:e.clonedFrom)??"",tenantId:(e==null?void 0:e.tenantId)??"public",createdAt:(e==null?void 0:e.createdAt)??(e==null?void 0:e.created_at)??new Date().toISOString()}}function ue(e,n={}){const i=((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||n.email||"").toLowerCase();return{id:String((e==null?void 0:e.id)??(e==null?void 0:e.vendorId)??n.vendorId??""),vendorId:String((e==null?void 0:e.vendorId)??(e==null?void 0:e.id)??n.vendorId??""),name:(e==null?void 0:e.name)??(e==null?void 0:e.companyName)??(e==null?void 0:e.vendor)??n.name??"",contactEmail:i,ownerUid:(e==null?void 0:e.ownerUid)??(e==null?void 0:e.uid)??n.uid??"",status:((e==null?void 0:e.status)||"active").toLowerCase()}}function de(e,n){if(!e)return null;const i=((n==null?void 0:n.email)||"").toLowerCase(),A=[Array.isArray(e.startups)&&e.startups,Array.isArray(e.vendors)&&e.vendors,Array.isArray(e.companies)&&e.companies,Array.isArray(e.profiles)&&e.profiles].filter(Boolean);for(const k of A){const U=k.find(s=>(s==null?void 0:s.ownerUid)&&s.ownerUid===(n==null?void 0:n.uid)||(s==null?void 0:s.email)&&s.email.toLowerCase()===i||(s==null?void 0:s.contactEmail)&&s.contactEmail.toLowerCase()===i||(n==null?void 0:n.vendorId)&&(String(s==null?void 0:s.vendorId)===String(n.vendorId)||String(s==null?void 0:s.id)===String(n.vendorId)));if(U)return ue(U,n)}return null}function Ce(){var ie,ne,se;const e=ye(),[n]=fe(),{vendor:i,ensureVendorId:A,refresh:k}=xe(),{syncNow:U}=je(),s=c.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),_=be(sessionStorage.getItem("role")),[N,Y]=c.useState(oe),[L,K]=c.useState(()=>_?[]:[]),ge=c.useMemo(()=>{const a=(N==null?void 0:N.services)||[];return Array.from(new Set(a.map(g=>(g.category||"").trim()).filter(Boolean)))},[N]),[W,Q]=c.useState(!1),[X,I]=c.useState(""),[Z,V]=c.useState(""),R=c.useMemo(()=>{const a=n.get("prefill");return a?ce(decodeURIComponent(a)):null},[n]),[u,pe]=c.useState(null);c.useEffect(()=>{let a=!0;return(async()=>{var g;await A();try{let x=oe;try{const{data:o}=await P.get(`${$}/live`,{headers:{"x-tenant-id":s,"cache-control":"no-cache"}});if(o){x=o;const h=n.get("from");if(h){const m=(g=o==null?void 0:o.services)==null?void 0:g.find(b=>String(b.id)===String(h));m&&pe(m)}}}catch{}try{const{data:o}=await P.get("/api/data/vendors"),h=Array.isArray(o)?o:[],m=JSON.parse(JSON.stringify(x));m.startups=Array.isArray(m.startups)?m.startups:[],h.forEach(b=>{const J=(b.email||b.contactEmail||"").toLowerCase(),T=String(b.vendorId||b.id||J||""),D=m.startups.findIndex(q=>String(q.vendorId||q.id)===T),y={...m.startups[D]||{},...b,vendorId:T,id:T};D>=0?m.startups[D]=y:m.startups.push(y)}),x=m}catch{}if(a&&Y(x),_)try{const{data:o}=await P.get(`${$}/checkpoints`,{headers:{"x-tenant-id":s,"cache-control":"no-cache"}}),h=Array.isArray(o==null?void 0:o.items)?o.items:[];a&&K(h)}catch{a&&K([])}}catch{}})(),()=>{a=!1}},[s,_]);const r=c.useMemo(()=>{var g,x,o;const a={uid:(g=f.currentUser)==null?void 0:g.uid,email:((x=f.currentUser)==null?void 0:x.email)||(i==null?void 0:i.email)||"",name:((o=f.currentUser)==null?void 0:o.displayName)||(i==null?void 0:i.name)||"",vendorId:(i==null?void 0:i.vendorId)||""};return de(N,a)||ue({},a)},[N,i==null?void 0:i.vendorId,(ie=f.currentUser)==null?void 0:ie.uid,(ne=f.currentUser)==null?void 0:ne.email]);c.useEffect(()=>{!(i!=null&&i.vendorId)&&(r!=null&&r.vendorId)&&(k==null||k())},[r==null?void 0:r.vendorId]);const ee=((r==null?void 0:r.status)||"").toLowerCase(),B=ee==="active",H=ee==="suspended",d=c.useMemo(()=>M(u||R||{}),[u,R]),[l,te]=c.useState({title:d.title||"",categoryChoice:d.category||"",categoryCustom:"",price:d.price?String(d.price):"",imageUrl:d.imageUrl||"",description:d.description||"",listingType:d.listingType||"service"});c.useEffect(()=>{te(a=>({...a,title:u?`${d.title} (Copy)`:d.title||a.title,categoryChoice:d.category||a.categoryChoice,price:d.price?String(d.price):a.price,imageUrl:d.imageUrl||a.imageUrl,description:d.description||a.description,listingType:d.listingType||a.listingType}))},[u==null?void 0:u.id]);function S(a,g){te(x=>({...x,[a]:g}))}const ae=l.categoryChoice===G?l.categoryCustom.trim():(l.categoryChoice||"").trim(),re=((r==null?void 0:r.contactEmail)||"").toLowerCase()||(((se=f.currentUser)==null?void 0:se.email)||"").toLowerCase(),E=!(r!=null&&r.vendorId),v=E||H||!B;c.useEffect(()=>{if(f.currentUser&&(E||!B)){const a=encodeURIComponent(window.location.pathname+window.location.search);e(`/profile-vendor?next=${a}`)}},[E,B]);async function he(a){var m,b,J,T,D;if(a.preventDefault(),I(""),V(""),E){I("Please create your vendor profile before submitting a listing.");return}if(!B){I("Your vendor account is not yet approved. Please complete your profile and wait for admin approval.");return}if(H){I("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}if(!l.title.trim()||!ae){I("Title and category are required.");return}let g=N;try{const{data:y}=await P.get(`${$}/live`,{headers:{"x-tenant-id":s,"cache-control":"no-cache"}});y&&(g=y)}catch{g=N}const x={uid:(m=f.currentUser)==null?void 0:m.uid,email:((b=f.currentUser)==null?void 0:b.email)||(i==null?void 0:i.email)||"",name:((J=f.currentUser)==null?void 0:J.displayName)||(i==null?void 0:i.name)||"",vendorId:(r==null?void 0:r.vendorId)||(i==null?void 0:i.vendorId)||""},o=de(g,x)||r;if(((o==null?void 0:o.status)||"").toLowerCase()==="suspended"){I("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}const h=M({id:me(),title:l.title.trim(),category:ae,vendor:o.name||o.contactEmail||"Vendor",vendorId:o.vendorId,contactEmail:re,ownerUid:((T=f.currentUser)==null?void 0:T.uid)||o.ownerUid||"",ownerEmail:re,price:Number(l.price||0),rating:0,reviewCount:0,imageUrl:(l.imageUrl||"").trim(),listingType:l.listingType||"service",status:"pending",isFeatured:!1,description:(l.description||"").trim(),reviews:[],createdAt:new Date().toISOString(),...u?{source:"duplicate",clonedFrom:u.id}:{},...R&&!u?{source:"prefill"}:{}});Q(!0);try{const y={...h,tenantId:s,tags:Array.isArray(h==null?void 0:h.tags)?h.tags:[]},{data:q}=await P.post("/api/data/services",y,{headers:{"Content-Type":"application/json","x-tenant-id":s}}),w=M(q||y);try{const{data:p}=await P.get(`${$}/live`,{headers:{"x-tenant-id":s,"cache-control":"no-cache"}}),j=p&&typeof p=="object"&&p.data?p.data:p;j&&typeof j=="object"&&!Array.isArray(j)?Y(j):Y(C=>{const O=C&&typeof C=="object"?{...C}:{},z=Array.isArray(O.services)?O.services:[];return{...O,services:[...z,w]}})}catch{Y(p=>{const j=p&&typeof p=="object"?{...p}:{},C=Array.isArray(j.services)?j.services:[];return{...j,services:[...C,w]}})}try{await(U==null?void 0:U())}catch{}try{const p=Ne(s,w.vendorId||w.contactEmail||w.ownerEmail||((D=f.currentUser)==null?void 0:D.uid)||"");if(p){const j=ce(localStorage.getItem(p)),C=Array.isArray(j)?j:[],O=String(w.id||w.serviceId||""),z=[w,...C.filter(F=>String((F==null?void 0:F.id)||(F==null?void 0:F.serviceId)||"")!==O)];localStorage.setItem(p,JSON.stringify(z))}}catch{}V("Listing submitted! Itâ€™s now pending review by the marketplace admins."),setTimeout(()=>e("/listings-vendors-mine",{replace:!0,state:{newListing:w}}),850)}catch(y){I((y==null?void 0:y.message)||"Failed to submit listing."),window.scrollTo({top:0,behavior:"smooth"})}finally{Q(!1)}}return t.jsx(we,{activeRoute:"/listings-vendors",pageTitle:"Submit a Listing",children:t.jsxs("div",{className:"container py-4",style:{maxWidth:880},children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[t.jsx("h1",{className:"h4 mb-0",children:"Submit a Listing"}),t.jsxs("div",{className:"text-muted small",children:["Vendor:"," ",r!=null&&r.vendorId?t.jsxs(t.Fragment,{children:[t.jsx("code",{className:"me-1",children:r.vendorId}),t.jsxs("span",{children:["(",r.name||r.contactEmail,")"]}),H&&t.jsx("span",{className:"badge text-bg-danger ms-2",children:"suspended"})]}):"not set"]})]}),E&&t.jsxs("div",{className:"alert alert-warning d-flex justify-content-between align-items-center",children:[t.jsx("div",{children:"You need a vendor profile before submitting a listing."}),t.jsx(le,{to:"/signup/vendor?next=/listings-vendors",className:"btn btn-sm btn-primary",children:"Create vendor profile"})]}),!E&&H&&t.jsxs("div",{className:"alert alert-danger",children:["Your vendor account is ",t.jsx("strong",{children:"suspended"}),". You cannot submit listings. Please contact support if you think this is an error."]}),u&&t.jsxs("div",{className:"alert alert-info",children:["Duplicating from ",t.jsx("strong",{children:u.title}),". Adjust fields and submit to create a new ",t.jsx("strong",{children:"pending"})," listing."]}),R&&!u&&t.jsxs("div",{className:"alert alert-info",children:["Form prefilled. Review and submit to create a"," ",t.jsx("strong",{children:"pending"})," listing."]}),X&&t.jsx("div",{className:"alert alert-danger",children:X}),Z&&t.jsx("div",{className:"alert alert-success",children:Z}),t.jsxs("div",{className:"card bg-body",children:[t.jsx("div",{className:"card-header bg-body-tertiary fw-semibold",children:"Listing details"}),t.jsx("div",{className:"card-body",children:t.jsxs("form",{onSubmit:he,noValidate:!0,children:[t.jsxs("div",{className:"row g-3 mb-1",children:[t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Vendor"}),t.jsx("input",{className:"form-control",value:(r==null?void 0:r.name)||(r==null?void 0:r.contactEmail)||"",disabled:!0,"aria-readonly":"true"})]}),t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Vendor ID"}),t.jsx("input",{className:"form-control",value:(r==null?void 0:r.vendorId)||"",disabled:!0,"aria-readonly":"true"})]})]}),t.jsxs("div",{className:"row g-3",children:[t.jsxs("div",{className:"col-md-8",children:[t.jsx("label",{className:"form-label",children:"Title"}),t.jsx("input",{className:"form-control",value:l.title,onChange:a=>S("title",a.target.value),placeholder:"e.g., Modern Logo & Brand Identity Pack",required:!0,disabled:v})]}),t.jsxs("div",{className:"col-md-4",children:[t.jsx("label",{className:"form-label",children:"Listing type"}),t.jsxs("select",{className:"form-select",value:l.listingType,onChange:a=>S("listingType",a.target.value),disabled:v,children:[t.jsx("option",{value:"service",children:"Service"}),t.jsx("option",{value:"saas",children:"SaaS"})]})]})]}),t.jsxs("div",{className:"row g-3 mt-1",children:[t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Category"}),t.jsxs("select",{className:"form-select",value:l.categoryChoice,onChange:a=>S("categoryChoice",a.target.value),disabled:v,required:!0,children:[t.jsx("option",{value:"",disabled:!0,children:"Pick a category"}),ge.map(a=>t.jsx("option",{value:a,children:a},a)),t.jsx("option",{value:G,children:"Otherâ€¦"})]})]}),l.categoryChoice===G&&t.jsxs("div",{className:"col-md-6",children:[t.jsx("label",{className:"form-label",children:"Custom category"}),t.jsx("input",{className:"form-control",value:l.categoryCustom,onChange:a=>S("categoryCustom",a.target.value),placeholder:"Type a new category",disabled:v,required:!0})]}),t.jsxs("div",{className:"col-md-3",children:[t.jsx("label",{className:"form-label",children:"Price (R)"}),t.jsx("input",{type:"number",min:"0",className:"form-control",value:l.price,onChange:a=>S("price",a.target.value),placeholder:"e.g., 8500",disabled:v})]}),t.jsxs("div",{className:"col-md-3",children:[t.jsx("label",{className:"form-label",children:"Image URL"}),t.jsx("input",{className:"form-control",value:l.imageUrl,onChange:a=>S("imageUrl",a.target.value),placeholder:"https://â€¦",disabled:v})]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("label",{className:"form-label",children:"Description"}),t.jsx("textarea",{className:"form-control",rows:4,value:l.description,onChange:a=>S("description",a.target.value),placeholder:"Describe what buyers get, deliverables, timelines, etc.",disabled:v})]}),t.jsxs("div",{className:"border rounded p-2 mt-3",children:[t.jsx("div",{className:"text-muted small mb-1",children:"Card preview"}),t.jsxs("div",{className:"d-flex align-items-center gap-2",children:[t.jsx("img",{src:l.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:120,height:72,objectFit:"cover",borderRadius:6}}),t.jsxs("div",{children:[t.jsx("div",{className:"fw-semibold",children:l.title||"Untitled service"}),t.jsx("div",{className:"text-muted small",children:(r==null?void 0:r.name)||(r==null?void 0:r.contactEmail)||"Vendor"}),t.jsxs("div",{className:"small",children:["R",Number(l.price||0).toLocaleString()," Â· â˜… 0.0"]})]})]})]}),t.jsxs("div",{className:"d-flex gap-2 mt-3",children:[t.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",type:"submit",disabled:W||v,children:W?"Submittingâ€¦":"Submit for review"}),t.jsx(le,{to:"/listings-vendors-mine",className:"btn btn-outline-secondary",children:"Cancel"})]}),t.jsxs("div",{className:"form-text mt-2",children:["Submissions are added as ",t.jsx("strong",{children:"pending"})," and become visible once approved by admins."]})]})})]}),_&&t.jsxs("div",{className:"card mt-3",children:[t.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[t.jsx("span",{children:"Recent checkpoints"}),t.jsx("span",{className:"text-muted small",children:"Latest snapshots"})]}),t.jsxs("div",{className:"list-group list-group-flush",children:[!(L!=null&&L.length)&&t.jsx("div",{className:"list-group-item text-muted small",children:"No checkpoints yet."}),L==null?void 0:L.slice(0,4).map(a=>t.jsxs("div",{className:"list-group-item d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("div",{className:"fw-semibold",children:a.message||"(no message)"}),t.jsx("div",{className:"text-muted small",children:new Date(a.ts).toLocaleString()})]}),t.jsx("a",{className:"btn btn-sm btn-outline-secondary",href:`${$}/checkpoints/${a.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]},a.id))]})]})]})})}export{Ce as default};
