import{u as M,d as A,r as c,c as N,a as T,j as e,L as x}from"./index-DGewQ82u.js";import{u as $,M as E}from"./MasterLayout-XUilH42m.js";import"./iconify-Ccvq_BdY.js";const R="/api/lms";function F({s:o}){const t=(o||"unknown").toLowerCase(),m={approved:"success",pending:"warning",rejected:"danger",unknown:"secondary"};return e.jsx("span",{className:`badge text-bg-${m[t]||"secondary"}`,children:t})}function P(){const o=M(),{vendor:t,ensureVendorId:m}=A(),{refresh:w,syncMessagesToLive:C}=$(),j=c.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[d,p]=c.useState([]),[h,I]=c.useState(!0),[a,r]=c.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1});c.useEffect(()=>{if(t&&!t.isApproved){const s=encodeURIComponent("/listings-vendors-mine");o(`/profile-vendor?next=${s}`,{replace:!0})}},[t,o]),c.useEffect(()=>{m();let s=!1;return(async()=>{try{const{data:i}=await N.get(`${R}/live`,{headers:{"x-tenant-id":j}}),n=i&&typeof i=="object"?i:T,u=(Array.isArray(n==null?void 0:n.services)?n.services:[]).filter(l=>{var y,v;return l.vendorId&&(t==null?void 0:t.vendorId)&&l.vendorId===t.vendorId||!l.vendorId&&(((y=l.vendor)==null?void 0:y.toLowerCase())===((t==null?void 0:t.name)||"").toLowerCase()||((v=l.contactEmail)==null?void 0:v.toLowerCase())===((t==null?void 0:t.email)||"").toLowerCase())});s||p(u)}catch{s||p([])}finally{s||I(!1)}})(),()=>{s=!0}},[j,t,m]);const b=c.useMemo(()=>{const s={approved:0,pending:0,rejected:0};return d.forEach(i=>{var n;return s[n=(i.status||"pending").toLowerCase()]||(s[n]=0),s[(i.status||"pending").toLowerCase()]++}),s},[d]);function k(s){const i=encodeURIComponent(JSON.stringify({title:s.title,category:s.category,price:s.price,imageUrl:s.imageUrl,description:s.description,listingType:s.listingType||"service"}));o(`/listings-vendors?prefill=${i}`)}function S(s){const i=`Feedback request: ${s.title}`,n=`Hello Admin

My listing "${s.title}" (ID: ${s.id}) was ${String(s.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;r({open:!0,listing:s,subject:i,content:n,sending:!1,err:null,done:!1})}function g(){r({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function L(s){var i;if((i=s==null?void 0:s.preventDefault)==null||i.call(s),!(!a.listing||!a.content.trim())){r(n=>({...n,sending:!0,err:null}));try{await N.post("/api/messages",{listingId:a.listing.id,listingTitle:a.listing.title,vendorId:(t==null?void 0:t.vendorId)||"",vendorEmail:(t==null?void 0:t.email)||"",subject:a.subject,content:a.content}),r(n=>({...n,sending:!1,done:!0}));try{await w(),await C()}catch{}setTimeout(()=>g(),1200)}catch(n){r(f=>{var u,l;return{...f,sending:!1,err:((l=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:l.message)||(n==null?void 0:n.message)||"Failed to send"}})}}}return e.jsx(E,{activeRoute:"/listings-vendors-mine",pageTitle:"My listings",children:e.jsxs("div",{className:"container py-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h1",{className:"h4 mb-0",children:"My listings"}),e.jsx("div",{className:"d-flex gap-2",children:e.jsx(x,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})})]}),e.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[e.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",b.approved]}),e.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",b.pending]}),e.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",b.rejected]}),e.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",d.length]})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[h&&e.jsx("div",{className:"text-muted",children:"Loading…"}),!h&&!d.length&&e.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",e.jsx(x,{to:"/listings-vendors",children:"Create your first one."})]}),!h&&!!d.length&&e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:72}}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Status"}),e.jsx("th",{style:{width:220},children:"Actions"})]})}),e.jsx("tbody",{children:d.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("img",{src:s.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),e.jsx("td",{className:"fw-semibold",children:s.title}),e.jsx("td",{children:s.category||"—"}),e.jsxs("td",{children:["R",Number(s.price||0).toLocaleString()]}),e.jsx("td",{children:e.jsx(F,{s:s.status})}),e.jsxs("td",{className:"d-flex gap-2",children:[e.jsx(x,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(s.id)}`,children:"View"}),e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>k(s),children:"Duplicate & edit"}),String(s.status||"").toLowerCase()==="rejected"&&e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>S(s),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},s.id))})]})})]})}),a.open&&a.listing&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&g(),children:e.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsxs("h6",{className:"mb-0",children:["Message Admin about: ",a.listing.title]}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:g,children:"Close"})]}),e.jsxs("form",{onSubmit:L,children:[e.jsxs("div",{className:"card-body",children:[a.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:a.err}),a.done&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject"}),e.jsx("input",{className:"form-control",value:a.subject,onChange:s=>r(i=>({...i,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{className:"form-control",rows:6,value:a.content,onChange:s=>r(i=>({...i,content:s.target.value}))}),e.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",(t==null?void 0:t.email)||"you"]})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:g,disabled:a.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:a.sending||!a.content.trim(),children:a.sending?"Sending…":"Send"})]})]})]})})]})})}export{P as default};
