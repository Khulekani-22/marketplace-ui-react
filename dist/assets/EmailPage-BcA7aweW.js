import{d as Ee,r as u,b as Te,a as be,j as e,L as pe,c as Y}from"./index-CgaA21Js.js";import{u as Ve,M as $e}from"./MasterLayout-ajeiF5Hb.js";import{B as Re}from"./Breadcrumb-Dc5n2DYD.js";import{I as C}from"./iconify-5qLksBFK.js";import{u as Pe}from"./useAppSync-3MBQQFvE.js";import{f as ze}from"./listings-CvoMyYg2.js";function De(d){const j=d.toString().toLowerCase();return j==="vendor"?"public":j}function qe(d,j){const q=De(d),k=(j||"").trim().toLowerCase();return k?`vendor_pending_listings:${q}:${k}`:null}function D(d){return String((d==null?void 0:d.id)||(d==null?void 0:d.serviceId)||(d==null?void 0:d.listingId)||"")}function Fe(d){try{const j=typeof d=="string"?JSON.parse(d):d;return Array.isArray(j)?j:[]}catch{return[]}}const Oe=()=>{var ge;const{threads:d,unreadCount:j,markRead:q,refresh:k,loading:he,refreshing:G,error:Q,syncMessagesToLive:X}=Ve(),{vendor:t}=Ee(),[F,xe]=u.useState(""),[E,Z]=u.useState("inbox"),ee=(typeof window<"u"?sessionStorage.getItem("role"):null)||"",[h,fe]=u.useState(()=>{const s=(typeof window<"u"?sessionStorage.getItem("messageViewAs"):null)||"";return s||(ee==="admin"?t!=null&&t.vendorId?"vendor":"admin":t!=null&&t.vendorId?"vendor":"user")}),[a,x]=u.useState({open:!1,mode:t!=null&&t.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1,subscriberEmail:""}),[se,te]=u.useState([]),[ve,T]=u.useState([]),[o,A]=u.useState({q:"",page:1,pageSize:10,total:0,items:[],loading:!1}),w=(typeof window<"u"?sessionStorage.getItem("tenantId"):null)||"vendor",{appData:V}=Pe(),ne=u.useMemo(()=>(w==="vendor"?"public":w).toString().toLowerCase(),[w]),O=u.useMemo(()=>qe(w,(t==null?void 0:t.vendorId)||(t==null?void 0:t.email)||(t==null?void 0:t.id)||""),[w,t==null?void 0:t.vendorId,t==null?void 0:t.email,t==null?void 0:t.id]),[ae,$]=u.useState([]);u.useEffect(()=>{if(!O){$([]);return}if(typeof window>"u"){$([]);return}try{const s=window.localStorage.getItem(O);$(Fe(s))}catch{$([])}},[O]);const ie=u.useCallback(s=>{const n=Array.isArray(s)?[...s]:[],r=new Set(n.map(m=>D(m)).filter(Boolean));return ae.forEach(m=>{const i=D(m);!i||r.has(i)||(r.add(i),n.unshift(m))}),n},[ae]),N=(((ge=Te.currentUser)==null?void 0:ge.email)||sessionStorage.getItem("userEmail")||"").toLowerCase(),re=ee,B=re==="admin"||!!(t!=null&&t.vendorId),K=(t==null?void 0:t.vendorId)||(t==null?void 0:t.id)||"",R=u.useMemo(()=>{const s=[];return h==="user"?N&&s.push(`user:${N}`):h==="vendor"?(K&&s.push(`vendor:${String(K).toLowerCase()}`),N&&s.push(`vendor:${N}`)):h==="admin"&&(s.push("admin"),N&&s.push(`admin:${N}`)),s},[h,N,K]),le=u.useMemo(()=>d.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(n=>R.includes(String(n.senderId||"").toLowerCase()))),[d,R]),ye=u.useMemo(()=>d.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(n=>!R.includes(String(n.senderId||"").toLowerCase()))),[d,R]),je=le.length,Ne=ye.length,U=E==="sent"?le:d,ce=u.useMemo(()=>{const s=F.trim().toLowerCase();return s?U.filter(n=>{var i;const r=(n.subject||"").toLowerCase(),m=(((i=n.lastMessage)==null?void 0:i.snippet)||"").toLowerCase();return r.includes(s)||m.includes(s)}):U},[U,F]),Se=j===0,we=async()=>{await Promise.all(d.filter(s=>!s.read).map(s=>q(s.id,!0)))},[oe,de]=u.useState(!1),[Ie,W]=u.useState(!1),[me,M]=u.useState(""),[ue,Ce]=u.useState(()=>{try{return localStorage.getItem("sl_messages_last_sync")||""}catch{return""}});async function Le(){if(!B){M("Vendor or admin access required to sync."),setTimeout(()=>M(""),2500);return}de(!0),M(""),W(!1);try{if(!await X())throw new Error("Sync did not complete");const n=new Date().toISOString();try{localStorage.setItem("sl_messages_last_sync",n)}catch{}Ce(n),W(!0),setTimeout(()=>W(!1),1500)}catch(s){M((s==null?void 0:s.message)||"Sync failed"),setTimeout(()=>M(""),2500)}finally{de(!1)}}u.useEffect(()=>{try{sessionStorage.setItem("messageViewAs",h)}catch{}x(s=>({...s,mode:h==="vendor"?"vendor_admin":"vendor_subscriber",serviceId:"",subscriberEmail:""}))},[h]);function _e(){x(s=>({...s,open:!0}))}function P(){x({open:!1,mode:t!=null&&t.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1})}async function ke(){try{const s=V||be,n=Array.isArray(s==null?void 0:s.services)?s.services:[];let r=[];try{const{listings:l}=await ze();r=Array.isArray(l)?l:[]}catch{r=[]}const m=t!=null&&t.vendorId?String(t.vendorId):t!=null&&t.id?String(t.id):"",i=((t==null?void 0:t.email)||(t==null?void 0:t.contactEmail)||"").toLowerCase(),g=n.filter(l=>{const b=String(l.vendorId||""),p=(l.contactEmail||l.email||"").toLowerCase();return m&&b===m||i&&p===i}),f=new Map;[...r,...g].forEach(l=>{const b=D(l);b&&(f.has(b)?f.set(b,{...f.get(b),...l}):f.set(b,l))});const y=ie(Array.from(f.values())).reduce((l,b)=>{const p=D(b);if(!p)return l;const I=(b==null?void 0:b.title)||(b==null?void 0:b.name)||(b==null?void 0:b.listingTitle)||"Untitled listing";return l.push({id:p,title:I}),l},[]);te(y);try{const b=(await Y.get("/api/subscriptions/my").then(p=>Array.isArray(p.data)?p.data:[])).map(p=>{var I,z;return{...p,title:((I=y.find(c=>String(c.id)===String(p.serviceId)))==null?void 0:I.title)||((z=n.find(c=>String(c.id)===String(p.serviceId)))==null?void 0:z.title)||p.serviceId}});T(b)}catch(l){if((l==null?void 0:l.code)==="ERR_NETWORK"){const p=(w==="vendor"?"public":w).toString().toLowerCase(),c=(Array.isArray(s==null?void 0:s.subscriptions)?s.subscriptions:[]).filter(v=>{const L=((v==null?void 0:v.tenantId)??"public").toString().toLowerCase()===p,_=((v==null?void 0:v.email)||"").toLowerCase();return L&&_===N}).map(v=>{var L,_;return{...v,title:((L=y.find(J=>String(J.id)===String(v.serviceId)))==null?void 0:L.title)||((_=n.find(J=>String(J.id)===String(v.serviceId)))==null?void 0:_.title)||v.serviceId}});T(c)}else T([])}}catch{te([]),T([])}}const Ae=u.useCallback((s,n="",r=1,m=10)=>{if(!s)return{items:[],total:0};const i=V||be,g=Array.isArray(i==null?void 0:i.subscriptions)?i.subscriptions:[],f=t!=null&&t.vendorId?String(t.vendorId).toLowerCase():"",S=(n||"").trim().toLowerCase(),y=g.filter(c=>{const v=((c==null?void 0:c.tenantId)??"public").toString().toLowerCase()===ne,L=String((c==null?void 0:c.serviceId)||"")===String(s),_=f?String((c==null?void 0:c.vendorId)||"").toLowerCase()===f:!0;return v&&L&&_}),l=S?y.filter(c=>((c==null?void 0:c.email)||"").toLowerCase().includes(S)):y,b=l.length,p=Math.max(0,(Number(r)-1)*Number(m)),I=p+Number(m);return{items:l.slice(p,I).map(c=>({id:c.id||`${c.serviceId}-${c.email}`,email:c.email,tenantId:c.tenantId,serviceId:c.serviceId})),total:b}},[V,ne,t]);async function H(s,n=o.q,r=o.page,m=o.pageSize){try{A(l=>({...l,loading:!0}));const{data:i}=await Y.get(`/api/subscriptions/service/${encodeURIComponent(s)}`,{params:{q:n,page:r,pageSize:m}}),g=Number((i==null?void 0:i.page)||r),f=Number((i==null?void 0:i.pageSize)||m),S=Number((i==null?void 0:i.total)||0),y=Array.isArray(i==null?void 0:i.items)?i.items:[];A({q:n,page:g,pageSize:f,total:S,items:y,loading:!1})}catch{const i=Ae(s,n,r,m);A(g=>i.total>0?{q:n,page:r,pageSize:m,total:i.total,items:i.items,loading:!1}:{...g,q:n,page:r,pageSize:m,loading:!1})}}u.useEffect(()=>{a.open&&ke()},[a.open,t==null?void 0:t.vendorId,t==null?void 0:t.email,t==null?void 0:t.id,w,ie,V,N]),u.useEffect(()=>{a.open&&a.mode==="vendor_to_subscriber"&&a.serviceId?H(a.serviceId,o.q,1,o.pageSize):A({q:"",page:1,pageSize:10,total:0,items:[],loading:!1})},[a.open,a.mode,a.serviceId]);async function Me(s){var n,r,m,i;if((n=s==null?void 0:s.preventDefault)==null||n.call(s),!(!a.serviceId||!a.content.trim())){x(g=>({...g,sending:!0,err:null,ok:!1}));try{const f={type:a.mode==="vendor_admin"?"vendor_admin":a.mode==="vendor_to_subscriber"?"vendor_to_subscriber":"vendor_subscriber",serviceId:a.serviceId,listingId:a.serviceId,subject:a.subject,content:a.content,subscriberEmail:a.mode==="vendor_to_subscriber"?a.subscriberEmail:void 0};await Y.post("/api/messages/compose",f),x(S=>({...S,sending:!1,ok:!0})),await k({force:!0});try{await X()}catch{}setTimeout(()=>P(),1200)}catch(g){const f=(r=g==null?void 0:g.response)==null?void 0:r.status,S=((i=(m=g==null?void 0:g.response)==null?void 0:m.data)==null?void 0:i.message)||(g==null?void 0:g.message)||"Failed to send",y=f===401?" Please sign in to send messages.":"";x(l=>({...l,sending:!1,err:S+y}))}}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-xxl-3",children:e.jsx("div",{className:"card h-100 p-0",children:e.jsx("div",{className:"card-body p-24",children:e.jsxs("div",{className:"mt-16",children:[e.jsxs("button",{type:"button",className:"btn btn-primary btn-sm w-100 mb-3 d-flex align-items-center gap-2",onClick:_e,disabled:h==="admin",children:[e.jsx(C,{icon:"fa6-regular:square-plus",className:"icon text-lg line-height-1"}),"Compose"]}),e.jsxs("ul",{children:[e.jsx("li",{className:"item-active mb-4",children:e.jsx("button",{type:"button",onClick:()=>Z("inbox"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${E==="inbox"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(C,{icon:"uil:envelope",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Message Center"})]}),e.jsx("span",{className:"fw-medium",children:Ne})]})})}),e.jsx("li",{className:"mb-4",children:e.jsx("button",{type:"button",onClick:()=>Z("sent"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${E==="sent"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(C,{icon:"ion:paper-plane-outline",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Sent"})]}),e.jsx("span",{className:"fw-medium",children:je})]})})})]})]})})})}),e.jsx("div",{className:"col-xxl-9",children:e.jsxs("div",{className:"card h-100 p-0 email-card",children:[e.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{k({silent:!0,force:!0})},disabled:he||G,children:[e.jsx(C,{icon:"tabler:reload",className:"me-1"}),G?"Refreshing…":"Refresh"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:we,disabled:Se,children:[e.jsx(C,{icon:"gravity-ui:envelope-open",className:"me-1"})," Mark all as read"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:Le,disabled:oe||!B,title:B?"Write messages to server appData.json":"Vendor or admin access required",children:[e.jsx(C,{icon:"mdi:cloud-upload-outline",className:"me-1"})," ",oe?"Syncing…":"Sync Now"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("label",{className:"form-label mb-0 small text-muted",children:"View as"}),e.jsxs("select",{className:"form-select form-select-sm",value:h,onChange:s=>fe(s.target.value),children:[e.jsx("option",{value:"user",children:"Startup"}),(t==null?void 0:t.vendorId)&&e.jsx("option",{value:"vendor",children:"Vendor"}),re==="admin"&&e.jsx("option",{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("form",{className:"navbar-search d-flex",onSubmit:s=>s.preventDefault(),children:[e.jsx("input",{type:"text",className:"bg-base h-40-px w-auto",name:"search",placeholder:"Search",value:F,onChange:s=>xe(s.target.value)}),e.jsx(C,{icon:"ion:search-outline",className:"icon"})]}),e.jsx("div",{className:"small text-muted",children:me?e.jsx("span",{className:"text-danger",children:me}):Ie?e.jsx("span",{className:"text-success",children:"Synced"}):ue?`Last sync: ${new Date(ue).toLocaleString()}`:""})]})]})}),e.jsxs("div",{className:"card-body p-0",children:[Q&&e.jsx("div",{className:"alert alert-danger rounded-0 border-bottom mb-0",children:Q}),e.jsxs("ul",{className:"overflow-x-auto",children:[ce.map(s=>{var n,r,m,i,g;return e.jsxs("li",{className:`email-item px-24 py-16 d-flex gap-4 align-items-center border-bottom cursor-pointer bg-hover-neutral-200 min-w-max-content ${s.read?"":"bg-primary-50"}`,children:[e.jsx(pe,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium text-md text-line-1 w-190-px",children:s.subject||"Message"}),e.jsx(pe,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium mb-0 text-line-1 max-w-740-px",children:((n=s.lastMessage)==null?void 0:n.snippet)||((i=(m=s.messages)==null?void 0:m[((r=s.messages)==null?void 0:r.length)-1])==null?void 0:i.content)||""}),e.jsx("span",{className:"text-primary-light fw-medium min-w-max-content ms-auto",children:(g=s.lastMessage)!=null&&g.date?new Date(s.lastMessage.date).toLocaleString():""})]},s.id)}),ce.length===0&&e.jsx("li",{className:"px-24 py-16 text-muted",children:E==="sent"?"No sent messages for this role; try switching “View as”.":"No messages yet. Try switching “View as” or start a conversation."})]})]})]})})]}),a.open&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&P(),children:e.jsxs("div",{className:"card",style:{maxWidth:640,margin:"8vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Compose message"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:P,children:"Close"})]}),e.jsxs("form",{onSubmit:Me,children:[e.jsxs("div",{className:"card-body",children:[a.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:a.err}),a.ok&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-select",value:a.mode,onChange:s=>x(n=>({...n,mode:s.target.value,serviceId:"",subscriberEmail:""})),children:[h==="vendor"&&(t==null?void 0:t.vendorId)&&e.jsx("option",{value:"vendor_admin",children:"Ask Admin about my listing"}),h==="user"&&e.jsx("option",{value:"vendor_subscriber",children:"Message Vendor about a subscribed listing"}),h==="vendor"&&(t==null?void 0:t.vendorId)&&e.jsx("option",{value:"vendor_to_subscriber",children:"Message a subscriber of my listing"})]})]}),a.mode==="vendor_admin"&&h==="vendor"&&(t==null?void 0:t.vendorId)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my listings"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>x(n=>({...n,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),se.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),a.mode==="vendor_subscriber"&&h==="user"&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my subscriptions"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>x(n=>({...n,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),ve.map(s=>e.jsx("option",{value:s.serviceId,children:s.title},s.id))]})]}),a.mode==="vendor_to_subscriber"&&h==="vendor"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select my listing"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>x(n=>({...n,serviceId:s.target.value,subscriberEmail:""})),children:[e.jsx("option",{value:"",children:"Select…"}),se.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"To (subscriber email)"}),e.jsx("input",{className:"form-control",value:a.subscriberEmail,onChange:s=>{const n=s.target.value;x(r=>({...r,subscriberEmail:n})),A(r=>({...r,q:n,page:1}))},placeholder:"Type to search subscribers",disabled:!a.serviceId}),a.serviceId&&e.jsxs("div",{className:"border rounded mt-2 p-2 bg-base",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"small text-secondary",children:"Suggestions"}),e.jsx("div",{className:"small text-secondary",children:o.loading?"Loading…":`${o.total} total`})]}),e.jsxs("div",{className:"list-group list-group-flush",style:{maxHeight:160,overflowY:"auto"},children:[o.items.map(s=>e.jsx("button",{type:"button",className:"list-group-item list-group-item-action py-1",onClick:()=>x(n=>({...n,subscriberEmail:s.email})),children:s.email},s.id)),!o.loading&&o.items.length===0&&e.jsx("div",{className:"text-muted small px-2 py-1",children:"No matches"})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:o.page<=1||o.loading,onClick:()=>H(a.serviceId,o.q,Math.max(1,o.page-1),o.pageSize),children:"Prev"}),e.jsxs("span",{className:"small text-secondary",children:["Page ",o.page," of ",Math.max(1,Math.ceil((o.total||0)/(o.pageSize||10)))]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:o.loading||o.page>=Math.ceil((o.total||0)/(o.pageSize||10)),onClick:()=>H(a.serviceId,o.q,o.page+1,o.pageSize),children:"Next"})]})]})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject (optional)"}),e.jsx("input",{className:"form-control",value:a.subject,onChange:s=>x(n=>({...n,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{rows:6,className:"form-control",value:a.content,onChange:s=>x(n=>({...n,content:s.target.value}))})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:P,disabled:a.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:a.sending||!a.serviceId||!a.content.trim()||a.mode==="vendor_to_subscriber"&&!a.subscriberEmail,children:a.sending?"Sending…":"Send"})]})]})]})})]})},Ge=()=>e.jsx(e.Fragment,{children:e.jsxs($e,{children:[e.jsx(Re,{title:"Message Center"}),e.jsx(Oe,{})]})});export{Ge as default};
