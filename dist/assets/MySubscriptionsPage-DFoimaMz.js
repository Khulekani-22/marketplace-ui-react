import{f as z,a as p,c as m,k as $,j as e,M as _,l as H}from"./index-BuQ02B8O.js";import{B as J}from"./Breadcrumb-DEgLa9As.js";import{r as l}from"./vendor-DW3XjTa1.js";import"./firebase-ARhtPVQA.js";import"./utils-B2rxisVD.js";function q(){const[S,w]=l.useState(!0),[g,b]=l.useState([]),[x,k]=l.useState([]),[P,A]=l.useState([]),[u,I]=l.useState("subscriptions"),[C,f]=l.useState(""),[j,U]=l.useState({}),[F,M]=l.useState(!1),L=l.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),{appData:N}=z(),h=l.useMemo(()=>Array.isArray(N?.services)?N.services:[],[N]),B=l.useCallback(async s=>{if(!s.size)return[];const r=Math.max(50,Math.min(500,s.size*3));try{const{data:t}=await p.get("/api/data/services",{params:{page:1,pageSize:r},suppressToast:!0,suppressErrorLog:!0}),a=(Array.isArray(t?.items)?t.items:[]).filter(d=>s.has(String(d?.id??""))),o=new Set(a.map(d=>String(d?.id??"")));if(o.size!==s.size&&h.length){const d=[...s].filter(i=>!o.has(i));if(d.length){const i=h.filter(c=>d.includes(String(c?.id??"")));if(i.length)return[...a,...i]}}return a}catch(t){if(console.warn("Failed to fetch services from API; using appData fallback",t),h.length)return h.filter(n=>s.has(String(n?.id??"")));throw t}},[h]),D=l.useCallback(async()=>{try{console.log("🔗 Testing API connection..."),console.log("🔗 Current API base URL:",p.defaults.baseURL);const s=await p.get("/api/health");if(console.log("✅ API health check passed:",s.data),m.currentUser){console.log("🔐 Testing authenticated endpoint...");const r=await p.get("/api/subscriptions/my");console.log("✅ Subscriptions endpoint test:",r.data)}}catch(s){console.error("❌ API connection test failed:",s),console.error("❌ Error details:",s?.response?.data)}},[]);l.useEffect(()=>{D()},[D]);const v=l.useCallback(async(s={})=>{const{silent:r,signal:t}=s;r?M(!0):w(!0),f("");try{if(!m.currentUser){console.log("🔐 No authenticated user found"),t?.aborted||(b([]),k([]),A([]));return}console.log("📡 Fetching subscriptions and bookings for user:",m.currentUser.email);const n=await $();console.log("📋 Raw subscriptions from API:",n),t?.aborted||A(n);const a=new Set(n.filter(i=>(i.type||"service")==="service"&&i.serviceId!=null).map(i=>String(i.serviceId)));console.log("🔍 Service IDs from subscriptions:",Array.from(a));const o=await B(a);console.log("✅ Matched services:",o.length,o.map(i=>({id:i.id,title:i.title})));let d=[];try{const{data:i}=await p.get("/api/subscriptions/bookings/mine",{suppressToast:!0,suppressErrorLog:!0});Array.isArray(i?.bookings)&&(d=i.bookings.map(c=>({id:c.id||"",serviceId:String(c.serviceId||""),serviceTitle:c.serviceTitle||"Unknown Service",vendorName:c.vendorName||c.vendor||"",scheduledDate:c.scheduledDate||"",scheduledSlot:c.scheduledSlot||"",status:c.status||"scheduled",price:Number(c.price||0),bookedAt:c.bookedAt||c.createdAt||"",imageUrl:c.imageUrl||""})),console.log("📅 Fetched bookings:",d.length))}catch(i){console.warn("⚠️ Failed to fetch bookings:",i)}t?.aborted||(b(o),k(d))}catch(n){console.error("❌ Failed to load data:",n),t?.aborted||f(n?.message||"Failed to load subscriptions")}finally{t?.aborted||(r?M(!1):w(!1))}},[B]);l.useEffect(()=>{const s=new AbortController;return v({silent:!1,signal:s.signal}),()=>{s.abort()}},[v,L]);async function E(s){const r=String(s);console.log("🔄 Starting unsubscribe process for service:",r),console.log("🔄 Current user:",m.currentUser?.email),console.log("🔄 Current tenant:",L),U(t=>({...t,[r]:!0}));try{console.log("🔍 Fetching current subscriptions before unsubscribe...");const t=await $();console.log("📋 Current subscriptions:",t);const n=t.find(a=>String(a.serviceId)===r);if(console.log("🎯 Target subscription to cancel:",n),!n){console.log("⚠️ No subscription found in cache for service:",r),b(a=>a.filter(o=>String(o.id)!==r)),alert(`✅ Service ${r} removed from your subscriptions (was already cancelled)`);return}console.log("📡 Calling unsubscribeFromService API...");try{const a=await H(r);console.log("✅ Unsubscribe API success:",a),alert(`✅ Successfully unsubscribed from service ${r}`)}catch(a){if(a?.response?.status===404)console.log("⚠️ Backend says subscription not found (404) - treating as already cancelled"),alert(`✅ Service ${r} removed from your subscriptions (was already cancelled on server)`);else throw a}b(a=>{const o=a.filter(d=>String(d.id)!==r);return console.log("📝 Updated items count:",o.length),o}),console.log("�️ Clearing subscription from local cache...");try{const a=`sl_subscriptions_cache_v1:${m.currentUser?.uid||m.currentUser?.email}`,o=localStorage.getItem(a);if(o){const i=JSON.parse(o).filter(c=>String(c.serviceId)!==r);localStorage.setItem(a,JSON.stringify(i)),console.log("🗑️ Removed subscription from cache, remaining:",i.length)}}catch(a){console.log("⚠️ Failed to update cache:",a)}console.log("✅ Unsubscribe completed - skipping refresh to prevent reappearing")}catch(t){console.error("❌ Failed to unsubscribe:",t),console.error("❌ Error response:",t?.response),console.error("❌ Error data:",t?.response?.data),console.error("❌ Error status:",t?.response?.status);const n=t?.response?.data?.message||t?.message||"Failed to unsubscribe";alert(`❌ Unsubscribe failed for service ${r}: ${n}`)}finally{U(t=>({...t,[r]:!1})),console.log("🏁 Unsubscribe process completed for service:",r)}}const y=s=>{if(!s)return"";try{return new Date(s).toLocaleDateString("en-ZA",{year:"numeric",month:"short",day:"numeric"})}catch{return s}},R=s=>{if(!s)return"";const[r]=s.split(":"),t=parseInt(r,10),n=t>=12?"PM":"AM";return`${t>12?t-12:t===0?12:t}:00 ${n}`},T=(s="scheduled")=>{switch(s.toLowerCase()){case"completed":return"bg-success-600";case"scheduled":return"bg-primary-600";case"canceled":case"cancelled":return"bg-danger-600";default:return"bg-secondary-600"}};return e.jsxs(_,{children:[e.jsx(J,{title:"My Subscriptions & Bookings"}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header border-bottom py-16 px-24",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between gap-3 flex-wrap",children:[e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{type:"button",className:`btn btn-sm ${u==="subscriptions"?"btn-primary-600":"btn-outline-primary"}`,onClick:()=>I("subscriptions"),children:[e.jsx("i",{className:"ri-shopping-cart-line me-1"}),"Subscriptions (",g.length,")"]}),e.jsxs("button",{type:"button",className:`btn btn-sm ${u==="bookings"?"btn-primary-600":"btn-outline-primary"}`,onClick:()=>I("bookings"),children:[e.jsx("i",{className:"ri-calendar-check-line me-1"}),"Bookings (",x.length,")"]})]}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>v({silent:!0}),disabled:S||F,children:F?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Refreshing…"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-refresh-line me-1"}),"Refresh"]})})]})}),e.jsxs("div",{className:"card-body",children:[C&&e.jsxs("div",{className:"alert alert-danger alert-dismissible fade show",role:"alert",children:[e.jsx("i",{className:"ri-error-warning-line me-2"}),C,e.jsx("button",{type:"button",className:"btn-close",onClick:()=>f(""),"aria-label":"Close"})]}),S?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border text-primary-600",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsxs("p",{className:"text-secondary mt-3",children:["Loading your ",u,"..."]})]}):e.jsxs(e.Fragment,{children:[u==="subscriptions"&&e.jsxs("div",{className:"row g-3",children:[g.length===0&&e.jsxs("div",{className:"col-12 text-center py-5",children:[e.jsx("i",{className:"ri-shopping-cart-line display-4 text-secondary mb-3"}),e.jsx("h5",{className:"text-secondary",children:"No active subscriptions"}),e.jsx("p",{className:"text-muted",children:"Browse the marketplace to subscribe to services"}),e.jsxs("a",{href:"/dashboard",className:"btn btn-primary-600 mt-2",children:[e.jsx("i",{className:"ri-store-2-line me-1"}),"Browse Marketplace"]})]}),g.map(s=>{const r=P.find(n=>String(n.serviceId)===String(s.id)),t=r?.scheduledDate&&r?.scheduledSlot;return e.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:e.jsxs("div",{className:"card h-100 shadow-sm hover-shadow",children:[s.imageUrl&&e.jsx("img",{src:s.imageUrl,className:"card-img-top",alt:s.title||"Listing",style:{height:180,objectFit:"cover"}}),e.jsxs("div",{className:"card-body d-flex flex-column",children:[e.jsx("h6",{className:"card-title mb-2",children:s.title||"Listing"}),e.jsxs("div",{className:"text-muted small mb-2",children:[e.jsx("i",{className:"ri-building-line me-1"}),s.vendor||"Unknown Vendor"]}),e.jsxs("div",{className:"text-muted small mb-2",children:[e.jsx("i",{className:"ri-price-tag-3-line me-1"}),s.category||"General"]}),s.description&&e.jsxs("p",{className:"flex-grow-1 text-secondary small mb-3",children:[s.description.slice(0,120),s.description.length>120?"…":""]}),t&&e.jsxs("div",{className:"alert alert-info alert-sm p-2 mb-3",children:[e.jsx("i",{className:"ri-calendar-line me-1"}),e.jsxs("small",{children:[e.jsx("strong",{children:"Next Session:"}),e.jsx("br",{}),y(r.scheduledDate)," at ",R(r.scheduledSlot)]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-auto pt-2 border-top",children:[e.jsxs("div",{children:[e.jsxs("strong",{className:"text-primary-600",children:["R ",Number(s.price||0).toLocaleString()]}),s.rating&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("i",{className:"ri-star-fill text-warning"}),Number(s.rating).toFixed(1)]})]}),e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>E(s.id),disabled:!!j[String(s.id)],children:j[String(s.id)]?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status"}),"Removing…"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-close-circle-line me-1"}),"Unsubscribe"]})})]})]})]})},String(s.id))})]}),u==="bookings"&&e.jsxs("div",{className:"row g-3",children:[x.length===0&&e.jsxs("div",{className:"col-12 text-center py-5",children:[e.jsx("i",{className:"ri-calendar-check-line display-4 text-secondary mb-3"}),e.jsx("h5",{className:"text-secondary",children:"No bookings found"}),e.jsx("p",{className:"text-muted",children:"Book service sessions to see them here"}),e.jsxs("a",{href:"/dashboard",className:"btn btn-primary-600 mt-2",children:[e.jsx("i",{className:"ri-calendar-event-line me-1"}),"Book a Session"]})]}),x.map(s=>e.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:e.jsx("div",{className:"card h-100 shadow-sm hover-shadow",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-3",children:[e.jsx("h6",{className:"card-title mb-0",children:s.serviceTitle}),e.jsx("span",{className:`badge ${T(s.status)}`,children:s.status||"Scheduled"})]}),s.vendorName&&e.jsxs("div",{className:"text-muted small mb-2",children:[e.jsx("i",{className:"ri-building-line me-1"}),s.vendorName]}),s.scheduledDate&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"d-flex align-items-center text-primary-600 mb-1",children:[e.jsx("i",{className:"ri-calendar-event-fill me-2"}),e.jsx("strong",{children:y(s.scheduledDate)})]}),s.scheduledSlot&&e.jsxs("div",{className:"d-flex align-items-center text-muted ms-4",children:[e.jsx("i",{className:"ri-time-line me-2"}),R(s.scheduledSlot)]})]}),s.price&&s.price>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("i",{className:"ri-money-dollar-circle-line me-1"}),e.jsxs("strong",{children:["R ",Number(s.price||0).toLocaleString()]})]}),s.bookedAt&&e.jsxs("div",{className:"text-muted small",children:[e.jsx("i",{className:"ri-calendar-check-line me-1"}),"Booked on ",y(s.bookedAt)]}),e.jsx("div",{className:"mt-3 pt-3 border-top",children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-sm btn-outline-primary flex-grow-1",onClick:()=>window.location.href=`/marketplace-details?id=${s.serviceId}`,children:[e.jsx("i",{className:"ri-eye-line me-1"}),"View Service"]}),s.status?.toLowerCase()==="scheduled"&&e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>E(s.serviceId),disabled:!!j[s.serviceId],title:"Cancel booking",children:e.jsx("i",{className:"ri-close-line"})})]})})]})})},s.id))]})]})]})]})]})}export{q as default};
