import{r as o,u as q,b as Y,a as j,j as e}from"./index-CDEs_jt0.js";import{f as D,u as Q,s as T}from"./subscriptions-Djd7jpc_.js";import{u as V}from"./useWallet-DN1Oz1sr.js";const z=new Intl.NumberFormat("en-ZA");function N(l){if(typeof l=="number"&&Number.isFinite(l))return l;if(l==null)return 0;const x=String(l),h=Number(x.replace(/[^0-9.]/g,""));return Number.isFinite(h)?h:0}function b(l){return z.format(Math.round(l))}function H(){const[l,x]=o.useState([]),[h,C]=o.useState(""),[M,y]=o.useState(!0),[w,f]=o.useState(()=>new Set),[i,d]=o.useState({open:!1,service:null,working:!1,error:"",success:""}),[R,F]=o.useState(()=>new Set),g=q(),I=o.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),{wallet:a,loading:p,eligible:u,redeemCredits:L}=V(),v=o.useCallback(async()=>{y(!0);const{data:s}=await Y.get("/api/data/services",{params:{q:h||void 0,page:1,pageSize:40,featured:"true"}});x(Array.isArray(s.items)?s.items:[]),y(!1)},[h]);o.useEffect(()=>{v()},[v]),o.useEffect(()=>{(async()=>{try{if(!j.currentUser)return;const s=await D(),r=new Set(s.filter(t=>(t.type||"service")==="service").map(t=>String(t.serviceId)));f(r)}catch{}})()},[I]),o.useEffect(()=>{if(!i.open||typeof document>"u")return;const{body:s}=document;if(s)return s.classList.add("modal-open"),()=>s.classList.remove("modal-open")},[i.open]);async function E(s){var r;try{if(!j.currentUser){g("/login",{replace:!0,state:{from:((r=window.location)==null?void 0:r.pathname)||"/"}});return}const t=String(s);w.has(t)?(await Q(t),f(c=>{const m=new Set(c);return m.delete(t),m})):(await T(t),f(c=>{const m=new Set(c);return m.add(t),m}))}catch{}}function P(s){var r;if(!j.currentUser){g("/login",{replace:!0,state:{from:((r=window.location)==null?void 0:r.pathname)||"/"}});return}d({open:!0,service:s,working:!1,error:u?"":"My Wallet is only available to startup and vendor accounts.",success:""})}function S(){d({open:!1,service:null,working:!1,error:"",success:""})}async function W(){const s=i.service;if(!s)return;if(!u){d(t=>({...t,error:"Your account does not have voucher access yet."}));return}if(!a){d(t=>({...t,error:"We could not load your wallet. Please try again."}));return}const r=N(s.price);if(r<=0){d(t=>({...t,success:"This listing does not require voucher credits.",error:""}));return}if(a.balance<r){d(t=>({...t,error:"You do not have enough voucher credits for this listing."}));return}d(t=>({...t,working:!0,error:"",success:""}));try{const t=await L(r,{description:`Listing purchase: ${s.title||"Marketplace service"}`,reference:`listing-${s.id||"unknown"}`,metadata:{serviceId:s.id||null,vendor:s.vendor||null,category:s.category||null}});if(!t.ok){d(n=>({...n,working:!1,error:t.error||"Unable to redeem vouchers."}));return}F(n=>{const c=new Set(n);return c.add(String(s.id)),c}),d(n=>{var c;return{...n,working:!1,error:"",success:`Voucher applied! Remaining balance: ${b(((c=t.wallet)==null?void 0:c.balance)||0)} credits.`}})}catch{d(n=>({...n,working:!1,error:"Unable to redeem vouchers."}))}}function U(){if(!i.open||!i.service)return null;const s=i.service,r=N(s.price),t=(a==null?void 0:a.balance)??0,n=Math.max(0,r-t),c=i.working||p||!u||!a||r<=0||t<r;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal fade show d-block",tabIndex:-1,role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Redeem voucher credits"}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:S})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("h6",{className:"mb-1",children:s.title}),e.jsx("p",{className:"text-muted mb-3",children:s.description||"Marketplace listing"}),e.jsxs("dl",{className:"row mb-0",children:[e.jsx("dt",{className:"col-6",children:"Listing price"}),e.jsxs("dd",{className:"col-6 text-end",children:["R ",b(r)]}),e.jsx("dt",{className:"col-6",children:"Wallet balance"}),e.jsxs("dd",{className:"col-6 text-end",children:["R ",b(t)]}),e.jsx("dt",{className:"col-6",children:"After redeeming"}),e.jsxs("dd",{className:"col-6 text-end",children:["R ",b(Math.max(0,t-r))]})]}),!u&&e.jsx("div",{className:"alert alert-warning mt-3 mb-0",children:"My Wallet is only available to startup and vendor accounts."}),u&&a&&n>0&&e.jsxs("div",{className:"alert alert-warning mt-3 mb-0",children:["You need an additional ",b(n)," credits to redeem this listing."]}),i.error&&e.jsx("div",{className:"alert alert-danger mt-3 mb-0",children:i.error}),i.success&&e.jsx("div",{className:"alert alert-success mt-3 mb-0",children:i.success})]}),e.jsxs("div",{className:"modal-footer d-flex justify-content-between",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:S,disabled:i.working,children:"Close"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>void W(),disabled:c,children:i.working?"Processing…":"Redeem now"})]})]})})}),e.jsx("div",{className:"modal-backdrop fade show"})]})}return e.jsxs("div",{className:"container py-4",children:[e.jsxs("div",{className:"d-flex align-items-end justify-content-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"h4 mb-1",children:"Featured Marketplace"}),e.jsx("small",{className:"text-muted",children:"Discover services from trusted vendors"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("input",{className:"form-control",placeholder:"Search…",value:h,onChange:s=>C(s.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:v,children:"Search"})]})]}),u&&a&&e.jsxs("div",{className:"alert alert-primary d-flex justify-content-between align-items-center",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"My Wallet:"})," ",b(a.balance)," credits available."]}),e.jsx("button",{className:"btn btn-sm btn-outline-light",onClick:()=>g("/wallet"),children:"View wallet"})]}),M?e.jsx("p",{children:"Loading…"}):e.jsxs("div",{className:"row g-3",children:[l.length===0&&e.jsx("p",{className:"text-muted",children:"No featured services yet."}),l.map(s=>{const r=N(s.price),t=String(s.id),n=R.has(t),c=w.has(t),m=(a==null?void 0:a.balance)??0,k=u&&a&&r>m,A=n?"Redeemed":u?"Redeem":"Select",$=n?"btn btn-success btn-sm":"btn btn-outline-primary btn-sm";return e.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start gap-2",children:[e.jsx("h5",{className:"card-title mb-0",children:s.title}),s.isFeatured&&e.jsx("span",{className:"badge text-bg-success",children:"Featured"})]}),e.jsxs("div",{className:"text-muted mb-2",children:[s.category," · ",s.vendor]}),e.jsx("p",{className:"flex-grow-1",children:s.description||"Quality service for SMMEs."}),e.jsxs("div",{className:"d-flex flex-column gap-2",children:[e.jsxs("strong",{children:["R ",b(r)]}),u&&a&&e.jsx("small",{className:k?"text-danger":"text-success",children:k?`Short by ${b(r-m)} credits`:"Covered by your voucher balance"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("button",{className:$,onClick:()=>P(s),disabled:p||n,children:p?"Checking wallet…":A}),e.jsx("button",{className:c?"btn btn-sm btn-secondary":"btn btn-sm btn-primary",onClick:()=>E(s.id),children:c?"Subscribed":"Subscribe"})]})]})]})})},t)})]}),U()]})}export{H as default};
