import{r as o,b as ee,a as m,j as a}from"./index-UCQmacn0.js";import{M as Ue}from"./MasterLayout-goJM0sHi.js";import{B as Ee}from"./Breadcrumb-DhTQvXqi.js";import"./iconify-PuEdyvXP.js";function Ae(){var Z;const[S,j]=o.useState([]),[A,T]=o.useState(!1),[B,ae]=o.useState(""),[$,te]=o.useState(""),[V,h]=o.useState(""),[D,g]=o.useState(""),[M,P]=o.useState([{id:"vendor",name:"Vendor"}]),se=(((Z=ee.currentUser)==null?void 0:Z.email)||sessionStorage.getItem("userEmail")||"").toLowerCase(),[I,O]=o.useState({}),[ne,ie]=o.useState({}),[re,le]=o.useState({}),[d,oe]=o.useState({}),[q,z]=o.useState({}),[_,Q]=o.useState({}),[G,de]=o.useState(""),[k,ce]=o.useState([]),[x,W]=o.useState(!1),[H,J]=o.useState(""),[N,me]=o.useState(""),[K,he]=o.useState(100),[L,ue]=o.useState({}),X=o.useMemo(()=>[...S].sort((e,s)=>(e.email||"").localeCompare(s.email||"")),[S]),[F,pe]=o.useState(""),[C,ge]=o.useState("All"),Y=o.useMemo(()=>{const e=F.trim().toLowerCase();return X.filter(s=>C!=="All"&&(s.role||"member")!==C?!1:e?`${s.email} ${s.tenantId} ${s.role}`.toLowerCase().includes(e):!0)},[X,F,C]);async function R(){var e,s;T(!0),h("");try{const{data:n}=await m.get("/api/users"),i=Array.isArray(n)?n:[];j(i.map(t=>({email:(t.email||"").toLowerCase(),tenantId:t.tenantId||"vendor",role:t.role||"member"})));try{const t=await m.get("/api/data/vendors").then(u=>u.data||[]),l={},r={},c={};t.forEach(u=>{const y=(u.contactEmail||u.email||"").toLowerCase(),v=u.ownerUid||"",p=String(u.id||""),b=String(u.vendorId||"");y&&(l[y]=u),v&&(r[v]=u),p&&(c[p]=u),b&&(c[b]=u)}),O(l),ie(r),le(c)}catch{}}catch(n){h(((s=(e=n==null?void 0:n.response)==null?void 0:e.data)==null?void 0:s.message)||(n==null?void 0:n.message)||"Failed to load users")}finally{T(!1)}}o.useEffect(()=>{R()},[]),o.useEffect(()=>{(async()=>{try{const{data:e}=await m.get("/api/tenants"),s=Array.isArray(e)?e:[],n=[{id:"vendor",name:"Vendor"},...s.map(t=>typeof t=="string"?{id:t,name:t}:{id:t==null?void 0:t.id,name:(t==null?void 0:t.name)||(t==null?void 0:t.id)}).map(t=>t.id==="public"?{...t,id:"vendor",name:t.name||"Vendor"}:t)].filter(t=>t&&t.id),i=new Map;n.forEach(t=>i.set(t.id,t)),P(Array.from(i.values()))}catch{P([{id:"vendor",name:"Vendor"}])}})()},[]);async function be(e){var i,t,l;e.preventDefault(),h(""),g("");const s=B.trim(),n=$.trim();if(!s||!n){h("Email and new tenant id are required");return}try{await m.post("/api/users/upgrade",{email:s,newTenantId:n}),g("Upgraded successfully");const r=(window==null?void 0:window.localStorage)&&window.localStorage.getItem("userEmail")||((i=window==null?void 0:window.sessionStorage)==null?void 0:i.getItem("userEmail"));r&&r.toLowerCase()===s.toLowerCase()&&(sessionStorage.setItem("tenantId",n),sessionStorage.setItem("role","admin")),await R()}catch(r){h(((l=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:l.message)||(r==null?void 0:r.message)||"Upgrade failed")}}async function U({email:e,tenantId:s,role:n}){await m.post("/api/users",{email:e,tenantId:s,role:n}),e.toLowerCase()===se&&(sessionStorage.setItem("tenantId",s),sessionStorage.setItem("role",n))}async function xe(e){var n,i;h(""),g("");const s=e.role==="admin"?"member":"admin";try{await U({email:e.email,tenantId:e.tenantId||"vendor",role:s}),j(t=>t.map(l=>l.email===e.email?{...l,role:s}:l)),g(`${e.email} is now ${s}`)}catch(t){h(((i=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:i.message)||(t==null?void 0:t.message)||"Failed to update role")}}async function fe(e,s){var n,i;h(""),g("");try{await U({email:e.email,tenantId:s,role:e.role||"member"}),j(t=>t.map(l=>l.email===e.email?{...l,tenantId:s}:l)),g(`${e.email} moved to ${s}`)}catch(t){h(((i=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:i.message)||(t==null?void 0:t.message)||"Failed to change tenant")}}async function ye(e){var n,i;h(""),g("");const s=(e.email||"").toLowerCase();if(s&&window.confirm(`Delete user ${s}? This removes their account and role mapping but keeps listings.`))try{await m.delete("/api/users",{data:{email:s}}),j(t=>t.filter(l=>(l.email||"").toLowerCase()!==s)),g(`Deleted ${s}`)}catch(t){h(((i=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:i.message)||(t==null?void 0:t.message)||"Failed to delete user")}}async function je(e){var s,n;h(""),g("");try{let i="";try{const{data:r}=await m.get("/api/users/lookup",{params:{email:e.email}});i=(r==null?void 0:r.uid)||""}catch{i=""}const t=(e.email||"").split("@")[0]||"Vendor",l={id:i||void 0,name:t,contactEmail:e.email,ownerUid:i||void 0,status:"pending",kycStatus:"pending",categories:[],tags:[]};await m.post("/api/data/vendors",l),O(r=>({...r,[e.email]:!0})),g(`Created vendor profile for ${e.email}`)}catch(i){h(((n=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:n.message)||(i==null?void 0:i.message)||"Failed to create vendor profile")}}async function ve(e){var n,i;const s=(e.email||"").toLowerCase();Q(t=>({...t,[s]:!0})),h(""),g("");try{let t="";try{const{data:c}=await m.get("/api/users/lookup",{params:{email:s}});t=(c==null?void 0:c.uid)||""}catch{h("Could not find Firebase UID for this email");return}await m.post("/api/users",{email:s,tenantId:e.tenantId||"vendor",role:e.role||"member",uid:t});let l=!1;const r=I[s];if(r){const c=String(r.id||r.vendorId||"");if(c)try{await m.put(`/api/data/vendors/${encodeURIComponent(c)}`,{ownerUid:t}),l=!0}catch{}}else try{const c=await m.get("/api/tenants"),y=(Array.isArray(c.data)?c.data:[]).map(p=>typeof p=="string"?p:p==null?void 0:p.id).filter(Boolean),v=Array.from(new Set(["vendor",...y]));for(const p of v)try{const{data:b}=await m.get("/api/data/vendors",{headers:{"x-tenant-id":p}}),w=Array.isArray(b)?b.find(f=>(f.contactEmail||f.email||"").toLowerCase()===s):null;if(w){const f=String(w.id||w.vendorId||"");if(f){await m.put(`/api/data/vendors/${encodeURIComponent(f)}`,{ownerUid:t},{headers:{"x-tenant-id":p}}),l=!0;break}}}catch{}}catch{}if(!l){const c=s.split("@")[0]||"Vendor";try{await m.post("/api/data/vendors",{name:c,contactEmail:s,ownerUid:t,status:"pending",kycStatus:"pending",categories:[]})}catch{}}await R(),g(`Synced Firebase UID for ${s}`)}catch(t){h(((i=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:i.message)||(t==null?void 0:t.message)||"Failed to sync UID")}finally{Q(t=>({...t,[s]:!1}))}}function we(e){const s={},n={},i={};return(e||[]).forEach(t=>{const l=(t.contactEmail||t.email||"").toLowerCase(),r=t.ownerUid||"",c=String(t.id||""),u=String(t.vendorId||"");l&&(s[l]=t),r&&(n[r]=t),c&&(i[c]=t),u&&(i[u]=t)}),{byEmail:s,byOwner:n,byId:i}}async function Se(e){const s=(e.email||"").toLowerCase();z(n=>({...n,[s]:!0}));try{let n=I[s]||null,i="",t=null,l=null;try{const{data:r}=await m.get("/api/users/lookup",{params:{email:s}});i=(r==null?void 0:r.uid)||""}catch{}if(i&&(t=ne[i]||null,l=re[i]||null),!n&&!t&&!l)try{const r=await m.get("/api/tenants"),u=(Array.isArray(r.data)?r.data:[]).map(b=>typeof b=="string"?b:b==null?void 0:b.id).filter(Boolean),y=[],v=Array.from(new Set(["vendor",...u]));for(const b of v)try{const{data:w}=await m.get("/api/data/vendors",{headers:{"x-tenant-id":b}});Array.isArray(w)&&y.push(...w.map(f=>({...f,_tenantId:f.tenantId||b})))}catch{}const p=we(y);n=p.byEmail[s]||null,i&&(t=p.byOwner[i]||t,l=p.byId[i]||l)}catch{}oe(r=>({...r,[s]:{uid:i,viaEmail:n,viaUid:t,viaId:l}}))}finally{z(n=>({...n,[s]:!1}))}}async function E(e=!0){var s,n;J(""),W(!0);try{const i={search:G,pageSize:K};!e&&N&&(i.pageToken=N);const{data:t}=await m.get("/api/users/all",{params:i}),l=Array.isArray(t==null?void 0:t.items)?t.items:[];ce(r=>e?l:[...r,...l]),me((t==null?void 0:t.nextPageToken)||"")}catch(i){J(((n=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:n.message)||(i==null?void 0:i.message)||"Failed to search platform users")}finally{W(!1)}}o.useEffect(()=>{E(!0)},[]);async function Ie(e){var n,i;const s=L[e]||"vendor";try{await U({email:e,tenantId:s,role:"admin"}),j(t=>t.find(r=>r.email===e)?t.map(r=>r.email===e?{...r,role:"admin",tenantId:s}:r):[...t,{email:e,role:"admin",tenantId:s}]),g(`${e} granted admin (${s})`)}catch(t){h(((i=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:i.message)||(t==null?void 0:t.message)||"Failed to grant admin")}}function Ne(e){const s=(e||"").toLowerCase();return S.some(n=>n.email===s&&(n.role||"member")==="admin")}async function Ce(e){var i,t;const s=S.find(l=>l.email===(e||"").toLowerCase()),n=(s==null?void 0:s.tenantId)||L[e]||"vendor";try{await U({email:e,tenantId:n,role:"member"}),j(l=>l.map(r=>r.email===e?{...r,role:"member"}:r)),g(`${e} admin revoked`)}catch(l){h(((t=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:t.message)||(l==null?void 0:l.message)||"Failed to revoke admin")}}return a.jsxs("div",{className:"card h-100 p-0 radius-12 overflow-hidden",children:[a.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between gap-3 flex-wrap",children:a.jsx("h6",{className:"mb-0",children:"Upgrade Public Tenant to Private Admin"})}),a.jsxs("div",{className:"card-body p-24",children:[a.jsxs("form",{onSubmit:be,className:"row g-3 align-items-end mb-24",children:[a.jsxs("div",{className:"col-sm-5",children:[a.jsx("label",{className:"form-label text-sm",children:"User Email"}),a.jsx("input",{type:"email",className:"form-control",value:B,onChange:e=>ae(e.target.value),placeholder:"user@example.com",required:!0})]}),a.jsxs("div",{className:"col-sm-5",children:[a.jsx("label",{className:"form-label text-sm",children:"New Tenant ID (private)"}),a.jsx("input",{type:"text",className:"form-control",value:$,onChange:e=>te(e.target.value),placeholder:"acme-inc",required:!0})]}),a.jsx("div",{className:"col-sm-2",children:a.jsx("button",{type:"submit",className:"btn btn-primary w-100",children:"Upgrade"})})]}),V&&a.jsx("div",{className:"alert alert-danger py-8 px-12 mb-16",children:V}),D&&a.jsx("div",{className:"alert alert-success py-8 px-12 mb-16",children:D}),a.jsx("div",{className:"d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3",children:a.jsxs("div",{className:"d-flex align-items-end gap-2 flex-wrap",children:[a.jsxs("div",{children:[a.jsx("label",{className:"form-label text-sm",children:"Search"}),a.jsx("input",{className:"form-control",placeholder:"Filter by email, tenant, role",value:F,onChange:e=>pe(e.target.value)})]}),a.jsxs("div",{children:[a.jsx("label",{className:"form-label text-sm",children:"Role"}),a.jsxs("select",{className:"form-select",value:C,onChange:e=>ge(e.target.value),children:[a.jsx("option",{children:"All"}),a.jsx("option",{children:"admin"}),a.jsx("option",{children:"member"})]})]})]})}),a.jsx("div",{className:"table-responsive scroll-sm",children:a.jsxs("table",{className:"table bordered-table sm-table mb-0 align-middle",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Email"}),a.jsx("th",{style:{minWidth:160},children:"Tenant"}),a.jsx("th",{children:"Role"}),a.jsx("th",{children:"Vendor"}),a.jsx("th",{style:{minWidth:320},children:"Actions / Trace"})]})}),a.jsxs("tbody",{children:[A&&a.jsx("tr",{children:a.jsx("td",{colSpan:4,children:"Loading…"})}),!A&&Y.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:4,children:"No users match your filters."})}),!A&&Y.map(e=>{var s;return a.jsxs("tr",{children:[a.jsx("td",{children:e.email}),a.jsx("td",{children:a.jsx("select",{className:"form-select form-select-sm w-auto bg-base border text-secondary-light rounded-pill",value:e.tenantId||"vendor",onChange:n=>fe(e,n.target.value),title:"Switch tenant",children:M.map(n=>a.jsx("option",{value:n.id,children:n.name||n.id},n.id))})}),a.jsx("td",{children:a.jsx("span",{className:e.role==="admin"?"badge bg-success-focus text-success-700":"badge bg-neutral-200 text-neutral-900",children:e.role||"member"})}),a.jsxs("td",{children:[I[e.email]?a.jsx("span",{className:"badge bg-primary-subtle text-primary-700",children:"Has vendor"}):a.jsx("span",{className:"badge bg-neutral-200 text-neutral-900",children:"No vendor"}),d[e.email]&&a.jsx("div",{className:"small text-secondary mt-1",children:d[e.email].uid?a.jsxs(a.Fragment,{children:[a.jsxs("div",{children:["uid: ",a.jsx("code",{children:d[e.email].uid})]}),a.jsxs("div",{children:["by email: ",d[e.email].viaEmail?a.jsxs(a.Fragment,{children:[a.jsx("code",{children:String(d[e.email].viaEmail.contactEmail||d[e.email].viaEmail.email||"")})," ","(vendorId: ",a.jsx("code",{children:String(d[e.email].viaEmail.id||d[e.email].viaEmail.vendorId)}),", tenant: ",a.jsx("code",{children:String(d[e.email].viaEmail.tenantId||d[e.email].viaEmail._tenantId||"vendor")}),")"]}):"—"]}),a.jsxs("div",{children:["by ownerUid: ",d[e.email].viaUid?a.jsxs(a.Fragment,{children:[a.jsx("code",{children:String(d[e.email].viaUid.ownerUid||"")})," ","(vendorId: ",a.jsx("code",{children:String(d[e.email].viaUid.id||d[e.email].viaUid.vendorId)}),", tenant: ",a.jsx("code",{children:String(d[e.email].viaUid.tenantId||d[e.email].viaUid._tenantId||"vendor")}),")"]}):"—"]}),a.jsxs("div",{children:["by id==uid: ",d[e.email].viaId?a.jsxs(a.Fragment,{children:[a.jsx("code",{children:String(d[e.email].viaId.id||d[e.email].viaId.vendorId)})," ","(tenant: ",a.jsx("code",{children:String(d[e.email].viaId.tenantId||d[e.email].viaId._tenantId||"vendor")}),")"]}):"—"]})]}):a.jsx("div",{children:"uid: — (lookup requires admin + Firebase link)"})})]}),a.jsx("td",{children:a.jsxs("div",{className:"d-flex gap-2",children:[a.jsx("button",{type:"button",className:e.role==="admin"?"btn btn-outline-danger btn-sm":"btn btn-outline-success btn-sm",onClick:()=>xe(e),title:e.role==="admin"?"Revoke admin":"Grant admin",children:e.role==="admin"?"Revoke Admin":"Make Admin"}),!I[e.email]&&a.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>je(e),title:"Create vendor profile for this user",children:"Create Vendor"}),a.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>Se(e),disabled:!!q[e.email],title:"Trace vendor status via email, UID, or vendor id",children:q[e.email]?"Tracing…":"Trace"}),a.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>ve(e),disabled:!!_[e.email],title:"Lookup Firebase UID and link it to this user's vendor",children:_[e.email]?"Syncing…":"Sync UID"}),a.jsx("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>ye(e),title:"Delete user from Firebase and remove role mapping (keeps listings)",disabled:(((s=ee.currentUser)==null?void 0:s.email)||"").toLowerCase()===(e.email||"").toLowerCase(),children:"Delete User"})]})})]},e.email)})]})]})}),a.jsxs("div",{className:"mt-24",children:[a.jsx("h6",{className:"mb-2",children:"Onboard Admins"}),a.jsxs("div",{className:"d-flex flex-wrap align-items-end gap-2 mb-2",children:[a.jsxs("div",{children:[a.jsx("label",{className:"form-label text-sm",children:"Search users"}),a.jsx("input",{className:"form-control",placeholder:"Search by email or name",value:G,onChange:e=>de(e.target.value)})]}),a.jsx("button",{className:"btn btn-outline-secondary",onClick:E,disabled:x,children:x?"Searching…":"Search"}),H&&a.jsx("div",{className:"text-danger small",children:H})]}),a.jsxs("div",{className:"table-responsive scroll-sm",children:[a.jsxs("table",{className:"table bordered-table sm-table mb-0 align-middle",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Email"}),a.jsx("th",{children:"Name"}),a.jsx("th",{children:"UID"}),a.jsx("th",{children:"Tenant"}),a.jsx("th",{children:"Action"})]})}),a.jsxs("tbody",{children:[x&&a.jsx("tr",{children:a.jsx("td",{colSpan:5,children:"Loading…"})}),!x&&k.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:5,children:"No results"})}),!x&&k.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.email}),a.jsx("td",{children:e.displayName||"—"}),a.jsx("td",{children:a.jsx("code",{children:e.uid})}),a.jsx("td",{children:a.jsx("select",{className:"form-select form-select-sm w-auto bg-base border text-secondary-light rounded-pill",value:L[e.email]||"vendor",onChange:s=>ue(n=>({...n,[e.email]:s.target.value})),children:M.map(s=>a.jsx("option",{value:s.id,children:s.name||s.id},s.id))})}),a.jsx("td",{children:Ne(e.email)?a.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>Ce((e.email||"").toLowerCase()),children:"Revoke Admin"}):a.jsx("button",{className:"btn btn-sm btn-outline-success",onClick:()=>Ie((e.email||"").toLowerCase()),children:"Grant Admin"})})]},e.uid))]})]}),a.jsxs("div",{className:"d-flex align-items-center justify-content-between mt-2",children:[a.jsxs("div",{className:"text-secondary small",children:["Showing ",k.length," user(s)"]}),a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx("label",{className:"text-sm",children:"Page size"}),a.jsx("select",{className:"form-select form-select-sm w-auto",value:K,onChange:e=>he(Number(e.target.value)||100),children:[50,100,200,500,1e3].map(e=>a.jsx("option",{value:e,children:e},e))}),a.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>E(!0),disabled:x,children:"Refresh"}),a.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>E(!1),disabled:x||!N,children:x?"Loading…":N?"Load more":"End"})]})]})]})]})]})]})}function Te(){return a.jsxs(Ue,{children:[a.jsx(Ee,{title:"User Role Management"}),a.jsx(Ae,{})]})}export{Te as default};
