import{g as J,b as K,a as N,B as C,j as e,I as f}from"./index-D_DTgdmv.js";import{r as d,L as Q}from"./vendor-DW3XjTa1.js";function A(i,c=80){return i?i.length>c?`${i.slice(0,c)}â€¦`:i:""}function I(i){return`https://ui-avatars.com/api/?name=${encodeURIComponent(i||"User")}&background=059669&color=fff`}function k(i){const c=i?.from||{},x=i?.timestamp||i?.date||new Date().toISOString();return{id:String(i?.id||x),senderId:c?.uid||c?.email,senderName:c?.name||c?.email||"User",senderEmail:c?.email,senderRole:c?.type,senderAvatar:c?.avatar,content:(i?.content??"").toString(),timestamp:x}}function D(i,c){const x=Array.isArray(i?.messages)?i.messages:[],p=i?.context||c||{},n=x.map(s=>{const g=s?.senderRole||s?.role;let u=s?.senderEmail||s?.email;if(!u){const o=(g||"").toLowerCase();o==="admin"&&p.adminEmail&&(u=p.adminEmail),o==="vendor"&&p.vendorEmail&&(u=p.vendorEmail),o==="subscriber"&&p.subscriberEmail&&(u=p.subscriberEmail)}const h=s?.date||s?.timestamp||s?.createdAt||new Date().toISOString();return{id:String(s?.id||s?.messageId||h),senderId:s?.senderId||s?.sender?.id,senderName:s?.senderName||s?.sender?.name||s?.senderId||"User",senderEmail:u,senderRole:g,senderAvatar:s?.senderAvatar||s?.sender?.avatar,content:(s?.content??s?.text??"").toString(),timestamp:h}});return n.sort((s,g)=>new Date(s.timestamp).getTime()-new Date(g.timestamp).getTime()),n}function P(i){const c=new Map;i.forEach(p=>{if(!p)return;const n=String(p.threadId||p.id||p.subject||`legacy-${Date.now()}`);c.has(n)||c.set(n,[]),c.get(n).push(p)});const x=[];for(const[p,n]of c.entries()){n.sort((h,o)=>new Date(h?.timestamp||h?.date||0).getTime()-new Date(o?.timestamp||o?.date||0).getTime());const s=n[0],g=n[n.length-1]||s,u=[];s?.from&&u.push({id:s.from.uid||s.from.email||s.from.name,name:s.from.name||s.from.email,email:s.from.email,role:s.from.type}),s?.to&&u.push({id:s.to.uid||s.to.email||s.to.name,name:s.to.name||s.to.email,email:s.to.email,role:s.to.type}),x.push({id:p,kind:"legacy",subject:g?.subject||s?.subject||"Conversation",lastMessageSnippet:A(g?.content||""),lastMessageAt:g?.timestamp||g?.date,participants:u,legacy:{user1:u[0]?.email,user2:u[1]?.email},raw:n})}return x}function X(i){const c=Array.isArray(i?.messages)?[...i.messages]:[],x=i?.lastMessage||c[c.length-1]||{},p=Array.isArray(i?.participants)?i.participants.map(o=>({id:o?.id||o?.email||o?.name,name:o?.name||o?.id||"Participant",email:o?.email,role:o?.role})):[],n=i?.context||{},s={id:String(i?.id||i?.threadId||n.threadId||`thread-${Date.now()}`),kind:"thread",subject:i?.subject||n.listingTitle||n.serviceTitle||"Conversation",lastMessageSnippet:A(i?.lastMessage?.snippet||x?.snippet||x?.content||""),lastMessageAt:x?.date||x?.timestamp||i?.updatedAt||i?.createdAt,unreadCount:typeof i?.unreadCount=="number"?i.unreadCount:void 0,participants:p,context:n,raw:i},g=n.vendorEmail,u=n.adminEmail,h=n.subscriberEmail;if(g){const o=s.participants.find(j=>(j?.role||"").toLowerCase()==="vendor"||(j?.id||"").startsWith("vendor:"));o&&!o.email&&(o.email=g)}if(u){const o=s.participants.find(j=>(j?.role||"").toLowerCase()==="admin");o&&!o.email&&(o.email=u)}if(h){const o=s.participants.find(j=>(j?.role||"").toLowerCase()==="subscriber");o&&!o.email&&(o.email=h)}return s}const se=()=>{const[i,c]=d.useState([]),[x,p]=d.useState([]),[n,s]=d.useState(null),[g,u]=d.useState([]),[h,o]=d.useState(()=>{try{return J()}catch{return null}}),[j,L]=d.useState(!0),[v,U]=d.useState(!1),[y,z]=d.useState(""),R=d.useRef(null),$=d.useCallback(()=>{R.current?.scrollIntoView({behavior:"smooth"})},[]);d.useEffect(()=>{$()},[g,$]),d.useEffect(()=>{K().then(t=>o(t)).catch(()=>{})},[]);const F=d.useCallback(t=>{const r=(h?.email||"").toLowerCase();return t.map(a=>{const l=a.participants||[];let m=l.find(T=>(T?.email||"").toLowerCase()!==r);!m&&l.length&&(m=l[0]);const b=m?.name||m?.email||a.subject||"Conversation",w=m?.email||(a.legacy?[a.legacy.user1,a.legacy.user2].find(T=>(T||"").toLowerCase()!==r):void 0),E=I(b),O=(a.kind==="thread"?a.context?.type||"active":"legacy conversation").replace(/[-_]/g," ");return{id:`${a.kind}:${a.id}`,threadId:a.id,name:b,email:w,avatar:E,status:O.charAt(0).toUpperCase()+O.slice(1),type:a.kind,lastMessageSnippet:A(a.lastMessageSnippet||""),lastMessageAt:a.lastMessageAt,unreadCount:a.unreadCount,thread:a}}).sort((a,l)=>{const m=a.lastMessageAt?new Date(a.lastMessageAt).getTime():0;return(l.lastMessageAt?new Date(l.lastMessageAt).getTime():0)-m})},[h]),S=d.useCallback(async({silent:t=!1}={})=>{t||L(!0);try{const a=(await N.get("/api/messages",{params:{limit:100}})).data;let l=[];Array.isArray(a?.items)?l=a.items.map(X):Array.isArray(a?.messages)?l=P(a.messages):Array.isArray(a)&&(l=P(a)),c(l);const m=F(l);return p(m),m}catch(r){if(console.error("Error fetching messages:",r),!t){const a=r?.response?.data?.message||"Failed to load messages";C.error(a)}return c([]),p([]),[]}finally{t||L(!1)}},[F]);d.useEffect(()=>{S()},[S]);const M=d.useCallback(async t=>{if(s(t),t.type==="thread")try{const r=await N.get(`/api/messages/${t.threadId}`),a=r.data&&r.data.id?r.data:t.thread.raw,l=D(a,t.thread.context);u(l)}catch(r){console.error("Error fetching thread conversation:",r);const a=D(t.thread.raw,t.thread.context);u(a),C.error("Unable to refresh conversation; showing cached messages.")}else{const r=t.thread.legacy?.user1,a=t.thread.legacy?.user2||t.email;if(!r||!a){u([]);return}try{const l=await N.get("/api/messages/conversation",{params:{user1:r,user2:a,limit:100}}),b=(Array.isArray(l.data?.conversation)?l.data.conversation:[]).map(k).sort((w,E)=>new Date(w.timestamp).getTime()-new Date(E.timestamp).getTime());u(b)}catch(l){console.error("Error fetching legacy conversation:",l),C.error("Unable to load conversation");const m=Array.isArray(t.thread.raw)?t.thread.raw.map(k):[];m.sort((b,w)=>new Date(b.timestamp).getTime()-new Date(w.timestamp).getTime()),u(m)}}},[]),W=d.useCallback(async t=>{if(t.preventDefault(),!n||!y.trim()||v)return;const r=y.trim();U(!0);try{if(n.type==="thread")await N.post("/api/messages/reply",{threadId:n.threadId,content:r});else{const m=n.email||n.thread.legacy?.user2;if(!m)throw new Error("Missing recipient email");const b=n.thread.subject||`Message to ${n.name}`;await N.post("/api/messages",{to:m,subject:b,content:r,priority:"normal"})}z("");const l=(await S({silent:!0})).find(m=>m.threadId===n.threadId&&m.type===n.type);l&&await M(l),C.success("Message sent")}catch(a){console.error("Error sending message:",a);const l=a?.response?.data?.message||a?.message||"Failed to send message";C.error(l)}finally{U(!1)}},[n,y,v,S,M]),H=d.useCallback(t=>{if(t.type==="thread"){const r=D(t.thread.raw,t.thread.context);return r.length?r[r.length-1]:null}if(Array.isArray(t.thread.raw)){const r=t.thread.raw.map(k).sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime());return r.length?r[r.length-1]:null}return null},[]),V=d.useCallback(t=>t.unreadCount||0,[]),Y=d.useMemo(()=>I(h?.email||"User"),[h]),_=d.useMemo(()=>h?.email||"User",[h]),q=d.useMemo(()=>h?.role||"member",[h]),G=d.useCallback(t=>{const r=(h?.email||"").toLowerCase();return r?!!(t.senderEmail&&t.senderEmail.toLowerCase()===r||t.senderId&&t.senderId.toLowerCase().includes(r)||t.senderRole?.toLowerCase()==="admin"&&h?.role==="admin"):!1},[h]),B=d.useCallback(t=>{if(!t)return"";const r=new Date(t);return Number.isFinite(r.getTime())?r.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""},[]);return j?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"400px"},children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):e.jsxs("div",{className:"chat-wrapper",children:[e.jsxs("div",{className:"chat-sidebar card",children:[e.jsxs("div",{className:"chat-sidebar-single active top-profile",children:[e.jsx("div",{className:"img",children:e.jsx("img",{src:Y,alt:"Current user"})}),e.jsxs("div",{className:"info",children:[e.jsx("h6",{className:"text-md mb-0",children:_}),e.jsx("p",{className:"mb-0 text-capitalize",children:q})]}),e.jsx("div",{className:"action",children:e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{type:"button",className:"text-secondary-light text-xl","data-bs-toggle":"dropdown","data-bs-display":"static","aria-expanded":"false",children:e.jsx(f,{icon:"bi:three-dots"})}),e.jsx("ul",{className:"dropdown-menu dropdown-menu-lg-end border",children:e.jsx("li",{children:e.jsxs(Q,{to:"/chat-profile",className:"dropdown-item rounded text-secondary-light bg-hover-neutral-200 text-hover-neutral-900 d-flex align-items-center gap-2",children:[e.jsx(f,{icon:"fluent:person-32-regular"}),"Profile"]})})})]})})]}),e.jsx("div",{className:"chat-search",children:e.jsxs("form",{children:[e.jsx("input",{type:"text",name:"chatSearch",placeholder:"Search here..."}),e.jsx(f,{icon:"iconoir:search",className:"search-icon"})]})}),e.jsx("div",{className:"chat-all-list",children:x.map(t=>{const r=H(t),a=V(t),l=r?A(r.content,30):"No messages yet",m=r?B(r.timestamp):"";return e.jsxs("div",{className:`chat-sidebar-single ${n?.id===t.id?"active":""}`,onClick:()=>{M(t)},style:{cursor:"pointer"},children:[e.jsx("div",{className:"img",children:e.jsx("img",{src:t.avatar,alt:t.name})}),e.jsxs("div",{className:"info",children:[e.jsx("h6",{className:"text-sm mb-1",children:t.name}),e.jsx("p",{className:"mb-0 text-xs",children:l})]}),e.jsxs("div",{className:"action text-end",children:[e.jsx("p",{className:"mb-0 text-neutral-400 text-xs lh-1",children:m}),a>0&&e.jsx("span",{className:"w-16-px h-16-px text-xs rounded-circle bg-warning-main text-white d-inline-flex align-items-center justify-content-center",children:a})]})]},t.id)})})]}),e.jsx("div",{className:"chat-main card",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"chat-sidebar-single active",children:[e.jsx("div",{className:"img",children:e.jsx("img",{src:n.avatar,alt:n.name})}),e.jsxs("div",{className:"info",children:[e.jsx("h6",{className:"text-md mb-0",children:n.name}),e.jsx("p",{className:"mb-0 text-capitalize",children:n.status})]}),e.jsxs("div",{className:"action d-inline-flex align-items-center gap-3",children:[e.jsx("button",{type:"button",className:"text-xl text-primary-light",children:e.jsx(f,{icon:"mi:call"})}),e.jsx("button",{type:"button",className:"text-xl text-primary-light",children:e.jsx(f,{icon:"fluent:video-32-regular"})}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{type:"button",className:"text-primary-light text-xl","data-bs-toggle":"dropdown","data-bs-display":"static","aria-expanded":"false",children:e.jsx(f,{icon:"tabler:dots-vertical"})}),e.jsx("ul",{className:"dropdown-menu dropdown-menu-lg-end border",children:e.jsx("li",{children:e.jsxs("button",{className:"dropdown-item rounded text-secondary-light bg-hover-neutral-200 text-hover-neutral-900 d-flex align-items-center gap-2",type:"button",children:[e.jsx(f,{icon:"mdi:clear-circle-outline"}),"Clear All"]})})})]})]})]}),e.jsxs("div",{className:"chat-message-list",style:{maxHeight:"400px",overflowY:"auto"},children:[g.map(t=>{const r=G(t),a=t.senderAvatar||I(t.senderName||"User");return e.jsxs("div",{className:`chat-single-message ${r?"right":"left"}`,children:[!r&&e.jsx("img",{src:a,alt:t.senderName||"Contact",className:"avatar-lg object-fit-cover rounded-circle"}),e.jsxs("div",{className:"chat-message-content",children:[e.jsx("p",{className:"mb-3",children:t.content}),e.jsx("p",{className:"chat-time mb-0",children:e.jsx("span",{children:B(t.timestamp)})})]})]},t.id)}),e.jsx("div",{ref:R})]}),e.jsxs("form",{className:"chat-message-box",onSubmit:W,children:[e.jsx("input",{type:"text",name:"chatMessage",placeholder:"Write message",value:y,onChange:t=>z(t.target.value),disabled:v}),e.jsxs("div",{className:"chat-message-box-action",children:[e.jsx("button",{type:"button",className:"text-xl",children:e.jsx(f,{icon:"ph:link"})}),e.jsx("button",{type:"button",className:"text-xl",children:e.jsx(f,{icon:"solar:gallery-linear"})}),e.jsxs("button",{type:"submit",className:"btn btn-sm btn-primary-600 radius-8 d-inline-flex align-items-center gap-1",disabled:v||!y.trim(),children:[v?"Sending...":"Send",e.jsx(f,{icon:"f7:paperplane"})]})]})]})]}):e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center h-100 text-center",children:[e.jsx(f,{icon:"fluent:chat-48-regular",className:"text-primary",style:{fontSize:"4rem"}}),e.jsx("h5",{className:"mt-3 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted",children:"Choose a contact from the sidebar to start messaging"})]})})]})};export{se as M};
