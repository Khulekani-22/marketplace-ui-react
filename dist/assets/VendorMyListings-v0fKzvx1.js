import{a as H,m as ie,u as ce,j as s,M as oe}from"./index-BuQ02B8O.js";import{b as le,u as de,r as a,L as $}from"./vendor-DW3XjTa1.js";import"./firebase-ARhtPVQA.js";import"./utils-B2rxisVD.js";async function ue(c={}){try{const{signal:i,refresh:m=!1}=c,r=m?{refresh:"true"}:{},{data:h}=await H.get("/api/data/services/mine",{signal:i,params:r}),N=Array.isArray(h?.listings)?h.listings:[],R=Array.isArray(h?.bookings)?h.bookings:[],E=h?.vendor||null,k=typeof h?.tenantId=="string"?h.tenantId:void 0;return{listings:N,bookings:R,vendor:E,tenantId:k}}catch(i){const m=i?.response?.status;if(m===401||m===403||m===404)return{listings:[],bookings:[]};throw i}}function me(c){const i=c.toString().toLowerCase();return i==="vendor"?"public":i}function ge(c,i){const m=me(c||"public"),r=(i||"").trim().toLowerCase();return r?`vendor_pending_listings:${m}:${r}`:null}function V(c){return String(c?.id||c?.serviceId||"")}function he(c){try{const i=typeof c=="string"?JSON.parse(c):c;return Array.isArray(i)?i:[]}catch{return[]}}function K({s:c}){const i=(c||"unknown").toLowerCase(),m={approved:"success",pending:"warning",rejected:"danger",scheduled:"info",completed:"success",canceled:"secondary",unknown:"secondary"};return s.jsx("span",{className:`badge text-bg-${m[i]||"secondary"}`,children:i})}function je(){const c=le(),i=de(),m=a.useRef(null),{vendor:r,ensureVendorId:h,loading:N}=ie(),{refresh:R,syncMessagesToLive:E}=ce(),k=a.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[f,S]=a.useState([]),[p,D]=a.useState([]),[w,J]=a.useState(!0),[O,_]=a.useState(!1),[q,v]=a.useState(""),[o,x]=a.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1}),I=a.useMemo(()=>r||null,[r]),j=a.useMemo(()=>ge(k,I?.vendorId||I?.email||I?.id||""),[k,I]),[y,L]=a.useState([]),b=i.state?.newListing,C=a.useCallback(e=>{if(L(e),!!j){if(!e.length){localStorage.removeItem(j);return}try{localStorage.setItem(j,JSON.stringify(e))}catch{}}},[j]);a.useEffect(()=>{if(!j){L([]);return}try{const e=he(localStorage.getItem(j));L(e)}catch{L([])}},[j]),a.useEffect(()=>{if(!b)return;m.current=b;const e=String(b?.id||b?.serviceId||"");S(t=>t?t.some(l=>String(l?.id||l?.serviceId)===e)?t:[b,...t]:[b]),C([b,...y.filter(t=>String(t?.id||t?.serviceId||"")!==e)]),v(""),c({pathname:i.pathname,search:i.search},{replace:!0,state:{}})},[b,c,i.pathname,i.search,C,y]);const z=a.useCallback(e=>{const t=Array.isArray(e)?[...e]:[],n=new Set(t.map(V).filter(Boolean)),l=m.current;if(l){const d=V(l);d&&!n.has(d)?(t.unshift(l),n.add(d)):m.current=null}if(y.length){const d=[];y.forEach(u=>{const g=V(u);g&&(n.has(g)||(n.add(g),t.unshift(u),d.push(u)))}),d.length!==y.length&&C(d)}return t},[y,C]);a.useEffect(()=>{if(r&&!r.isApproved){const e=encodeURIComponent("/listings-vendors-mine");c(`/profile-vendor?next=${e}`,{replace:!0})}},[r,c]);const A=a.useCallback(async({signal:e,silent:t,refresh:n}={})=>{const l=u=>{t?_(u):J(u)};l(!0),v("");let d=r;try{if(e?.aborted||N&&!r)return;if(!r){S([]),D([]);return}const u=h?await h():r;if(e?.aborted)return;if(d=u||r,!d){S([]),D([]);return}const{listings:g,bookings:T}=await ue({signal:e,refresh:n});if(e?.aborted)return;const P=Array.isArray(g)?g:[],U=Array.isArray(T)?T:[],ae=z(P);S(ae),D(U)}catch(u){if(e?.aborted)return;const g=u?.code;v(g==="ERR_NETWORK"?"Network error – showing cached drafts.":u?.response?.data?.message||u?.message||"Failed to load listings")}finally{l(!1)}},[h,z,r,N]);a.useEffect(()=>{const e=new AbortController;return A({signal:e.signal}),()=>{e.abort()}},[A]);const W=a.useCallback(async()=>{v(""),await A({silent:!0,refresh:!0})},[A]),B=a.useMemo(()=>{const e={approved:0,pending:0,rejected:0};return f.forEach(t=>{const n=(t.status||"pending").toLowerCase();e[n]=(e[n]||0)+1}),e},[f]),Y=a.useMemo(()=>{const e={};return p.forEach(t=>{const n=String(t.serviceId||"");n&&(e[n]=(e[n]||0)+1)}),e},[p]),Q=a.useMemo(()=>{const e={};return f.forEach(t=>{[String(t.id||""),String(t.serviceId||""),String(t.vendorId||"")].filter(Boolean).forEach(l=>{e[l]=t})}),e},[f]);function G(e){const t=(e+11)%12+1,n=e>=12?"PM":"AM";return`${t}:00 ${n}`}function X(e){if(!e)return"";const[t]=e.split(":"),n=Number(t);return Number.isNaN(n)?e:`${G(n)} – ${G(n+1)}`}function F(e){if(e?.scheduledDate){const t=e.scheduledSlot||"00:00",n=`${e.scheduledDate}T${t.length===5?t:`${t}:00`}`,l=new Date(n);if(!Number.isNaN(l.getTime()))return l}if(e?.bookedAt){const t=new Date(e.bookedAt);if(!Number.isNaN(t.getTime()))return t}return null}const Z=a.useMemo(()=>{const e=p.map(t=>({...t}));return e.sort((t,n)=>{const l=F(t)?.getTime()??0,d=F(n)?.getTime()??0;return l-d}),e},[p]);function ee(e){return e?{date:e.toLocaleDateString(),time:e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}:{date:"—",time:""}}function se(e){const t=encodeURIComponent(JSON.stringify({title:e.title,category:e.category,price:e.price,imageUrl:e.imageUrl,description:e.description,listingType:e.listingType||"service"}));c(`/listings-vendors?prefill=${t}`)}function te(e){const t=`Feedback request: ${e.title}`,n=`Hello Admin

My listing "${e.title}" (ID: ${e.id}) was ${String(e.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;x({open:!0,listing:e,subject:t,content:n,sending:!1,err:null,done:!1})}function ne(){const e=`General inquiry from ${r?.name||r?.companyName||"vendor"}`;x({open:!0,listing:null,subject:e,content:`Hello Admin

I have a question/concern regarding my vendor account or listings.

[Please describe your question or concern here]

Thank you for your assistance!`,sending:!1,err:null,done:!1})}function M(){x({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function re(e){if(e?.preventDefault?.(),!!o.content.trim()){x(t=>({...t,sending:!0,err:null}));try{const t={listingId:o.listing?o.listing.id||"general":"general-admin-message",listingTitle:o.listing?o.listing.title||"General Feedback":"General Admin Message",vendorId:r?.vendorId||r?.id||"",vendorEmail:r?.email||r?.contactEmail||"",subject:o.subject,content:o.content};await H.post("/api/messages",t),x(n=>({...n,sending:!1,done:!0}));try{await R({force:!0}),await E()}catch{}setTimeout(()=>M(),1200)}catch(t){x(n=>({...n,sending:!1,err:t?.response?.data?.message||t?.message||"Failed to send"}))}}}return s.jsx(oe,{children:s.jsxs("div",{className:"container py-4",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[s.jsx("h1",{className:"h4 mb-0",children:"My listings"}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:W,disabled:w||O,children:O?"Refreshing…":"Refresh"}),s.jsxs("button",{type:"button",className:"btn btn-outline-primary",onClick:()=>ne(),title:"Contact admin about any questions or concerns",children:[s.jsx("i",{className:"bi bi-envelope me-1"}),"Message Admin"]}),s.jsx($,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})]})]}),s.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[s.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",B.approved]}),s.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",B.pending]}),s.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",B.rejected]}),s.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",f.length]})]}),s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[q&&s.jsx("div",{className:"alert alert-danger",children:q}),w&&s.jsx("div",{className:"text-muted",children:"Loading…"}),!w&&!f.length&&s.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",s.jsx($,{to:"/listings-vendors",children:"Create your first one."})]}),!w&&!!f.length&&s.jsx("div",{className:"table-responsive",children:s.jsxs("table",{className:"table align-middle",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{style:{width:72}}),s.jsx("th",{children:"Title"}),s.jsx("th",{children:"Category"}),s.jsx("th",{children:"Price"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Bookings"}),s.jsx("th",{style:{width:220},children:"Actions"})]})}),s.jsx("tbody",{children:f.map((e,t)=>{const n=String(e.id||e.serviceId||e.vendorId||"");return s.jsxs("tr",{children:[s.jsx("td",{children:s.jsx("img",{src:e.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),s.jsx("td",{className:"fw-semibold",children:e.title}),s.jsx("td",{children:e.category||"—"}),s.jsxs("td",{children:["R",Number(e.price||0).toLocaleString()]}),s.jsx("td",{children:s.jsx(K,{s:e.status})}),s.jsx("td",{children:Y[n]||0}),s.jsxs("td",{className:"d-flex gap-2",children:[s.jsx($,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(e.id||"")}`,children:"View"}),s.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>se(e),children:"Duplicate & edit"}),String(e.status||"").toLowerCase()==="rejected"&&s.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>te(e),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},n||t)})})]})})]})}),s.jsxs("div",{className:"card mt-4",children:[s.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[s.jsx("h6",{className:"mb-0",children:"Bookings"}),s.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",p.length]})]}),s.jsxs("div",{className:"card-body",children:[!p.length&&s.jsx("div",{className:"text-muted",children:"No bookings yet. Once customers reserve sessions, they will appear here."}),!!p.length&&s.jsx("div",{className:"table-responsive",children:s.jsxs("table",{className:"table align-middle",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Service"}),s.jsx("th",{children:"Customer"}),s.jsx("th",{children:"Scheduled"}),s.jsx("th",{children:"Status"}),s.jsx("th",{className:"text-end",children:"Price"})]})}),s.jsx("tbody",{children:Z.map((e,t)=>{const n=F(e),{date:l,time:d}=ee(n),u=X(e.scheduledSlot),g=Q[String(e.serviceId||"")],T=e.serviceTitle||g?.title||"Unknown service",P=Number(e.price||g?.price||0)||0,U=String(e.id||[e.serviceId,e.customerId,e.scheduledDate,e.scheduledSlot,e.bookedAt].filter(Boolean).join("-")||t);return s.jsxs("tr",{children:[s.jsx("td",{children:s.jsxs("div",{className:"d-flex flex-column",children:[s.jsx("span",{className:"fw-semibold",children:T}),g?.id&&s.jsx($,{className:"small",to:`/marketplace-details?id=${encodeURIComponent(g.id)}`,children:"Open listing"})]})}),s.jsx("td",{children:s.jsx("div",{className:"small text-muted",children:e.customerName||e.customerEmail||"—"})}),s.jsx("td",{children:s.jsxs("div",{className:"d-flex flex-column small",children:[s.jsx("span",{children:l}),s.jsx("span",{children:u||d})]})}),s.jsx("td",{children:s.jsx(K,{s:e.status||"pending"})}),s.jsxs("td",{className:"text-end",children:["R",P.toLocaleString()]})]},U)})})]})})]})]}),o.open&&s.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:e=>e.target===e.currentTarget&&M(),children:s.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[s.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[s.jsx("h6",{className:"mb-0",children:o.listing?`Message Admin about: ${o.listing.title}`:"Message Admin"}),s.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:M,children:"Close"})]}),s.jsxs("form",{onSubmit:re,children:[s.jsxs("div",{className:"card-body",children:[o.err&&s.jsx("div",{className:"alert alert-danger py-2 mb-2",children:o.err}),o.done&&s.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label",children:"Subject"}),s.jsx("input",{className:"form-control",value:o.subject,onChange:e=>x(t=>({...t,subject:e.target.value}))})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"form-label",children:"Message"}),s.jsx("textarea",{className:"form-control",rows:6,value:o.content,onChange:e=>x(t=>({...t,content:e.target.value}))}),s.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",r?.email||"you"]})]})]}),s.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[s.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:M,disabled:o.sending,children:"Cancel"}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:o.sending||!o.content.trim(),children:o.sending?"Sending…":"Send"})]})]})]})})]})})}export{je as default};
