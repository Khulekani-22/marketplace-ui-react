import{u as ge,D as pe,d as he,r as c,a as ie,c as E,b as f,j as a,L as ne}from"./index-CA0CEW2v.js";import{M as ye}from"./MasterLayout-DmY1NVaa.js";import{u as fe}from"./useAppSync-C6gKe1DY.js";import"./iconify-DgbGXnnR.js";const P="/api/lms",q="__OTHER__";function oe(){return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)}function xe(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return null}}function R(e){var s;return{id:(e==null?void 0:e.id)??oe(),title:(e==null?void 0:e.title)??"",category:(e==null?void 0:e.category)??"",vendor:(e==null?void 0:e.vendor)??"",vendorId:(e==null?void 0:e.vendorId)??"",contactEmail:((e==null?void 0:e.contactEmail)||(e==null?void 0:e.email)||"").toLowerCase(),ownerUid:(e==null?void 0:e.ownerUid)??(e==null?void 0:e.ownerId)??"",ownerEmail:((e==null?void 0:e.ownerEmail)||(e==null?void 0:e.contactEmail)||(e==null?void 0:e.email)||"").toLowerCase(),price:Number((e==null?void 0:e.price)||0),rating:Number((e==null?void 0:e.rating)||0),reviewCount:typeof(e==null?void 0:e.reviewCount)=="number"?e.reviewCount:Number((e==null?void 0:e.reviewCount)||((s=e==null?void 0:e.reviews)==null?void 0:s.length)||0),imageUrl:(e==null?void 0:e.imageUrl)??"",aiHint:(e==null?void 0:e.aiHint)??"",listingType:(e==null?void 0:e.listingType)??"service",status:(e==null?void 0:e.status)??"pending",isFeatured:!!(e!=null&&e.isFeatured),description:(e==null?void 0:e.description)??"",reviews:Array.isArray(e==null?void 0:e.reviews)?e.reviews:[],tags:Array.isArray(e==null?void 0:e.tags)?e.tags:[],source:(e==null?void 0:e.source)??"",clonedFrom:(e==null?void 0:e.clonedFrom)??"",tenantId:(e==null?void 0:e.tenantId)??"public",createdAt:(e==null?void 0:e.createdAt)??(e==null?void 0:e.created_at)??new Date().toISOString()}}function le(e,s={}){const i=((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||s.email||"").toLowerCase();return{id:String((e==null?void 0:e.id)??(e==null?void 0:e.vendorId)??s.vendorId??""),vendorId:String((e==null?void 0:e.vendorId)??(e==null?void 0:e.id)??s.vendorId??""),name:(e==null?void 0:e.name)??(e==null?void 0:e.companyName)??(e==null?void 0:e.vendor)??s.name??"",contactEmail:i,ownerUid:(e==null?void 0:e.ownerUid)??(e==null?void 0:e.uid)??s.uid??"",status:((e==null?void 0:e.status)||"active").toLowerCase()}}function se(e,s){if(!e)return null;const i=((s==null?void 0:s.email)||"").toLowerCase(),B=[Array.isArray(e.startups)&&e.startups,Array.isArray(e.vendors)&&e.vendors,Array.isArray(e.companies)&&e.companies,Array.isArray(e.profiles)&&e.profiles].filter(Boolean);for(const T of B){const S=T.find(n=>(n==null?void 0:n.ownerUid)&&n.ownerUid===(s==null?void 0:s.uid)||(n==null?void 0:n.email)&&n.email.toLowerCase()===i||(n==null?void 0:n.contactEmail)&&n.contactEmail.toLowerCase()===i||(s==null?void 0:s.vendorId)&&(String(n==null?void 0:n.vendorId)===String(s.vendorId)||String(n==null?void 0:n.id)===String(s.vendorId)));if(S)return le(S,s)}return null}function ve(){var ae,te,re;const e=ge(),[s]=pe(),{vendor:i,ensureVendorId:B,refresh:T}=he(),{syncNow:S}=fe(),n=c.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),k=sessionStorage.getItem("role")==="admin",[b,M]=c.useState(ie),[C,J]=c.useState(()=>k?[]:[]),ce=c.useMemo(()=>{const t=(b==null?void 0:b.services)||[];return Array.from(new Set(t.map(g=>(g.category||"").trim()).filter(Boolean)))},[b]),[z,G]=c.useState(!1),[W,v]=c.useState(""),[K,Q]=c.useState(""),D=c.useMemo(()=>{const t=s.get("prefill");return t?xe(decodeURIComponent(t)):null},[s]),[u,de]=c.useState(null);c.useEffect(()=>{let t=!0;return(async()=>{var g;await B();try{let y=ie;try{const{data:o}=await E.get(`${P}/live`,{headers:{"x-tenant-id":n,"cache-control":"no-cache"}});if(o){y=o;const h=s.get("from");if(h){const m=(g=o==null?void 0:o.services)==null?void 0:g.find(x=>String(x.id)===String(h));m&&de(m)}}}catch{}try{const{data:o}=await E.get("/api/data/vendors"),h=Array.isArray(o)?o:[],m=JSON.parse(JSON.stringify(y));m.startups=Array.isArray(m.startups)?m.startups:[],h.forEach(x=>{const $=(x.email||x.contactEmail||"").toLowerCase(),U=String(x.vendorId||x.id||$||""),p=m.startups.findIndex(L=>String(L.vendorId||L.id)===U),_={...m.startups[p]||{},...x,vendorId:U,id:U};p>=0?m.startups[p]=_:m.startups.push(_)}),y=m}catch{}if(t&&M(y),k)try{const{data:o}=await E.get(`${P}/checkpoints`,{headers:{"x-tenant-id":n,"cache-control":"no-cache"}}),h=Array.isArray(o==null?void 0:o.items)?o.items:[];t&&J(h)}catch{t&&J([])}}catch{}})(),()=>{t=!1}},[n,k]);const r=c.useMemo(()=>{var g,y,o;const t={uid:(g=f.currentUser)==null?void 0:g.uid,email:((y=f.currentUser)==null?void 0:y.email)||(i==null?void 0:i.email)||"",name:((o=f.currentUser)==null?void 0:o.displayName)||(i==null?void 0:i.name)||"",vendorId:(i==null?void 0:i.vendorId)||""};return se(b,t)||le({},t)},[b,i==null?void 0:i.vendorId,(ae=f.currentUser)==null?void 0:ae.uid,(te=f.currentUser)==null?void 0:te.email]);c.useEffect(()=>{!(i!=null&&i.vendorId)&&(r!=null&&r.vendorId)&&(T==null||T())},[r==null?void 0:r.vendorId]);const X=((r==null?void 0:r.status)||"").toLowerCase(),O=X==="active",Y=X==="suspended",d=c.useMemo(()=>R(u||D||{}),[u,D]),[l,Z]=c.useState({title:d.title||"",categoryChoice:d.category||"",categoryCustom:"",price:d.price?String(d.price):"",imageUrl:d.imageUrl||"",description:d.description||"",listingType:d.listingType||"service"});c.useEffect(()=>{Z(t=>({...t,title:u?`${d.title} (Copy)`:d.title||t.title,categoryChoice:d.category||t.categoryChoice,price:d.price?String(d.price):t.price,imageUrl:d.imageUrl||t.imageUrl,description:d.description||t.description,listingType:d.listingType||t.listingType}))},[u==null?void 0:u.id]);function I(t,g){Z(y=>({...y,[t]:g}))}const V=l.categoryChoice===q?l.categoryCustom.trim():(l.categoryChoice||"").trim(),ee=((r==null?void 0:r.contactEmail)||"").toLowerCase()||(((re=f.currentUser)==null?void 0:re.email)||"").toLowerCase(),A=!(r!=null&&r.vendorId),w=A||Y||!O;c.useEffect(()=>{if(f.currentUser&&(A||!O)){const t=encodeURIComponent(window.location.pathname+window.location.search);e(`/profile-vendor?next=${t}`)}},[A,O]);async function me(t){var m,x,$,U;if(t.preventDefault(),v(""),Q(""),A){v("Please create your vendor profile before submitting a listing.");return}if(!O){v("Your vendor account is not yet approved. Please complete your profile and wait for admin approval.");return}if(Y){v("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}if(!l.title.trim()||!V){v("Title and category are required.");return}let g=b;try{const{data:p}=await E.get(`${P}/live`,{headers:{"x-tenant-id":n,"cache-control":"no-cache"}});p&&(g=p)}catch{g=b}const y={uid:(m=f.currentUser)==null?void 0:m.uid,email:((x=f.currentUser)==null?void 0:x.email)||(i==null?void 0:i.email)||"",name:(($=f.currentUser)==null?void 0:$.displayName)||(i==null?void 0:i.name)||"",vendorId:(r==null?void 0:r.vendorId)||(i==null?void 0:i.vendorId)||""},o=se(g,y)||r;if(((o==null?void 0:o.status)||"").toLowerCase()==="suspended"){v("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}const h=R({id:oe(),title:l.title.trim(),category:V,vendor:o.name||o.contactEmail||"Vendor",vendorId:o.vendorId,contactEmail:ee,ownerUid:((U=f.currentUser)==null?void 0:U.uid)||o.ownerUid||"",ownerEmail:ee,price:Number(l.price||0),rating:0,reviewCount:0,imageUrl:(l.imageUrl||"").trim(),listingType:l.listingType||"service",status:"pending",isFeatured:!1,description:(l.description||"").trim(),reviews:[],createdAt:new Date().toISOString(),...u?{source:"duplicate",clonedFrom:u.id}:{},...D&&!u?{source:"prefill"}:{}});G(!0);try{const p={...h,tenantId:n,tags:Array.isArray(h==null?void 0:h.tags)?h.tags:[]},{data:_}=await E.post("/api/data/services",p,{headers:{"Content-Type":"application/json","x-tenant-id":n}}),L=R(_||p);try{const{data:j}=await E.get(`${P}/live`,{headers:{"x-tenant-id":n,"cache-control":"no-cache"}}),N=j&&typeof j=="object"&&j.data?j.data:j;N&&typeof N=="object"&&!Array.isArray(N)?M(N):M(F=>{const H=F&&typeof F=="object"?{...F}:{},ue=Array.isArray(H.services)?H.services:[];return{...H,services:[...ue,L]}})}catch{M(j=>{const N=j&&typeof j=="object"?{...j}:{},F=Array.isArray(N.services)?N.services:[];return{...N,services:[...F,L]}})}try{await(S==null?void 0:S())}catch{}Q("Listing submitted! It’s now pending review by the marketplace admins."),setTimeout(()=>e("/listings-vendors-mine",{replace:!0,state:{newListing:L}}),850)}catch(p){v((p==null?void 0:p.message)||"Failed to submit listing."),window.scrollTo({top:0,behavior:"smooth"})}finally{G(!1)}}return a.jsx(ye,{activeRoute:"/listings-vendors",pageTitle:"Submit a Listing",children:a.jsxs("div",{className:"container py-4",style:{maxWidth:880},children:[a.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[a.jsx("h1",{className:"h4 mb-0",children:"Submit a Listing"}),a.jsxs("div",{className:"text-muted small",children:["Vendor:"," ",r!=null&&r.vendorId?a.jsxs(a.Fragment,{children:[a.jsx("code",{className:"me-1",children:r.vendorId}),a.jsxs("span",{children:["(",r.name||r.contactEmail,")"]}),Y&&a.jsx("span",{className:"badge text-bg-danger ms-2",children:"suspended"})]}):"not set"]})]}),A&&a.jsxs("div",{className:"alert alert-warning d-flex justify-content-between align-items-center",children:[a.jsx("div",{children:"You need a vendor profile before submitting a listing."}),a.jsx(ne,{to:"/signup/vendor?next=/listings-vendors",className:"btn btn-sm btn-primary",children:"Create vendor profile"})]}),!A&&Y&&a.jsxs("div",{className:"alert alert-danger",children:["Your vendor account is ",a.jsx("strong",{children:"suspended"}),". You cannot submit listings. Please contact support if you think this is an error."]}),u&&a.jsxs("div",{className:"alert alert-info",children:["Duplicating from ",a.jsx("strong",{children:u.title}),". Adjust fields and submit to create a new ",a.jsx("strong",{children:"pending"})," listing."]}),D&&!u&&a.jsxs("div",{className:"alert alert-info",children:["Form prefilled. Review and submit to create a"," ",a.jsx("strong",{children:"pending"})," listing."]}),W&&a.jsx("div",{className:"alert alert-danger",children:W}),K&&a.jsx("div",{className:"alert alert-success",children:K}),a.jsxs("div",{className:"card bg-body",children:[a.jsx("div",{className:"card-header bg-body-tertiary fw-semibold",children:"Listing details"}),a.jsx("div",{className:"card-body",children:a.jsxs("form",{onSubmit:me,noValidate:!0,children:[a.jsxs("div",{className:"row g-3 mb-1",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Vendor"}),a.jsx("input",{className:"form-control",value:(r==null?void 0:r.name)||(r==null?void 0:r.contactEmail)||"",disabled:!0,"aria-readonly":"true"})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Vendor ID"}),a.jsx("input",{className:"form-control",value:(r==null?void 0:r.vendorId)||"",disabled:!0,"aria-readonly":"true"})]})]}),a.jsxs("div",{className:"row g-3",children:[a.jsxs("div",{className:"col-md-8",children:[a.jsx("label",{className:"form-label",children:"Title"}),a.jsx("input",{className:"form-control",value:l.title,onChange:t=>I("title",t.target.value),placeholder:"e.g., Modern Logo & Brand Identity Pack",required:!0,disabled:w})]}),a.jsxs("div",{className:"col-md-4",children:[a.jsx("label",{className:"form-label",children:"Listing type"}),a.jsxs("select",{className:"form-select",value:l.listingType,onChange:t=>I("listingType",t.target.value),disabled:w,children:[a.jsx("option",{value:"service",children:"Service"}),a.jsx("option",{value:"saas",children:"SaaS"})]})]})]}),a.jsxs("div",{className:"row g-3 mt-1",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Category"}),a.jsxs("select",{className:"form-select",value:l.categoryChoice,onChange:t=>I("categoryChoice",t.target.value),disabled:w,required:!0,children:[a.jsx("option",{value:"",disabled:!0,children:"Pick a category"}),ce.map(t=>a.jsx("option",{value:t,children:t},t)),a.jsx("option",{value:q,children:"Other…"})]})]}),l.categoryChoice===q&&a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Custom category"}),a.jsx("input",{className:"form-control",value:l.categoryCustom,onChange:t=>I("categoryCustom",t.target.value),placeholder:"Type a new category",disabled:w,required:!0})]}),a.jsxs("div",{className:"col-md-3",children:[a.jsx("label",{className:"form-label",children:"Price (R)"}),a.jsx("input",{type:"number",min:"0",className:"form-control",value:l.price,onChange:t=>I("price",t.target.value),placeholder:"e.g., 8500",disabled:w})]}),a.jsxs("div",{className:"col-md-3",children:[a.jsx("label",{className:"form-label",children:"Image URL"}),a.jsx("input",{className:"form-control",value:l.imageUrl,onChange:t=>I("imageUrl",t.target.value),placeholder:"https://…",disabled:w})]})]}),a.jsxs("div",{className:"mt-2",children:[a.jsx("label",{className:"form-label",children:"Description"}),a.jsx("textarea",{className:"form-control",rows:4,value:l.description,onChange:t=>I("description",t.target.value),placeholder:"Describe what buyers get, deliverables, timelines, etc.",disabled:w})]}),a.jsxs("div",{className:"border rounded p-2 mt-3",children:[a.jsx("div",{className:"text-muted small mb-1",children:"Card preview"}),a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx("img",{src:l.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:120,height:72,objectFit:"cover",borderRadius:6}}),a.jsxs("div",{children:[a.jsx("div",{className:"fw-semibold",children:l.title||"Untitled service"}),a.jsx("div",{className:"text-muted small",children:(r==null?void 0:r.name)||(r==null?void 0:r.contactEmail)||"Vendor"}),a.jsxs("div",{className:"small",children:["R",Number(l.price||0).toLocaleString()," · ★ 0.0"]})]})]})]}),a.jsxs("div",{className:"d-flex gap-2 mt-3",children:[a.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",type:"submit",disabled:z||w,children:z?"Submitting…":"Submit for review"}),a.jsx(ne,{to:"/listings-vendors-mine",className:"btn btn-outline-secondary",children:"Cancel"})]}),a.jsxs("div",{className:"form-text mt-2",children:["Submissions are added as ",a.jsx("strong",{children:"pending"})," and become visible once approved by admins."]})]})})]}),k&&a.jsxs("div",{className:"card mt-3",children:[a.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[a.jsx("span",{children:"Recent checkpoints"}),a.jsx("span",{className:"text-muted small",children:"Latest snapshots"})]}),a.jsxs("div",{className:"list-group list-group-flush",children:[!(C!=null&&C.length)&&a.jsx("div",{className:"list-group-item text-muted small",children:"No checkpoints yet."}),C==null?void 0:C.slice(0,4).map(t=>a.jsxs("div",{className:"list-group-item d-flex justify-content-between align-items-center",children:[a.jsxs("div",{children:[a.jsx("div",{className:"fw-semibold",children:t.message||"(no message)"}),a.jsx("div",{className:"text-muted small",children:new Date(t.ts).toLocaleString()})]}),a.jsx("a",{className:"btn btn-sm btn-outline-secondary",href:`${P}/checkpoints/${t.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]},t.id))]})]})]})})}export{ve as default};
