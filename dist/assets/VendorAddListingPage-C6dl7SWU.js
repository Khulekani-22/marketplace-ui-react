import{u as le,D as oe,d as ce,r as d,a as Z,c as I,b as j,j as a,L as V}from"./index-1xXifhh4.js";import{M as de}from"./MasterLayout-12_PyrKn.js";import"./iconify-Dl13qa3R.js";const U="/api/lms",M="__OTHER__";function ae(){return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)}function me(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return null}}function k(e){var s;return{id:(e==null?void 0:e.id)??ae(),title:(e==null?void 0:e.title)??"",category:(e==null?void 0:e.category)??"",vendor:(e==null?void 0:e.vendor)??"",vendorId:(e==null?void 0:e.vendorId)??"",contactEmail:((e==null?void 0:e.contactEmail)||(e==null?void 0:e.email)||"").toLowerCase(),price:Number((e==null?void 0:e.price)||0),rating:Number((e==null?void 0:e.rating)||0),reviewCount:typeof(e==null?void 0:e.reviewCount)=="number"?e.reviewCount:Number((e==null?void 0:e.reviewCount)||((s=e==null?void 0:e.reviews)==null?void 0:s.length)||0),imageUrl:(e==null?void 0:e.imageUrl)??"",aiHint:(e==null?void 0:e.aiHint)??"",listingType:(e==null?void 0:e.listingType)??"service",status:(e==null?void 0:e.status)??"pending",isFeatured:!!(e!=null&&e.isFeatured),description:(e==null?void 0:e.description)??"",reviews:Array.isArray(e==null?void 0:e.reviews)?e.reviews:[]}}function te(e,s={}){const r=((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||s.email||"").toLowerCase();return{id:String((e==null?void 0:e.id)??(e==null?void 0:e.vendorId)??s.vendorId??""),vendorId:String((e==null?void 0:e.vendorId)??(e==null?void 0:e.id)??s.vendorId??""),name:(e==null?void 0:e.name)??(e==null?void 0:e.companyName)??(e==null?void 0:e.vendor)??s.name??"",contactEmail:r,ownerUid:(e==null?void 0:e.ownerUid)??(e==null?void 0:e.uid)??s.uid??"",status:((e==null?void 0:e.status)||"active").toLowerCase()}}function ee(e,s){if(!e)return null;const r=((s==null?void 0:s.email)||"").toLowerCase(),F=[Array.isArray(e.startups)&&e.startups,Array.isArray(e.vendors)&&e.vendors,Array.isArray(e.companies)&&e.companies,Array.isArray(e.profiles)&&e.profiles].filter(Boolean);for(const E of F){const y=E.find(n=>(n==null?void 0:n.ownerUid)&&n.ownerUid===(s==null?void 0:s.uid)||(n==null?void 0:n.email)&&n.email.toLowerCase()===r||(n==null?void 0:n.contactEmail)&&n.contactEmail.toLowerCase()===r||(s==null?void 0:s.vendorId)&&(String(n==null?void 0:n.vendorId)===String(s.vendorId)||String(n==null?void 0:n.id)===String(s.vendorId)));if(y)return te(y,s)}return null}function he(){var W,K,Q;const e=le(),[s]=oe(),{vendor:r,ensureVendorId:F,refresh:E}=ce(),y=d.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),n=sessionStorage.getItem("role")==="admin",[x,$]=d.useState(Z),[L,O]=d.useState(()=>n?[]:[]),ie=d.useMemo(()=>{const t=(x==null?void 0:x.services)||[];return Array.from(new Set(t.map(g=>(g.category||"").trim()).filter(Boolean)))},[x]),[Y,_]=d.useState(!1),[B,v]=d.useState(""),[H,q]=d.useState(""),T=d.useMemo(()=>{const t=s.get("prefill");return t?me(decodeURIComponent(t)):null},[s]),[p,re]=d.useState(null);d.useEffect(()=>{let t=!0;return(async()=>{var g;await F();try{let h=Z;try{const{data:l}=await I.get(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache"}});if(l){h=l;const b=s.get("from");if(b){const u=(g=l==null?void 0:l.services)==null?void 0:g.find(f=>String(f.id)===String(b));u&&re(u)}}}catch{}try{const{data:l}=await I.get("/api/data/vendors"),b=Array.isArray(l)?l:[],u=JSON.parse(JSON.stringify(h));u.startups=Array.isArray(u.startups)?u.startups:[],b.forEach(f=>{const R=(f.email||f.contactEmail||"").toLowerCase(),c=String(f.vendorId||f.id||R||""),S=u.startups.findIndex(X=>String(X.vendorId||X.id)===c),C={...u.startups[S]||{},...f,vendorId:c,id:c};S>=0?u.startups[S]=C:u.startups.push(C)}),h=u}catch{}if(t&&$(h),n)try{const{data:l}=await I.get(`${U}/checkpoints`,{headers:{"x-tenant-id":y,"cache-control":"no-cache"}}),b=Array.isArray(l==null?void 0:l.items)?l.items:[];t&&O(b)}catch{t&&O([])}}catch{}})(),()=>{t=!1}},[y,n]);const i=d.useMemo(()=>{var g,h,l;const t={uid:(g=j.currentUser)==null?void 0:g.uid,email:((h=j.currentUser)==null?void 0:h.email)||(r==null?void 0:r.email)||"",name:((l=j.currentUser)==null?void 0:l.displayName)||(r==null?void 0:r.name)||"",vendorId:(r==null?void 0:r.vendorId)||""};return ee(x,t)||te({},t)},[x,r==null?void 0:r.vendorId,(W=j.currentUser)==null?void 0:W.uid,(K=j.currentUser)==null?void 0:K.email]);d.useEffect(()=>{!(r!=null&&r.vendorId)&&(i!=null&&i.vendorId)&&(E==null||E())},[i==null?void 0:i.vendorId]);const J=((i==null?void 0:i.status)||"").toLowerCase(),D=J==="active",P=J==="suspended",m=d.useMemo(()=>k(p||T||{}),[p,T]),[o,z]=d.useState({title:m.title||"",categoryChoice:m.category||"",categoryCustom:"",price:m.price?String(m.price):"",imageUrl:m.imageUrl||"",description:m.description||"",listingType:m.listingType||"service"});d.useEffect(()=>{z(t=>({...t,title:p?`${m.title} (Copy)`:m.title||t.title,categoryChoice:m.category||t.categoryChoice,price:m.price?String(m.price):t.price,imageUrl:m.imageUrl||t.imageUrl,description:m.description||t.description,listingType:m.listingType||t.listingType}))},[p==null?void 0:p.id]);function w(t,g){z(h=>({...h,[t]:g}))}const G=o.categoryChoice===M?o.categoryCustom.trim():(o.categoryChoice||"").trim(),se=((i==null?void 0:i.contactEmail)||"").toLowerCase()||(((Q=j.currentUser)==null?void 0:Q.email)||"").toLowerCase(),A=!(i!=null&&i.vendorId),N=A||P||!D;d.useEffect(()=>{if(j.currentUser&&(A||!D)){const t=encodeURIComponent(window.location.pathname+window.location.search);e(`/profile-vendor?next=${t}`)}},[A,D]);async function ne(t){var u,f,R;if(t.preventDefault(),v(""),q(""),A){v("Please create your vendor profile before submitting a listing.");return}if(!D){v("Your vendor account is not yet approved. Please complete your profile and wait for admin approval.");return}if(P){v("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}if(!o.title.trim()||!G){v("Title and category are required.");return}let g=x;try{const{data:c}=await I.get(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache"}});c&&(g=c)}catch{g=x}const h={uid:(u=j.currentUser)==null?void 0:u.uid,email:((f=j.currentUser)==null?void 0:f.email)||(r==null?void 0:r.email)||"",name:((R=j.currentUser)==null?void 0:R.displayName)||(r==null?void 0:r.name)||"",vendorId:(i==null?void 0:i.vendorId)||(r==null?void 0:r.vendorId)||""},l=ee(g,h)||i;if(((l==null?void 0:l.status)||"").toLowerCase()==="suspended"){v("Your vendor account is suspended. You cannot submit listings. Please contact support.");return}const b=k({id:ae(),title:o.title.trim(),category:G,vendor:l.name||l.contactEmail||"Vendor",vendorId:l.vendorId,contactEmail:se,price:Number(o.price||0),rating:0,reviewCount:0,imageUrl:(o.imageUrl||"").trim(),listingType:o.listingType||"service",status:"pending",isFeatured:!1,description:(o.description||"").trim(),reviews:[],createdAt:new Date().toISOString(),...p?{source:"duplicate",clonedFrom:p.id}:{},...T&&!p?{source:"prefill"}:{}});_(!0);try{let c=x;try{const{data:C}=await I.get(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache"}});C&&(c=C)}catch{c=x}const S={...c,services:Array.isArray(c==null?void 0:c.services)?[...c.services,b]:[b]};await I.put(`${U}/publish`,{data:S},{headers:{"Content-Type":"application/json","x-tenant-id":y}});try{const{data:C}=await I.get(`${U}/live`,{headers:{"x-tenant-id":y,"cache-control":"no-cache"}});$(C||S)}catch{$(S)}q("Listing submitted! Itâ€™s now pending review by the marketplace admins."),setTimeout(()=>e("/listings-vendors-mine",{replace:!0}),850)}catch(c){v((c==null?void 0:c.message)||"Failed to submit listing."),window.scrollTo({top:0,behavior:"smooth"})}finally{_(!1)}}return a.jsx(de,{activeRoute:"/listings-vendors",pageTitle:"Submit a Listing",children:a.jsxs("div",{className:"container py-4",style:{maxWidth:880},children:[a.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[a.jsx("h1",{className:"h4 mb-0",children:"Submit a Listing"}),a.jsxs("div",{className:"text-muted small",children:["Vendor:"," ",i!=null&&i.vendorId?a.jsxs(a.Fragment,{children:[a.jsx("code",{className:"me-1",children:i.vendorId}),a.jsxs("span",{children:["(",i.name||i.contactEmail,")"]}),P&&a.jsx("span",{className:"badge text-bg-danger ms-2",children:"suspended"})]}):"not set"]})]}),A&&a.jsxs("div",{className:"alert alert-warning d-flex justify-content-between align-items-center",children:[a.jsx("div",{children:"You need a vendor profile before submitting a listing."}),a.jsx(V,{to:"/signup/vendor?next=/listings-vendors",className:"btn btn-sm btn-primary",children:"Create vendor profile"})]}),!A&&P&&a.jsxs("div",{className:"alert alert-danger",children:["Your vendor account is ",a.jsx("strong",{children:"suspended"}),". You cannot submit listings. Please contact support if you think this is an error."]}),p&&a.jsxs("div",{className:"alert alert-info",children:["Duplicating from ",a.jsx("strong",{children:p.title}),". Adjust fields and submit to create a new ",a.jsx("strong",{children:"pending"})," listing."]}),T&&!p&&a.jsxs("div",{className:"alert alert-info",children:["Form prefilled. Review and submit to create a"," ",a.jsx("strong",{children:"pending"})," listing."]}),B&&a.jsx("div",{className:"alert alert-danger",children:B}),H&&a.jsx("div",{className:"alert alert-success",children:H}),a.jsxs("div",{className:"card bg-body",children:[a.jsx("div",{className:"card-header bg-body-tertiary fw-semibold",children:"Listing details"}),a.jsx("div",{className:"card-body",children:a.jsxs("form",{onSubmit:ne,noValidate:!0,children:[a.jsxs("div",{className:"row g-3 mb-1",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Vendor"}),a.jsx("input",{className:"form-control",value:(i==null?void 0:i.name)||(i==null?void 0:i.contactEmail)||"",disabled:!0,"aria-readonly":"true"})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Vendor ID"}),a.jsx("input",{className:"form-control",value:(i==null?void 0:i.vendorId)||"",disabled:!0,"aria-readonly":"true"})]})]}),a.jsxs("div",{className:"row g-3",children:[a.jsxs("div",{className:"col-md-8",children:[a.jsx("label",{className:"form-label",children:"Title"}),a.jsx("input",{className:"form-control",value:o.title,onChange:t=>w("title",t.target.value),placeholder:"e.g., Modern Logo & Brand Identity Pack",required:!0,disabled:N})]}),a.jsxs("div",{className:"col-md-4",children:[a.jsx("label",{className:"form-label",children:"Listing type"}),a.jsxs("select",{className:"form-select",value:o.listingType,onChange:t=>w("listingType",t.target.value),disabled:N,children:[a.jsx("option",{value:"service",children:"Service"}),a.jsx("option",{value:"saas",children:"SaaS"})]})]})]}),a.jsxs("div",{className:"row g-3 mt-1",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Category"}),a.jsxs("select",{className:"form-select",value:o.categoryChoice,onChange:t=>w("categoryChoice",t.target.value),disabled:N,required:!0,children:[a.jsx("option",{value:"",disabled:!0,children:"Pick a category"}),ie.map(t=>a.jsx("option",{value:t,children:t},t)),a.jsx("option",{value:M,children:"Otherâ€¦"})]})]}),o.categoryChoice===M&&a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",children:"Custom category"}),a.jsx("input",{className:"form-control",value:o.categoryCustom,onChange:t=>w("categoryCustom",t.target.value),placeholder:"Type a new category",disabled:N,required:!0})]}),a.jsxs("div",{className:"col-md-3",children:[a.jsx("label",{className:"form-label",children:"Price (R)"}),a.jsx("input",{type:"number",min:"0",className:"form-control",value:o.price,onChange:t=>w("price",t.target.value),placeholder:"e.g., 8500",disabled:N})]}),a.jsxs("div",{className:"col-md-3",children:[a.jsx("label",{className:"form-label",children:"Image URL"}),a.jsx("input",{className:"form-control",value:o.imageUrl,onChange:t=>w("imageUrl",t.target.value),placeholder:"https://â€¦",disabled:N})]})]}),a.jsxs("div",{className:"mt-2",children:[a.jsx("label",{className:"form-label",children:"Description"}),a.jsx("textarea",{className:"form-control",rows:4,value:o.description,onChange:t=>w("description",t.target.value),placeholder:"Describe what buyers get, deliverables, timelines, etc.",disabled:N})]}),a.jsxs("div",{className:"border rounded p-2 mt-3",children:[a.jsx("div",{className:"text-muted small mb-1",children:"Card preview"}),a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx("img",{src:o.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:120,height:72,objectFit:"cover",borderRadius:6}}),a.jsxs("div",{children:[a.jsx("div",{className:"fw-semibold",children:o.title||"Untitled service"}),a.jsx("div",{className:"text-muted small",children:(i==null?void 0:i.name)||(i==null?void 0:i.contactEmail)||"Vendor"}),a.jsxs("div",{className:"small",children:["R",Number(o.price||0).toLocaleString()," Â· â˜… 0.0"]})]})]})]}),a.jsxs("div",{className:"d-flex gap-2 mt-3",children:[a.jsx("button",{className:"btn rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",type:"submit",disabled:Y||N,children:Y?"Submittingâ€¦":"Submit for review"}),a.jsx(V,{to:"/listings-vendors-mine",className:"btn btn-outline-secondary",children:"Cancel"})]}),a.jsxs("div",{className:"form-text mt-2",children:["Submissions are added as ",a.jsx("strong",{children:"pending"})," and become visible once approved by admins."]})]})})]}),n&&a.jsxs("div",{className:"card mt-3",children:[a.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[a.jsx("span",{children:"Recent checkpoints"}),a.jsx("span",{className:"text-muted small",children:"Latest snapshots"})]}),a.jsxs("div",{className:"list-group list-group-flush",children:[!(L!=null&&L.length)&&a.jsx("div",{className:"list-group-item text-muted small",children:"No checkpoints yet."}),L==null?void 0:L.slice(0,4).map(t=>a.jsxs("div",{className:"list-group-item d-flex justify-content-between align-items-center",children:[a.jsxs("div",{children:[a.jsx("div",{className:"fw-semibold",children:t.message||"(no message)"}),a.jsx("div",{className:"text-muted small",children:new Date(t.ts).toLocaleString()})]}),a.jsx("a",{className:"btn btn-sm btn-outline-secondary",href:`${U}/checkpoints/${t.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]},t.id))]})]})]})})}export{he as default};
