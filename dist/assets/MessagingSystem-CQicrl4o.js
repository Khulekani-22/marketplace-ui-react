import{r,j as e,L as R}from"./index-C1K-Ttoc.js";import{I as c}from"./iconify-CXWIXv_s.js";const k=()=>{const[d,h]=r.useState([]),[N,y]=r.useState([]),[i,w]=r.useState(null),[x,g]=r.useState([]),[o,u]=r.useState(""),[a,S]=r.useState(null),[C,p]=r.useState(!0),[m,j]=r.useState(!1),f=r.useRef(null),l="http://localhost:5500/api",M=()=>{var s;(s=f.current)==null||s.scrollIntoView({behavior:"smooth"})};r.useEffect(()=>{M()},[x]),r.useEffect(()=>{(async()=>{try{const n=await(await fetch(`${l}/me`)).json();S(n)}catch(t){console.error("Error fetching current user:",t)}})()},[]),r.useEffect(()=>{(async()=>{try{const n=await(await fetch(`${l}/messages/contacts`)).json();n.success&&y(n.contacts)}catch(t){console.error("Error fetching contacts:",t)}})()},[]),r.useEffect(()=>{(async()=>{try{const n=await(await fetch(`${l}/messages?limit=100`)).json();h(n.messages||[]),p(!1)}catch(t){console.error("Error fetching messages:",t),p(!1)}})()},[]),r.useEffect(()=>{i&&a&&(async()=>{try{const n=await(await fetch(`${l}/messages/conversation?user1=${a.email}&user2=${i.email}`)).json();n.success&&g(n.conversation||[])}catch(t){console.error("Error fetching conversation:",t)}})()},[i,a]);const E=async s=>{if(s.preventDefault(),!(!o.trim()||!i||!a||m)){j(!0);try{const n=await(await fetch(`${l}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:i.email,subject:`Message to ${i.name}`,content:o,priority:"normal",from:{uid:a.uid,email:a.email,name:a.name||a.email,type:a.role||"user"}})})).json();if(n.success){g(D=>[...D,n.data]),u("");const L=await(await fetch(`${l}/messages?limit=100`)).json();h(L.messages||[])}}catch(t){console.error("Error sending message:",t)}finally{j(!1)}}},b=s=>new Date(s).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),$=s=>d.filter(n=>n.from.email===s.email&&n.to.email===(a==null?void 0:a.email)||n.from.email===(a==null?void 0:a.email)&&n.to.email===s.email).sort((n,v)=>new Date(v.timestamp).getTime()-new Date(n.timestamp).getTime())[0],T=s=>d.filter(t=>t.from.email===s.email&&t.to.email===(a==null?void 0:a.email)&&t.status==="unread").length;return C?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"400px"},children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):e.jsxs("div",{className:"chat-wrapper",children:[e.jsxs("div",{className:"chat-sidebar card",children:[e.jsxs("div",{className:"chat-sidebar-single active top-profile",children:[e.jsx("div",{className:"img",children:e.jsx("img",{src:(a==null?void 0:a.avatar)||"assets/images/chat/1.png",alt:"Current user"})}),e.jsxs("div",{className:"info",children:[e.jsx("h6",{className:"text-md mb-0",children:(a==null?void 0:a.name)||"User"}),e.jsx("p",{className:"mb-0",children:"Available"})]}),e.jsx("div",{className:"action",children:e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{type:"button",className:"text-secondary-light text-xl","data-bs-toggle":"dropdown","data-bs-display":"static","aria-expanded":"false",children:e.jsx(c,{icon:"bi:three-dots"})}),e.jsx("ul",{className:"dropdown-menu dropdown-menu-lg-end border",children:e.jsx("li",{children:e.jsxs(R,{to:"/chat-profile",className:"dropdown-item rounded text-secondary-light bg-hover-neutral-200 text-hover-neutral-900 d-flex align-items-center gap-2",children:[e.jsx(c,{icon:"fluent:person-32-regular"}),"Profile"]})})})]})})]}),e.jsx("div",{className:"chat-search",children:e.jsxs("form",{children:[e.jsx("input",{type:"text",name:"chatSearch",placeholder:"Search here..."}),e.jsx(c,{icon:"iconoir:search",className:"search-icon"})]})}),e.jsx("div",{className:"chat-all-list",children:N.map(s=>{const t=$(s),n=T(s);return e.jsxs("div",{className:`chat-sidebar-single ${(i==null?void 0:i.id)===s.id?"active":""}`,onClick:()=>w(s),style:{cursor:"pointer"},children:[e.jsx("div",{className:"img",children:e.jsx("img",{src:s.avatar,alt:s.name})}),e.jsxs("div",{className:"info",children:[e.jsx("h6",{className:"text-sm mb-1",children:s.name}),e.jsx("p",{className:"mb-0 text-xs",children:t?t.content.length>30?t.content.substring(0,30)+"...":t.content:"No messages yet"})]}),e.jsxs("div",{className:"action text-end",children:[e.jsx("p",{className:"mb-0 text-neutral-400 text-xs lh-1",children:t?b(t.timestamp):""}),n>0&&e.jsx("span",{className:"w-16-px h-16-px text-xs rounded-circle bg-warning-main text-white d-inline-flex align-items-center justify-content-center",children:n})]})]},s.id)})})]}),e.jsx("div",{className:"chat-main card",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"chat-sidebar-single active",children:[e.jsx("div",{className:"img",children:e.jsx("img",{src:i.avatar,alt:i.name})}),e.jsxs("div",{className:"info",children:[e.jsx("h6",{className:"text-md mb-0",children:i.name}),e.jsx("p",{className:"mb-0",children:i.status})]}),e.jsxs("div",{className:"action d-inline-flex align-items-center gap-3",children:[e.jsx("button",{type:"button",className:"text-xl text-primary-light",children:e.jsx(c,{icon:"mi:call"})}),e.jsx("button",{type:"button",className:"text-xl text-primary-light",children:e.jsx(c,{icon:"fluent:video-32-regular"})}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{type:"button",className:"text-primary-light text-xl","data-bs-toggle":"dropdown","data-bs-display":"static","aria-expanded":"false",children:e.jsx(c,{icon:"tabler:dots-vertical"})}),e.jsx("ul",{className:"dropdown-menu dropdown-menu-lg-end border",children:e.jsx("li",{children:e.jsxs("button",{className:"dropdown-item rounded text-secondary-light bg-hover-neutral-200 text-hover-neutral-900 d-flex align-items-center gap-2",type:"button",children:[e.jsx(c,{icon:"mdi:clear-circle-outline"}),"Clear All"]})})})]})]})]}),e.jsxs("div",{className:"chat-message-list",style:{maxHeight:"400px",overflowY:"auto"},children:[x.map(s=>{const t=s.from.email===(a==null?void 0:a.email);return e.jsxs("div",{className:`chat-single-message ${t?"right":"left"}`,children:[!t&&e.jsx("img",{src:s.from.avatar,alt:s.from.name,className:"avatar-lg object-fit-cover rounded-circle"}),e.jsxs("div",{className:"chat-message-content",children:[e.jsx("p",{className:"mb-3",children:s.content}),e.jsx("p",{className:"chat-time mb-0",children:e.jsx("span",{children:b(s.timestamp)})})]})]},s.id)}),e.jsx("div",{ref:f})]}),e.jsxs("form",{className:"chat-message-box",onSubmit:E,children:[e.jsx("input",{type:"text",name:"chatMessage",placeholder:"Write message",value:o,onChange:s=>u(s.target.value),disabled:m}),e.jsxs("div",{className:"chat-message-box-action",children:[e.jsx("button",{type:"button",className:"text-xl",children:e.jsx(c,{icon:"ph:link"})}),e.jsx("button",{type:"button",className:"text-xl",children:e.jsx(c,{icon:"solar:gallery-linear"})}),e.jsxs("button",{type:"submit",className:"btn btn-sm btn-primary-600 radius-8 d-inline-flex align-items-center gap-1",disabled:m||!o.trim(),children:[m?"Sending...":"Send",e.jsx(c,{icon:"f7:paperplane"})]})]})]})]}):e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center h-100 text-center",children:[e.jsx(c,{icon:"fluent:chat-48-regular",className:"text-primary",style:{fontSize:"4rem"}}),e.jsx("h5",{className:"mt-3 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted",children:"Choose a contact from the sidebar to start messaging"})]})})]})};export{k as M};
