import{r as b,n as A,j as e}from"./index-DEYsEGWU.js";const D="lms_admin_draft_v1",U="lms_admin_undo_v1",K="lms_admin_history_cache_v1",S="/api/lms";function E(o){try{return typeof o=="string"?JSON.parse(o):o}catch{return null}}function y(o){return JSON.parse(JSON.stringify(o))}function xe(o){return new Date(o).toLocaleString()}function fe(o){var u,f;const i=Array.isArray(o==null?void 0:o.cohorts)?o.cohorts.length:0,d=((u=o==null?void 0:o.cohorts)==null?void 0:u.reduce((j,a)=>j+(Array.isArray(a.courses)?a.courses.length:0),0))??0,m=((f=o==null?void 0:o.cohorts)==null?void 0:f.reduce((j,a)=>j+(Array.isArray(a.courses)?a.courses.reduce((p,g)=>p+(Array.isArray(g.lessons)?g.lessons.length:0),0):0),0))??0;return{cohorts:i,courses:d,lessons:m}}function Ce(){var W,F;const o=b.useMemo(()=>sessionStorage.getItem("tenantId")||"public",[]),[i,d]=b.useState(()=>E(localStorage.getItem(D))??{cohorts:[],bookings:[],events:[],forumThreads:[],jobs:[],mentorshipSessions:[],messageThreads:[],services:[],leads:[],startups:[]}),[m,u]=b.useState(()=>JSON.stringify(i,null,2)),[f,j]=b.useState("visual"),[a,p]=b.useState(!1),[g,k]=b.useState(null),[R,C]=b.useState(null),I=b.useRef([]),[P,B]=b.useState(()=>E(localStorage.getItem(K))??[]),L=(i==null?void 0:i.cohorts)??[],[J,T]=b.useState(((W=L[0])==null?void 0:W.id)??""),l=b.useMemo(()=>L.find(s=>s.id===J),[L,J]),[_,H]=b.useState(""),[x,M]=b.useState(null),v=b.useMemo(()=>{var s;return(s=l==null?void 0:l.courses)==null?void 0:s.find(t=>t.id===x)},[l,x]);function q(s){const t=E(localStorage.getItem(U))??[];t.unshift(s);const n=t.slice(0,10);localStorage.setItem(U,JSON.stringify(n)),I.current=n}function N(s){q(i),d(s),u(JSON.stringify(s,null,2)),localStorage.setItem(D,JSON.stringify(s))}function G(){const s=I.current.length?I.current:E(localStorage.getItem(U))??[];if(!s.length)return;const t=s.shift();I.current=s,localStorage.setItem(U,JSON.stringify(s)),d(t),u(JSON.stringify(t,null,2))}function O(s){k(s),setTimeout(()=>k(null),2500)}b.useEffect(()=>{(async()=>{var s,t,n,r;try{p(!0);const c=await((t=(s=A.currentUser)==null?void 0:s.getIdToken)==null?void 0:t.call(s)),h=await fetch(`${S}/live`,{headers:{"x-tenant-id":o,...c?{Authorization:`Bearer ${c}`}:{}}});if(h.ok){const w=await h.json();d(w),u(JSON.stringify(w,null,2)),localStorage.setItem(D,JSON.stringify(w)),T(((r=(n=w==null?void 0:w.cohorts)==null?void 0:n[0])==null?void 0:r.id)??"")}await $()}catch(c){console.warn("Init load failed:",c)}finally{p(!1)}})()},[]);async function $(){var s,t;try{const n=await((t=(s=A.currentUser)==null?void 0:s.getIdToken)==null?void 0:t.call(s)),c=(await fetch(`${S}/checkpoints`,{headers:{"x-tenant-id":o,...n?{Authorization:`Bearer ${n}`}:{}}}).then(h=>h.ok?h.json():{items:[]})).items??[];B(c),localStorage.setItem(K,JSON.stringify(c.slice(0,2)))}catch{}}async function Q(s){var n;const t=(n=s.target.files)==null?void 0:n[0];if(t)try{const r=await t.text(),c=JSON.parse(r);N(c),O("Imported JSON into working copy")}catch{C("Invalid JSON file")}finally{s.target.value=""}}function X(){const s=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),t=URL.createObjectURL(s),n=document.createElement("a");n.download=`lms-working-copy-${Date.now()}.json`,n.href=t,n.click(),URL.revokeObjectURL(t)}async function Z(){var s,t;C(null),p(!0);try{const n=await((t=(s=A.currentUser)==null?void 0:s.getIdToken)==null?void 0:t.call(s)),r=await fetch(`${S}/publish`,{method:"PUT",headers:{"Content-Type":"application/json","x-tenant-id":o,...n?{Authorization:`Bearer ${n}`}:{}},body:JSON.stringify({data:i})});if(!r.ok)throw new Error(await r.text()||`Publish failed (${r.status})`);O("Published to live"),await $()}catch(n){C(n.message||"Publish failed")}finally{p(!1)}}async function ee(s){var t,n;C(null);try{const r=await((n=(t=A.currentUser)==null?void 0:t.getIdToken)==null?void 0:n.call(t)),c=await fetch(`${S}/checkpoints`,{method:"POST",headers:{"Content-Type":"application/json","x-tenant-id":o,...r?{Authorization:`Bearer ${r}`}:{}},body:JSON.stringify({message:s||"",data:i})});if(!c.ok)throw new Error(await c.text());O("Checkpoint saved"),await $()}catch(r){C(r.message||"Failed to save checkpoint")}}async function se(s){var t,n;if(window.confirm("Restore this snapshot to LIVE? This will overwrite appData.json."))try{const r=await((n=(t=A.currentUser)==null?void 0:t.getIdToken)==null?void 0:n.call(t)),c=await fetch(`${S}/restore/${s}`,{method:"POST",headers:{"x-tenant-id":o,...r?{Authorization:`Bearer ${r}`}:{}}});if(!c.ok)throw new Error(await c.text());O("Restored and published"),await $();const h=await fetch(`${S}/live`).then(w=>w.json());N(h)}catch(r){C(r.message||"Restore failed")}}async function te(){var s,t;if(window.confirm("Clear ALL checkpoints on the server?"))try{const n=await((t=(s=A.currentUser)==null?void 0:s.getIdToken)==null?void 0:t.call(s)),r=await fetch(`${S}/checkpoints`,{method:"DELETE",headers:{"x-tenant-id":o,...n?{Authorization:`Bearer ${n}`}:{}}});if(!r.ok)throw new Error(await r.text());O("Cleared history"),await $()}catch(n){C(n.message||"Failed to clear")}}function ne(){const s=prompt("Cohort name?");if(!s)return;const t=s.toLowerCase().replace(/\s+/g,"-"),n=y(i);n.cohorts=n.cohorts||[],n.cohorts.push({id:t,name:s,courses:[]}),N(n),T(t)}function oe(){if(!l)return;const s=prompt("New cohort name:",l.name||"");if(!s)return;const t=y(i),n=t.cohorts.find(r=>r.id===l.id);n.name=s,N(t)}function ie(){var t;if(!l||!window.confirm(`Delete cohort "${l.name}"?`))return;const s=y(i);s.cohorts=s.cohorts.filter(n=>n.id!==l.id),N(s),T(((t=s.cohorts[0])==null?void 0:t.id)??""),M(null)}function re(){var c;if(!l)return;const s=prompt("Course title?");if(!s)return;const t=(((c=l.courses)==null?void 0:c.length)||0)+1+"",n=y(i),r=n.cohorts.find(h=>h.id===l.id);r.courses=r.courses||[],r.courses.push({id:t,title:s,description:"",videoThumbnail:"",aiHint:"",lessons:[]}),N(n)}function ce(){if(!v||!l)return;const s=y(i),t=s.cohorts.find(r=>r.id===l.id),n=y(v);n.id=(t.courses.length+1).toString(),n.title=n.title+" (Copy)",t.courses.push(n),N(s)}function le(){if(!v||!l||!window.confirm(`Delete "${v.title}"?`))return;const s=y(i),t=s.cohorts.find(n=>n.id===l.id);t.courses=t.courses.filter(n=>n.id!==v.id),N(s),M(null)}function ae(s,t){const n=y(i),c=n.cohorts.find(h=>h.id===l.id).courses.find(h=>h.id===v.id);c[s]=t,N(n)}function de(){if(!v)return;const s=prompt("Lesson title?");if(!s)return;const t=y(i),r=t.cohorts.find(h=>h.id===l.id).courses.find(h=>h.id===v.id);r.lessons=r.lessons||[];const c=r.lessons.length+1;r.lessons.push({id:`${r.id}-${String.fromCharCode(96+c)}`,title:s,duration:"15 min",completed:!1}),N(t)}function he(s,t){const n=y(i),c=n.cohorts.find(h=>h.id===l.id).courses.find(h=>h.id===v.id);c.lessons[s]={...c.lessons[s],...t},N(n)}function ue(s){if(!v)return;const t=y(i);t.cohorts.find(c=>c.id===l.id).courses.find(c=>c.id===v.id).lessons.splice(s,1),N(t)}const z=fe(i),me=((F=l==null?void 0:l.courses)==null?void 0:F.filter(s=>s.title.toLowerCase().includes(_.toLowerCase())))??[];return e.jsxs("div",{className:"container py-4",children:[e.jsx("style",{children:`
        .history-item{ padding: .75rem 1rem; }
        .item-actions{ opacity: 0; transition: opacity .15s ease; }
        .history-item:hover .item-actions{ opacity: 1; }
        .pill{ padding:.25rem .5rem; border-radius:9999px; font-weight:600; font-size:.75rem; }
        .pill-low{ background:#fde2e0; color:#b42318; }     /* red-ish */
        .pill-med{ background:#eadcfb; color:#5925dc; }    /* purple-ish */
        .pill-high{ background:#d1fadf; color:#067647; }   /* green-ish */
        .pill-none{ background:#e9ecef; color:#495057; }
        .icon{ width:20px; height:20px; margin-right:.5rem; opacity:.8 }
        .btn-icon{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; }
      `}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("h1",{className:"display-6 mb-0",children:"LMS Admin"}),e.jsxs("div",{className:"text-muted small",children:["Cohorts: ",z.cohorts," · Courses: ",z.courses," · Lessons: ",z.lessons]})]}),e.jsxs("p",{className:"text-secondary",children:["Manage cohorts, courses and lessons. Draft persists in ",e.jsx("code",{children:"localStorage"}),". Checkpoints live on the server (with a 2-item offline cache)."]}),e.jsxs("div",{className:"d-flex gap-2 mb-3",children:[e.jsxs("label",{className:"btn btn-light mb-0",children:["Import JSON",e.jsx("input",{type:"file",accept:"application/json",hidden:!0,onChange:Q})]}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:X,children:"Export Current"}),e.jsx("button",{className:"btn btn-success",onClick:Z,disabled:a,title:"Write working copy to live appData.json on the server",children:a?"Publishing…":"Publish to live"})]}),g&&e.jsx("div",{className:"alert alert-success py-2",children:g}),R&&e.jsx("div",{className:"alert alert-danger py-2",children:R}),e.jsx(je,{onSave:ee,onClear:te,onUndo:G,disabled:a}),e.jsxs("div",{className:"d-flex gap-3",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("ul",{className:"nav nav-tabs mb-3",children:[e.jsx("li",{className:"nav-item",children:e.jsx("button",{className:`nav-link ${f==="visual"?"active":""}`,onClick:()=>j("visual"),children:"Visual editor"})}),e.jsx("li",{className:"nav-item",children:e.jsx("button",{className:`nav-link ${f==="json"?"active":""}`,onClick:()=>j("json"),children:"JSON editor"})})]}),f==="json"?e.jsx(be,{text:m,setText:u,onApply:()=>{const s=E(m);if(!s){C("Invalid JSON");return}N(s),O("Applied JSON to working copy")}}):e.jsx(pe,{data:i,cohortId:J,setCohortId:T,currentCohort:l,courseSearch:_,setCourseSearch:H,filteredCourses:me,selectedCourseId:x,setSelectedCourseId:M,selectedCourse:v,addCohort:ne,renameCohort:oe,deleteCohort:ie,addCourse:re,duplicateCourse:ce,deleteCourse:le,updateCourseField:ae,addLesson:de,updateLesson:he,deleteLesson:ue})]}),e.jsx("div",{style:{width:420},children:e.jsx(Ne,{items:P,onRestore:se})})]})]})}function je({onSave:o,onClear:i,onUndo:d,disabled:m}){const[u,f]=b.useState("");return e.jsx("div",{className:"card mb-3",children:e.jsxs("div",{className:"card-body d-flex align-items-center gap-2 py-2",children:[e.jsx(Y,{className:"icon"}),e.jsx("input",{className:"form-control",placeholder:"Checkpoint message (e.g. 'Added AWS serverless module')",value:u,onChange:j=>f(j.target.value)}),e.jsx("button",{className:"btn btn-primary",onClick:()=>o(u),disabled:m,title:"Save checkpoint",children:"Save"}),e.jsx("button",{className:"btn btn-outline-secondary btn-icon",onClick:d,title:"Undo",children:"↶"}),e.jsx("button",{className:"btn btn-outline-danger btn-icon",onClick:i,title:"Clear history",children:"🗑"})]})})}function be({text:o,setText:i,onApply:d}){return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header fw-semibold",children:"Working copy (JSON)"}),e.jsxs("div",{className:"card-body",children:[e.jsx("textarea",{value:o,onChange:m=>i(m.target.value),rows:22,spellCheck:!1,className:"form-control font-monospace"}),e.jsxs("div",{className:"d-flex justify-content-between mt-2",children:[e.jsxs("small",{className:"text-muted",children:["Tip: Press ",e.jsx("kbd",{children:"⌘/Ctrl"}),"+",e.jsx("kbd",{children:"A"})," then ",e.jsx("kbd",{children:"⌘/Ctrl"}),"+",e.jsx("kbd",{children:"C"})," to copy."]}),e.jsx("button",{className:"btn btn-outline-primary",onClick:d,children:"Apply JSON"})]})]})]})}function pe(o){const{data:i,cohortId:d,setCohortId:m,currentCohort:u,courseSearch:f,setCourseSearch:j,filteredCourses:a,selectedCourseId:p,setSelectedCourseId:g,selectedCourse:k,addCohort:R,renameCohort:C,deleteCohort:I,addCourse:P,duplicateCourse:B,deleteCourse:L,updateCourseField:J,addLesson:T,updateLesson:l,deleteLesson:_}=o,H=(i==null?void 0:i.cohorts)??[];return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between",children:[e.jsx("span",{className:"fw-semibold",children:"Visual editor"}),e.jsx("span",{className:"text-muted small",children:"Friendly CRUD for cohorts, courses & lessons"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-3",children:[e.jsx("label",{className:"fw-medium me-2",children:"Cohort"}),e.jsx("select",{className:"form-select",style:{maxWidth:320},value:d,onChange:x=>m(x.target.value),children:H.map(x=>e.jsx("option",{value:x.id,children:x.name||x.id},x.id))}),e.jsx("button",{className:"btn btn-outline-primary",onClick:R,children:"+ Add cohort"}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:C,disabled:!u,children:"Rename"}),e.jsx("button",{className:"btn btn-outline-danger",onClick:I,disabled:!u,children:"Delete"})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-4",children:[e.jsx("label",{className:"fw-medium",children:"Courses"}),e.jsx("input",{className:"form-control mb-2",placeholder:"Search",value:f,onChange:x=>j(x.target.value)}),e.jsxs("div",{className:"list-group mb-2",style:{maxHeight:360,overflow:"auto"},children:[a.map(x=>e.jsx("button",{className:"list-group-item list-group-item-action "+(p===x.id?"active":""),onClick:()=>g(x.id),children:x.title},x.id)),!a.length&&e.jsx("div",{className:"text-muted small p-2",children:"No courses."})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-outline-primary",onClick:P,disabled:!u,children:"+ Add course"}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:B,disabled:!k,children:"Duplicate"}),e.jsx("button",{className:"btn btn-outline-danger",onClick:L,disabled:!k,children:"Delete"})]})]}),e.jsx("div",{className:"col",children:k?e.jsx(ge,{course:k,updateCourseField:J,addLesson:T,updateLesson:l,deleteLesson:_}):e.jsx("div",{className:"text-muted mt-2",children:"Select a course to edit details and lessons."})})]})]})]})}function ge({course:o,updateCourseField:i,addLesson:d,updateLesson:m,deleteLesson:u}){var f,j;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Title"}),e.jsx("input",{className:"form-control",value:o.title||"",onChange:a=>i("title",a.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-control",rows:3,value:o.description||"",onChange:a=>i("description",a.target.value)})]}),e.jsxs("div",{className:"row g-3 mb-3",children:[e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"Video thumbnail URL"}),e.jsx("input",{className:"form-control",value:o.videoThumbnail||"",onChange:a=>i("videoThumbnail",a.target.value)})]}),e.jsxs("div",{className:"col",children:[e.jsx("label",{className:"form-label",children:"AI hint (optional)"}),e.jsx("input",{className:"form-control",value:o.aiHint||"",onChange:a=>i("aiHint",a.target.value)})]})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-2",children:"Lessons"}),e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:d,children:"+ Add lesson"})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:80},children:"ID"}),e.jsx("th",{children:"Title"}),e.jsx("th",{style:{width:120},children:"Duration"}),e.jsx("th",{style:{width:100},children:"Completed"}),e.jsx("th",{style:{width:70}})]})}),e.jsxs("tbody",{children:[(f=o.lessons)==null?void 0:f.map((a,p)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.id}),e.jsx("td",{children:e.jsx("input",{className:"form-control form-control-sm",value:a.title||"",onChange:g=>m(p,{title:g.target.value})})}),e.jsx("td",{children:e.jsx("input",{className:"form-control form-control-sm",value:a.duration||"",onChange:g=>m(p,{duration:g.target.value})})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",className:"form-check-input",checked:!!a.completed,onChange:g=>m(p,{completed:!!g.target.checked})})}),e.jsx("td",{className:"text-end",children:e.jsx("button",{className:"btn btn-outline-danger btn-sm",onClick:()=>u(p),children:"Delete"})})]},a.id||p)),!((j=o.lessons)!=null&&j.length)&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-muted small",children:"No lessons yet."})})]})]})})]})}function Ne({items:o,onRestore:i}){return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header fw-semibold d-flex justify-content-between",children:[e.jsx("span",{children:"Version history"}),e.jsx("span",{className:"text-muted small",children:"Showing latest checkpoints"})]}),o!=null&&o.length?e.jsx("div",{className:"list-group list-group-flush",children:o.map(d=>{var u,f,j;const m=ve(d.delta);return e.jsx("div",{className:"list-group-item history-item",children:e.jsxs("div",{className:"d-flex align-items-start justify-content-between gap-3",children:[e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx(Y,{className:"icon"}),e.jsxs("div",{className:"text-truncate",style:{maxWidth:220},children:[e.jsx("div",{className:"fw-semibold text-truncate",children:d.message||"(no message)"}),e.jsx("div",{className:"text-muted small",children:xe(d.ts)}),e.jsxs("div",{className:"text-muted small",children:["Δ Cohorts: ",V((u=d.delta)==null?void 0:u.cohorts)," · Δ Courses: ",V((f=d.delta)==null?void 0:f.courses)," · Δ Lessons: ",V((j=d.delta)==null?void 0:j.lessons)]})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:`pill ${m.className}`,children:m.label}),e.jsxs("div",{className:"item-actions",children:[e.jsx("button",{className:"btn btn-outline-primary btn-sm",title:"Restore snapshot to LIVE",onClick:()=>i(d.id),children:"Restore"}),e.jsx("a",{className:"btn btn-outline-secondary btn-sm ms-1",title:"Download snapshot JSON",href:`${S}/checkpoints/${d.id}`,target:"_blank",rel:"noreferrer",children:"Download"})]})]})]})},d.id)})}):e.jsx("div",{className:"list-group list-group-flush",children:e.jsxs("div",{className:"list-group-item text-muted small",children:["No checkpoints yet.",e.jsx("div",{className:"mt-1",children:"Offline cache keeps the two most recent checkpoints."})]})})]})}function V(o){const i=Number(o||0);return(i>=0?"+":"")+i}function ve(o){const i=Math.abs((o==null?void 0:o.cohorts)||0)+Math.abs((o==null?void 0:o.courses)||0)+Math.abs((o==null?void 0:o.lessons)||0);return i===0?{label:"No change",className:"pill-none"}:i<=2?{label:"Low",className:"pill-low"}:i<=5?{label:"Medium",className:"pill-med"}:{label:"High",className:"pill-high"}}function Y({className:o}){return e.jsxs("svg",{className:o,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeWidth:"1.6"}),e.jsx("path",{d:"M12 7v5l3 2",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})]})}export{Ce as default};
