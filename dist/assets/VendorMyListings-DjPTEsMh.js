import{c as te,u as he,m as ge,r as l,d as fe,a as Z,j as t,L as $}from"./index-CA0CEW2v.js";import{u as pe,M as xe}from"./MasterLayout-DmY1NVaa.js";import{u as be}from"./useAppSync-C6gKe1DY.js";import"./iconify-DgbGXnnR.js";async function je(h={}){var d;try{const{signal:u}=h,{data:r}=await te.get("/api/data/services/mine",{signal:u}),w=Array.isArray(r==null?void 0:r.listings)?r.listings:[],L=Array.isArray(r==null?void 0:r.bookings)?r.bookings:[],B=(r==null?void 0:r.vendor)||null,F=typeof(r==null?void 0:r.tenantId)=="string"?r.tenantId:void 0;return{listings:w,bookings:L,vendor:B,tenantId:F}}catch(u){const r=(d=u==null?void 0:u.response)==null?void 0:d.status;if(r===401||r===403||r===404)return{listings:[],bookings:[]};throw u}}function H(h){if(!h)return"public";const d=h.toString().toLowerCase();return d==="vendor"?"public":d}function V(h,d){const u=H(h),r=H(d);return u===r||u==="public"||r==="public"}function ee({s:h}){const d=(h||"unknown").toLowerCase(),u={approved:"success",pending:"warning",rejected:"danger",scheduled:"info",completed:"success",canceled:"secondary",unknown:"secondary"};return t.jsx("span",{className:`badge text-bg-${u[d]||"secondary"}`,children:d})}function ke(){var X;const h=he(),d=ge(),u=l.useRef(null),{vendor:r,ensureVendorId:w,loading:L}=fe(),{refresh:B,syncMessagesToLive:F}=pe(),{appData:W,appDataLoading:q}=be(),J=l.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),[b,j]=l.useState([]),[N,S]=l.useState([]),[M,se]=l.useState(!0),[Y,ne]=l.useState(!1),[_,k]=l.useState(""),[o,v]=l.useState({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1}),f=(X=d.state)==null?void 0:X.newListing;l.useEffect(()=>{f&&(u.current=f,j(e=>e?e.some(n=>String((n==null?void 0:n.id)||(n==null?void 0:n.serviceId))===String((f==null?void 0:f.id)||(f==null?void 0:f.serviceId)))?e:[f,...e]:[f]),k(""),h({pathname:d.pathname,search:d.search},{replace:!0,state:{}}))},[f,h,d.pathname,d.search]);const I=l.useCallback(e=>{const s=u.current;return s?e.some(i=>String((i==null?void 0:i.id)||(i==null?void 0:i.serviceId))===String((s==null?void 0:s.id)||(s==null?void 0:s.serviceId)))?(u.current=null,e):[s,...e]:e},[]);l.useEffect(()=>{if(r&&!r.isApproved){const e=encodeURIComponent("/listings-vendors-mine");h(`/profile-vendor?next=${e}`,{replace:!0})}},[r,h]);function G(e){var i,g,m;let s=e;const n=new Set;for(;s&&typeof s=="object"&&!Array.isArray(s==null?void 0:s.services)&&!n.has(s);){if(n.add(s),Array.isArray((i=s==null?void 0:s.data)==null?void 0:i.services)){s=s.data;continue}if(Array.isArray((g=s==null?void 0:s.payload)==null?void 0:g.services)){s=s.payload;continue}if(Array.isArray((m=s==null?void 0:s.appData)==null?void 0:m.services)){s=s.appData;continue}break}return s&&typeof s=="object"?s:null}const U=l.useCallback(e=>{if(!e)return{listings:[],bookings:[]};const s=G(W)||G(Z)||Z,n=H(J),i=Array.isArray(s==null?void 0:s.services)?s.services:[],m=(Array.isArray(s==null?void 0:s.bookings)?s.bookings:[]).filter(c=>V(c==null?void 0:c.tenantId,n)),a=String((e==null?void 0:e.vendorId)||""),x=String((e==null?void 0:e.email)||(e==null?void 0:e.contactEmail)||"").toLowerCase(),p=String((e==null?void 0:e.name)||(e==null?void 0:e.companyName)||"").toLowerCase(),y=i.filter(c=>{if(!V(c==null?void 0:c.tenantId,n))return!1;const A=String(c.vendorId||""),K=String(c.contactEmail||c.email||"").toLowerCase(),D=String(c.vendor||"").toLowerCase();return A&&a&&A===a||!A&&(D&&D===p||x&&K===x)}),P=new Set(y.flatMap(c=>[String(c.id||""),String(c.serviceId||""),String(c.vendorId||"")]).filter(Boolean)),C=m.filter(c=>{const E=String(c.serviceId||""),A=a&&String(c.vendorId||"")===a,K=x&&String(c.vendorEmail||"").toLowerCase()===x,D=p&&String(c.vendorName||"").toLowerCase()===p;return P.has(E)||A||K||D});return{listings:y,bookings:C}},[W,J]),R=l.useCallback(async({signal:e,silent:s}={})=>{var g,m;const n=a=>{s?ne(a):se(a)};n(!0),k("");let i=r;try{if(e!=null&&e.aborted||L&&!r)return;if(!r){j([]),S([]);return}const a=w?await w():r;if(e!=null&&e.aborted)return;if(i=a||r,!i){j([]),S([]);return}const{listings:x,bookings:p}=await je({signal:e});if(e!=null&&e.aborted)return;const y=Array.isArray(x)?x:[],P=Array.isArray(p)?p:[],C=I(y);if(C.length)j(C),S(P);else{const c=U(i);if(c.listings.length){const E=I(c.listings);j(E),S(c.bookings),s||k("Showing cached listings until the live catalog updates.")}else j(C),S([])}}catch(a){if(e!=null&&e.aborted)return;if((a==null?void 0:a.code)==="ERR_NETWORK"){const p=U(i),y=I(p.listings);j(y),S(p.bookings),k("Showing cached data while the network is unavailable.")}else k(((m=(g=a==null?void 0:a.response)==null?void 0:g.data)==null?void 0:m.message)||(a==null?void 0:a.message)||"Failed to load listings"),j(I([])),S([])}finally{n(!1)}},[U,w,I,r,L]);l.useEffect(()=>{const e=new AbortController;return R({signal:e.signal}),()=>{e.abort()}},[R]);const re=l.useCallback(async()=>{k(""),await R({silent:!0})},[R]),z=l.useMemo(()=>{const e={approved:0,pending:0,rejected:0};return b.forEach(s=>{var n;return e[n=(s.status||"pending").toLowerCase()]||(e[n]=0),e[(s.status||"pending").toLowerCase()]++}),e},[b]),ae=l.useMemo(()=>{const e={};return N.forEach(s=>{const n=String(s.serviceId||"");n&&(e[n]=(e[n]||0)+1)}),e},[N]),ie=l.useMemo(()=>{const e={};return b.forEach(s=>{[String(s.id||""),String(s.serviceId||""),String(s.vendorId||"")].filter(Boolean).forEach(i=>{e[i]=s})}),e},[b]);function Q(e){const s=(e+11)%12+1,n=e>=12?"PM":"AM";return`${s}:00 ${n}`}function ce(e){if(!e)return"";const[s]=e.split(":"),n=Number(s);return Number.isNaN(n)?e:`${Q(n)} – ${Q(n+1)}`}function O(e){if(e!=null&&e.scheduledDate){const s=e.scheduledSlot||"00:00",n=`${e.scheduledDate}T${s.length===5?s:`${s}:00`}`,i=new Date(n);if(!Number.isNaN(i.getTime()))return i}if(e!=null&&e.bookedAt){const s=new Date(e.bookedAt);if(!Number.isNaN(s.getTime()))return s}return null}const le=l.useMemo(()=>{const e=N.map(s=>({...s}));return e.sort((s,n)=>{var m,a;const i=((m=O(s))==null?void 0:m.getTime())??0,g=((a=O(n))==null?void 0:a.getTime())??0;return i-g}),e},[N]);function oe(e){return e?{date:e.toLocaleDateString(),time:e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}:{date:"—",time:""}}function de(e){const s=encodeURIComponent(JSON.stringify({title:e.title,category:e.category,price:e.price,imageUrl:e.imageUrl,description:e.description,listingType:e.listingType||"service"}));h(`/listings-vendors?prefill=${s}`)}function ue(e){const s=`Feedback request: ${e.title}`,n=`Hello Admin

My listing "${e.title}" (ID: ${e.id}) was ${String(e.status||"rejected")}. Could you please share more details on what needs to be corrected so I can resubmit?

Thank you!`;v({open:!0,listing:e,subject:s,content:n,sending:!1,err:null,done:!1})}function T(){v({open:!1,listing:null,subject:"",content:"",sending:!1,err:null,done:!1})}async function me(e){var s;if((s=e==null?void 0:e.preventDefault)==null||s.call(e),!(!o.listing||!o.content.trim())){v(n=>({...n,sending:!0,err:null}));try{await te.post("/api/messages",{listingId:o.listing.id,listingTitle:o.listing.title,vendorId:(r==null?void 0:r.vendorId)||"",vendorEmail:(r==null?void 0:r.email)||"",subject:o.subject,content:o.content}),v(n=>({...n,sending:!1,done:!0}));try{await B({force:!0}),await F()}catch{}setTimeout(()=>T(),1200)}catch(n){v(i=>{var g,m;return{...i,sending:!1,err:((m=(g=n==null?void 0:n.response)==null?void 0:g.data)==null?void 0:m.message)||(n==null?void 0:n.message)||"Failed to send"}})}}}return t.jsx(xe,{activeRoute:"/listings-vendors-mine",pageTitle:"My listings",children:t.jsxs("div",{className:"container py-4",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[t.jsx("h1",{className:"h4 mb-0",children:"My listings"}),t.jsxs("div",{className:"d-flex gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:re,disabled:M||Y||q,children:Y||q?"Refreshing…":"Refresh"}),t.jsx($,{to:"/listings-vendors",className:"btn btn-primary",children:"+ Submit new listing"})]})]}),t.jsxs("div",{className:"d-flex gap-2 flex-wrap mb-3",children:[t.jsxs("span",{className:"badge text-bg-success",children:["Approved: ",z.approved]}),t.jsxs("span",{className:"badge text-bg-warning",children:["Pending: ",z.pending]}),t.jsxs("span",{className:"badge text-bg-danger",children:["Rejected: ",z.rejected]}),t.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",b.length]})]}),t.jsx("div",{className:"card",children:t.jsxs("div",{className:"card-body",children:[_&&t.jsx("div",{className:"alert alert-danger",children:_}),M&&t.jsx("div",{className:"text-muted",children:"Loading…"}),!M&&!b.length&&t.jsxs("div",{className:"text-muted",children:["You haven’t submitted any listings yet."," ",t.jsx($,{to:"/listings-vendors",children:"Create your first one."})]}),!M&&!!b.length&&t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{width:72}}),t.jsx("th",{children:"Title"}),t.jsx("th",{children:"Category"}),t.jsx("th",{children:"Price"}),t.jsx("th",{children:"Status"}),t.jsx("th",{children:"Bookings"}),t.jsx("th",{style:{width:220},children:"Actions"})]})}),t.jsx("tbody",{children:b.map((e,s)=>{const n=String(e.id||e.serviceId||e.vendorId||"");return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx("img",{src:e.imageUrl||"/assets/images/placeholder-4x3.png",alt:"",style:{width:64,height:40,objectFit:"cover",borderRadius:6}})}),t.jsx("td",{className:"fw-semibold",children:e.title}),t.jsx("td",{children:e.category||"—"}),t.jsxs("td",{children:["R",Number(e.price||0).toLocaleString()]}),t.jsx("td",{children:t.jsx(ee,{s:e.status})}),t.jsx("td",{children:ae[n]||0}),t.jsxs("td",{className:"d-flex gap-2",children:[t.jsx($,{className:"btn btn-outline-secondary btn-sm",to:`/marketplace-details?id=${encodeURIComponent(e.id)}`,children:"View"}),t.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>de(e),children:"Duplicate & edit"}),String(e.status||"").toLowerCase()==="rejected"&&t.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>ue(e),title:"Ask admin why this was rejected",children:"Message Admin"})]})]},n||s)})})]})})]})}),t.jsxs("div",{className:"card mt-4",children:[t.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[t.jsx("h6",{className:"mb-0",children:"Bookings"}),t.jsxs("span",{className:"badge text-bg-secondary",children:["Total: ",N.length]})]}),t.jsxs("div",{className:"card-body",children:[!N.length&&t.jsx("div",{className:"text-muted",children:"No bookings yet. Once customers reserve sessions, they will appear here."}),!!N.length&&t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table align-middle",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Service"}),t.jsx("th",{children:"Customer"}),t.jsx("th",{children:"Scheduled"}),t.jsx("th",{children:"Status"}),t.jsx("th",{className:"text-end",children:"Price"})]})}),t.jsx("tbody",{children:le.map((e,s)=>{const n=O(e),{date:i,time:g}=oe(n),m=ce(e.scheduledSlot),a=ie[String(e.serviceId||"")],x=e.serviceTitle||(a==null?void 0:a.title)||"Unknown service",p=Number(e.price||(a==null?void 0:a.price)||0)||0,y=String(e.id||[e.serviceId,e.customerId,e.scheduledDate,e.scheduledSlot,e.bookedAt].filter(Boolean).join("-")||s);return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"d-flex flex-column",children:[t.jsx("span",{className:"fw-semibold",children:x}),(a==null?void 0:a.id)&&t.jsx($,{className:"small",to:`/marketplace-details?id=${encodeURIComponent(a.id)}`,children:"Open listing"})]})}),t.jsx("td",{children:t.jsx("div",{className:"small text-muted",children:e.customerName||e.customerEmail||"—"})}),t.jsx("td",{children:t.jsxs("div",{className:"d-flex flex-column small",children:[t.jsx("span",{children:i}),t.jsx("span",{children:m||g})]})}),t.jsx("td",{children:t.jsx(ee,{s:e.status||"pending"})}),t.jsxs("td",{className:"text-end",children:["R",p.toLocaleString()]})]},y)})})]})})]})]}),o.open&&o.listing&&t.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:e=>e.target===e.currentTarget&&T(),children:t.jsxs("div",{className:"card",style:{maxWidth:560,margin:"10vh auto"},children:[t.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[t.jsxs("h6",{className:"mb-0",children:["Message Admin about: ",o.listing.title]}),t.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:T,children:"Close"})]}),t.jsxs("form",{onSubmit:me,children:[t.jsxs("div",{className:"card-body",children:[o.err&&t.jsx("div",{className:"alert alert-danger py-2 mb-2",children:o.err}),o.done&&t.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"form-label",children:"Subject"}),t.jsx("input",{className:"form-control",value:o.subject,onChange:e=>v(s=>({...s,subject:e.target.value}))})]}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"form-label",children:"Message"}),t.jsx("textarea",{className:"form-control",rows:6,value:o.content,onChange:e=>v(s=>({...s,content:e.target.value}))}),t.jsxs("div",{className:"text-secondary small mt-1",children:["Sent as ",(r==null?void 0:r.email)||"you"]})]})]}),t.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:T,disabled:o.sending,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:o.sending||!o.content.trim(),children:o.sending?"Sending…":"Send"})]})]})]})})]})})}export{ke as default};
