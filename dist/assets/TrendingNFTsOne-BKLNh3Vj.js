import{r as l,u as ve,a as D,b as j,j as t}from"./index-DZWX-KI0.js";import{a as fe}from"./appData-56SExs5I.js";import{f as ye,u as we,s as je}from"./subscriptions-q5aYT3lE.js";const k=o=>({...o,vendor:o.vendor??o.vendorName??"",imageUrl:o.imageUrl??o.thumbnail??"",category:o.category??o.categoryId??"",rating:typeof o.rating=="number"?o.rating:Number(o.rating||0),reviews:Array.isArray(o.reviews)?o.reviews:[],status:(o.status??"approved").toString().toLowerCase()}),F=o=>o.status==="approved",Ce=({query:o,onQueryChange:J,category:K,onCategoryChange:X,onCategoriesChange:R})=>{const Z=l.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),N=l.useMemo(()=>(fe.services||[]).map(k).filter(F),[]),[p,T]=l.useState(N),L=l.useRef(N),y=l.useRef(0),[E,_]=l.useState(!0),[ee,te]=l.useState("All"),A=K??ee,se=X??te,[ae,ne]=l.useState(""),S=o??ae,$=J??ne,[b,q]=l.useState({}),[x,v]=l.useState({open:!1,id:null,showAll:!1,page:0}),[P,m]=l.useState(""),[re,f]=l.useState("success"),[B,W]=l.useState(!1),[Q,M]=l.useState(()=>new Set),ie=ve();function le(e={},s={}){const n=Number(e.reviewCount||(Array.isArray(e.reviews)?e.reviews.length:0)||0),a=Number(s.reviewCount||(Array.isArray(s.reviews)?s.reviews.length:0)||0),i=Date.parse(e.lastReviewedAt||"")||0,g=Date.parse(s.lastReviewedAt||"")||0;return a>n?s:a<n?e:g>i?s:e}function V(e,s,n){const a=new Map;return s.forEach(i=>a.set(String(i.id),i)),n.forEach(i=>a.set(String(i.id),i)),e.forEach(i=>{const g=String(i.id),d=a.get(g)||{},c=le(d,i);a.set(g,{...d,reviews:Array.isArray(c.reviews)?c.reviews:d.reviews,reviewCount:Number(c.reviewCount||(Array.isArray(c.reviews)?c.reviews.length:d.reviewCount||0)||0),rating:typeof c.rating=="number"?c.rating:Number(c.rating||d.rating||0),lastReviewedAt:c.lastReviewedAt||d.lastReviewedAt})}),Array.from(a.values())}async function ce(){const e=y.current,{data:s}=await D.get("/api/lms/live"),n=((s==null?void 0:s.services)||[]).map(k).filter(F),a=V(L.current??p,N,n);e===y.current&&T(a)}l.useEffect(()=>{let e=!1;const s=y.current;return(async()=>{try{const{data:n}=await D.get("/api/lms/live"),a=((n==null?void 0:n.services)||[]).map(k).filter(F),i=V(L.current??p,N,a);!e&&s===y.current&&T(i)}catch{}finally{e||_(!1)}})(),()=>{e=!0}},[Z]),l.useEffect(()=>{let e=!1;return(async()=>{try{if(!j.currentUser)return;const s=await ye();if(e)return;const n=new Set(s.filter(a=>(a.type||"service")==="service").map(a=>String(a.serviceId)));M(n)}catch{}})(),()=>{e=!0}},[]);async function oe(e){var s,n,a;try{if(!j.currentUser){ie("/login",{replace:!0,state:{from:((s=window.location)==null?void 0:s.pathname)||"/"}});return}const i=String(e);Q.has(i)?(await we(i),M(d=>{const c=new Set(Array.from(d));return c.delete(i),c}),f("success"),m("Unsubscribed"),setTimeout(()=>m(""),2e3)):(await je(i),M(d=>new Set([...Array.from(d),i])),f("success"),m("Subscribed"),setTimeout(()=>m(""),2e3))}catch(i){const g=((a=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:a.message)||(i==null?void 0:i.message)||"Failed to update subscription";f("danger"),m(g),setTimeout(()=>m(""),2500)}}const z=l.useMemo(()=>["All",...Array.from(new Set(p.map(s=>(s.category||"").trim()).filter(Boolean)))],[p]);l.useEffect(()=>{try{typeof R=="function"&&R(z)}catch{}},[z,R]);const G=l.useMemo(()=>{const e=A.toLowerCase(),s=(S||"").trim().toLowerCase();let n=A==="All"?p:p.filter(a=>(a.category||"").trim().toLowerCase()===e);return s?n.filter(a=>[a.title||"",a.vendor||"",a.category||"",a.description||a.summary||"",Array.isArray(a.tags)?a.tags.join(" "):""].join(` 
 `).toLowerCase().includes(s)):n},[p,A,S]);l.useEffect(()=>{L.current=p},[p]);function H(e,s,n){q(a=>({...a,[e]:{...a[e]||{},[s]:n}}))}function de(e){v({open:!0,id:e,showAll:!1,page:0}),b[e]||q(s=>({...s,[e]:{rating:0,comment:""}}))}function U(){v({open:!1,id:null,showAll:!1,page:0})}function me(e,s){H(e,"rating",s)}function O(e){const s=Number(e||0);return t.jsx("span",{children:[1,2,3,4,5].map(n=>t.jsx("span",{style:{color:s>=n?"#f5a623":"#ccc",fontSize:16},children:"★"},n))})}function ue(e){const s=Array.isArray(e)?e.slice():[];return s.sort((n,a)=>(Date.parse((a==null?void 0:a.createdAt)||"")||0)-(Date.parse((n==null?void 0:n.createdAt)||"")||0)),s}const C=5;function ge(e){const s=Math.max(0,Math.ceil(e/C)-1);v(n=>({...n,page:Math.min(s,(n.page||0)+1)}))}function pe(){v(e=>({...e,page:Math.max(0,(e.page||0)-1)}))}async function he(e){var a,i,g,d,c,w;const s=Number(((a=b[e])==null?void 0:a.rating)||0),n=(((i=b[e])==null?void 0:i.comment)||"").trim();if(Number.isNaN(s)||s<1||s>5){f("danger"),m("Please select a star rating (1–5)."),setTimeout(()=>m(""),2500);return}W(!0);try{const u=((g=j.currentUser)==null?void 0:g.email)||"",r=((d=j.currentUser)==null?void 0:d.displayName)||(u?u.split("@")[0]:"Guest"),h=p.find(I=>I.id===e)||{},{data:xe}=await D.post(`/api/data/services/${encodeURIComponent(e)}/reviews`,{rating:s,comment:n,author:r,authorEmail:u,title:h.title||"",vendor:h.vendor||"",contactEmail:h.contactEmail||h.email||""}),be=k(xe);y.current+=1,T(I=>I.map(Y=>Y.id===e?be:Y)),f("success"),m("Review submitted. Thank you!"),setTimeout(()=>m(""),2500),U(),setTimeout(()=>{ce().catch(()=>{})},800)}catch(u){const r=((w=(c=u==null?void 0:u.response)==null?void 0:c.data)==null?void 0:w.message)||(u==null?void 0:u.message)||"Failed to submit review";f("danger"),m(r),setTimeout(()=>m(""),2500)}finally{W(!1)}}return t.jsxs("div",{className:"col-12",children:[t.jsxs("div",{className:"mb-16 mt-8 d-flex flex-wrap justify-content-between align-items-center gap-12",children:[t.jsx("h6",{className:"mb-0",children:"All Listings"}),t.jsxs("div",{className:"d-flex flex-wrap align-items-center gap-12",children:[t.jsxs("div",{className:"position-relative",children:[t.jsx("input",{type:"text",className:"form-control form-control-sm rounded-3 border-1 border-neutral-300 bg-neutral-100 text-sm ps-12 pe-32 py-8",placeholder:"Search listings by name, vendor, category…",value:S,onChange:e=>$(e.target.value),style:{minWidth:260},"aria-label":"Search listings"}),S&&t.jsx("button",{type:"button",className:"btn btn-sm btn-link position-absolute end-0 top-50 translate-middle-y me-2",onClick:()=>$(""),"aria-label":"Clear search",children:"✕"})]}),t.jsx("ul",{className:"nav button-tab nav-pills mb-0 gap-12",role:"tablist",children:z.map(e=>t.jsx("li",{className:"nav-item",role:"presentation",children:t.jsx("button",{className:`nav-link btn btn-sm rounded-pill text-neutral-500 hover-text-white bg-neutral-300 bg-hover-primary-800 rounded-pill px-20 py-6 border border-neutral-300 ${A===e?"active":""}`,onClick:()=>se(e),children:e})},e))})]})]}),t.jsx("div",{className:"tab-content",children:t.jsx("div",{className:"tab-pane fade show active",children:t.jsxs("div",{className:"row g-3",children:[E&&t.jsx("div",{className:"col-12 text-center text-secondary-light",children:"Loading listings…"}),!E&&G.map(e=>{const s=Number(e.rating||0),n=Number(e.reviewCount||(Array.isArray(e.reviews)?e.reviews.length:0)||0),a=Q.has(String(e.id));return t.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:t.jsx("article",{className:"card p-1 h-100",tabIndex:0,"aria-label":`${e.title||"Listing"} card`,style:{fontSize:"0.8rem"},children:t.jsxs("div",{className:"row g-1 align-items-start",children:[t.jsx("div",{className:"col-4 d-flex align-items-center justify-content-center",children:t.jsx("img",{src:e.imageUrl,alt:e.title||"Listing image",className:"img-fluid rounded",style:{maxHeight:"6.8rem",objectFit:"contain"}})}),t.jsxs("div",{className:"col-8 d-flex flex-column",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[t.jsxs("div",{children:[t.jsx("p",{className:"fw-medium mb-1",style:{fontSize:"1.1rem",lineHeight:1.2},children:e.title}),t.jsxs("div",{className:"text-muted small",style:{fontSize:"0.74rem"},children:[e.vendor||"Unknown",e.category?t.jsxs("span",{children:[t.jsx("span",{className:"mx-1",children:"|"}),e.category]}):null]})]}),t.jsxs("div",{className:"d-flex flex-column gap-1 pt-1",children:[t.jsx("button",{type:"button",className:a?"btn btn-sm rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6":"btn btn-sm  rounded-pill text-primary-50 hover-text-primary-200 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",style:{fontSize:"0.74rem",padding:"0.2rem 0.45rem"},onClick:()=>oe(e.id),children:a?"Subscribed":"Subscribe"}),t.jsx("button",{type:"button",className:"btn rounded-pill border text-neutral-500 border-neutral-700 radius-8 px-12 py-6 bg-hover-primary-700 text-hover-white",style:{fontSize:"0.74rem",padding:"0.2rem 0.45rem"},onClick:()=>de(e.id),children:n>0?"Review":"Write review"})]})]}),t.jsxs("div",{className:"d-flex align-items-center small",style:{fontSize:"0.74rem"},children:[t.jsx("svg",{className:"me-1",width:"12",height:"12",fill:"currentColor",viewBox:"0 0 24 24",role:"img","aria-label":"rating star",children:t.jsx("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})}),t.jsx("span",{className:"me-1",children:s.toFixed(1)}),t.jsxs("span",{className:"text-muted",children:["(",n," ",n===1?"rating":"ratings",")"]})]})]})]})})},e.id)}),!E&&G.length===0&&t.jsx("div",{className:"col-12 text-center text-secondary-light",children:"No services found in this category."})]})})}),P&&t.jsx("div",{className:"position-fixed top-0 end-0 p-3",style:{zIndex:1080},children:t.jsx("div",{className:`toast show align-items-center ${re==="danger"?"text-bg-danger":"text-bg-success"} border-0`,children:t.jsxs("div",{className:"d-flex",children:[t.jsx("div",{className:"toast-body",children:P}),t.jsx("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:()=>m("")})]})})}),x.open&&(()=>{var c,w,u;const e=p.find(r=>r.id===x.id);if(!e)return null;const s=Array.isArray(e.reviews)?e.reviews.length:0,n=ue(e.reviews),a=n.slice(0,3),i=(x.page||0)*C,g=n.slice(i,i+C),d=Math.max(0,Math.ceil(s/C)-1);return t.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:r=>r.target===r.currentTarget&&U(),children:t.jsxs("div",{className:"card",style:{maxWidth:520,margin:"10vh auto"},children:[t.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[t.jsxs("h6",{className:"mb-0",children:["Review: ",e.title]}),t.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:U,children:"Close"})]}),t.jsxs("div",{className:"card-body",children:[t.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[t.jsxs("div",{className:"text-secondary small",children:["You are reviewing as: ",t.jsx("strong",{children:((c=j.currentUser)==null?void 0:c.email)||"Guest"})]}),t.jsxs("div",{className:"text-secondary small",children:["Vendor: ",t.jsx("strong",{children:e.vendor||"Unknown"})]})]}),(!e.reviews||e.reviews.length===0)&&t.jsx("div",{className:"alert alert-info py-2",children:Number(e.reviewCount||0)>0?`We have ${Number(e.reviewCount)} review(s) in aggregate, but no individual reviews to display yet.`:"No reviews yet. Be the first to write one!"}),!x.showAll&&a.length>0&&t.jsxs("div",{className:"mb-3",children:[t.jsx("div",{className:"fw-semibold mb-2",children:"Recent reviews"}),t.jsx("div",{className:"list-group list-group-flush",children:a.map((r,h)=>t.jsxs("div",{className:"list-group-item px-0",children:[t.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[t.jsxs("div",{className:"d-flex align-items-center gap-2",children:[O(r.rating),t.jsx("span",{className:"text-secondary small",children:r.author||r.authorEmail||"Anonymous"})]}),t.jsx("span",{className:"text-secondary small",children:r.createdAt?new Date(r.createdAt).toLocaleDateString():""})]}),r.comment&&t.jsx("div",{className:"small mt-1",children:r.comment})]},r.id||h))}),s>3&&t.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary mt-2",onClick:()=>v(r=>({...r,showAll:!0,page:0})),children:["See all reviews (",s,")"]})]}),x.showAll&&t.jsxs("div",{className:"mb-3",children:[t.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[t.jsxs("div",{className:"fw-semibold",children:["All reviews (",s,")"]}),t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>v(r=>({...r,showAll:!1,page:0})),children:"Back"})]}),t.jsx("div",{className:"list-group list-group-flush",children:g.map((r,h)=>t.jsxs("div",{className:"list-group-item px-0",children:[t.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[t.jsxs("div",{className:"d-flex align-items-center gap-2",children:[O(r.rating),t.jsx("span",{className:"text-secondary small",children:r.author||r.authorEmail||"Anonymous"})]}),t.jsx("span",{className:"text-secondary small",children:r.createdAt?new Date(r.createdAt).toLocaleDateString():""})]}),r.comment&&t.jsx("div",{className:"small mt-1",children:r.comment})]},r.id||`${h}-${i}`))}),t.jsxs("div",{className:"d-flex align-items-center justify-content-between mt-2",children:[t.jsxs("span",{className:"text-secondary small",children:["Page ",(x.page||0)+1," of ",d+1]}),t.jsxs("div",{className:"d-flex gap-2",children:[t.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:pe,disabled:(x.page||0)<=0,children:"Prev"}),t.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>ge(s),disabled:(x.page||0)>=d,children:"Next"})]})]})]}),t.jsx("div",{className:"mb-3",children:[1,2,3,4,5].map(r=>{var h;return t.jsx("button",{type:"button",onClick:()=>me(e.id,r),className:"btn btn-link p-0 me-1","aria-label":`Rate ${r} stars`,children:t.jsx("span",{style:{fontSize:24,color:(((h=b[e.id])==null?void 0:h.rating)||0)>=r?"#f5a623":"#ccc"},children:"★"})},r)})}),t.jsx("div",{className:"mb-3",children:t.jsx("textarea",{className:"form-control",rows:3,placeholder:"Write a quick comment (optional)",value:((w=b[e.id])==null?void 0:w.comment)||"",onChange:r=>H(e.id,"comment",r.target.value)})}),t.jsx("button",{className:"btn btn-primary",disabled:B||Number(((u=b[e.id])==null?void 0:u.rating)||0)<1,onClick:()=>he(e.id),children:B?"Submitting…":"Submit review"})]})]})})})()]})};export{Ce as T};
