import{d as ue,r as c,b as be,j as e,L as H,a as pe,c as A}from"./index-DGewQ82u.js";import{u as ge,M as xe}from"./MasterLayout-XUilH42m.js";import{B as he}from"./Breadcrumb-BQGAfmV6.js";import{I as g}from"./iconify-Ccvq_BdY.js";import{u as ve}from"./useAppSync-DNmMczzp.js";const fe=()=>{var W;const{threads:x,unreadCount:Y,markRead:G,refresh:T,loading:$,syncMessagesToLive:z}=ge(),{vendor:n}=ue(),[N,J]=c.useState(""),[f,R]=c.useState("inbox"),V=(typeof window<"u"?sessionStorage.getItem("role"):null)||"",[m,K]=c.useState(()=>{const s=(typeof window<"u"?sessionStorage.getItem("messageViewAs"):null)||"";return s||(V==="admin"?n!=null&&n.vendorId?"vendor":"admin":n!=null&&n.vendorId?"vendor":"user")}),[t,u]=c.useState({open:!1,mode:n!=null&&n.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1,subscriberEmail:""}),[q,S]=c.useState([]),[Q,w]=c.useState([]),[l,h]=c.useState({q:"",page:1,pageSize:10,total:0,items:[],loading:!1}),X=(typeof window<"u"?sessionStorage.getItem("tenantId"):null)||"vendor",{appData:Z}=ve(),b=(((W=be.currentUser)==null?void 0:W.email)||sessionStorage.getItem("userEmail")||"").toLowerCase(),ee=V,I=(n==null?void 0:n.vendorId)||(n==null?void 0:n.id)||"",j=c.useMemo(()=>{const s=[];return m==="user"?b&&s.push(`user:${b}`):m==="vendor"?(I&&s.push(`vendor:${String(I).toLowerCase()}`),b&&s.push(`vendor:${b}`)):m==="admin"&&(s.push("admin"),b&&s.push(`admin:${b}`)),s},[m,b,I]),D=c.useMemo(()=>x.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(a=>j.includes(String(a.senderId||"").toLowerCase()))),[x,j]),se=c.useMemo(()=>x.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(a=>!j.includes(String(a.senderId||"").toLowerCase()))),[x,j]),te=D.length,ae=se.length,C=f==="sent"?D:x,F=c.useMemo(()=>{const s=N.trim().toLowerCase();return s?C.filter(a=>{var i;const o=(a.subject||"").toLowerCase(),d=(((i=a.lastMessage)==null?void 0:i.snippet)||"").toLowerCase();return o.includes(s)||d.includes(s)}):C},[C,N]),ne=Y===0,ie=async()=>{await Promise.all(x.filter(s=>!s.read).map(s=>G(s.id,!0)))},[P,B]=c.useState(!1),[le,_]=c.useState(!1),[U,k]=c.useState(""),[O,re]=c.useState(()=>{try{return localStorage.getItem("sl_messages_last_sync")||""}catch{return""}});async function ce(){B(!0),k(""),_(!1);try{if(!await z())throw new Error("Sync did not complete");const a=new Date().toISOString();try{localStorage.setItem("sl_messages_last_sync",a)}catch{}re(a),_(!0),setTimeout(()=>_(!1),1500)}catch(s){k((s==null?void 0:s.message)||"Sync failed"),setTimeout(()=>k(""),2500)}finally{B(!1)}}c.useEffect(()=>{try{sessionStorage.setItem("messageViewAs",m)}catch{}u(s=>({...s,mode:m==="vendor"?"vendor_admin":"vendor_subscriber",serviceId:"",subscriberEmail:""}))},[m]);function oe(){u(s=>({...s,open:!0}))}function y(){u({open:!1,mode:n!=null&&n.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1})}async function de(){try{const s=Z||pe,a=Array.isArray(s==null?void 0:s.services)?s.services:[];if(n!=null&&n.vendorId){const o=a.filter(d=>String(d.vendorId||"")===String(n.vendorId));S(o.map(d=>({id:d.id,title:d.title})))}else S([]);try{const d=(await A.get("/api/subscriptions/my").then(i=>Array.isArray(i.data)?i.data:[])).map(i=>{var r;return{...i,title:((r=a.find(p=>String(p.id)===String(i.serviceId)))==null?void 0:r.title)||i.serviceId}});w(d)}catch{w([])}}catch{S([]),w([])}}async function M(s,a=l.q,o=l.page,d=l.pageSize){try{h(L=>({...L,loading:!0}));const{data:i}=await A.get(`/api/subscriptions/service/${encodeURIComponent(s)}`,{params:{q:a,page:o,pageSize:d}}),r=Number((i==null?void 0:i.page)||o),p=Number((i==null?void 0:i.pageSize)||d),v=Number((i==null?void 0:i.total)||0),E=Array.isArray(i==null?void 0:i.items)?i.items:[];h({q:a,page:r,pageSize:p,total:v,items:E,loading:!1})}catch{h(i=>({...i,loading:!1,items:[],total:0}))}}c.useEffect(()=>{t.open&&de()},[t.open,n==null?void 0:n.vendorId,X]),c.useEffect(()=>{t.open&&t.mode==="vendor_to_subscriber"&&t.serviceId?M(t.serviceId,l.q,1,l.pageSize):h({q:"",page:1,pageSize:10,total:0,items:[],loading:!1})},[t.open,t.mode,t.serviceId]);async function me(s){var a,o,d,i;if((a=s==null?void 0:s.preventDefault)==null||a.call(s),!(!t.serviceId||!t.content.trim())){u(r=>({...r,sending:!0,err:null,ok:!1}));try{const p={type:t.mode==="vendor_admin"?"vendor_admin":t.mode==="vendor_to_subscriber"?"vendor_to_subscriber":"vendor_subscriber",serviceId:t.serviceId,listingId:t.serviceId,subject:t.subject,content:t.content,subscriberEmail:t.mode==="vendor_to_subscriber"?t.subscriberEmail:void 0};await A.post("/api/messages/compose",p),u(v=>({...v,sending:!1,ok:!0})),await T();try{await z()}catch{}setTimeout(()=>y(),1200)}catch(r){const p=(o=r==null?void 0:r.response)==null?void 0:o.status,v=((i=(d=r==null?void 0:r.response)==null?void 0:d.data)==null?void 0:i.message)||(r==null?void 0:r.message)||"Failed to send",E=p===401?" Please sign in to send messages.":"";u(L=>({...L,sending:!1,err:v+E}))}}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-xxl-3",children:e.jsx("div",{className:"card h-100 p-0",children:e.jsx("div",{className:"card-body p-24",children:e.jsxs("div",{className:"mt-16",children:[e.jsxs("button",{type:"button",className:"btn btn-primary btn-sm w-100 mb-3 d-flex align-items-center gap-2",onClick:oe,disabled:m==="admin",children:[e.jsx(g,{icon:"fa6-regular:square-plus",className:"icon text-lg line-height-1"}),"Compose"]}),e.jsxs("ul",{children:[e.jsx("li",{className:"item-active mb-4",children:e.jsx("button",{type:"button",onClick:()=>R("inbox"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${f==="inbox"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(g,{icon:"uil:envelope",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Message Center"})]}),e.jsx("span",{className:"fw-medium",children:ae})]})})}),e.jsx("li",{className:"mb-4",children:e.jsx("button",{type:"button",onClick:()=>R("sent"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${f==="sent"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(g,{icon:"ion:paper-plane-outline",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Sent"})]}),e.jsx("span",{className:"fw-medium",children:te})]})})})]})]})})})}),e.jsx("div",{className:"col-xxl-9",children:e.jsxs("div",{className:"card h-100 p-0 email-card",children:[e.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:T,disabled:$,children:[e.jsx(g,{icon:"tabler:reload",className:"me-1"})," ",$?"Refreshing…":"Refresh"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ie,disabled:ne,children:[e.jsx(g,{icon:"gravity-ui:envelope-open",className:"me-1"})," Mark all as read"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ce,disabled:P,title:"Write messages to server appData.json",children:[e.jsx(g,{icon:"mdi:cloud-upload-outline",className:"me-1"})," ",P?"Syncing…":"Sync Now"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("label",{className:"form-label mb-0 small text-muted",children:"View as"}),e.jsxs("select",{className:"form-select form-select-sm",value:m,onChange:s=>K(s.target.value),children:[e.jsx("option",{value:"user",children:"Startup"}),(n==null?void 0:n.vendorId)&&e.jsx("option",{value:"vendor",children:"Vendor"}),ee==="admin"&&e.jsx("option",{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("form",{className:"navbar-search d-flex",onSubmit:s=>s.preventDefault(),children:[e.jsx("input",{type:"text",className:"bg-base h-40-px w-auto",name:"search",placeholder:"Search",value:N,onChange:s=>J(s.target.value)}),e.jsx(g,{icon:"ion:search-outline",className:"icon"})]}),e.jsx("div",{className:"small text-muted",children:U?e.jsx("span",{className:"text-danger",children:U}):le?e.jsx("span",{className:"text-success",children:"Synced"}):O?`Last sync: ${new Date(O).toLocaleString()}`:""})]})]})}),e.jsx("div",{className:"card-body p-0",children:e.jsxs("ul",{className:"overflow-x-auto",children:[F.map(s=>{var a,o,d,i,r;return e.jsxs("li",{className:`email-item px-24 py-16 d-flex gap-4 align-items-center border-bottom cursor-pointer bg-hover-neutral-200 min-w-max-content ${s.read?"":"bg-primary-50"}`,children:[e.jsx(H,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium text-md text-line-1 w-190-px",children:s.subject||"Message"}),e.jsx(H,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium mb-0 text-line-1 max-w-740-px",children:((a=s.lastMessage)==null?void 0:a.snippet)||((i=(d=s.messages)==null?void 0:d[((o=s.messages)==null?void 0:o.length)-1])==null?void 0:i.content)||""}),e.jsx("span",{className:"text-primary-light fw-medium min-w-max-content ms-auto",children:(r=s.lastMessage)!=null&&r.date?new Date(s.lastMessage.date).toLocaleString():""})]},s.id)}),F.length===0&&e.jsx("li",{className:"px-24 py-16 text-muted",children:f==="sent"?"No sent messages for this role; try switching “View as”.":"No messages yet. Try switching “View as” or start a conversation."})]})})]})})]}),t.open&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&y(),children:e.jsxs("div",{className:"card",style:{maxWidth:640,margin:"8vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Compose message"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:y,children:"Close"})]}),e.jsxs("form",{onSubmit:me,children:[e.jsxs("div",{className:"card-body",children:[t.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:t.err}),t.ok&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-select",value:t.mode,onChange:s=>u(a=>({...a,mode:s.target.value,serviceId:"",subscriberEmail:""})),children:[m==="vendor"&&(n==null?void 0:n.vendorId)&&e.jsx("option",{value:"vendor_admin",children:"Ask Admin about my listing"}),m==="user"&&e.jsx("option",{value:"vendor_subscriber",children:"Message Vendor about a subscribed listing"}),m==="vendor"&&(n==null?void 0:n.vendorId)&&e.jsx("option",{value:"vendor_to_subscriber",children:"Message a subscriber of my listing"})]})]}),t.mode==="vendor_admin"&&m==="vendor"&&(n==null?void 0:n.vendorId)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my listings"}),e.jsxs("select",{className:"form-select",value:t.serviceId,onChange:s=>u(a=>({...a,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),q.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),t.mode==="vendor_subscriber"&&m==="user"&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my subscriptions"}),e.jsxs("select",{className:"form-select",value:t.serviceId,onChange:s=>u(a=>({...a,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),Q.map(s=>e.jsx("option",{value:s.serviceId,children:s.title},s.id))]})]}),t.mode==="vendor_to_subscriber"&&m==="vendor"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select my listing"}),e.jsxs("select",{className:"form-select",value:t.serviceId,onChange:s=>u(a=>({...a,serviceId:s.target.value,subscriberEmail:""})),children:[e.jsx("option",{value:"",children:"Select…"}),q.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"To (subscriber email)"}),e.jsx("input",{className:"form-control",value:t.subscriberEmail,onChange:s=>{const a=s.target.value;u(o=>({...o,subscriberEmail:a})),h(o=>({...o,q:a,page:1}))},placeholder:"Type to search subscribers",disabled:!t.serviceId}),t.serviceId&&e.jsxs("div",{className:"border rounded mt-2 p-2 bg-base",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"small text-secondary",children:"Suggestions"}),e.jsx("div",{className:"small text-secondary",children:l.loading?"Loading…":`${l.total} total`})]}),e.jsxs("div",{className:"list-group list-group-flush",style:{maxHeight:160,overflowY:"auto"},children:[l.items.map(s=>e.jsx("button",{type:"button",className:"list-group-item list-group-item-action py-1",onClick:()=>u(a=>({...a,subscriberEmail:s.email})),children:s.email},s.id)),!l.loading&&l.items.length===0&&e.jsx("div",{className:"text-muted small px-2 py-1",children:"No matches"})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:l.page<=1||l.loading,onClick:()=>M(t.serviceId,l.q,Math.max(1,l.page-1),l.pageSize),children:"Prev"}),e.jsxs("span",{className:"small text-secondary",children:["Page ",l.page," of ",Math.max(1,Math.ceil((l.total||0)/(l.pageSize||10)))]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:l.loading||l.page>=Math.ceil((l.total||0)/(l.pageSize||10)),onClick:()=>M(t.serviceId,l.q,l.page+1,l.pageSize),children:"Next"})]})]})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject (optional)"}),e.jsx("input",{className:"form-control",value:t.subject,onChange:s=>u(a=>({...a,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{rows:6,className:"form-control",value:t.content,onChange:s=>u(a=>({...a,content:s.target.value}))})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:y,disabled:t.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t.sending||!t.serviceId||!t.content.trim()||t.mode==="vendor_to_subscriber"&&!t.subscriberEmail,children:t.sending?"Sending…":"Send"})]})]})]})})]})},Ie=()=>e.jsx(e.Fragment,{children:e.jsxs(xe,{children:[e.jsx(he,{title:"Message Center"}),e.jsx(fe,{})]})});export{Ie as default};
