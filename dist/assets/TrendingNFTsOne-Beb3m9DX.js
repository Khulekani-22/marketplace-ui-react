import{r as b,c as Ve,u as He,d as _e,a as C,j as e,L as Oe,b as Qe}from"./index-HPcd39yI.js";import{u as Ge}from"./useWallet-CWfrR7mr.js";import{f as Ze,u as ee,s as we}from"./subscriptions-pzAMMObV.js";const Y=d=>({...d,vendor:d.vendor??d.vendorName??"",imageUrl:d.imageUrl??d.thumbnail??"",category:d.category??d.categoryId??"",rating:typeof d.rating=="number"?d.rating:Number(d.rating||0),reviews:Array.isArray(d.reviews)?d.reviews:[],status:(d.status??"approved").toString().toLowerCase()}),te=d=>d.status==="approved",Je=8,Ke=17;function Se(d){const v=(d+11)%12+1,M=d>=12?"PM":"AM";return`${v}:00 ${M}`}function Xe(d=Je,v=Ke){const M=[];for(let S=d;S<v;S+=1){const E=S+1,q=`${String(S).padStart(2,"0")}:00`;M.push({value:q,label:`${Se(S)} – ${Se(E)}`})}return M}function et(d={}){const v=(d.listingType||d.type||"").toString().toLowerCase();return v==="service"||v==="services"}function ke(d){if(!d)return"";try{const v=new Date(`${d}T00:00:00`);return Number.isNaN(v.getTime())?d:v.toLocaleDateString()}catch{return d}}const tt=new Intl.NumberFormat("en-ZA");function T(d){const v=Number(d)||0;return tt.format(Math.round(v))}const rt=({query:d,onQueryChange:v,category:M,onCategoryChange:S,onCategoriesChange:E})=>{const q=b.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),B=b.useMemo(()=>(Ve.services||[]).map(Y).filter(te),[]),[x,V]=b.useState(B),D=b.useRef(B),Ae=b.useRef(0),[H,Ce]=b.useState(!0),[Te,Me]=b.useState("All"),U=M??Te,$e=S??Me,[Le,Re]=b.useState(""),F=d??Le,se=v??Re,[$,ae]=b.useState({}),[j,L]=b.useState({open:!1,id:null,showAll:!1,page:0}),[_,ne]=b.useState({open:!1,id:null}),[re,u]=b.useState(""),[Ee,f]=b.useState("success"),[ie,le]=b.useState(!1),[oe,z]=b.useState(()=>new Set),[ce,O]=b.useState({}),[w,N]=b.useState({open:!1,id:null,date:"",slot:"",error:""}),[Q,de]=b.useState(!1),me=He(),{appData:k}=_e(),{wallet:y,eligible:R,redeemCredits:ue,loading:I,refresh:G}=Ge(),Z=b.useMemo(()=>Xe(),[]),be=b.useMemo(()=>{const t={};return Z.forEach(a=>{t[a.value]=a.label}),t},[Z]);function De(t={},a={}){const r=Number(t.reviewCount||(Array.isArray(t.reviews)?t.reviews.length:0)||0),l=Number(a.reviewCount||(Array.isArray(a.reviews)?a.reviews.length:0)||0),n=Date.parse(t.lastReviewedAt||"")||0,c=Date.parse(a.lastReviewedAt||"")||0;return l>r?a:l<r?t:c>n?a:t}function he(t,a,r){const l=new Map;return a.forEach(n=>l.set(String(n.id),n)),r.forEach(n=>l.set(String(n.id),n)),t.forEach(n=>{const c=String(n.id),m=l.get(c)||{},o=De(m,n);l.set(c,{...m,reviews:Array.isArray(o.reviews)?o.reviews:m.reviews,reviewCount:Number(o.reviewCount||(Array.isArray(o.reviews)?o.reviews.length:m.reviewCount||0)||0),rating:typeof o.rating=="number"?o.rating:Number(o.rating||m.rating||0),lastReviewedAt:o.lastReviewedAt||m.lastReviewedAt})}),Array.from(l.values())}async function Ie(){const t=((k==null?void 0:k.services)||[]).map(Y).filter(te),a=he(D.current??x,B,t);V(a)}b.useEffect(()=>{const t=((k==null?void 0:k.services)||[]).map(Y).filter(te),a=he(D.current??x,B,t);V(a),Ce(!1)},[q,k]),b.useEffect(()=>{let t=!1;return(async()=>{try{if(!C.currentUser)return;const a=await Ze();if(t)return;const r={},l=new Set(a.filter(n=>(n.type||"service")==="service").map(n=>{const c=String(n.serviceId);return(n.scheduledDate||n.scheduledSlot)&&(r[c]={date:n.scheduledDate||"",slot:n.scheduledSlot||""}),c}));z(l),O(r)}catch{}})(),()=>{t=!0}},[]);async function ge(t,a={}){var l,n,c,m;const{bookable:r=!1}=a;try{if(!C.currentUser){me("/login",{replace:!0,state:{from:((l=window.location)==null?void 0:l.pathname)||"/"}});return}const o=String(t);if(oe.has(o)){await ee(o),z(p=>{const A=new Set(Array.from(p));return A.delete(o),A}),O(p=>{const A={...p};return delete A[o],A}),f("success"),u(r?"Booking cancelled":"Unsubscribed"),setTimeout(()=>u(""),2e3);return}const s=(D.current||x||[]).find(p=>String(p.id)===o)||null,h=Number((s==null?void 0:s.price)||0)||0;if(!r&&h>0){if(I){f("danger"),u("Checking wallet, please try again in a moment."),setTimeout(()=>u(""),2500);return}if(!R){f("danger"),u("My Wallet is only available to startup and vendor accounts."),setTimeout(()=>u(""),2500);return}if(!y){f("danger"),u("We could not load your wallet. Please try again."),setTimeout(()=>u(""),2500);return}if(y.balance<h){const p=h-y.balance;f("danger"),u(`You need ${T(p)} more credits to subscribe to this listing.`),setTimeout(()=>u(""),3e3);return}}if(await we(o,s?{price:s.price}:{}),!r&&h>0){const p=await ue(h,{description:`Listing subscription: ${(s==null?void 0:s.title)||"Marketplace service"}`,reference:`listing-${(s==null?void 0:s.id)||"unknown"}`,metadata:{serviceId:(s==null?void 0:s.id)||null,vendor:(s==null?void 0:s.vendor)||null,category:(s==null?void 0:s.category)||null,source:"dashboard-trending"}});if(!p.ok){await ee(o),f("danger"),u(p.error||"Unable to redeem wallet credits; subscription canceled."),setTimeout(()=>u(""),3e3);return}setTimeout(()=>G().catch(()=>{}),100),f("success"),u(`Voucher applied! Remaining balance: ${T(((n=p.wallet)==null?void 0:n.balance)||0)} credits.`)}else f("success"),u(r?"Booking confirmed":"Subscribed");z(p=>new Set([...Array.from(p),o])),setTimeout(()=>u(""),2500)}catch(o){const g=((m=(c=o==null?void 0:o.response)==null?void 0:c.data)==null?void 0:m.message)||(o==null?void 0:o.message)||"Failed to update subscription";f("danger"),u(g),setTimeout(()=>u(""),2500)}}const J=b.useMemo(()=>["All",...Array.from(new Set(x.map(a=>(a.category||"").trim()).filter(Boolean)))],[x]);b.useEffect(()=>{try{typeof E=="function"&&E(J)}catch{}},[J,E]);const xe=b.useMemo(()=>{const t=U.toLowerCase(),a=(F||"").trim().toLowerCase();let r=U==="All"?x:x.filter(l=>(l.category||"").trim().toLowerCase()===t);return a?r.filter(l=>[l.title||"",l.vendor||"",l.category||"",l.description||l.summary||"",Array.isArray(l.tags)?l.tags.join(" "):""].join(` 
 `).toLowerCase().includes(a)):r},[x,U,F]);b.useEffect(()=>{D.current=x},[x]);function pe(t,a,r){ae(l=>({...l,[t]:{...l[t]||{},[a]:r}}))}function Be(t){L({open:!0,id:t,showAll:!1,page:0}),$[t]||ae(a=>({...a,[t]:{rating:0,comment:""}}))}function K(){L({open:!1,id:null,showAll:!1,page:0})}function fe(t){ne({open:!0,id:t})}function ye(){ne({open:!1,id:null})}function Ue(t){var l;if(!C.currentUser){me("/login",{replace:!0,state:{from:((l=window.location)==null?void 0:l.pathname)||"/"}});return}const a=t==null?void 0:t.id,r=ce[String(a)]||{};N({open:!0,id:a,date:r.date||"",slot:r.slot||"",error:""})}function P(){N({open:!1,id:null,date:"",slot:"",error:""})}function ve(t,a){N(r=>({...r,[t]:a,error:t==="date"||t==="slot"?"":r.error}))}async function Fe(){var m,o,g;const{id:t,date:a,slot:r}=w;if(!t)return;if(!a){N(i=>({...i,error:"Please choose a date."}));return}if(!r){N(i=>({...i,error:"Please choose a time slot."}));return}const n=(D.current||x||[]).find(i=>String(i.id)===String(t))||null,c=Number((n==null?void 0:n.price)||0)||0;if(c>0){if(I){N(i=>({...i,error:"Checking wallet, please try again in a moment."}));return}if(!R){N(i=>({...i,error:"My Wallet is only available to startup and vendor accounts."}));return}if(!y){N(i=>({...i,error:"We could not load your wallet. Please try again."}));return}if(y.balance<c){const i=c-y.balance;N(s=>({...s,error:`You need ${T(i)} more credits to book this session.`}));return}}de(!0);try{const i={scheduledDate:a,scheduledSlot:r};if(await we(String(t),i),c>0){const s=await ue(c,{description:`Listing booking: ${(n==null?void 0:n.title)||"Marketplace service"}`,reference:`listing-${(n==null?void 0:n.id)||"unknown"}`,metadata:{serviceId:(n==null?void 0:n.id)||null,vendor:(n==null?void 0:n.vendor)||null,category:(n==null?void 0:n.category)||null,scheduledDate:a,scheduledSlot:r,source:"dashboard-trending-booking"}});if(!s.ok){await ee(String(t)),N(h=>({...h,error:s.error||"Unable to redeem wallet credits; booking canceled."}));return}setTimeout(()=>G().catch(()=>{}),100),f("success"),u(`Voucher applied! Remaining balance: ${T(((m=s.wallet)==null?void 0:m.balance)||0)} credits.`)}else f("success"),u(`Session booked for ${ke(a)} at ${be[r]||r}.`);z(s=>new Set([...Array.from(s),String(t)])),O(s=>({...s,[String(t)]:{date:a,slot:r}})),setTimeout(()=>u(""),2500),P()}catch(i){const s=((g=(o=i==null?void 0:i.response)==null?void 0:o.data)==null?void 0:g.message)||(i==null?void 0:i.message)||"Failed to book session";N(h=>({...h,error:s}))}finally{de(!1)}}function ze(t,a){pe(t,"rating",a)}function Ne(t){const a=Number(t||0);return e.jsx("span",{children:[1,2,3,4,5].map(r=>e.jsx("span",{style:{color:a>=r?"#f5a623":"#ccc",fontSize:16},children:"★"},r))})}function Pe(t){const a=Array.isArray(t)?t.slice():[];return a.sort((r,l)=>(Date.parse((l==null?void 0:l.createdAt)||"")||0)-(Date.parse((r==null?void 0:r.createdAt)||"")||0)),a}const W=5;function We(t){const a=Math.max(0,Math.ceil(t/W)-1);L(r=>({...r,page:Math.min(a,(r.page||0)+1)}))}function Ye(){L(t=>({...t,page:Math.max(0,(t.page||0)-1)}))}async function qe(t){var l,n,c,m,o,g;const a=Number(((l=$[t])==null?void 0:l.rating)||0),r=(((n=$[t])==null?void 0:n.comment)||"").trim();if(Number.isNaN(a)||a<1||a>5){f("danger"),u("Please select a star rating (1–5)."),setTimeout(()=>u(""),2500);return}le(!0);try{const i=((c=C.currentUser)==null?void 0:c.email)||"",s=((m=C.currentUser)==null?void 0:m.displayName)||(i?i.split("@")[0]:"Guest"),h=x.find(X=>X.id===t)||{},{data:p}=await Qe.post(`/api/data/services/${encodeURIComponent(t)}/reviews`,{rating:a,comment:r,author:s,authorEmail:i,title:h.title||"",vendor:h.vendor||"",contactEmail:h.contactEmail||h.email||""}),A=Y(p);Ae.current+=1,V(X=>X.map(je=>je.id===t?A:je)),f("success"),u("Review submitted. Thank you!"),setTimeout(()=>u(""),2500),K(),setTimeout(()=>{Ie().catch(()=>{})},800)}catch(i){const s=((g=(o=i==null?void 0:i.response)==null?void 0:o.data)==null?void 0:g.message)||(i==null?void 0:i.message)||"Failed to submit review";f("danger"),u(s),setTimeout(()=>u(""),2500)}finally{le(!1)}}return e.jsxs("div",{className:"col-12",children:[e.jsxs("div",{className:"mb-16 mt-8 d-flex flex-wrap justify-content-between align-items-center gap-12",children:[e.jsx("h6",{className:"mb-0",children:"All Listings"}),e.jsxs("div",{className:"d-flex flex-wrap align-items-center gap-12",children:[e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"text",className:"form-control form-control-sm rounded-3 border-1 border-neutral-300 bg-neutral-100 text-sm ps-12 pe-32 py-8",placeholder:"Search listings by name, vendor, category…",value:F,onChange:t=>se(t.target.value),style:{minWidth:260},"aria-label":"Search listings"}),F&&e.jsx("button",{type:"button",className:"btn btn-sm btn-link position-absolute end-0 top-50 translate-middle-y me-2",onClick:()=>se(""),"aria-label":"Clear search",children:"✕"})]}),e.jsx("ul",{className:"nav button-tab nav-pills mb-0 gap-12 text-neutral-500",role:"tablist",children:J.map(t=>e.jsx("li",{className:"nav-item text-neutral-500",role:"presentation",children:e.jsx("button",{className:`nav-link btn btn-sm rounded-pill text-neutral-500 hover-text-white bg-hover-primary-800 px-20 py-6 border border-neutral-300 ${U===t?"active bg-primary-400 text-white border-primary-400":"bg-neutral-50"}`,onClick:()=>$e(t),children:t})},t))})]})]}),I&&e.jsx("div",{className:"alert alert-secondary mb-3",role:"status",children:"Loading wallet balance…"}),R&&y&&!I&&e.jsxs("div",{className:"alert alert-primary d-flex flex-wrap align-items-center justify-content-between mb-3",role:"status",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("strong",{children:"Wallet balance:"}),e.jsxs("span",{className:"fs-6",children:["R ",T(y.balance)," credits available"]}),e.jsx("small",{className:"text-secondary",children:"Marketplace subscriptions automatically draw from your credits."})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2 mt-md-0",children:[e.jsx(Oe,{to:"/wallet",className:"btn btn-sm btn-outline-secondary",children:"View wallet"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-primary",onClick:()=>G().catch(()=>{}),disabled:I,children:"Refresh balance"})]})]}),!R&&C.currentUser&&e.jsx("div",{className:"alert alert-warning mb-3",role:"alert",children:"My Wallet credits are reserved for startup and vendor profiles. Contact your programme manager if you need access."}),e.jsx("div",{className:"tab-content",children:e.jsx("div",{className:"tab-pane fade show active",children:e.jsxs("div",{className:"row g-3",children:[H&&e.jsx("div",{className:"col-12 text-center text-secondary-light",children:"Loading listings…"}),!H&&xe.map(t=>{const a=Number(t.rating||0),r=Number(t.reviewCount||(Array.isArray(t.reviews)?t.reviews.length:0)||0),l=String(t.id),n=oe.has(l),c=et(t),m=ce[l],o=Number(t.price||0)||0,g=(y==null?void 0:y.balance)??0,i=R&&y,s=i?Math.max(0,o-g):0,h=!c&&!n&&o>0&&(!R||!y||y.balance<o);return e.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:e.jsx("article",{className:"card p-1 h-100",tabIndex:0,"aria-label":`${t.title||"Listing"} card`,style:{fontSize:"0.8rem"},children:e.jsxs("div",{className:"row g-1 align-items-start",children:[e.jsx("div",{className:"col-4 d-flex align-items-center justify-content-center",children:e.jsx("button",{type:"button",className:"btn p-0 border-0 bg-transparent",onClick:()=>fe(t.id),"aria-label":`View details for ${t.title||"listing"}`,children:e.jsx("img",{src:t.imageUrl,alt:t.title||"Listing image",className:"img-fluid rounded",style:{maxHeight:"6.8rem",objectFit:"contain"}})})}),e.jsxs("div",{className:"col-8 d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{children:[e.jsx("button",{type:"button",className:"btn btn-link text-neutral-800  hover-text-primary-200 p-0 fw-medium text-start",style:{fontSize:"1.1rem",lineHeight:1.2,textDecoration:"none"},onClick:()=>fe(t.id),"aria-label":`Open details for ${t.title||"listing"}`,children:t.title}),e.jsxs("div",{className:"text-muted small ",style:{fontSize:"0.74rem"},children:[t.vendor||"Unknown",t.category?e.jsxs("span",{children:[e.jsx("span",{className:"mx-1",children:"|"}),t.category]}):null]}),o>0&&e.jsxs("div",{className:"d-flex align-items-center justify-content-between text-xs mt-1",style:{fontSize:"0.72rem"},children:[e.jsxs("span",{className:"fw-semibold text-neutral-800",children:["R ",T(o)]}),i?e.jsx("span",{className:s>0?"text-danger":"text-success",children:s>0?`Short by ${T(s)} credits`:"Covered by wallet"}):e.jsx("span",{className:"text-secondary",children:"Wallet required"})]}),c&&m&&e.jsxs("div",{className:"text-success small mt-1",style:{fontSize:"0.7rem"},children:["Next session: ",ke(m.date),m.slot?e.jsxs("span",{className:"ms-1",children:["· ",be[m.slot]||m.slot]}):null]})]}),e.jsxs("div",{className:"d-flex flex-column gap-1 pt-1",children:[e.jsx("button",{type:"button",className:n?"btn btn-sm rounded-pill text-primary-50 hover-text-primary-400 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6":"btn btn-sm  rounded-pill text-primary-50 hover-text-primary-400 bg-primary-500 bg-hover-primary-800 radius-8 px-12 py-6",style:{fontSize:"0.74rem",padding:"0.2rem 0.45rem"},onClick:()=>{c?Ue(t):ge(t.id)},disabled:h,children:c?n?"Reschedule":"Book session":n?"Subscribed":"Subscribe"}),c&&n&&e.jsx("button",{type:"button",className:"btn btn-sm rounded-pill border text-neutral-500 border-neutral-700 radius-8 px-12 py-6 bg-hover-primary-700 text-hover-white",style:{fontSize:"0.74rem",padding:"0.2rem 0.45rem"},onClick:()=>ge(t.id,{bookable:!0}),children:"Cancel booking"}),e.jsx("button",{type:"button",className:"btn rounded-pill border text-neutral-500 border-neutral-700 radius-8 px-12 py-6 bg-hover-primary-700 text-hover-white",style:{fontSize:"0.74rem",padding:"0.2rem 0.45rem"},onClick:()=>Be(t.id),children:r>0?"Review":"Write review"})]})]}),e.jsxs("div",{className:"d-flex align-items-center small",style:{fontSize:"0.74rem"},children:[e.jsx("svg",{className:"me-1",width:"12",height:"12",fill:"currentColor",viewBox:"0 0 24 24",role:"img","aria-label":"rating star",children:e.jsx("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})}),e.jsx("span",{className:"me-1",children:a.toFixed(1)}),e.jsxs("span",{className:"text-muted",children:["(",r," ",r===1?"rating":"ratings",")"]})]})]})]})})},t.id)}),!H&&xe.length===0&&e.jsx("div",{className:"col-12 text-center text-secondary-light",children:"No services found in this category."})]})})}),re&&e.jsx("div",{className:"position-fixed top-0 end-0 p-3",style:{zIndex:1080},children:e.jsx("div",{className:`toast show align-items-center ${Ee==="danger"?"text-bg-danger":"text-bg-success"} border-0`,children:e.jsxs("div",{className:"d-flex",children:[e.jsx("div",{className:"toast-body",children:re}),e.jsx("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:()=>u("")})]})})}),w.open&&(()=>{const t=x.find(i=>i.id===w.id);if(!t)return null;const a=new Date,r=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),c=`${r}-${l}-${n}`,m=String(w.id??""),o=`booking-date-${m}`,g=`booking-slot-${m}`;return e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1076},onClick:i=>{i.target===i.currentTarget&&P()},children:e.jsxs("div",{className:"card shadow-lg",style:{maxWidth:560,margin:"10vh auto",maxHeight:"80vh",overflowY:"auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsxs("h6",{className:"mb-0",children:["Book session: ",t.title]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:P,children:"Close"})]}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"text-secondary small mb-3",children:"One-hour slots available between 8:00 AM and 5:00 PM."}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label small fw-semibold",htmlFor:o,children:"Choose a date"}),e.jsx("input",{id:o,type:"date",className:"form-control",value:w.date,min:c,onChange:i=>ve("date",i.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label small fw-semibold",htmlFor:g,children:"Choose a time slot"}),e.jsxs("select",{id:g,className:"form-select",value:w.slot,onChange:i=>ve("slot",i.target.value),children:[e.jsx("option",{value:"",children:"Select a slot"}),Z.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))]})]}),w.error&&e.jsx("div",{className:"alert alert-danger py-2",role:"alert",children:w.error}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:P,disabled:Q,children:"Close"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:Fe,disabled:Q,children:Q?"Booking…":"Confirm booking"})]})]})]})})})(),_.open&&(()=>{const t=x.find(c=>c.id===_.id);if(!t)return null;const a=Array.isArray(t.tags)?t.tags.filter(Boolean):[],r=t.description||t.summary||"",l=typeof t.price=="number"&&!Number.isNaN(Number(t.price)),n=l?Intl.NumberFormat(void 0,{style:"currency",currency:t.currency||"USD",maximumFractionDigits:0}).format(Number(t.price)):"";return e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1075},onClick:c=>{c.target===c.currentTarget&&ye()},children:e.jsxs("div",{className:"card shadow-lg",style:{maxWidth:640,margin:"10vh auto",maxHeight:"80vh",overflowY:"auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Listing details"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ye,children:"Close"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-column flex-md-row gap-3 mb-3",children:[t.imageUrl?e.jsx("div",{className:"flex-shrink-0 text-center",children:e.jsx("img",{src:t.imageUrl,alt:t.title||"Listing image",className:"img-fluid rounded",style:{maxWidth:"12rem",objectFit:"cover"}})}):null,e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mb-1",children:t.title||"Untitled listing"}),e.jsxs("div",{className:"text-muted small mb-2",children:[t.vendor||"Unknown vendor",t.category?e.jsxs("span",{children:[e.jsx("span",{className:"mx-1",children:"|"}),t.category]}):null]}),e.jsxs("div",{className:"d-flex flex-wrap align-items-center gap-2 small",children:[e.jsxs("span",{className:"badge bg-primary-600 text-white",children:["Rating ",Number(t.rating||0).toFixed(1)]}),e.jsxs("span",{className:"text-secondary",children:[Number(t.reviewCount||(Array.isArray(t.reviews)?t.reviews.length:0))," review(s)"]}),l&&e.jsx("span",{className:"badge bg-neutral-200 text-dark",children:n})]})]})]}),r&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"fw-semibold",children:"Overview"}),e.jsx("p",{className:"mb-0 text-break",style:{whiteSpace:"pre-wrap"},children:r})]}),a.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"fw-semibold",children:"Tags"}),e.jsx("div",{className:"d-flex flex-wrap gap-2",children:a.map((c,m)=>e.jsx("span",{className:"badge bg-neutral-200 text-dark",children:c},`${_.id}-${m}`))})]}),(t.contactEmail||t.website||t.contactPhone)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("h6",{className:"fw-semibold",children:"Contact"}),e.jsxs("ul",{className:"mb-0 ps-3 small",children:[t.contactEmail&&e.jsxs("li",{children:["Email: ",e.jsx("a",{href:`mailto:${t.contactEmail}`,children:t.contactEmail})]}),t.contactPhone&&e.jsxs("li",{children:["Phone: ",t.contactPhone]}),t.website&&e.jsxs("li",{children:["Website: ",e.jsx("a",{href:t.website,target:"_blank",rel:"noreferrer",children:t.website})]})]})]})]})]})})})(),j.open&&(()=>{var o,g,i;const t=x.find(s=>s.id===j.id);if(!t)return null;const a=Array.isArray(t.reviews)?t.reviews.length:0,r=Pe(t.reviews),l=r.slice(0,3),n=(j.page||0)*W,c=r.slice(n,n+W),m=Math.max(0,Math.ceil(a/W)-1);return e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&K(),children:e.jsxs("div",{className:"card",style:{maxWidth:520,margin:"10vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsxs("h6",{className:"mb-0",children:["Review: ",t.title]}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:K,children:"Close"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsxs("div",{className:"text-secondary small",children:["You are reviewing as: ",e.jsx("strong",{children:((o=C.currentUser)==null?void 0:o.email)||"Guest"})]}),e.jsxs("div",{className:"text-secondary small",children:["Vendor: ",e.jsx("strong",{children:t.vendor||"Unknown"})]})]}),(!t.reviews||t.reviews.length===0)&&e.jsx("div",{className:"alert alert-info py-2",children:Number(t.reviewCount||0)>0?`We have ${Number(t.reviewCount)} review(s) in aggregate, but no individual reviews to display yet.`:"No reviews yet. Be the first to write one!"}),!j.showAll&&l.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"fw-semibold mb-2",children:"Recent reviews"}),e.jsx("div",{className:"list-group list-group-flush",children:l.map((s,h)=>e.jsxs("div",{className:"list-group-item px-0",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[Ne(s.rating),e.jsx("span",{className:"text-secondary small",children:s.author||s.authorEmail||"Anonymous"})]}),e.jsx("span",{className:"text-secondary small",children:s.createdAt?new Date(s.createdAt).toLocaleDateString():""})]}),s.comment&&e.jsx("div",{className:"small mt-1",children:s.comment})]},s.id||h))}),a>3&&e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary mt-2",onClick:()=>L(s=>({...s,showAll:!0,page:0})),children:["See all reviews (",a,")"]})]}),j.showAll&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsxs("div",{className:"fw-semibold",children:["All reviews (",a,")"]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>L(s=>({...s,showAll:!1,page:0})),children:"Back"})]}),e.jsx("div",{className:"list-group list-group-flush",children:c.map((s,h)=>e.jsxs("div",{className:"list-group-item px-0",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[Ne(s.rating),e.jsx("span",{className:"text-secondary small",children:s.author||s.authorEmail||"Anonymous"})]}),e.jsx("span",{className:"text-secondary small",children:s.createdAt?new Date(s.createdAt).toLocaleDateString():""})]}),s.comment&&e.jsx("div",{className:"small mt-1",children:s.comment})]},s.id||`${h}-${n}`))}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between mt-2",children:[e.jsxs("span",{className:"text-secondary small",children:["Page ",(j.page||0)+1," of ",m+1]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:Ye,disabled:(j.page||0)<=0,children:"Prev"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>We(a),disabled:(j.page||0)>=m,children:"Next"})]})]})]}),e.jsx("div",{className:"mb-3",children:[1,2,3,4,5].map(s=>{var h;return e.jsx("button",{type:"button",onClick:()=>ze(t.id,s),className:"btn btn-link p-0 me-1","aria-label":`Rate ${s} stars`,children:e.jsx("span",{style:{fontSize:24,color:(((h=$[t.id])==null?void 0:h.rating)||0)>=s?"#f5a623":"#ccc"},children:"★"})},s)})}),e.jsx("div",{className:"mb-3",children:e.jsx("textarea",{className:"form-control",rows:3,placeholder:"Write a quick comment (optional)",value:((g=$[t.id])==null?void 0:g.comment)||"",onChange:s=>pe(t.id,"comment",s.target.value)})}),e.jsx("button",{className:"btn btn-primary",disabled:ie||Number(((i=$[t.id])==null?void 0:i.rating)||0)<1,onClick:()=>qe(t.id),children:ie?"Submitting…":"Submit review"})]})]})})})()]})};export{rt as T};
