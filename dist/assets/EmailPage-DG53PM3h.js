import{d as xe,r as d,b as he,j as e,L as Q,a as fe,c as V}from"./index-CmOqa4Kr.js";import{u as ve,M as je}from"./MasterLayout-w0NEjqQ2.js";import{B as ye}from"./Breadcrumb-DGCwdBIn.js";import{I as f}from"./iconify-Bjpih9DI.js";import{u as Ne}from"./useAppSync-Cv6kC8Or.js";const Se=()=>{var J;const{threads:v,unreadCount:X,markRead:Z,refresh:$,loading:ee,refreshing:q,error:z,syncMessagesToLive:D}=ve(),{vendor:a}=xe(),[C,se]=d.useState(""),[N,F]=d.useState("inbox"),P=(typeof window<"u"?sessionStorage.getItem("role"):null)||"",[m,te]=d.useState(()=>{const s=(typeof window<"u"?sessionStorage.getItem("messageViewAs"):null)||"";return s||(P==="admin"?a!=null&&a.vendorId?"vendor":"admin":a!=null&&a.vendorId?"vendor":"user")}),[t,u]=d.useState({open:!1,mode:a!=null&&a.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1,subscriberEmail:""}),[B,_]=d.useState([]),[ae,S]=d.useState([]),[r,j]=d.useState({q:"",page:1,pageSize:10,total:0,items:[],loading:!1}),k=(typeof window<"u"?sessionStorage.getItem("tenantId"):null)||"vendor",{appData:ne}=Ne(),p=(((J=he.currentUser)==null?void 0:J.email)||sessionStorage.getItem("userEmail")||"").toLowerCase(),O=P,M=O==="admin"||!!(a!=null&&a.vendorId),L=(a==null?void 0:a.vendorId)||(a==null?void 0:a.id)||"",w=d.useMemo(()=>{const s=[];return m==="user"?p&&s.push(`user:${p}`):m==="vendor"?(L&&s.push(`vendor:${String(L).toLowerCase()}`),p&&s.push(`vendor:${p}`)):m==="admin"&&(s.push("admin"),p&&s.push(`admin:${p}`)),s},[m,p,L]),U=d.useMemo(()=>v.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(n=>w.includes(String(n.senderId||"").toLowerCase()))),[v,w]),ie=d.useMemo(()=>v.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(n=>!w.includes(String(n.senderId||"").toLowerCase()))),[v,w]),re=U.length,le=ie.length,E=N==="sent"?U:v,W=d.useMemo(()=>{const s=C.trim().toLowerCase();return s?E.filter(n=>{var i;const l=(n.subject||"").toLowerCase(),o=(((i=n.lastMessage)==null?void 0:i.snippet)||"").toLowerCase();return l.includes(s)||o.includes(s)}):E},[E,C]),ce=X===0,oe=async()=>{await Promise.all(v.filter(s=>!s.read).map(s=>Z(s.id,!0)))},[K,H]=d.useState(!1),[de,A]=d.useState(!1),[Y,y]=d.useState(""),[G,me]=d.useState(()=>{try{return localStorage.getItem("sl_messages_last_sync")||""}catch{return""}});async function ue(){if(!M){y("Vendor or admin access required to sync."),setTimeout(()=>y(""),2500);return}H(!0),y(""),A(!1);try{if(!await D())throw new Error("Sync did not complete");const n=new Date().toISOString();try{localStorage.setItem("sl_messages_last_sync",n)}catch{}me(n),A(!0),setTimeout(()=>A(!1),1500)}catch(s){y((s==null?void 0:s.message)||"Sync failed"),setTimeout(()=>y(""),2500)}finally{H(!1)}}d.useEffect(()=>{try{sessionStorage.setItem("messageViewAs",m)}catch{}u(s=>({...s,mode:m==="vendor"?"vendor_admin":"vendor_subscriber",serviceId:"",subscriberEmail:""}))},[m]);function be(){u(s=>({...s,open:!0}))}function I(){u({open:!1,mode:a!=null&&a.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1})}async function pe(){try{const s=ne||fe,n=Array.isArray(s==null?void 0:s.services)?s.services:[];if(a!=null&&a.vendorId){const l=n.filter(o=>String(o.vendorId||"")===String(a.vendorId));_(l.map(o=>({id:o.id,title:o.title})))}else _([]);try{const o=(await V.get("/api/subscriptions/my").then(i=>Array.isArray(i.data)?i.data:[])).map(i=>{var c;return{...i,title:((c=n.find(g=>String(g.id)===String(i.serviceId)))==null?void 0:c.title)||i.serviceId}});S(o)}catch(l){if((l==null?void 0:l.code)==="ERR_NETWORK"){const i=(k==="vendor"?"public":k).toString().toLowerCase(),h=(Array.isArray(s==null?void 0:s.subscriptions)?s.subscriptions:[]).filter(b=>{const x=((b==null?void 0:b.tenantId)??"public").toString().toLowerCase()===i,R=((b==null?void 0:b.email)||"").toLowerCase();return x&&R===p}).map(b=>{var x;return{...b,title:((x=n.find(R=>String(R.id)===String(b.serviceId)))==null?void 0:x.title)||b.serviceId}});S(h)}else S([])}}catch{_([]),S([])}}async function T(s,n=r.q,l=r.page,o=r.pageSize){try{j(x=>({...x,loading:!0}));const{data:i}=await V.get(`/api/subscriptions/service/${encodeURIComponent(s)}`,{params:{q:n,page:l,pageSize:o}}),c=Number((i==null?void 0:i.page)||l),g=Number((i==null?void 0:i.pageSize)||o),h=Number((i==null?void 0:i.total)||0),b=Array.isArray(i==null?void 0:i.items)?i.items:[];j({q:n,page:c,pageSize:g,total:h,items:b,loading:!1})}catch{j(i=>({...i,loading:!1,items:[],total:0}))}}d.useEffect(()=>{t.open&&pe()},[t.open,a==null?void 0:a.vendorId,k]),d.useEffect(()=>{t.open&&t.mode==="vendor_to_subscriber"&&t.serviceId?T(t.serviceId,r.q,1,r.pageSize):j({q:"",page:1,pageSize:10,total:0,items:[],loading:!1})},[t.open,t.mode,t.serviceId]);async function ge(s){var n,l,o,i;if((n=s==null?void 0:s.preventDefault)==null||n.call(s),!(!t.serviceId||!t.content.trim())){u(c=>({...c,sending:!0,err:null,ok:!1}));try{const g={type:t.mode==="vendor_admin"?"vendor_admin":t.mode==="vendor_to_subscriber"?"vendor_to_subscriber":"vendor_subscriber",serviceId:t.serviceId,listingId:t.serviceId,subject:t.subject,content:t.content,subscriberEmail:t.mode==="vendor_to_subscriber"?t.subscriberEmail:void 0};await V.post("/api/messages/compose",g),u(h=>({...h,sending:!1,ok:!0})),await $({force:!0});try{await D()}catch{}setTimeout(()=>I(),1200)}catch(c){const g=(l=c==null?void 0:c.response)==null?void 0:l.status,h=((i=(o=c==null?void 0:c.response)==null?void 0:o.data)==null?void 0:i.message)||(c==null?void 0:c.message)||"Failed to send",b=g===401?" Please sign in to send messages.":"";u(x=>({...x,sending:!1,err:h+b}))}}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-xxl-3",children:e.jsx("div",{className:"card h-100 p-0",children:e.jsx("div",{className:"card-body p-24",children:e.jsxs("div",{className:"mt-16",children:[e.jsxs("button",{type:"button",className:"btn btn-primary btn-sm w-100 mb-3 d-flex align-items-center gap-2",onClick:be,disabled:m==="admin",children:[e.jsx(f,{icon:"fa6-regular:square-plus",className:"icon text-lg line-height-1"}),"Compose"]}),e.jsxs("ul",{children:[e.jsx("li",{className:"item-active mb-4",children:e.jsx("button",{type:"button",onClick:()=>F("inbox"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${N==="inbox"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(f,{icon:"uil:envelope",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Message Center"})]}),e.jsx("span",{className:"fw-medium",children:le})]})})}),e.jsx("li",{className:"mb-4",children:e.jsx("button",{type:"button",onClick:()=>F("sent"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${N==="sent"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(f,{icon:"ion:paper-plane-outline",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Sent"})]}),e.jsx("span",{className:"fw-medium",children:re})]})})})]})]})})})}),e.jsx("div",{className:"col-xxl-9",children:e.jsxs("div",{className:"card h-100 p-0 email-card",children:[e.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{$({silent:!0,force:!0})},disabled:ee||q,children:[e.jsx(f,{icon:"tabler:reload",className:"me-1"}),q?"Refreshing…":"Refresh"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:oe,disabled:ce,children:[e.jsx(f,{icon:"gravity-ui:envelope-open",className:"me-1"})," Mark all as read"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ue,disabled:K||!M,title:M?"Write messages to server appData.json":"Vendor or admin access required",children:[e.jsx(f,{icon:"mdi:cloud-upload-outline",className:"me-1"})," ",K?"Syncing…":"Sync Now"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("label",{className:"form-label mb-0 small text-muted",children:"View as"}),e.jsxs("select",{className:"form-select form-select-sm",value:m,onChange:s=>te(s.target.value),children:[e.jsx("option",{value:"user",children:"Startup"}),(a==null?void 0:a.vendorId)&&e.jsx("option",{value:"vendor",children:"Vendor"}),O==="admin"&&e.jsx("option",{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("form",{className:"navbar-search d-flex",onSubmit:s=>s.preventDefault(),children:[e.jsx("input",{type:"text",className:"bg-base h-40-px w-auto",name:"search",placeholder:"Search",value:C,onChange:s=>se(s.target.value)}),e.jsx(f,{icon:"ion:search-outline",className:"icon"})]}),e.jsx("div",{className:"small text-muted",children:Y?e.jsx("span",{className:"text-danger",children:Y}):de?e.jsx("span",{className:"text-success",children:"Synced"}):G?`Last sync: ${new Date(G).toLocaleString()}`:""})]})]})}),e.jsxs("div",{className:"card-body p-0",children:[z&&e.jsx("div",{className:"alert alert-danger rounded-0 border-bottom mb-0",children:z}),e.jsxs("ul",{className:"overflow-x-auto",children:[W.map(s=>{var n,l,o,i,c;return e.jsxs("li",{className:`email-item px-24 py-16 d-flex gap-4 align-items-center border-bottom cursor-pointer bg-hover-neutral-200 min-w-max-content ${s.read?"":"bg-primary-50"}`,children:[e.jsx(Q,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium text-md text-line-1 w-190-px",children:s.subject||"Message"}),e.jsx(Q,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium mb-0 text-line-1 max-w-740-px",children:((n=s.lastMessage)==null?void 0:n.snippet)||((i=(o=s.messages)==null?void 0:o[((l=s.messages)==null?void 0:l.length)-1])==null?void 0:i.content)||""}),e.jsx("span",{className:"text-primary-light fw-medium min-w-max-content ms-auto",children:(c=s.lastMessage)!=null&&c.date?new Date(s.lastMessage.date).toLocaleString():""})]},s.id)}),W.length===0&&e.jsx("li",{className:"px-24 py-16 text-muted",children:N==="sent"?"No sent messages for this role; try switching “View as”.":"No messages yet. Try switching “View as” or start a conversation."})]})]})]})})]}),t.open&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&I(),children:e.jsxs("div",{className:"card",style:{maxWidth:640,margin:"8vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Compose message"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:I,children:"Close"})]}),e.jsxs("form",{onSubmit:ge,children:[e.jsxs("div",{className:"card-body",children:[t.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:t.err}),t.ok&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-select",value:t.mode,onChange:s=>u(n=>({...n,mode:s.target.value,serviceId:"",subscriberEmail:""})),children:[m==="vendor"&&(a==null?void 0:a.vendorId)&&e.jsx("option",{value:"vendor_admin",children:"Ask Admin about my listing"}),m==="user"&&e.jsx("option",{value:"vendor_subscriber",children:"Message Vendor about a subscribed listing"}),m==="vendor"&&(a==null?void 0:a.vendorId)&&e.jsx("option",{value:"vendor_to_subscriber",children:"Message a subscriber of my listing"})]})]}),t.mode==="vendor_admin"&&m==="vendor"&&(a==null?void 0:a.vendorId)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my listings"}),e.jsxs("select",{className:"form-select",value:t.serviceId,onChange:s=>u(n=>({...n,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),B.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),t.mode==="vendor_subscriber"&&m==="user"&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my subscriptions"}),e.jsxs("select",{className:"form-select",value:t.serviceId,onChange:s=>u(n=>({...n,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),ae.map(s=>e.jsx("option",{value:s.serviceId,children:s.title},s.id))]})]}),t.mode==="vendor_to_subscriber"&&m==="vendor"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select my listing"}),e.jsxs("select",{className:"form-select",value:t.serviceId,onChange:s=>u(n=>({...n,serviceId:s.target.value,subscriberEmail:""})),children:[e.jsx("option",{value:"",children:"Select…"}),B.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"To (subscriber email)"}),e.jsx("input",{className:"form-control",value:t.subscriberEmail,onChange:s=>{const n=s.target.value;u(l=>({...l,subscriberEmail:n})),j(l=>({...l,q:n,page:1}))},placeholder:"Type to search subscribers",disabled:!t.serviceId}),t.serviceId&&e.jsxs("div",{className:"border rounded mt-2 p-2 bg-base",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"small text-secondary",children:"Suggestions"}),e.jsx("div",{className:"small text-secondary",children:r.loading?"Loading…":`${r.total} total`})]}),e.jsxs("div",{className:"list-group list-group-flush",style:{maxHeight:160,overflowY:"auto"},children:[r.items.map(s=>e.jsx("button",{type:"button",className:"list-group-item list-group-item-action py-1",onClick:()=>u(n=>({...n,subscriberEmail:s.email})),children:s.email},s.id)),!r.loading&&r.items.length===0&&e.jsx("div",{className:"text-muted small px-2 py-1",children:"No matches"})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:r.page<=1||r.loading,onClick:()=>T(t.serviceId,r.q,Math.max(1,r.page-1),r.pageSize),children:"Prev"}),e.jsxs("span",{className:"small text-secondary",children:["Page ",r.page," of ",Math.max(1,Math.ceil((r.total||0)/(r.pageSize||10)))]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:r.loading||r.page>=Math.ceil((r.total||0)/(r.pageSize||10)),onClick:()=>T(t.serviceId,r.q,r.page+1,r.pageSize),children:"Next"})]})]})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject (optional)"}),e.jsx("input",{className:"form-control",value:t.subject,onChange:s=>u(n=>({...n,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{rows:6,className:"form-control",value:t.content,onChange:s=>u(n=>({...n,content:s.target.value}))})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:I,disabled:t.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t.sending||!t.serviceId||!t.content.trim()||t.mode==="vendor_to_subscriber"&&!t.subscriberEmail,children:t.sending?"Sending…":"Send"})]})]})]})})]})},Le=()=>e.jsx(e.Fragment,{children:e.jsxs(je,{children:[e.jsx(ye,{title:"Message Center"}),e.jsx(Se,{})]})});export{Le as default};
