import{b as u,a as v}from"./index-7-v0jUWh.js";const y="sl_subscriptions_cache_v1";function p(t){if(!t||typeof t!="object")return"";const e=(t.type||"service").toString(),r=(t.email||"").toLowerCase(),n=t.serviceId!=null?String(t.serviceId):"";return`${e}::${r}::${n}`}function m(t){return[...t].sort((e,r)=>{const n=Date.parse((e==null?void 0:e.createdAt)||"")||0;return(Date.parse((r==null?void 0:r.createdAt)||"")||0)-n})}function I(t,e){if(!(e!=null&&e.length))return t;const r=new Map;return t.forEach(n=>{const i=p(n);i&&r.set(i,n)}),e.forEach(n=>{const i=p(n);!i||r.has(i)||r.set(i,n)}),Array.from(r.values())}function b(t){if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}function f(){if(typeof window>"u")return null;try{const t=v.currentUser,e=((t==null?void 0:t.email)||window.sessionStorage.getItem("userEmail")||"").toLowerCase(),r=(t==null?void 0:t.uid)||window.sessionStorage.getItem("userId")||"";return!e&&!r?null:`${y}:${r||e}`}catch{return null}}function d(t){if(!t||typeof window>"u")return[];try{return b(window.localStorage.getItem(t))}catch{return[]}}function l(t,e){if(!(!t||typeof window>"u"))try{window.localStorage.setItem(t,JSON.stringify(e))}catch{}}function C(t){if(!(!t||typeof window>"u"))try{window.localStorage.removeItem(t)}catch{}}function w(t){if(!t||typeof t!="object")return null;const e={...t};return e.type=(e.type||"service").toString(),e.email&&(e.email=e.email.toLowerCase()),e.serviceId=e.serviceId!=null?String(e.serviceId):e.serviceId,e.tenantId=(e.tenantId||"public").toString(),e}function A(t,e){const r=w(e);if(!t||!r)return;const n=d(t),i=(r.email||"").toLowerCase(),s=String(r.serviceId||""),o=r.type||"service",c=n.findIndex(a=>{const S=(a.email||"").toLowerCase(),g=String(a.serviceId||""),h=a.type||"service";return S===i&&g===s&&h===o});c>=0?n[c]={...n[c],...r,canceledAt:void 0}:n.push(r),l(t,n)}function L(t,e){if(!t)return;const r=String(e||""),n=d(t).filter(i=>String(i.serviceId||"")!==r);l(t,n)}async function E(){var r;const t=f(),e=d(t);try{const{data:n}=await u.get("/api/subscriptions/my"),s=(Array.isArray(n)?n:[]).map(w).filter(Boolean),o=I(s,e),c=m(o);return t&&l(t,c),c}catch(n){const i=(r=n==null?void 0:n.response)==null?void 0:r.status;return i===401||i===403||i===404?(C(t),[]):e.length?m(e):[]}}async function _(t,e={}){const r={serviceId:t,...e},{data:n}=await u.post("/api/subscriptions/service",r),i=f();return A(i,n||{serviceId:t,...e,type:"service"}),n}async function $(t){await u.put("/api/subscriptions/service/cancel",{serviceId:t});const e=f();return L(e,t),!0}export{E as f,_ as s,$ as u};
