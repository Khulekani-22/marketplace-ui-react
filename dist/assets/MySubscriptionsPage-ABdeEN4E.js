import{r as i,d as B,b as h,a as d,j as s}from"./index-BiIypJQ8.js";import{M as T}from"./MasterLayout-R6RBQnho.js";import{B as _}from"./Breadcrumb-59wj0bKM.js";import{f as L,u as J}from"./subscriptions-BOpbJB5M.js";import"./iconify-BEfBG96Y.js";function q(){const[v,y]=i.useState(!0),[x,p]=i.useState([]),[S,j]=i.useState(""),[N,w]=i.useState({}),[I,U]=i.useState(!1),A=i.useMemo(()=>sessionStorage.getItem("tenantId")||"vendor",[]),{appData:u}=B(),C=i.useCallback(async()=>{var t;try{console.log("🔗 Testing API connection..."),console.log("🔗 Current API base URL:",h.defaults.baseURL);const e=await h.get("/api/health");if(console.log("✅ API health check passed:",e.data),d.currentUser){console.log("🔐 Testing authenticated endpoint...");const c=await h.get("/api/subscriptions/my");console.log("✅ Subscriptions endpoint test:",c.data)}}catch(e){console.error("❌ API connection test failed:",e),console.error("❌ Error details:",(t=e==null?void 0:e.response)==null?void 0:t.data)}},[]);i.useEffect(()=>{C()},[C]);const f=i.useCallback(async({silent:t,signal:e}={})=>{t?U(!0):y(!0),j("");try{if(!d.currentUser){console.log("🔐 No authenticated user found"),e!=null&&e.aborted||p([]);return}console.log("📡 Fetching subscriptions for user:",d.currentUser.email);const c=await L();console.log("📋 Raw subscriptions from API:",c);const b=new Set(c.filter(n=>(n.type||"service")==="service").map(n=>String(n.serviceId)));console.log("🔍 Service IDs from subscriptions:",Array.from(b));const m=Array.isArray(u==null?void 0:u.services)?u.services:[];console.log("📦 Available services in appData:",m.length);const l=m.filter(n=>b.has(String(n.id)));console.log("✅ Matched services:",l.length,l.map(n=>({id:n.id,title:n.title}))),e!=null&&e.aborted||p(l)}catch(c){console.error("❌ Failed to load subscriptions:",c),e!=null&&e.aborted||j((c==null?void 0:c.message)||"Failed to load subscriptions")}finally{(e==null?void 0:e.aborted)||(t?U(!1):y(!1))}},[u]);i.useEffect(()=>{const t=new AbortController;return f({silent:!1,signal:t.signal}),()=>{t.abort()}},[f,A]);async function P(t){var c,b,m,l,n,F,R,M;const e=String(t);console.log("🔄 Starting unsubscribe process for service:",e),console.log("🔄 Current user:",(c=d.currentUser)==null?void 0:c.email),console.log("🔄 Current tenant:",A),w(r=>({...r,[e]:!0}));try{console.log("🔍 Fetching current subscriptions before unsubscribe...");const r=await L();console.log("📋 Current subscriptions:",r);const g=r.find(o=>String(o.serviceId)===e);if(console.log("🎯 Target subscription to cancel:",g),!g){console.log("⚠️ No subscription found in cache for service:",e),p(o=>o.filter(a=>String(a.id)!==e)),alert(`✅ Service ${e} removed from your subscriptions (was already cancelled)`);return}console.log("📡 Calling unsubscribeFromService API...");try{const o=await J(e);console.log("✅ Unsubscribe API success:",o),alert(`✅ Successfully unsubscribed from service ${e}`)}catch(o){if(((b=o==null?void 0:o.response)==null?void 0:b.status)===404)console.log("⚠️ Backend says subscription not found (404) - treating as already cancelled"),alert(`✅ Service ${e} removed from your subscriptions (was already cancelled on server)`);else throw o}p(o=>{const a=o.filter(k=>String(k.id)!==e);return console.log("📝 Updated items count:",a.length),a}),console.log("�️ Clearing subscription from local cache...");try{const o=`sl_subscriptions_cache_v1:${((m=d.currentUser)==null?void 0:m.uid)||((l=d.currentUser)==null?void 0:l.email)}`,a=localStorage.getItem(o);if(a){const E=JSON.parse(a).filter($=>String($.serviceId)!==e);localStorage.setItem(o,JSON.stringify(E)),console.log("🗑️ Removed subscription from cache, remaining:",E.length)}}catch(o){console.log("⚠️ Failed to update cache:",o)}console.log("✅ Unsubscribe completed - skipping refresh to prevent reappearing")}catch(r){console.error("❌ Failed to unsubscribe:",r),console.error("❌ Error response:",r==null?void 0:r.response),console.error("❌ Error data:",(n=r==null?void 0:r.response)==null?void 0:n.data),console.error("❌ Error status:",(F=r==null?void 0:r.response)==null?void 0:F.status);const g=((M=(R=r==null?void 0:r.response)==null?void 0:R.data)==null?void 0:M.message)||(r==null?void 0:r.message)||"Failed to unsubscribe";alert(`❌ Unsubscribe failed for service ${e}: ${g}`)}finally{w(r=>({...r,[e]:!1})),console.log("🏁 Unsubscribe process completed for service:",e)}}return s.jsxs(T,{children:[s.jsx(_,{title:"My Subscriptions"}),s.jsxs("div",{className:"card",children:[s.jsxs("div",{className:"card-header border-bottom py-16 px-24 d-flex align-items-center justify-content-between gap-3 flex-wrap",children:[s.jsx("h6",{className:"mb-0",children:"Active Subscriptions"}),s.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>f({silent:!0}),disabled:v||I,children:I?"Refreshing…":"Refresh"})]}),s.jsxs("div",{className:"card-body",children:[S&&s.jsx("div",{className:"alert alert-danger",children:S}),v?s.jsx("div",{children:"Loading…"}):s.jsxs("div",{className:"row g-3",children:[x.length===0&&s.jsx("div",{className:"col-12 text-secondary",children:"No subscriptions yet."}),x.map(t=>s.jsx("div",{className:"col-12 col-md-6 col-lg-4",children:s.jsxs("div",{className:"card h-100",children:[s.jsx("img",{src:t.imageUrl||"/assets/images/services/placeholder.png",className:"card-img-top",alt:t.title||"Listing",style:{maxHeight:160,objectFit:"cover"}}),s.jsxs("div",{className:"card-body d-flex flex-column",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[s.jsx("h6",{className:"card-title mb-1",children:t.title||"Listing"}),s.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",title:"Notifications (soon)",disabled:!0,children:s.jsx("i",{className:"ri-notification-3-line"})})]}),s.jsxs("div",{className:"text-muted small mb-2",children:[t.category||"General"," · ",t.vendor||""]}),t.description&&s.jsxs("p",{className:"flex-grow-1 text-secondary small",children:[t.description.slice(0,140),t.description.length>140?"…":""]}),s.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-auto",children:[s.jsxs("strong",{children:["R ",Number(t.price||0).toLocaleString()]}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsxs("span",{className:"badge bg-neutral-200 text-neutral-900",children:["★ ",Number(t.rating||0).toFixed(1)]}),s.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>P(t.id),disabled:!!N[String(t.id)],children:N[String(t.id)]?"Removing…":"Unsubscribe"})]})]})]})]})},String(t.id)))]})]})]})]})}export{q as default};
