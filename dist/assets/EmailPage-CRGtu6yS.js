import{c as X,r as m,b as Z,j as e,L as D,a as M}from"./index-BgSSzMVW.js";import{u as ee,M as se}from"./MasterLayout-DVOb_jF6.js";import{B as ae}from"./Breadcrumb-Bz_yGRYO.js";import{I as p}from"./iconify-C46oQfm1.js";import{a as te}from"./appData-B63YnYfI.js";const ne=()=>{var P;const{threads:x,unreadCount:U,markRead:V,refresh:E,loading:L}=ee(),{vendor:i}=X(),[f,B]=m.useState(""),[y,A]=m.useState("inbox"),[a,o]=m.useState({open:!1,mode:i!=null&&i.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1,subscriberEmail:""}),[z,N]=m.useState([]),[H,w]=m.useState([]),[l,g]=m.useState({q:"",page:1,pageSize:10,total:0,items:[],loading:!1}),$=(typeof window<"u"?sessionStorage.getItem("tenantId"):null)||"vendor",h=(((P=Z.currentUser)==null?void 0:P.email)||sessionStorage.getItem("userEmail")||"").toLowerCase(),R=(typeof window<"u"?sessionStorage.getItem("role"):null)||"",I=(i==null?void 0:i.vendorId)||(i==null?void 0:i.id)||"",j=m.useMemo(()=>{const s=[];return h&&s.push(`user:${h}`),I&&s.push(`vendor:${String(I).toLowerCase()}`),h&&s.push(`vendor:${h}`),R==="admin"&&s.push("admin"),s},[h,I,R]),q=m.useMemo(()=>x.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(t=>j.includes(String(t.senderId||"").toLowerCase()))),[x,j]),T=m.useMemo(()=>x.filter(s=>Array.isArray(s==null?void 0:s.messages)&&s.messages.some(t=>!j.includes(String(t.senderId||"").toLowerCase()))),[x,j]),W=q.length,Y=T.length,S=y==="sent"?q:T,F=m.useMemo(()=>{const s=f.trim().toLowerCase();return s?S.filter(t=>{var n;const c=(t.subject||"").toLowerCase(),d=(((n=t.lastMessage)==null?void 0:n.snippet)||"").toLowerCase();return c.includes(s)||d.includes(s)}):S},[S,f]),G=U===0,J=async()=>{await Promise.all(x.filter(s=>!s.read).map(s=>V(s.id,!0)))};function K(){o(s=>({...s,open:!0}))}function v(){o({open:!1,mode:i!=null&&i.vendorId?"vendor_admin":"vendor_subscriber",serviceId:"",subject:"",content:"",sending:!1,err:null,ok:!1})}async function O(){try{const s=await fetch("/api/lms/live",{headers:{"x-tenant-id":$}}),t=s.ok?await s.json():te,c=Array.isArray(t==null?void 0:t.services)?t.services:[];if(i!=null&&i.vendorId){const d=c.filter(n=>String(n.vendorId||"")===String(i.vendorId));N(d.map(n=>({id:n.id,title:n.title})))}else N([]);try{const n=(await M.get("/api/subscriptions/my").then(r=>Array.isArray(r.data)?r.data:[])).map(r=>{var u;return{...r,title:((u=c.find(b=>String(b.id)===String(r.serviceId)))==null?void 0:u.title)||r.serviceId}});w(n)}catch{w([])}}catch{N([]),w([])}}async function C(s,t=l.q,c=l.page,d=l.pageSize){try{g(k=>({...k,loading:!0}));const{data:n}=await M.get(`/api/subscriptions/service/${encodeURIComponent(s)}`,{params:{q:t,page:c,pageSize:d}}),r=Number((n==null?void 0:n.page)||c),u=Number((n==null?void 0:n.pageSize)||d),b=Number((n==null?void 0:n.total)||0),_=Array.isArray(n==null?void 0:n.items)?n.items:[];g({q:t,page:r,pageSize:u,total:b,items:_,loading:!1})}catch{g(n=>({...n,loading:!1,items:[],total:0}))}}m.useEffect(()=>{a.open&&O()},[a.open,i==null?void 0:i.vendorId,$]),m.useEffect(()=>{a.open&&a.mode==="vendor_to_subscriber"&&a.serviceId?C(a.serviceId,l.q,1,l.pageSize):g({q:"",page:1,pageSize:10,total:0,items:[],loading:!1})},[a.open,a.mode,a.serviceId]);async function Q(s){var t,c,d,n;if((t=s==null?void 0:s.preventDefault)==null||t.call(s),!(!a.serviceId||!a.content.trim())){o(r=>({...r,sending:!0,err:null,ok:!1}));try{const u={type:a.mode==="vendor_admin"?"vendor_admin":a.mode==="vendor_to_subscriber"?"vendor_to_subscriber":"vendor_subscriber",serviceId:a.serviceId,listingId:a.serviceId,subject:a.subject,content:a.content,subscriberEmail:a.mode==="vendor_to_subscriber"?a.subscriberEmail:void 0};await M.post("/api/messages/compose",u),o(b=>({...b,sending:!1,ok:!0})),await E(),setTimeout(()=>v(),1200)}catch(r){const u=(c=r==null?void 0:r.response)==null?void 0:c.status,b=((n=(d=r==null?void 0:r.response)==null?void 0:d.data)==null?void 0:n.message)||(r==null?void 0:r.message)||"Failed to send",_=u===401?" Please sign in to send messages.":"";o(k=>({...k,sending:!1,err:b+_}))}}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-xxl-3",children:e.jsx("div",{className:"card h-100 p-0",children:e.jsx("div",{className:"card-body p-24",children:e.jsxs("div",{className:"mt-16",children:[e.jsxs("button",{type:"button",className:"btn btn-primary btn-sm w-100 mb-3 d-flex align-items-center gap-2",onClick:K,children:[e.jsx(p,{icon:"fa6-regular:square-plus",className:"icon text-lg line-height-1"}),"Compose"]}),e.jsxs("ul",{children:[e.jsx("li",{className:"item-active mb-4",children:e.jsx("button",{type:"button",onClick:()=>A("inbox"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${y==="inbox"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(p,{icon:"uil:envelope",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Inbox"})]}),e.jsx("span",{className:"fw-medium",children:Y})]})})}),e.jsx("li",{className:"mb-4",children:e.jsx("button",{type:"button",onClick:()=>A("sent"),className:`bg-hover-primary-50 px-12 py-8 w-100 radius-8 text-start ${y==="sent"?"text-primary-600 fw-semibold":"text-secondary-light"}`,children:e.jsxs("span",{className:"d-flex align-items-center gap-10 justify-content-between w-100",children:[e.jsxs("span",{className:"d-flex align-items-center gap-10",children:[e.jsx("span",{className:"icon text-xxl line-height-1 d-flex",children:e.jsx(p,{icon:"ion:paper-plane-outline",className:"icon line-height-1"})}),e.jsx("span",{className:"fw-semibold",children:"Sent"})]}),e.jsx("span",{className:"fw-medium",children:W})]})})})]})]})})})}),e.jsx("div",{className:"col-xxl-9",children:e.jsxs("div",{className:"card h-100 p-0 email-card",children:[e.jsx("div",{className:"card-header border-bottom bg-base py-16 px-24",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:E,disabled:L,children:[e.jsx(p,{icon:"tabler:reload",className:"me-1"})," ",L?"Refreshing…":"Refresh"]}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:J,disabled:G,children:[e.jsx(p,{icon:"gravity-ui:envelope-open",className:"me-1"})," Mark all as read"]})]}),e.jsxs("form",{className:"navbar-search d-flex",onSubmit:s=>s.preventDefault(),children:[e.jsx("input",{type:"text",className:"bg-base h-40-px w-auto",name:"search",placeholder:"Search",value:f,onChange:s=>B(s.target.value)}),e.jsx(p,{icon:"ion:search-outline",className:"icon"})]})]})}),e.jsx("div",{className:"card-body p-0",children:e.jsxs("ul",{className:"overflow-x-auto",children:[F.map(s=>{var t,c,d,n,r;return e.jsxs("li",{className:`email-item px-24 py-16 d-flex gap-4 align-items-center border-bottom cursor-pointer bg-hover-neutral-200 min-w-max-content ${s.read?"":"bg-primary-50"}`,children:[e.jsx(D,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium text-md text-line-1 w-190-px",children:s.subject||"Message"}),e.jsx(D,{to:`/view-details?tid=${encodeURIComponent(s.id)}`,className:"text-primary-light fw-medium mb-0 text-line-1 max-w-740-px",children:((t=s.lastMessage)==null?void 0:t.snippet)||((n=(d=s.messages)==null?void 0:d[((c=s.messages)==null?void 0:c.length)-1])==null?void 0:n.content)||""}),e.jsx("span",{className:"text-primary-light fw-medium min-w-max-content ms-auto",children:(r=s.lastMessage)!=null&&r.date?new Date(s.lastMessage.date).toLocaleString():""})]},s.id)}),F.length===0&&e.jsx("li",{className:"px-24 py-16 text-muted",children:"No messages"})]})})]})})]}),a.open&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100",style:{background:"rgba(0,0,0,0.5)",zIndex:1070},onClick:s=>s.target===s.currentTarget&&v(),children:e.jsxs("div",{className:"card",style:{maxWidth:640,margin:"8vh auto"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"mb-0",children:"Compose message"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:v,children:"Close"})]}),e.jsxs("form",{onSubmit:Q,children:[e.jsxs("div",{className:"card-body",children:[a.err&&e.jsx("div",{className:"alert alert-danger py-2 mb-2",children:a.err}),a.ok&&e.jsx("div",{className:"alert alert-success py-2 mb-2",children:"Sent"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-select",value:a.mode,onChange:s=>o(t=>({...t,mode:s.target.value,serviceId:"",subscriberEmail:""})),children:[(i==null?void 0:i.vendorId)&&e.jsx("option",{value:"vendor_admin",children:"Ask Admin about my listing"}),e.jsx("option",{value:"vendor_subscriber",children:"Message Vendor about a subscribed listing"}),(i==null?void 0:i.vendorId)&&e.jsx("option",{value:"vendor_to_subscriber",children:"Message a subscriber of my listing"})]})]}),a.mode==="vendor_admin"&&(i==null?void 0:i.vendorId)&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my listings"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>o(t=>({...t,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),z.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),a.mode==="vendor_subscriber"&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select one of my subscriptions"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>o(t=>({...t,serviceId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),H.map(s=>e.jsx("option",{value:s.serviceId,children:s.title},s.id))]})]}),a.mode==="vendor_to_subscriber"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Select my listing"}),e.jsxs("select",{className:"form-select",value:a.serviceId,onChange:s=>o(t=>({...t,serviceId:s.target.value,subscriberEmail:""})),children:[e.jsx("option",{value:"",children:"Select…"}),z.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"To (subscriber email)"}),e.jsx("input",{className:"form-control",value:a.subscriberEmail,onChange:s=>{const t=s.target.value;o(c=>({...c,subscriberEmail:t})),g(c=>({...c,q:t,page:1}))},placeholder:"Type to search subscribers",disabled:!a.serviceId}),a.serviceId&&e.jsxs("div",{className:"border rounded mt-2 p-2 bg-base",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("div",{className:"small text-secondary",children:"Suggestions"}),e.jsx("div",{className:"small text-secondary",children:l.loading?"Loading…":`${l.total} total`})]}),e.jsxs("div",{className:"list-group list-group-flush",style:{maxHeight:160,overflowY:"auto"},children:[l.items.map(s=>e.jsx("button",{type:"button",className:"list-group-item list-group-item-action py-1",onClick:()=>o(t=>({...t,subscriberEmail:s.email})),children:s.email},s.id)),!l.loading&&l.items.length===0&&e.jsx("div",{className:"text-muted small px-2 py-1",children:"No matches"})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:l.page<=1||l.loading,onClick:()=>C(a.serviceId,l.q,Math.max(1,l.page-1),l.pageSize),children:"Prev"}),e.jsxs("span",{className:"small text-secondary",children:["Page ",l.page," of ",Math.max(1,Math.ceil((l.total||0)/(l.pageSize||10)))]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",disabled:l.loading||l.page>=Math.ceil((l.total||0)/(l.pageSize||10)),onClick:()=>C(a.serviceId,l.q,l.page+1,l.pageSize),children:"Next"})]})]})]})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Subject (optional)"}),e.jsx("input",{className:"form-control",value:a.subject,onChange:s=>o(t=>({...t,subject:s.target.value}))})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label",children:"Message"}),e.jsx("textarea",{rows:6,className:"form-control",value:a.content,onChange:s=>o(t=>({...t,content:s.target.value}))})]})]}),e.jsxs("div",{className:"card-footer d-flex justify-content-end gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:v,disabled:a.sending,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:a.sending||!a.serviceId||!a.content.trim()||a.mode==="vendor_to_subscriber"&&!a.subscriberEmail,children:a.sending?"Sending…":"Send"})]})]})]})})]})},de=()=>e.jsx(e.Fragment,{children:e.jsxs(se,{children:[e.jsx(ae,{title:"Email"}),e.jsx(ne,{})]})});export{de as default};
