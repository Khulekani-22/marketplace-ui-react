import{r as i,d as Z,b as y,A as M,B as f,j as e,L as S}from"./index-C1K-Ttoc.js";import{M as _}from"./MasterLayout-2IldCL2c.js";import{B as ee}from"./Breadcrumb-Y9hUuaca.js";import{I as n}from"./iconify-CXWIXv_s.js";import{u as se}from"./useWallet-B_qgyXNK.js";import{W as ae,a as te,A as le,T as ne,f as ie}from"./WalletNavigation-Cx7Un648.js";function re(){const[k,P]=i.useState([]),[A,U]=i.useState(!0),[x,$]=i.useState(""),[u,v]=i.useState(!1),[m,q]=i.useState(""),[G,F]=i.useState([]),[p,E]=i.useState(!1),[T,w]=i.useState(""),[g,W]=i.useState(""),[C,ce]=i.useState(100),I=i.useRef(!1),{wallet:h,loading:Q,eligible:V,refresh:z,grantCredits:H}=se(),{isAdmin:O}=Z(),L=i.useCallback(async(s=!0)=>{var a,t,l,j,R;w(""),E(!0);try{const r={search:m,pageSize:C};!s&&g&&(r.pageToken=g);const{data:d}=await y.get("/api/users/all",{params:r}),c=Array.isArray(d==null?void 0:d.items)?d.items:[];F(o=>s?c:[...o,...c]),W((d==null?void 0:d.nextPageToken)||"")}catch(r){const d=(a=r==null?void 0:r.response)==null?void 0:a.status;if(d===401||d===403)try{await M();const c={search:m,pageSize:C};!s&&g&&(c.pageToken=g);const{data:o}=await y.get("/api/users/all",{params:c}),B=Array.isArray(o==null?void 0:o.items)?o.items:[];F(Y=>s?B:[...Y,...B]),W((o==null?void 0:o.nextPageToken)||""),w("");return}catch(c){w(((l=(t=c==null?void 0:c.response)==null?void 0:t.data)==null?void 0:l.message)||(c==null?void 0:c.message)||"Failed to search platform users")}else w(((R=(j=r==null?void 0:r.response)==null?void 0:j.data)==null?void 0:R.message)||(r==null?void 0:r.message)||"Failed to search platform users")}finally{E(!1)}},[m,C,g]);i.useEffect(()=>{if(I.current)return;I.current=!0;let s=!0;return(async()=>{try{if(await M(),!s||(await L(!0),!s))return;await b()}catch(a){console.error("Failed to auto-load users:",a)}})(),()=>{s=!1}},[L]);const b=async()=>{try{U(!0);const t=((await y.get("/api/users")).data||[]).map(l=>({...l,walletBalance:J(l.uid||l.email),lastActivity:l.lastActivity||new Date().toISOString(),avatar:l.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(l.name||l.email)}&background=6366f1&color=fff`}));P(t)}catch(s){console.error("Error loading users:",s),f.error("Failed to load user data")}finally{U(!1)}},J=s=>{const a=k.find(t=>t.uid===s);return(a==null?void 0:a.walletBalance)||0},K=async()=>{var s,a;if(!u)try{v(!0),await y.post("/api/admin/wallet/normalize-appdata"),f.success("Successfully normalized app data"),await b()}catch(t){console.error("Error normalizing data:",t);const l=((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to normalize app data";f.error(l)}finally{v(!1)}},X=async()=>{var s,a;if(!u)try{v(!0);const t=["mncubekhulekani@gmail.com","ruthmaphosa2024@gmail.com","zinhlesloane@gmail.com","khulekani@gecafrica.co","22onsloanedigitalteam@gmail.com","khulekani@22onsloane.co"],l=await y.post("/api/admin/wallet/sync-firebase-users",{promoteVendors:t,defaultRole:"member",defaultTenant:"vendor"});f.success(`Successfully synced ${l.data.synced} Firebase users`),await b()}catch(t){console.error("Error syncing Firebase users:",t);const l=((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to sync Firebase users";f.error(l)}finally{v(!1)}},D=k.filter(s=>{var a;return s.email.toLowerCase().includes(x.toLowerCase())||((a=s.name)==null?void 0:a.toLowerCase().includes(x.toLowerCase()))||s.role.toLowerCase().includes(x.toLowerCase())}),N=G.filter(s=>{var a,t;return((a=s.email)==null?void 0:a.toLowerCase().includes(m.toLowerCase()))||((t=s.displayName)==null?void 0:t.toLowerCase().includes(m.toLowerCase()))});return e.jsxs("div",{className:"container-fluid",children:[e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-info",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(n,{icon:"mdi:information",className:"me-2 text-xl"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Enhanced Integration Available:"}),e.jsxs("p",{className:"mb-1",children:["The main ",e.jsx(S,{to:"/wallet",className:"alert-link",children:"Wallet interface"})," now includes all admin functionality with improved user transaction tracking capabilities."]}),e.jsx("small",{className:"text-muted",children:"This legacy interface remains available for compatibility, but we recommend using the unified wallet for better user experience."})]})]})})})}),e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-12",children:e.jsx(ae,{})}),O&&h&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"row gy-4",children:[e.jsx("div",{className:"col-12 col-lg-8",children:e.jsx(te,{wallet:h,loading:Q,eligible:V,onRefresh:z,showActions:!0})}),e.jsx("div",{className:"col-12 col-lg-4",children:e.jsxs("div",{className:"card p-24 radius-12 h-100",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(n,{icon:"mdi:shield-crown",className:"text-xl text-primary-600 me-2"}),"Admin Actions"]}),e.jsxs("div",{className:"d-grid gap-2",children:[e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:K,disabled:u,children:u?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Normalizing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(n,{icon:"mdi:database-sync",className:"me-2"}),"Normalize Data"]})}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:X,disabled:u,children:u?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Syncing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(n,{icon:"mdi:account-sync",className:"me-2"}),"Sync Firebase Users"]})}),e.jsxs(S,{to:"/wallet",className:"btn btn-outline-success btn-sm",children:[e.jsx(n,{icon:"mdi:wallet",className:"me-2"}),"Unified Wallet Interface"]}),e.jsxs(S,{to:"/dashboard",className:"btn btn-outline-info btn-sm",children:[e.jsx(n,{icon:"mdi:view-dashboard",className:"me-2"}),"Dashboard"]})]})]})})]})}),e.jsx("div",{className:"col-12",children:e.jsx(le,{grantCredits:H,onRefresh:async()=>{await b(),await z()},compact:!1,showUserLookup:!0})}),(h==null?void 0:h.transactions)&&h.transactions.length>0&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(n,{icon:"mdi:history",className:"text-xl text-primary-600 me-2"}),"My Recent Activity"]}),e.jsx(S,{to:"/wallet",className:"btn btn-outline-primary btn-sm",children:"View Full History"})]}),e.jsx(ne,{transactions:h.transactions,compact:!0})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(n,{icon:"mdi:account-group",className:"text-xl text-primary-600 me-2"}),"Platform Users"]}),e.jsx("div",{className:"d-flex gap-2",children:e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>L(!0),disabled:p,children:p?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(n,{icon:"mdi:refresh"})})})]}),e.jsx("div",{className:"row mb-3",children:e.jsx("div",{className:"col-12 col-md-6",children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx(n,{icon:"mdi:magnify"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Search platform users...",value:m,onChange:s=>q(s.target.value)})]})})}),T&&e.jsxs("div",{className:"alert alert-warning mb-3",children:[e.jsx(n,{icon:"mdi:alert-circle",className:"me-2"}),T]}),p&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"text-secondary mt-2",children:"Searching platform users..."})]}),!p&&N.length>0&&e.jsxs("div",{className:"table-responsive",children:[e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Last Sign In"}),e.jsx("th",{children:"Provider"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:N.slice(0,20).map(s=>{var a,t,l;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:s.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.displayName||s.email)}&background=6366f1&color=fff`,alt:s.displayName||s.email,className:"rounded-circle me-2",width:"32",height:"32"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.displayName||"No Name"}),e.jsx("div",{className:"text-xs text-secondary",children:s.uid})]})]})}),e.jsx("td",{children:s.email}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:(a=s.metadata)!=null&&a.lastSignInTime?new Date(s.metadata.lastSignInTime).toLocaleDateString():"Never"})}),e.jsx("td",{children:e.jsx("span",{className:"badge bg-light text-dark",children:((l=(t=s.providerData)==null?void 0:t[0])==null?void 0:l.providerId)||"Unknown"})}),e.jsx("td",{children:e.jsx("div",{className:"btn-group btn-group-sm",children:e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{const j=document.querySelector('input[type="email"]');j&&(j.value=s.email,j.dispatchEvent(new Event("input",{bubbles:!0})))},title:"Grant credits to this user",children:e.jsx(n,{icon:"mdi:wallet-plus"})})})})]},s.uid)})})]}),N.length>20&&e.jsx("div",{className:"text-center pt-3",children:e.jsxs("small",{className:"text-secondary",children:["Showing 20 of ",N.length," users. Use search to narrow results."]})})]}),!p&&N.length===0&&m&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(n,{icon:"mdi:account-search",className:"text-4xl text-secondary-light mb-2"}),e.jsxs("p",{className:"text-secondary",children:['No users found matching "',m,'"']})]})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card p-24 radius-12",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(n,{icon:"mdi:account-group",className:"text-xl text-primary-600 me-2"}),"Local Users & Wallets"]}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:b,disabled:A,children:A?e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}):e.jsx(n,{icon:"mdi:refresh"})})]}),e.jsx("div",{className:"row mb-3",children:e.jsx("div",{className:"col-12 col-md-6",children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx(n,{icon:"mdi:magnify"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Search users...",value:x,onChange:s=>$(s.target.value)})]})})}),A?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"text-secondary mt-2",children:"Loading users..."})]}):D.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Tenant"}),e.jsx("th",{children:"Wallet Balance"}),e.jsx("th",{children:"Last Activity"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:D.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{src:s.avatar,alt:s.name,className:"rounded-circle me-2",width:"32",height:"32"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.name}),e.jsx("div",{className:"text-xs text-secondary",children:s.email})]})]})}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.role==="admin"?"bg-danger":s.role==="vendor"?"bg-warning":"bg-secondary"}`,children:s.role})}),e.jsx("td",{children:s.tenantId}),e.jsx("td",{children:e.jsxs("span",{className:"fw-medium",children:["R ",ie(s.walletBalance)]})}),e.jsx("td",{children:e.jsx("span",{className:"text-sm",children:new Date(s.lastActivity).toLocaleDateString()})}),e.jsx("td",{children:e.jsx("div",{className:"btn-group btn-group-sm",children:e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{const a=document.querySelector('input[type="email"]');a&&(a.value=s.email,a.dispatchEvent(new Event("input",{bubbles:!0})))},title:"Grant credits to this user",children:e.jsx(n,{icon:"mdi:wallet-plus"})})})})]},s.uid))})]})}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(n,{icon:"mdi:account-search",className:"text-4xl text-secondary-light mb-2"}),e.jsx("p",{className:"text-secondary",children:x?`No users found matching "${x}"`:"No users found"})]})]})})]})]})}const je=()=>e.jsxs(_,{children:[e.jsx(ee,{title:"Wallet Credits Management"}),e.jsx(re,{})]});export{je as default};
